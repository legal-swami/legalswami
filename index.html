<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>LegalSwami - AI Legal Assistant</title>
    
    <!-- jsPDF Library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>
    <!-- jsPDF AutoTable plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- ChatGPT-like Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
    /* ChatGPT-like Colors */
    --primary: #10a37f;
    --primary-dark: #0d8c6d;
    --primary-light: #12b886;
    --secondary: #7e57c2;
    --accent: #ec4899;
    
    /* Dark Mode (ChatGPT-like) */
    --dark-bg: #343541;
    --dark-surface: #40414f;
    --dark-surface-light: #444654;
    --dark-border: #565869;
    --dark-text: #ececf1;
    --dark-text-secondary: #8e8ea0;
    --dark-text-tertiary: #6e6e80;
    
    /* Light Mode (ChatGPT-like) */
    --light-bg: #ffffff;
    --light-surface: #f7f7f8;
    --light-surface-light: #f0f0f0;
    --light-border: #e5e5e5;
    --light-text: #000000;
    --light-text-secondary: #6e6e80;
    --light-text-tertiary: #8e8ea0;
    
    /* Status Colors */
    --success: #10b981;
    --warning: #f59e0b;
    --error: #ef4444;
    --info: #3b82f6;
}
        
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
    -webkit-tap-highlight-color: transparent;
}
        
body {
    background: var(--dark-bg);
    color: var(--dark-text);
    line-height: 1.5;
    min-height: 100vh;
    overflow-x: hidden;
    transition: all 0.2s ease;
    overflow-y: auto;
    font-size: 14px;
}
        
body.light-mode {
    background: var(--light-bg);
    color: var(--light-text);
}

/* ChatGPT-like Container */
.container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    width: 100%;
    background: var(--dark-bg);
    overflow: hidden;
    transition: all 0.2s ease;
    position: relative;
}
        
.light-mode .container {
    background: var(--light-bg);
}

/* ChatGPT-like Header - FIXED FOR MOBILE */
header {
    background: var(--dark-surface);
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--dark-border);
    position: sticky;
    top: 0;
    z-index: 1000;
    min-height: 60px;
    transition: all 0.2s ease;
    width: 100%;
    flex-shrink: 0;
    overflow-x: auto;
    overflow-y: hidden;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
}
        
.light-mode header {
    background: var(--light-surface);
    border-bottom-color: var(--light-border);
}
        
/* Hide scrollbar but keep functionality */
header::-webkit-scrollbar {
    height: 0;
    background: transparent;
}
        
.logo {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
    position: sticky;
    left: 0;
    background: inherit;
    padding-right: 10px;
    z-index: 2;
}
        
.logo-icon {
    font-size: 1.1rem;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
        
.logo h1 {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--dark-text);
    white-space: nowrap;
}
        
.light-mode .logo h1 {
    color: var(--light-text);
}
        
.header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: nowrap;
    justify-content: flex-end;
    min-width: max-content;
    padding-left: 10px;
}
        
.header-btn {
    background: var(--dark-surface-light);
    color: var(--dark-text);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
    min-height: 36px;
    font-weight: 500;
    flex-shrink: 0;
}
        
.light-mode .header-btn {
    background: var(--light-surface-light);
    color: var(--light-text);
    border-color: var(--light-border);
}
        
.header-btn:hover {
    background: var(--dark-border);
}
        
.light-mode .header-btn:hover {
    background: var(--light-border);
}
        
.status-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 0.4rem 0.75rem;
    background: rgba(16, 163, 127, 0.1);
    border: 1px solid rgba(16, 163, 127, 0.3);
    border-radius: 6px;
    font-size: 0.85rem;
    white-space: nowrap;
    flex-shrink: 0;
    min-height: 36px;
    font-weight: 500;
}
        
.light-mode .status-indicator {
    background: rgba(16, 163, 127, 0.08);
    border-color: rgba(16, 163, 127, 0.2);
}
        
.status-dot {
    width: 8px;
    height: 8px;
    background-color: var(--success);
    border-radius: 50%;
    animation: pulse 2s infinite;
}
        
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
        
.theme-toggle {
    background: var(--dark-surface-light);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    flex-shrink: 0;
}
        
.light-mode .theme-toggle {
    background: var(--light-surface-light);
    border-color: var(--light-border);
}
        
.theme-toggle:hover {
    transform: rotate(15deg);
}
        
.theme-toggle i {
    color: var(--dark-text);
    transition: all 0.2s;
    font-size: 1rem;
}
        
.light-mode .theme-toggle i {
    color: var(--light-text);
}

/* ChatGPT-like Main Layout */
.main-content {
    display: flex;
    flex: 1;
    overflow: hidden;
    position: relative;
    width: 100%;
    min-height: 0;
}

/* ChatGPT-like Sidebar */
.sidebar {
    width: 260px;
    background: var(--dark-surface);
    border-right: 1px solid var(--dark-border);
    display: flex;
    flex-direction: column;
    transition: transform 0.2s ease;
    z-index: 50;
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    overflow: hidden;
    transform: translateX(-100%);
}
        
.light-mode .sidebar {
    background: var(--light-surface);
    border-right-color: var(--light-border);
}
        
.sidebar.active {
    transform: translateX(0);
}
        
.sidebar-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: var(--dark-surface-light);
    color: var(--dark-text);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    padding: 0.5rem;
    cursor: pointer;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
}
        
.light-mode .sidebar-close {
    background: var(--light-surface-light);
    color: var(--light-text);
    border-color: var(--light-border);
}
        
.sidebar-close:hover {
    background: var(--dark-border);
}
        
.light-mode .sidebar-close:hover {
    background: var(--light-border);
}
        
.sidebar-tabs {
    display: flex;
    border-bottom: 1px solid var(--dark-border);
    background: var(--dark-surface);
    position: sticky;
    top: 0;
    z-index: 20;
}
        
.light-mode .sidebar-tabs {
    background: var(--light-surface);
    border-bottom-color: var(--light-border);
}
        
.sidebar-tab {
    flex: 1;
    padding: 0.875rem 0.5rem;
    background: transparent;
    border: none;
    color: var(--dark-text-secondary);
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    position: relative;
    white-space: nowrap;
}
        
.light-mode .sidebar-tab {
    color: var(--light-text-secondary);
}
        
.sidebar-tab:hover {
    color: var(--dark-text);
    background: var(--dark-surface-light);
}
        
.light-mode .sidebar-tab:hover {
    color: var(--light-text);
    background: var(--light-surface-light);
}
        
.sidebar-tab.active {
    color: var(--primary);
    background: var(--dark-surface-light);
}
        
.light-mode .sidebar-tab.active {
    background: var(--light-surface-light);
}
        
.tab-content {
    flex: 1;
    overflow-y: auto;
    display: none;
}
        
.tab-content.active {
    display: block;
}
        
.history-header {
    padding: 0.875rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--dark-border);
    position: sticky;
    top: 0;
    background: var(--dark-surface);
    z-index: 10;
}
        
.light-mode .history-header {
    background: var(--light-surface);
    border-bottom-color: var(--light-border);
}
        
.history-header h2 {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--dark-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 8px;
}
        
.light-mode .history-header h2 {
    color: var(--light-text-secondary);
}
        
.new-chat-btn {
    background: var(--dark-surface-light);
    color: var(--dark-text);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
}
        
.light-mode .new-chat-btn {
    background: var(--light-surface-light);
    color: var(--light-text);
    border-color: var(--light-border);
}
        
.new-chat-btn:hover {
    background: var(--dark-border);
}
        
.light-mode .new-chat-btn:hover {
    background: var(--light-border);
}
        
.history-list {
    padding: 0.5rem;
}
        
.history-item {
    padding: 0.75rem;
    background: transparent;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    display: flex;
    flex-direction: column;
    gap: 4px;
    color: var(--dark-text);
    margin-bottom: 4px;
    position: relative;
    text-align: left;
    width: 100%;
}
        
.light-mode .history-item {
    color: var(--light-text);
}
        
.history-item:hover {
    background: var(--dark-surface-light);
}
        
.light-mode .history-item:hover {
    background: var(--light-surface-light);
}
        
.history-item.active {
    background: rgba(16, 163, 127, 0.1);
    border: 1px solid rgba(16, 163, 127, 0.3);
}
        
.light-mode .history-item.active {
    background: rgba(16, 163, 127, 0.08);
    border-color: rgba(16, 163, 127, 0.2);
}
        
.history-title {
    font-size: 0.875rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding-right: 60px;
}
        
.history-preview {
    font-size: 0.8rem;
    color: var(--dark-text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding-right: 60px;
}
        
.light-mode .history-preview {
    color: var(--light-text-secondary);
}
        
.history-date {
    font-size: 0.75rem;
    color: var(--dark-text-secondary);
}
        
.light-mode .history-date {
    color: var(--light-text-secondary);
}
        
.history-item-actions {
    display: none;
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    gap: 4px;
    background: var(--dark-surface);
    padding: 4px;
    border-radius: 6px;
    border: 1px solid var(--dark-border);
    z-index: 5;
}
        
.light-mode .history-item-actions {
    background: var(--light-surface);
    border-color: var(--light-border);
}
        
.history-item:hover .history-item-actions {
    display: flex;
}
        
.history-item-btn {
    background: transparent;
    border: none;
    color: var(--dark-text-secondary);
    cursor: pointer;
    padding: 4px 6px;
    border-radius: 4px;
    font-size: 0.8rem;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
}
        
.light-mode .history-item-btn {
    color: var(--light-text-secondary);
}
        
.history-item-btn:hover {
    background: var(--dark-surface-light);
}
        
.light-mode .history-item-btn:hover {
    background: var(--light-surface-light);
}
        
.history-item-btn.delete:hover {
    color: var(--error);
}
        
.history-item-btn.download:hover {
    color: var(--primary);
}
        
.empty-history {
    text-align: center;
    padding: 2.5rem 1rem;
    color: var(--dark-text-secondary);
}
        
.light-mode .empty-history {
    color: var(--light-text-secondary);
}
        
.empty-history i {
    font-size: 1.75rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}
        
.empty-history p {
    font-size: 0.875rem;
}

/* ChatGPT-like Chat Container */
.chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--dark-bg);
    width: 100%;
    height: 100%;
    min-height: 0;
    overflow: hidden;
}
        
.light-mode .chat-container {
    background: var(--light-bg);
}
        
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1.25rem 1rem;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    min-height: 0;
    width: 100%;
}
        
.message {
    display: flex;
    gap: 0.75rem;
    max-width: 100%;
    padding: 0 0.75rem;
    animation: fadeIn 0.2s ease-out;
}
        
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
        
.user-message {
    background: var(--dark-surface);
    border-radius: 8px;
    padding: 1rem;
    max-width: 100%;
}
        
.light-mode .user-message {
    background: var(--light-surface);
}
        
.ai-message {
    background: transparent;
}
        
.avatar {
    width: 32px;
    height: 32px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
    flex-shrink: 0;
    margin-top: 4px;
}
        
.user-message .avatar {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
}
        
.ai-message .avatar {
    background: linear-gradient(135deg, var(--secondary) 0%, #5e35b1 100%);
}
        
.message-content {
    flex: 1;
    position: relative;
    width: 100%;
    min-width: 0;
}
        
.message-text {
    padding: 0;
    border-radius: 0;
    font-size: 0.9375rem;
    line-height: 1.6;
    word-wrap: break-word;
    overflow-wrap: break-word;
    overflow: hidden;
    color: var(--dark-text);
}
        
.light-mode .message-text {
    color: var(--light-text);
}
        
/* FIXED: User message text visibility in light mode */
.user-message .message-text {
    color: var(--dark-text);
}
        
.light-mode .user-message .message-text {
    color: var(--light-text);
}
        
.message-attachments {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
        
.attachment-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    max-width: 200px;
    border: 1px solid var(--dark-border);
}
        
.light-mode .attachment-item {
    border-color: var(--light-border);
}
        
.attachment-image {
    max-width: 100%;
    max-height: 200px;
    object-fit: cover;
    display: block;
}
        
.attachment-name {
    padding: 4px 8px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    font-size: 0.75rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
        
/* ChatGPT-like Message Actions */
.message-actions {
    display: flex;
    gap: 8px;
    margin-top: 0.75rem;
    flex-wrap: wrap;
    opacity: 0;
    transition: opacity 0.2s ease;
}
        
.message:hover .message-actions {
    opacity: 1;
}
        
.action-btn {
    background: var(--dark-surface-light);
    color: var(--dark-text-secondary);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    padding: 0.375rem 0.75rem;
    cursor: pointer;
    font-size: 0.8125rem;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    min-height: 32px;
    font-weight: 500;
    white-space: nowrap;
}
        
.light-mode .action-btn {
    background: var(--light-surface-light);
    color: var(--light-text-secondary);
    border-color: var(--light-border);
}
        
.action-btn:hover {
    background: var(--dark-border);
    color: var(--dark-text);
}
        
.light-mode .action-btn:hover {
    background: var(--light-border);
    color: var(--light-text);
}
        
.action-btn.copy:hover {
    background: var(--success);
    border-color: var(--success);
    color: white;
}
        
.action-btn.like:hover {
    background: var(--success);
    border-color: var(--success);
    color: white;
}
        
.action-btn.dislike:hover {
    background: var(--error);
    border-color: var(--error);
    color: white;
}
        
.action-btn.download:hover {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
}
        
.document-download-btn {
    position: absolute;
    top: -12px;
    right: 8px;
    background: var(--dark-surface);
    border: 1px solid var(--primary);
    border-radius: 20px;
    padding: 6px 12px;
    color: var(--primary);
    cursor: pointer;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: all 0.2s;
    z-index: 5;
    opacity: 0;
    transform: translateY(5px);
    font-weight: 500;
}
        
.light-mode .document-download-btn {
    background: var(--light-surface);
    border-color: var(--primary);
    color: var(--primary);
}
        
.ai-message .message-content:hover .document-download-btn {
    opacity: 1;
    transform: translateY(0);
}
        
.document-download-btn:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
}
        
.document-template {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 8px;
    padding: 1.25rem;
    margin: 0.75rem 0;
    overflow: hidden;
}
        
.light-mode .document-template {
    background: var(--light-surface);
    border-color: var(--light-border);
}
        
.document-header {
    text-align: center;
    border-bottom: 2px solid var(--primary);
    padding-bottom: 1rem;
    margin-bottom: 1.25rem;
}
        
.document-title {
    font-size: 1.375rem;
    color: var(--primary);
    margin-bottom: 0.5rem;
    word-wrap: break-word;
    font-weight: 600;
}
        
.document-subtitle {
    color: var(--dark-text-secondary);
    font-size: 0.875rem;
}
        
.light-mode .document-subtitle {
    color: var(--light-text-secondary);
}
        
.document-section {
    margin-bottom: 1.25rem;
}
        
.document-section-title {
    color: var(--primary);
    font-size: 1rem;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--dark-border);
    word-wrap: break-word;
    font-weight: 600;
}
        
.light-mode .document-section-title {
    border-bottom-color: var(--light-border);
}
        
.document-clause {
    margin-bottom: 0.875rem;
    padding-left: 1rem;
    border-left: 3px solid var(--primary-light);
}
        
.clause-title {
    font-weight: 600;
    color: var(--dark-text);
    margin-bottom: 0.5rem;
    word-wrap: break-word;
}
        
.light-mode .clause-title {
    color: var(--light-text);
}
        
.clause-content {
    color: var(--dark-text-secondary);
    line-height: 1.6;
    word-wrap: break-word;
}
        
.light-mode .clause-content {
    color: var(--light-text-secondary);
}
        
.signature-section {
    margin-top: 1.75rem;
    padding-top: 1.25rem;
    border-top: 1px solid var(--dark-border);
}
        
.light-mode .signature-section {
    border-top-color: var(--light-border);
}
        
.signature-line {
    display: flex;
    justify-content: space-between;
    margin-top: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}
        
.signature-block {
    flex: 1;
    padding: 0.875rem;
    min-width: 150px;
}
        
.signature-name {
    border-bottom: 1px solid var(--dark-border);
    padding-bottom: 0.5rem;
    margin-bottom: 0.5rem;
    min-height: 30px;
}
        
.light-mode .signature-name {
    border-bottom-color: var(--light-border);
}
        
.signature-label {
    font-size: 0.8125rem;
    color: var(--dark-text-secondary);
}
        
.light-mode .signature-label {
    color: var(--light-text-secondary);
}
        
.welcome-message {
    text-align: center;
    max-width: 600px;
    margin: 1.5rem auto;
    padding: 1.25rem;
    background: linear-gradient(135deg, rgba(16, 163, 127, 0.1) 0%, rgba(30, 64, 175, 0.1) 100%);
    border: 1px solid var(--dark-border);
    border-radius: 12px;
    width: 90%;
}
        
.light-mode .welcome-message {
    background: linear-gradient(135deg, rgba(16, 163, 127, 0.08) 0%, rgba(30, 64, 175, 0.08) 100%);
    border-color: var(--light-border);
}
        
.welcome-message h2 {
    font-size: 1.5rem;
    margin-bottom: 0.75rem;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    word-wrap: break-word;
    font-weight: 600;
}
        
.welcome-message p {
    color: var(--dark-text-secondary);
    font-size: 0.9375rem;
    margin-bottom: 1rem;
    line-height: 1.5;
    word-wrap: break-word;
}
        
.light-mode .welcome-message p {
    color: var(--light-text-secondary);
}
        
.welcome-features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 0.875rem;
    margin-top: 1.25rem;
}
        
.feature {
    background: var(--dark-surface);
    padding: 0.875rem;
    border-radius: 8px;
    border: 1px solid var(--dark-border);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    word-wrap: break-word;
}
        
.light-mode .feature {
    background: var(--light-surface);
    border-color: var(--light-border);
}
        
.feature i {
    font-size: 1.375rem;
    color: var(--primary);
    margin-bottom: 0.5rem;
}
        
.feature h4 {
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
    color: var(--dark-text);
    font-weight: 600;
}
        
.light-mode .feature h4 {
    color: var(--light-text);
}
        
.feature p {
    font-size: 0.8125rem;
    color: var(--dark-text-secondary);
}
        
.light-mode .feature p {
    color: var(--light-text-secondary);
}

/* ChatGPT-like Input Area */
.input-container {
    padding: 0.875rem;
    background: var(--dark-bg);
    border-top: 1px solid var(--dark-border);
    position: sticky;
    bottom: 0;
    z-index: 10;
    transition: all 0.2s ease;
    width: 100%;
    flex-shrink: 0;
}
        
.light-mode .input-container {
    background: var(--light-bg);
    border-top-color: var(--light-border);
}
        
.input-area {
    max-width: 800px;
    margin: 0 auto;
    position: relative;
    width: 100%;
}
        
.attachments-preview {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 8px;
    padding: 6px;
    background: var(--dark-surface-light);
    border-radius: 8px;
    border: 1px solid var(--dark-border);
    max-height: 100px;
    overflow-y: auto;
}
        
.light-mode .attachments-preview {
    background: var(--light-surface-light);
    border-color: var(--light-border);
}
        
.attachment-preview-item {
    position: relative;
    width: 70px;
    height: 70px;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid var(--dark-border);
}
        
.light-mode .attachment-preview-item {
    border-color: var(--light-border);
}
        
.attachment-preview-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
        
.remove-attachment {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 20px;
    height: 20px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
}
        
.attachment-preview-name {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 2px 4px;
    font-size: 0.625rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
        
.input-area textarea {
    width: 100%;
    padding: 0.875rem 6.5rem 0.875rem 1rem;
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 12px;
    color: var(--dark-text);
    font-size: 0.9375rem;
    resize: none;
    min-height: 52px;
    max-height: 150px;
    transition: all 0.2s;
    line-height: 1.5;
    font-family: inherit;
    outline: none;
}
        
.light-mode .input-area textarea {
    background: var(--light-surface);
    border-color: var(--light-border);
    color: var(--light-text);
}
        
.input-area textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.1);
}
        
.input-buttons {
    position: absolute;
    right: 0.75rem;
    bottom: 0.75rem;
    display: flex;
    gap: 6px;
    align-items: center;
}
        
.attachment-btn {
    background: transparent;
    border: none;
    color: var(--dark-text-secondary);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
}
        
.light-mode .attachment-btn {
    color: var(--light-text-secondary);
}
        
.attachment-btn:hover {
    background: var(--dark-surface-light);
    color: var(--dark-text);
}
        
.light-mode .attachment-btn:hover {
    background: var(--light-surface-light);
    color: var(--light-text);
}
        
.input-microphone-btn {
    background: transparent;
    border: none;
    color: var(--dark-text-secondary);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
}
        
.light-mode .input-microphone-btn {
    color: var(--light-text-secondary);
}
        
.input-microphone-btn:hover {
    background: var(--dark-surface-light);
    color: var(--dark-text);
}
        
.light-mode .input-microphone-btn:hover {
    background: var(--light-surface-light);
    color: var(--light-text);
}
        
.input-microphone-btn.listening {
    color: var(--error);
    animation: pulse 1.5s infinite;
}
        
.input-microphone-btn.listening:hover {
    background: rgba(239, 68, 68, 0.1);
}
        
.send-button {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.5rem 0.875rem;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    min-height: 40px;
    font-size: 0.875rem;
}
        
.send-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
}
        
.send-button:disabled {
    background: var(--dark-border);
    cursor: not-allowed;
    opacity: 0.5;
}
        
.light-mode .send-button:disabled {
    background: var(--light-border);
}
        
.typing-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0.875rem 1rem;
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 12px;
    max-width: fit-content;
    margin-left: 2.5rem;
    margin-top: 0.5rem;
}
        
.light-mode .typing-indicator {
    background: var(--light-surface);
    border-color: var(--light-border);
}
        
.typing-dot {
    width: 8px;
    height: 8px;
    background-color: var(--primary);
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
}
        
.typing-dot:nth-child(1) {
    animation-delay: -0.32s;
}
        
.typing-dot:nth-child(2) {
    animation-delay: -0.16s;
}
        
@keyframes typing {
    0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}
        
.sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 45;
}
        
.light-mode .sidebar-overlay {
    background: rgba(0, 0, 0, 0.3);
}
        
.sidebar-overlay.active {
    display: block;
}
        
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 16px;
}
        
.light-mode .modal-overlay {
    background: rgba(0, 0, 0, 0.5);
}
        
.modal-overlay.active {
    display: flex;
}
        
.modal {
    background: var(--dark-surface);
    border-radius: 12px;
    border: 1px solid var(--dark-border);
    width: 100%;
    max-width: 480px;
    max-height: 90vh;
    overflow: hidden;
    animation: modalSlideIn 0.2s ease-out;
}
        
.light-mode .modal {
    background: var(--light-surface);
    border-color: var(--light-border);
}
        
@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
        
.modal-header {
    padding: 1.25rem;
    border-bottom: 1px solid var(--dark-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
        
.light-mode .modal-header {
    border-bottom-color: var(--light-border);
}
        
.modal-header h2 {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--dark-text);
}
        
.light-mode .modal-header h2 {
    color: var(--light-text);
}
        
.modal-close {
    background: transparent;
    border: none;
    color: var(--dark-text-secondary);
    cursor: pointer;
    font-size: 1.125rem;
    padding: 4px;
    border-radius: 6px;
    transition: all 0.2s;
}
        
.light-mode .modal-close {
    color: var(--light-text-secondary);
}
        
.modal-close:hover {
    background: var(--dark-surface-light);
    color: var(--dark-text);
}
        
.light-mode .modal-close:hover {
    background: var(--light-surface-light);
    color: var(--light-text);
}
        
.modal-content {
    padding: 1.25rem;
}
        
.download-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.875rem;
    margin: 1.25rem 0;
}
        
.download-option {
    background: var(--dark-surface-light);
    border: 1px solid var(--dark-border);
    border-radius: 8px;
    padding: 1.25rem 0.875rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}
        
.light-mode .download-option {
    background: var(--light-surface-light);
    border-color: var(--light-border);
}
        
.download-option:hover {
    background: var(--dark-border);
    border-color: var(--primary);
    transform: translateY(-2px);
}
        
.light-mode .download-option:hover {
    background: var(--light-border);
}
        
.download-option i {
    font-size: 1.75rem;
    color: var(--primary);
}
        
.download-option h3 {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--dark-text);
}
        
.light-mode .download-option h3 {
    color: var(--light-text);
}
        
.download-option p {
    font-size: 0.8125rem;
    color: var(--dark-text-secondary);
}
        
.light-mode .download-option p {
    color: var(--light-text-secondary);
}
        
.modal-footer {
    padding: 1.25rem;
    border-top: 1px solid var(--dark-border);
    text-align: center;
}
        
.light-mode .modal-footer {
    border-top-color: var(--light-border);
}
        
.modal-footer p {
    font-size: 0.8125rem;
    color: var(--dark-text-secondary);
}
        
.light-mode .modal-footer p {
    color: var(--light-text-secondary);
}
        
.progress-indicator {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 0.875rem;
    padding: 1.5rem;
}
        
.progress-indicator.active {
    display: flex;
}
        
.progress-spinner {
    width: 36px;
    height: 36px;
    border: 3px solid var(--dark-border);
    border-top: 3px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
        
.light-mode .progress-spinner {
    border-color: var(--light-border);
}
        
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
        
.confirmation-modal {
    max-width: 360px;
}
        
.confirmation-text {
    text-align: center;
    margin-bottom: 1.25rem;
}
        
.confirmation-text i {
    font-size: 2.5rem;
    color: var(--error);
    margin-bottom: 0.875rem;
}
        
.confirmation-buttons {
    display: flex;
    gap: 0.875rem;
    margin-top: 1.5rem;
}
        
.confirmation-btn {
    flex: 1;
    padding: 0.75rem;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
    font-size: 0.875rem;
}
        
.confirmation-btn.cancel {
    background: var(--dark-surface-light);
    color: var(--dark-text);
    border: 1px solid var(--dark-border);
}
        
.light-mode .confirmation-btn.cancel {
    background: var(--light-surface-light);
    color: var(--light-text);
    border-color: var(--light-border);
}
        
.confirmation-btn.cancel:hover {
    background: var(--dark-border);
}
        
.light-mode .confirmation-btn.cancel:hover {
    background: var(--light-border);
}
        
.confirmation-btn.delete {
    background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
    color: white;
}
        
.confirmation-btn.delete:hover {
    opacity: 0.9;
    transform: translateY(-2px);
}
        
/* Scroll to Bottom Button */
.scroll-to-bottom-btn {
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: 40px;
    height: 40px;
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 50%;
    color: var(--dark-text);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    z-index: 900;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    opacity: 0;
    transform: translateY(20px);
}
        
.light-mode .scroll-to-bottom-btn {
    background: var(--light-surface);
    border-color: var(--light-border);
    color: var(--light-text);
}
        
.scroll-to-bottom-btn.visible {
    opacity: 1;
    transform: translateY(0);
}
        
.scroll-to-bottom-btn:hover {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(16, 163, 127, 0.3);
}
        
.user-message-controls {
    position: relative;
    margin-top: 8px;
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    opacity: 1 !important;
    z-index: 5;
}
        
.user-message-btn {
    background: var(--dark-surface-light);
    color: var(--dark-text);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    cursor: pointer;
    padding: 6px 10px;
    font-size: 0.75rem;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
    min-width: 32px;
    min-height: 32px;
    justify-content: center;
    font-weight: 500;
}
        
.light-mode .user-message-btn {
    background: var(--light-surface-light);
    color: var(--light-text);
    border-color: var(--light-border);
}
        
.user-message-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}
        
.user-message-btn.copy-btn {
    background: rgba(16, 163, 127, 0.1);
    border-color: rgba(16, 163, 127, 0.3);
    color: var(--primary);
}
        
.user-message-btn.copy-btn:hover {
    background: rgba(16, 163, 127, 0.3);
    border-color: rgba(16, 163, 127, 0.5);
}
        
.user-message-btn.edit-btn {
    background: rgba(59, 130, 246, 0.1);
    border-color: rgba(59, 130, 246, 0.3);
    color: #3b82f6;
}
        
.user-message-btn.edit-btn:hover {
    background: rgba(59, 130, 246, 0.3);
    border-color: rgba(59, 130, 246, 0.5);
}
        
.user-message:hover .user-message-controls {
    opacity: 1;
}
        
.stream-controls {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    padding: 0 8px;
}
        
.stream-control-btn {
    background: var(--dark-surface-light);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    padding: 6px 10px;
    color: var(--dark-text-secondary);
    cursor: pointer;
    font-size: 0.75rem;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: 500;
}
        
.light-mode .stream-control-btn {
    background: var(--light-surface-light);
    border-color: var(--light-border);
    color: var(--light-text-secondary);
}
        
.stream-control-btn:hover {
    background: var(--dark-border);
    color: var(--dark-text);
}
        
.light-mode .stream-control-btn:hover {
    background: var(--light-border);
    color: var(--light-text);
}
        
.stream-control-btn.pause-btn:hover {
    background: var(--warning);
    border-color: var(--warning);
    color: white;
}
        
.stream-control-btn.copy-btn:hover {
    background: var(--success);
    border-color: var(--success);
    color: white;
}
        
.image-upload-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 16px;
}
        
.image-upload-modal.active {
    display: flex;
}
        
.image-upload-content {
    background: var(--dark-surface);
    border-radius: 12px;
    border: 1px solid var(--dark-border);
    width: 100%;
    max-width: 480px;
    max-height: 90vh;
    overflow: hidden;
    animation: modalSlideIn 0.2s ease-out;
}
        
.light-mode .image-upload-content {
    background: var(--light-surface);
    border-color: var(--light-border);
}
        
.upload-area {
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    border: 2px dashed var(--dark-border);
    border-radius: 8px;
    margin: 1.25rem;
    transition: all 0.2s;
}
        
.light-mode .upload-area {
    border-color: var(--light-border);
}
        
.upload-area:hover {
    border-color: var(--primary);
    background: rgba(16, 163, 127, 0.05);
}
        
.light-mode .upload-area:hover {
    background: rgba(16, 163, 127, 0.02);
}
        
.upload-area.dragover {
    border-color: var(--primary);
    background: rgba(16, 163, 127, 0.1);
}
        
.upload-icon {
    font-size: 2.5rem;
    color: var(--primary);
    margin-bottom: 0.875rem;
}
        
.upload-text h3 {
    font-size: 1.125rem;
    margin-bottom: 0.5rem;
    color: var(--dark-text);
    font-weight: 600;
}
        
.light-mode .upload-text h3 {
    color: var(--light-text);
}
        
.upload-text p {
    color: var(--dark-text-secondary);
    font-size: 0.875rem;
    margin-bottom: 0.875rem;
}
        
.light-mode .upload-text p {
    color: var(--light-text-secondary);
}
        
.upload-btn {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    font-size: 0.9375rem;
    font-weight: 500;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}
        
.upload-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
}
        
.uploaded-images {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 8px;
    margin: 1.25rem;
    max-height: 250px;
    overflow-y: auto;
}
        
.uploaded-image-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--dark-border);
}
        
.light-mode .uploaded-image-item {
    border-color: var(--light-border);
}
        
.uploaded-image-preview {
    width: 100%;
    height: 100px;
    object-fit: cover;
    display: block;
}
        
.remove-uploaded-image {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 24px;
    height: 24px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
}
        
.share-btn {
    position: absolute;
    top: 4px;
    left: 4px;
    background: rgba(16, 163, 127, 0.9);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    gap: 4px;
    z-index: 2;
    font-weight: 500;
}
        
.share-btn:hover {
    background: rgba(16, 163, 127, 1);
}
        
.streaming-content {
    min-height: 20px;
}
        
.streaming-cursor {
    display: inline-block;
    width: 8px;
    height: 20px;
    background-color: var(--primary);
    margin-left: 4px;
    vertical-align: middle;
    animation: cursorBlink 1s infinite;
}
        
@keyframes cursorBlink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}
        
.streaming-loader {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 8px;
}
        
.streaming-loader .dot {
    width: 8px;
    height: 8px;
    background-color: var(--primary);
    border-radius: 50%;
    animation: streamingDots 1.4s infinite ease-in-out both;
}
        
.streaming-loader .dot:nth-child(1) {
    animation-delay: -0.32s;
}
        
.streaming-loader .dot:nth-child(2) {
    animation-delay: -0.16s;
}
        
@keyframes streamingDots {
    0%, 80%, 100% { 
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% { 
        transform: scale(1);
        opacity: 1;
    }
}
        
.request-attachments {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
}
        
.message-text p {
    margin-bottom: 0.5rem;
}
        
.message-text p:last-child {
    margin-bottom: 0;
}
        
.message-text ul, .message-text ol {
    margin-left: 1.5rem;
    margin-bottom: 0.5rem;
}
        
.message-text li {
    margin-bottom: 0.25rem;
}
        
.paused-indicator {
    display: inline-block;
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    margin-left: 8px;
    border: 1px solid rgba(245, 158, 11, 0.3);
    font-weight: 500;
}
        
.file-content-display {
    background: var(--dark-surface-light);
    border: 1px solid var(--dark-border);
    border-radius: 8px;
    padding: 0.875rem;
    margin: 8px 0;
    max-height: 250px;
    overflow-y: auto;
    font-size: 0.8125rem;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
    position: relative;
}
    
.light-mode .file-content-display {
    background: var(--light-surface-light);
    border-color: var(--light-border);
}
    
.file-content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--dark-border);
}
    
.light-mode .file-content-header {
    border-bottom-color: var(--light-border);
}
    
.file-content-title {
    font-weight: 600;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.875rem;
}
    
.file-content-close {
    background: transparent;
    border: none;
    color: var(--dark-text-secondary);
    cursor: pointer;
    font-size: 0.9375rem;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s;
}
    
.file-content-close:hover {
    background: var(--dark-border);
    color: var(--dark-text);
}
    
.light-mode .file-content-close:hover {
    background: var(--light-border);
    color: var(--light-text);
}
    
.sources-container {
    background: linear-gradient(135deg, rgba(16, 163, 127, 0.08) 0%, rgba(126, 87, 194, 0.08) 100%);
    border: 1px solid var(--dark-border);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    margin-bottom: 0.875rem;
    border-left: 4px solid var(--primary);
}
    
.light-mode .sources-container {
    background: linear-gradient(135deg, rgba(16, 163, 127, 0.05) 0%, rgba(126, 87, 194, 0.05) 100%);
    border-color: var(--light-border);
}
    
.sources-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    color: var(--primary);
    font-weight: 600;
    font-size: 0.875rem;
}
    
.sources-header i {
    color: var(--primary);
    font-size: 0.9375rem;
}
    
.sources-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 10px;
}
    
.source-tag {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 0.75rem;
    color: var(--dark-text);
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-weight: 500;
}
    
.light-mode .source-tag {
    background: var(--light-surface);
    border-color: var(--light-border);
    color: var(--light-text);
}
    
.source-tag:hover {
    background: var(--dark-surface-light);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}
    
.light-mode .source-tag:hover {
    background: var(--light-surface-light);
}
    
.source-tag i {
    color: var(--primary);
    font-size: 0.75rem;
    flex-shrink: 0;
}
    
.sources-info {
    font-size: 0.75rem;
    color: var(--dark-text-secondary);
    margin-top: 10px;
    font-style: italic;
    display: flex;
    align-items: center;
    gap: 6px;
    padding-top: 8px;
    border-top: 1px dashed var(--dark-border);
}
    
.light-mode .sources-info {
    color: var(--light-text-secondary);
    border-top-color: var(--light-border);
}
    
.sources-info i {
    color: var(--primary);
    font-size: 0.75rem;
}

.download-notification {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: var(--dark-surface);
    color: var(--dark-text);
    padding: 12px 16px;
    border-radius: 8px;
    border: 1px solid var(--dark-border);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    gap: 8px;
    z-index: 1001;
    transform: translateX(-100%);
    transition: transform 0.2s ease;
    max-width: 300px;
}

.download-notification.show {
    transform: translateX(0);
}

.light-mode .download-notification {
    background: var(--light-surface);
    color: var(--light-text);
    border-color: var(--light-border);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.download-notification i {
    color: var(--primary);
    font-size: 1.125rem;
}

.download-notification-content {
    flex: 1;
}

.download-notification-title {
    font-weight: 600;
    margin-bottom: 2px;
    font-size: 0.875rem;
}

.download-notification-message {
    font-size: 0.8125rem;
    color: var(--dark-text-secondary);
}

.light-mode .download-notification-message {
    color: var(--light-text-secondary);
}

.download-notification-close {
    background: transparent;
    border: none;
    color: var(--dark-text-secondary);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
}

.download-notification-close:hover {
    background: var(--dark-border);
    color: var(--dark-text);
}

.light-mode .download-notification-close:hover {
    background: var(--light-border);
    color: var(--light-text);
}

.send-button:disabled {
    background: var(--dark-border) !important;
    cursor: not-allowed !important;
    opacity: 0.5 !important;
}

.stop-button {
    background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%) !important;
    color: white !important;
}

.stop-button:hover {
    background: linear-gradient(135deg, var(--error) 0%, #b91c1c 100%) !important;
}

/* Login Modal */
.login-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    padding: 16px;
    backdrop-filter: blur(5px);
}
        
.login-modal-overlay.active {
    display: flex;
}
        
.login-modal {
    background: var(--dark-surface);
    border-radius: 12px;
    border: 1px solid var(--dark-border);
    width: 100%;
    max-width: 420px;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalSlideIn 0.2s ease-out;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}
        
.light-mode .login-modal {
    background: var(--light-surface);
    border-color: var(--light-border);
}
        
.login-header {
    padding: 1.75rem;
    text-align: center;
    border-bottom: 1px solid var(--dark-border);
}
        
.light-mode .login-header {
    border-bottom-color: var(--light-border);
}
        
.login-icon {
    font-size: 2.5rem;
    margin-bottom: 0.875rem;
    color: var(--primary);
}
        
.login-header h2 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    color: var(--dark-text);
    font-weight: 600;
}
        
.light-mode .login-header h2 {
    color: var(--light-text);
}
        
.login-header p {
    color: var(--dark-text-secondary);
    font-size: 0.875rem;
}
        
.light-mode .login-header p {
    color: var(--light-text-secondary);
}
        
.login-content {
    padding: 1.75rem;
    overflow-y: visible;
}
        
.login-features {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.875rem;
    margin-bottom: 1.5rem;
}
        
.login-feature {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 0.75rem;
    background: var(--dark-surface-light);
    border-radius: 8px;
    border: 1px solid var(--dark-border);
}
        
.light-mode .login-feature {
    background: var(--light-surface-light);
    border-color: var(--light-border);
}
        
.login-feature i {
    color: var(--primary);
    font-size: 1.125rem;
    width: 24px;
    text-align: center;
}
        
.login-feature h4 {
    font-size: 0.875rem;
    margin-bottom: 2px;
    color: var(--dark-text);
    font-weight: 600;
}
        
.light-mode .login-feature h4 {
    color: var(--light-text);
}
        
.login-feature p {
    font-size: 0.8125rem;
    color: var(--dark-text-secondary);
}
        
.light-mode .login-feature p {
    color: var(--light-text-secondary);
}
        
.google-login-btn {
    width: 100%;
    padding: 0.875rem;
    background: var(--dark-surface-light);
    color: var(--dark-text);
    border: 1px solid var(--dark-border);
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9375rem;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 1.25rem;
}
        
.light-mode .google-login-btn {
    background: var(--light-surface-light);
    color: var(--light-text);
    border-color: var(--light-border);
}
        
.google-login-btn:hover {
    background: var(--dark-border);
}
        
.light-mode .google-login-btn:hover {
    background: var(--light-border);
}
        
.login-footer {
    padding: 1.25rem 1.75rem;
    border-top: 1px solid var(--dark-border);
    text-align: center;
    font-size: 0.8125rem;
    color: var(--dark-text-secondary);
}
        
.light-mode .login-footer {
    border-top-color: var(--light-border);
}
        
.login-footer a {
    color: var(--primary);
    text-decoration: none;
    font-weight: 500;
}
        
.login-footer a:hover {
    text-decoration: underline;
}

/* User Profile */
.user-profile {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 6px;
    transition: all 0.2s;
    border: 1px solid transparent;
    flex-shrink: 0;
}
        
.user-profile:hover {
    background: var(--dark-surface-light);
    border-color: var(--dark-border);
}
        
.light-mode .user-profile:hover {
    background: var(--light-surface-light);
    border-color: var(--light-border);
}
        
.user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    overflow: hidden;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 500;
    font-size: 0.875rem;
    flex-shrink: 0;
}
        
.user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
        
.user-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
}
        
.user-name {
    font-size: 0.875rem;
    font-weight: 500;
    white-space: nowrap;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
}
        
.user-email {
    font-size: 0.75rem;
    color: var(--dark-text-secondary);
    white-space: nowrap;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
}
        
.light-mode .user-email {
    color: var(--light-text-secondary);
}
        
.user-dropdown {
    position: absolute;
    top: 65px;
    right: 12px;
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 8px;
    min-width: 220px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    display: none;
    overflow: hidden;
    animation: fadeIn 0.2s ease;
}
        
.light-mode .user-dropdown {
    background: var(--light-surface);
    border-color: var(--light-border);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
}
        
.user-dropdown.active {
    display: block;
}
        
.dropdown-header {
    padding: 1rem;
    border-bottom: 1px solid var(--dark-border);
    display: flex;
    align-items: center;
    gap: 10px;
}
        
.light-mode .dropdown-header {
    border-bottom-color: var(--light-border);
}
        
.dropdown-header .user-avatar {
    width: 40px;
    height: 40px;
}
        
.dropdown-header .user-info {
    flex: 1;
}
        
.dropdown-header .user-name {
    font-size: 0.9375rem;
}
        
.dropdown-items {
    padding: 0.5rem;
}
        
.dropdown-item {
    padding: 0.75rem;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--dark-text);
    text-decoration: none;
    border-radius: 6px;
    transition: all 0.2s;
    cursor: pointer;
    border: none;
    background: transparent;
    width: 100%;
    text-align: left;
    font-size: 0.875rem;
    font-weight: 500;
}
        
.light-mode .dropdown-item {
    color: var(--light-text);
}
        
.dropdown-item:hover {
    background: var(--dark-surface-light);
}
        
.light-mode .dropdown-item:hover {
    background: var(--light-surface-light);
}
        
.dropdown-item i {
    width: 20px;
    text-align: center;
    color: var(--dark-text-secondary);
    font-size: 0.9375rem;
}
        
.light-mode .dropdown-item i {
    color: var(--light-text-secondary);
}
        
.dropdown-item.logout {
    color: var(--error);
}
        
.dropdown-item.logout:hover {
    background: rgba(239, 68, 68, 0.1);
}
        
.dropdown-footer {
    padding: 0.75rem;
    border-top: 1px solid var(--dark-border);
    font-size: 0.75rem;
    color: var(--dark-text-secondary);
    text-align: center;
}
        
.light-mode .dropdown-footer {
    border-top-color: var(--light-border);
    color: var(--light-text-secondary);
}
        
.login-btn {
    background: var(--dark-surface-light);
    color: var(--dark-text);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    padding: 0.5rem 0.875rem;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    min-height: 36px;
    flex-shrink: 0;
    white-space: nowrap;
}
        
.login-btn:hover {
    background: var(--dark-border);
}
        
.login-btn i {
    font-size: 0.875rem;
}
        
.sidebar-toggle {
    background: transparent;
    border: none;
    color: var(--dark-text);
    font-size: 1.375rem;
    cursor: pointer;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    border-radius: 6px;
    width: 36px;
    height: 36px;
    flex-shrink: 0;
}
        
.light-mode .sidebar-toggle {
    color: var(--light-text);
}
        
.sidebar-toggle:hover {
    background: var(--dark-surface-light);
}
        
.light-mode .sidebar-toggle:hover {
    background: var(--light-surface-light);
}

/* AI Response Footer */
.ai-response-footer {
    margin-top: 1rem;
    padding-top: 0.75rem;
    border-top: 1px dashed var(--dark-border);
    font-size: 0.8125rem;
    color: var(--dark-text-secondary);
    display: flex;
    align-items: center;
    gap: 8px;
}
        
.light-mode .ai-response-footer {
    border-top-color: var(--light-border);
    color: var(--light-text-secondary);
}
        
.ai-response-footer i {
    color: var(--primary);
    font-size: 0.875rem;
}
        
.ai-response-footer .ai-signature {
    font-weight: 600;
    color: var(--primary);
}

/* Mobile Optimization - FIXED */
@media (max-width: 768px) {
    body, .container {
        height: 100vh;
        overflow: hidden;
    }
    
    header {
        padding: 0.625rem 0.75rem;
        min-height: 56px;
        gap: 4px;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
    }
            
    .logo h1 {
        font-size: 1rem;
    }
            
    .status-indicator {
        padding: 0.375rem;
        font-size: 0.75rem;
    }
            
    .status-indicator span {
        display: none;
    }
            
    .header-actions {
        gap: 4px;
    }
    
    .new-chat-header-btn span,
    .login-btn span {
        display: none;
    }
    
    .new-chat-header-btn i,
    .login-btn i {
        margin: 0;
    }
    
    .theme-toggle {
        width: 32px;
        height: 32px;
    }
    
    .clear-chat-btn {
        width: 32px;
        height: 32px;
        padding: 0.5rem;
    }
    
    .clear-chat-btn span {
        display: none;
    }
    
    .clear-chat-btn i {
        margin: 0;
    }
            
    .main-content {
        position: fixed;
        top: 56px;
        bottom: 0;
        left: 0;
        right: 0;
        overflow: hidden;
    }
            
    .chat-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        overflow: hidden;
    }
            
    .chat-messages {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 70px;
        padding: 0.75rem 0.5rem;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
            
    .message {
        padding: 0 0.5rem;
        gap: 0.625rem;
    }
            
    .avatar {
        width: 28px;
        height: 28px;
        font-size: 0.75rem;
    }
            
    .message-text {
        font-size: 0.875rem;
    }
            
    .document-download-btn {
        opacity: 1;
        transform: translateY(0);
        top: -8px;
        right: 4px;
        padding: 4px 8px;
        font-size: 0.625rem;
    }
            
    .welcome-message {
        padding: 0.875rem;
        margin: 0.875rem auto;
    }
            
    .welcome-message h2 {
        font-size: 1.25rem;
    }
            
    .welcome-features {
        grid-template-columns: 1fr;
    }
            
    .input-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 0.75rem;
        background: var(--dark-bg);
        border-top: 1px solid var(--dark-border);
        z-index: 100;
    }
            
    .input-area textarea {
        padding: 0.75rem 5.5rem 0.75rem 0.875rem;
        font-size: 0.875rem;
        min-height: 48px;
        max-height: 120px;
    }
            
    .input-buttons {
        right: 0.5rem;
        bottom: 0.5rem;
        gap: 4px;
    }
            
    .send-button {
        padding: 0.5rem 0.75rem;
        min-height: 36px;
        font-size: 0.8125rem;
    }
            
    .input-microphone-btn,
    .attachment-btn {
        width: 28px;
        height: 28px;
        padding: 0.375rem;
    }
            
    .sidebar {
        width: 85vw;
        max-width: 280px;
        position: fixed;
        top: 56px;
        bottom: 0;
        z-index: 999;
    }
            
    .download-options {
        grid-template-columns: 1fr;
    }
            
    .history-item-actions {
        display: flex !important;
        opacity: 0.9;
    }
            
    .document-template {
        padding: 0.875rem;
    }
            
    .signature-line {
        flex-direction: column;
        gap: 0.875rem;
    }
            
    .attachment-item {
        max-width: 140px;
    }
            
    .scroll-to-bottom-btn {
        bottom: 80px;
        right: 12px;
        width: 36px;
        height: 36px;
        position: fixed;
    }
            
    .user-message-controls {
        gap: 6px;
        margin-top: 6px;
    }
            
    .user-message-btn {
        padding: 4px 6px;
        font-size: 0.75rem;
        min-width: 28px;
        min-height: 28px;
    }
            
    .action-btn {
        padding: 0.375rem 0.625rem;
        font-size: 0.75rem;
        min-height: 28px;
    }
            
    .sources-container {
        padding: 0.75rem;
        margin-top: 0.75rem;
    }
            
    .sources-list {
        gap: 4px;
    }
            
    .source-tag {
        padding: 4px 8px;
        font-size: 0.75rem;
    }
    
    .sidebar-overlay {
        position: fixed;
        top: 56px;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 998;
    }
    
    .download-notification {
        bottom: 80px;
        left: 10px;
        right: 10px;
        max-width: none;
    }
    
    .ai-response-footer {
        font-size: 0.75rem;
        padding-top: 0.5rem;
        margin-top: 0.75rem;
    }
}
        
@media (min-width: 481px) and (max-width: 768px) {
    .status-indicator {
        padding: 0.375rem;
    }
            
    .status-indicator span {
        display: none;
    }
            
    .welcome-features {
        grid-template-columns: repeat(2, 1fr);
    }
            
    .history-item-actions {
        display: flex !important;
        opacity: 0.9;
    }
            
    .input-area textarea {
        padding: 0.875rem 6rem 0.875rem 1rem;
    }
            
    .sidebar {
        width: 85vw;
        max-width: 300px;
    }
}
        
@media (min-width: 769px) and (max-width: 1024px) {
    .sidebar {
        position: fixed;
        transform: translateX(-100%);
        width: 300px;
    }
            
    .sidebar.active {
        transform: translateX(0);
    }
            
    .chat-container {
        margin-left: 0;
    }
            
    .sidebar-toggle {
        display: flex;
    }
            
    .welcome-features {
        grid-template-columns: repeat(3, 1fr);
    }
            
    .message-content {
        max-width: 80%;
    }
}
        
@media (min-width: 1025px) {
    .sidebar {
        position: relative;
        transform: translateX(0);
        flex-shrink: 0;
    }
            
    .sidebar-toggle {
        display: none;
    }
            
    .sidebar-close {
        display: none;
    }
            
    .sidebar-overlay {
        display: none !important;
    }
            
    .chat-messages {
        padding: 1.25rem 1.5rem;
    }
            
    .input-container {
        padding: 1.25rem;
    }
            
    .welcome-message {
        margin: 2rem auto;
        padding: 1.5rem;
    }
            
    .welcome-message h2 {
        font-size: 1.75rem;
    }
            
    .main-content {
        overflow: hidden;
    }
}
        
/* Scrollbar */
::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}
        
::-webkit-scrollbar-track {
    background: var(--dark-bg);
}
        
.light-mode ::-webkit-scrollbar-track {
    background: var(--light-bg);
}
        
::-webkit-scrollbar-thumb {
    background: var(--dark-border);
    border-radius: 3px;
}
        
.light-mode ::-webkit-scrollbar-thumb {
    background: var(--light-border);
}
        
::-webkit-scrollbar-thumb:hover {
    background: var(--dark-surface-light);
}
        
.light-mode ::-webkit-scrollbar-thumb:hover {
    background: var(--light-surface-light);
}

/* Voice animation */
.voice-animation {
    display: flex;
    align-items: center;
    gap: 3px;
    height: 20px;
}
        
.voice-bar {
    width: 3px;
    background: var(--primary);
    border-radius: 3px;
    animation: voicePulse 0.8s ease-in-out infinite;
}
        
.voice-bar:nth-child(1) {
    height: 8px;
    animation-delay: 0.1s;
}
        
.voice-bar:nth-child(2) {
    height: 12px;
    animation-delay: 0.2s;
}
        
.voice-bar:nth-child(3) {
    height: 16px;
    animation-delay: 0.3s;
}
        
.voice-bar:nth-child(4) {
    height: 12px;
    animation-delay: 0.4s;
}
        
.voice-bar:nth-child(5) {
    height: 8px;
    animation-delay: 0.5s;
}
        
@keyframes voicePulse {
    0%, 100% {
        opacity: 0.4;
        transform: scaleY(0.8);
    }
    50% {
        opacity: 1;
        transform: scaleY(1.2);
    }
}

/* Hide/show on mobile */
.hide-on-mobile {
    display: none;
}
        
.show-on-mobile {
    display: flex;
}
        
@media (min-width: 769px) {
    .hide-on-mobile {
        display: flex;
    }
            
    .show-on-mobile {
        display: none;
    }
}

/* Toast message - hidden as requested */
.toast {
    display: none !important;
}

</style>
</head>
<body>
    <!-- Login Modal -->
    <div class="login-modal-overlay" id="loginModal">
        <div class="login-modal">
            <div class="login-header">
                <div class="login-icon">
                    <i class="fas fa-scale-balanced"></i>
                </div>
                <h2>Welcome to LegalSwami</h2>
                <p>Your AI-powered legal assistant</p>
            </div>
            
            <div class="login-content">
                <div class="login-features">
                    <div class="login-feature">
                        <i class="fas fa-shield-alt"></i>
                        <div>
                            <h4>Secure & Private</h4>
                            <p>Your conversations are encrypted and confidential</p>
                        </div>
                    </div>
                    <div class="login-feature">
                        <i class="fas fa-sync-alt"></i>
                        <div>
                            <h4>Sync Across Devices</h4>
                            <p>Access your chat history anywhere</p>
                        </div>
                    </div>
                    <div class="login-feature">
                        <i class="fas fa-download"></i>
                        <div>
                            <h4>Document Download</h4>
                            <p>Save legal documents for offline use</p>
                        </div>
                    </div>
                </div>
                
                <!-- Guest Login Button -->
                <button class="google-login-btn" id="guestLoginBtn">
                    <i class="fas fa-user"></i>
                    <span>Continue as Guest</span>
                </button>
                
                <div style="text-align: center; margin-top: 1rem; font-size: 0.875rem; color: var(--dark-text-secondary);">
                    <p>Chat history will be saved locally in your browser</p>
                </div>
            </div>
            
            <div class="login-footer">
                <p>By continuing, you agree to our <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a></p>
            </div>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div class="container" id="appContainer" style="display: none;">
        <header>
            <div class="logo">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo-icon">
                    <i class="fas fa-scale-balanced"></i>
                </div>
                <h1>LegalSwami</h1>
            </div>
            
            <div class="header-actions">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span class="hide-on-mobile">AI Ready</span>
                </div>
                
                <!-- NEW: Create New Chat button in header -->
                <button class="header-btn" id="newChatHeaderBtn">
                    <i class="fas fa-plus"></i>
                    <span class="hide-on-mobile">New Chat</span>
                </button>
                
                <!-- Login Button with icon -->
                <button class="login-btn" id="headerLoginBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span class="hide-on-mobile">Login</span>
                </button>
                
                <button class="header-btn theme-toggle" id="themeToggle" title="Toggle Theme">
                    <i class="fas fa-sun"></i>
                </button>
                <button class="header-btn" id="clearChatBtn">
                    <i class="fas fa-broom"></i>
                    <span class="hide-on-mobile">Clear Chat</span>
                </button>
                
                <!-- User Profile -->
                <div class="user-profile" id="userProfile" style="display: none;">
                    <div class="user-avatar" id="userAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Guest User</div>
                        <div class="user-email" id="userEmail">Local Browser Mode</div>
                    </div>
                    <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                </div>
            </div>
        </header>
        
        <!-- User Dropdown Menu -->
        <div class="user-dropdown" id="userDropdown">
            <div class="dropdown-header">
                <div class="user-avatar" id="dropdownAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-info">
                    <div class="user-name" id="dropdownName">Guest User</div>
                    <div class="user-email" id="dropdownEmail">Local Browser Mode</div>
                </div>
            </div>
            
            <div class="dropdown-items">
                <button class="dropdown-item" id="profileBtn">
                    <i class="fas fa-user-circle"></i>
                    <span>My Profile</span>
                </button>
                <button class="dropdown-item" id="settingsBtn">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </button>
                <button class="dropdown-item" id="historyBtn">
                    <i class="fas fa-history"></i>
                    <span>Chat History</span>
                </button>
                <button class="dropdown-item" id="helpBtn">
                    <i class="fas fa-question-circle"></i>
                    <span>Help & Support</span>
                </button>
                <div class="dropdown-footer">
                    <button class="dropdown-item logout" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Clear Local Data</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Down Arrow Button (Scroll to Bottom) -->
            <button class="scroll-to-bottom-btn" id="scrollToBottomBtn" title="Scroll to bottom">
                <i class="fas fa-chevron-down"></i>
            </button>
            
            <div class="sidebar-overlay" id="sidebarOverlay"></div>
            
            <aside class="sidebar" id="sidebar">
                <!-- Sidebar Close Button -->
                <button class="sidebar-close" id="sidebarClose">
                    <i class="fas fa-times"></i>
                </button>
                
                <!-- Chat History Tab Content -->
                <div class="tab-content active" id="chat-history-content">
                    <div class="history-header">
                        <h2><i class="fas fa-history"></i> Chat History</h2>
                        <button class="new-chat-btn" id="newChatBtn">
                            <i class="fas fa-plus"></i>
                            <span class="hide-on-mobile">New Chat</span>
                        </button>
                    </div>
                    
                    <div class="history-list" id="historyList">
                        <!-- History items will be loaded here -->
                        <div class="empty-history">
                            <i class="fas fa-comments"></i>
                            <p>No chat history yet</p>
                            <p style="font-size: 0.8125rem; margin-top: 0.5rem;">Start a conversation to see it here</p>
                        </div>
                    </div>
                </div>
            </aside>
            
            <main class="chat-container" id="chatContainer">
                <div class="chat-messages" id="chatMessages">
                    <!-- Welcome Message will be added dynamically -->
                </div>
                
                <div class="input-container">
                    <div class="input-area">
                        <!-- Attachments Preview -->
                        <div class="attachments-preview" id="attachmentsPreview" style="display: none;"></div>
                        
                        <textarea 
                            id="userInput" 
                            placeholder="Ask any legal question or attach files (images, PDF, TXT)... (Press Enter for new line, Ctrl+Enter to send)"
                            rows="1"
                        ></textarea>
                        
                        <div class="input-buttons">
                            <!-- Attachment Button -->
                            <button class="attachment-btn" id="attachmentBtn" title="Attach files (images, PDF, TXT)">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            
                            <!-- Voice Input Button -->
                            <button class="input-microphone-btn" id="inputMicrophoneBtn" title="Voice input">
                                <i class="fas fa-microphone"></i>
                            </button>
                            
                            <!-- Send/Stop Button -->
                            <button class="send-button" id="sendButton">
                                <i class="fas fa-paper-plane"></i> <span class="hide-on-mobile">Send</span>
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- Download Modal (for full chat) -->
        <div class="modal-overlay" id="downloadModal">
            <div class="modal">
                <div class="modal-header">
                    <h2><i class="fas fa-download"></i> Download Chat</h2>
                    <button class="modal-close" id="closeDownloadModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <p>Select the format you want to download your chat in:</p>
                    
                    <div class="download-options">
                        <div class="download-option" data-format="doc">
                            <i class="fas fa-file-word"></i>
                            <h3>Word Document</h3>
                            <p>.doc format</p>
                        </div>
                        <div class="download-option" data-format="pdf">
                            <i class="fas fa-file-pdf"></i>
                            <h3>PDF Document</h3>
                            <p>.pdf format</p>
                        </div>
                        <div class="download-option" data-format="txt">
                            <i class="fas fa-file-alt"></i>
                            <h3>Text File</h3>
                            <p>.txt format</p>
                        </div>
                    </div>
                    
                    <div class="progress-indicator" id="progressIndicator">
                        <div class="progress-spinner"></div>
                        <p>Preparing your document...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <p>The document will include the complete chat conversation with timestamps.</p>
                </div>
            </div>
        </div>
        
        <!-- Delete Confirmation Modal -->
        <div class="modal-overlay" id="deleteModal">
            <div class="modal confirmation-modal">
                <div class="modal-header">
                    <h2><i class="fas fa-trash"></i> Delete Chat</h2>
                    <button class="modal-close" id="closeDeleteModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <div class="confirmation-text">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Are you sure you want to delete this chat?</h3>
                        <p id="deleteChatTitle">This action cannot be undone and the chat will be permanently deleted.</p>
                    </div>
                    
                    <div class="confirmation-buttons">
                        <button class="confirmation-btn cancel" id="cancelDelete">Cancel</button>
                        <button class="confirmation-btn delete" id="confirmDelete">Delete Permanently</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Individual Message Download Modal -->
        <div class="modal-overlay" id="messageDownloadModal">
            <div class="modal">
                <div class="modal-header">
                    <h2><i class="fas fa-file-download"></i> Download Document</h2>
                    <button class="modal-close" id="closeMessageDownloadModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <p>Select the format for this specific response:</p>
                    
                    <div class="download-options">
                        <div class="download-option" data-format="doc">
                            <i class="fas fa-file-word"></i>
                            <h3>Word Document</h3>
                            <p>.doc format</p>
                        </div>
                        <div class="download-option" data-format="pdf">
                            <i class="fas fa-file-pdf"></i>
                            <h3>PDF Document</h3>
                            <p>.pdf format</p>
                        </div>
                        <div class="download-option" data-format="txt">
                            <i class="fas fa-file-alt"></i>
                            <h3>Text File</h3>
                            <p>.txt format</p>
                        </div>
                    </div>
                    
                    <div class="progress-indicator" id="messageProgressIndicator">
                        <div class="progress-spinner"></div>
                        <p>Preparing your document...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <p>The document will include only this specific AI response.</p>
                </div>
            </div>
        </div>
        
        <!-- File Upload Modal -->
        <div class="modal-overlay image-upload-modal" id="fileUploadModal">
            <div class="image-upload-content">
                <div class="modal-header">
                    <h2><i class="fas fa-paperclip"></i> Attach Files</h2>
                    <button class="modal-close" id="closeFileUploadModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">
                            <h3>Drag & Drop Files Here</h3>
                            <p>or click to browse files</p>
                            <p style="font-size: 0.8125rem; color: var(--dark-text-secondary);">
                                Supported formats: Images (JPG, PNG, GIF), PDF, TXT, DOC
                            </p>
                            <button class="upload-btn" id="browseFilesBtn">
                                <i class="fas fa-folder-open"></i> Browse Files
                            </button>
                        </div>
                    </div>
                    
                    <div class="uploaded-images" id="uploadedFiles">
                        <!-- Uploaded files will appear here -->
                    </div>
                    
                    <div class="confirmation-buttons" style="margin-top: 1.25rem;">
                        <button class="confirmation-btn cancel" id="cancelFileUpload">
                            Cancel
                        </button>
                        <button class="confirmation-btn" id="confirmFileUpload" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white;">
                            <i class="fas fa-paperclip"></i> Attach Selected Files
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Download Notification - Fixed position -->
        <div class="download-notification" id="downloadNotification">
            <i class="fas fa-file-download"></i>
            <div class="download-notification-content">
                <div class="download-notification-title" id="downloadNotificationTitle">Document Downloaded</div>
                <div class="download-notification-message" id="downloadNotificationMessage">Click to open the file</div>
            </div>
            <button class="download-notification-close" id="closeDownloadNotification">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="toast" id="toast">
            <i class="fas fa-check-circle"></i>
            <span id="toast-message">Message sent successfully</span>
        </div>
    </div>

    <script>
    // All API keys and models
    const API_KEYS = [""];
    
    const WORKING_MODELS = [
        "llama-3.3-70b-versatile",
        "llama-3.1-8b-instant",
        "llama3-70b-8192",
        "llama3-8b-8192",
        "mixtral-8x7b-32768"
    ];
    
    let currentModel = "llama-3.3-70b-versatile";
    let currentApiKeyIndex = 0;
    let requestCount = 0;
    const REQUEST_LIMIT_PER_KEY = 5;
    
    let chatHistory = [];
    let currentChatId = null;
    let conversationHistory = [];
    
    let messageContentForDownload = "";
    
    let isListening = false;
    let recognition = null;
    let isInputMicrophoneActive = false;
    
    let isLightMode = false;
    
    let currentStreamingMessageId = null;
    let currentStreamingContent = '';
    let currentStreamingBuffer = '';
    let streamingTextChunks = [];
    let streamingTextIndex = 0;
    let streamingWordDelay = 20;
    let streamingPunctuationDelay = 100;
    
    let attachedFiles = [];
    let selectedFiles = [];
    
    let isStreamingPaused = false;
    let isStreamingActive = false;
    let stopStreamingRequested = false;
    
    let currentUser = null;
    let isLoggedIn = false;
    let userToken = null;
    
    let scrollPosition = 0;
    
    let lastDownloadedFileUrl = null;
    let lastDownloadedFileName = '';
    
    const WELCOME_MESSAGE_HTML = `
        <div class="welcome-message">
            <h2>Welcome to LegalSwami</h2>
            <p>Your AI-powered legal assistant for accurate, comprehensive legal information and guidance.</p>
            <p style="color: var(--primary); margin-top: 10px; font-size: 0.875rem;">
                <i class="fas fa-language"></i> Supports multiple Indian languages including Marathi, Hindi, and more!
            </p>
            
            <div style="margin-top: 1.5rem;">
                <h3 style="color: var(--primary); margin-bottom: 0.875rem; font-size: 1rem;">Ready-to-Use Legal Documents:</h3>
                <div class="draft-templates">
                    <div class="draft-template" data-template="nda">
                        <i class="fas fa-file-signature"></i>
                        <h4>Non-Disclosure Agreement</h4>
                        <p>Confidentiality agreement template</p>
                    </div>
                    <div class="draft-template" data-template="employment">
                        <i class="fas fa-briefcase"></i>
                        <h4>Employment Contract</h4>
                        <p>Employee agreement template</p>
                    </div>
                    <div class="draft-template" data-template="rental">
                        <i class="fas fa-house"></i>
                        <h4>Rental Agreement</h4>
                        <p>Tenancy agreement template</p>
                    </div>
                    <div class="draft-template" data-template="loan">
                        <i class="fas fa-money-bill-wave"></i>
                        <h4>Loan Agreement</h4>
                        <p>Money lending agreement</p>
                    </div>
                </div>
            </div>
            
            <div class="section-divider"></div>
            
            <div class="welcome-features">
                <div class="feature">
                    <i class="fas fa-bolt"></i>
                    <h4>Instant Responses</h4>
                    <p>Get immediate legal insights powered by advanced AI</p>
                </div>
                <div class="feature">
                    <i class="fas fa-shield-alt"></i>
                    <h4>Confidential & Secure</h4>
                    <p>Your conversations are private and encrypted</p>
                </div>
                <div class="feature">
                    <i class="fas fa-language"></i>
                    <h4>Multi-Language</h4>
                    <p>Responds in same language as your query</p>
                </div>
                <div class="feature">
                    <i class="fas fa-microphone"></i>
                    <h4>Voice Search</h4>
                    <p>Speak your queries in natural language</p>
                </div>
                <div class="feature">
                    <i class="fas fa-file-upload"></i>
                    <h4>File Analysis</h4>
                    <p>Upload and analyze documents, images</p>
                </div>
            </div>
        </div>
    `;
    
    // Initialize app for guest users
    function initializeAppForGuest() {
        console.log("Initializing in guest mode...");
        
        // Set guest user
        currentUser = {
            id: 'guest_' + Date.now(),
            name: 'Guest User',
            email: 'Local Browser Mode',
            isGuest: true,
            picture: null
        };
        isLoggedIn = false;
        
        // Show app immediately
        document.getElementById('appContainer').style.display = 'flex';
        document.getElementById('loginModal').classList.remove('active');
        
        // Update UI for guest
        updateUserUI();
        
        // Initialize chat functionality
        initializeChatApp();
        
        // Load user's chat history
        loadUserChatHistory();
        
        // Load chat history list
        loadHistoryList();
    }
    
    // Update User UI
    function updateUserUI() {
        if (isLoggedIn && currentUser) {
            // Show user profile, hide login button
            document.getElementById('headerLoginBtn').style.display = 'none';
            document.getElementById('userProfile').style.display = 'flex';
            
            // Update name and email
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('dropdownName').textContent = currentUser.name;
            document.getElementById('dropdownEmail').textContent = currentUser.email;
            
            // Update avatar
            const avatar = document.getElementById('userAvatar');
            const dropdownAvatar = document.getElementById('dropdownAvatar');
            
            if (currentUser.picture) {
                avatar.innerHTML = `<img src="${currentUser.picture}" alt="${currentUser.name}">`;
                dropdownAvatar.innerHTML = `<img src="${currentUser.picture}" alt="${currentUser.name}">`;
            } else {
                avatar.innerHTML = `<i class="fas fa-user"></i>`;
                dropdownAvatar.innerHTML = `<i class="fas fa-user"></i>`;
            }
            
            // Update logout button text
            document.getElementById('logoutBtn').innerHTML = `
                <i class="fas fa-sign-out-alt"></i>
                <span>${currentUser.isGuest ? 'Clear Local Data' : 'Logout'}</span>
            `;
            
        } else {
            // Show login button, hide profile
            document.getElementById('headerLoginBtn').style.display = 'flex';
            document.getElementById('userProfile').style.display = 'none';
        }
    }
    
    // Toggle User Dropdown
    function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdown');
        dropdown.classList.toggle('active');
    }
    
    // Handle Logout
    function handleLogout() {
        if (currentUser && currentUser.isGuest) {
            // Guest user - clear local data
            if (confirm('Are you sure you want to clear all local data? This will delete all chat history and settings.')) {
                // Clear all local data
                localStorage.clear();
                
                // Reset all variables
                chatHistory = [];
                conversationHistory = [];
                currentChatId = null;
                currentUser = null;
                isLoggedIn = false;
                
                // Show login modal
                document.getElementById('loginModal').classList.add('active');
                document.getElementById('appContainer').style.display = 'none';
                
                // Reset UI
                document.getElementById('userProfile').style.display = 'none';
                document.getElementById('headerLoginBtn').style.display = 'flex';
            }
        } else {
            // Logged in user - logout
            if (confirm('Are you sure you want to logout?')) {
                // Clear local storage
                localStorage.removeItem('legalSwamiUser');
                localStorage.removeItem('legalSwamiToken');
                
                // Reset variables
                currentUser = null;
                userToken = null;
                isLoggedIn = false;
                
                // Show login modal
                document.getElementById('loginModal').classList.add('active');
                document.getElementById('appContainer').style.display = 'none';
                
                // Reset UI
                document.getElementById('userProfile').style.display = 'none';
                document.getElementById('headerLoginBtn').style.display = 'flex';
            }
        }
    }
    
    // Load User's Chat History
    function loadUserChatHistory() {
        const userId = currentUser ? currentUser.id : 'guest';
        const storageKey = `legalSwamiChatHistory_${userId}`;
        
        try {
            const savedHistory = localStorage.getItem(storageKey);
            if (savedHistory) {
                chatHistory = JSON.parse(savedHistory);
            }
            
            const savedChatId = localStorage.getItem(`legalSwamiCurrentChatId_${userId}`);
            if (savedChatId) {
                currentChatId = savedChatId;
                // Load the current chat's messages
                const currentChat = chatHistory.find(chat => chat.id === currentChatId);
                if (currentChat) {
                    conversationHistory = [...currentChat.messages];
                }
            }
        } catch (error) {
            console.error('Error loading chat history:', error);
            chatHistory = [];
        }
    }
    
    // Save User's Chat History
    function saveUserChatHistory() {
        const userId = currentUser ? currentUser.id : 'guest';
        const storageKey = `legalSwamiChatHistory_${userId}`;
        
        try {
            localStorage.setItem(storageKey, JSON.stringify(chatHistory));
            localStorage.setItem(`legalSwamiCurrentChatId_${userId}`, currentChatId);
        } catch (error) {
            console.error('Error saving chat history:', error);
        }
    }
    
    // Initialize Chat App
    function initializeChatApp() {
        console.log("Initializing chat app...");
        
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarClose = document.getElementById('sidebarClose');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const themeToggle = document.getElementById('themeToggle');
        const newChatBtn = document.getElementById('newChatBtn');
        const newChatHeaderBtn = document.getElementById('newChatHeaderBtn');
        const attachmentBtn = document.getElementById('attachmentBtn');
        const guestLoginBtn = document.getElementById('guestLoginBtn');
        const headerLoginBtn = document.getElementById('headerLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userProfile = document.getElementById('userProfile');
        const inputMicrophoneBtn = document.getElementById('inputMicrophoneBtn');
        
        // Set initial state based on screen size
        const isDesktop = window.innerWidth >= 1025;
        if (isDesktop) {
            sidebar.classList.add('active');
        }
        
        // Load theme preference
        loadThemePreference();
        
        // Create new chat if no current chat
        if (!currentChatId || conversationHistory.length === 0) {
            createNewChat();
        } else {
            // Load existing chat messages
            loadCurrentChatMessages();
        }
        
        // Event listeners for chat functionality
        sendButton.addEventListener('click', function() {
            if (isStreamingActive) {
                stopStreaming();
            } else {
                sendMessage();
            }
        });
        
        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                if (isStreamingActive) {
                    stopStreaming();
                } else {
                    sendMessage();
                }
            }
            // Enter without Ctrl - just add new line
            if (e.key === 'Enter' && !e.ctrlKey) {
                // Allow default behavior (new line)
                setTimeout(() => {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 150) + 'px';
                }, 10);
            }
        });
        
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            
            // Update send button state
            if (isStreamingActive) {
                sendButton.disabled = false;
                sendButton.classList.add('stop-button');
                sendButton.innerHTML = '<i class="fas fa-stop"></i> <span class="hide-on-mobile">Stop</span>';
            } else {
                sendButton.disabled = this.value.trim() === '' && attachedFiles.length === 0;
                sendButton.classList.remove('stop-button');
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> <span class="hide-on-mobile">Send</span>';
            }
        });
        
        // Voice search functionality
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-IN,hi-IN,mr-IN,ta-IN,te-IN';
            
            recognition.onstart = function() {
                isListening = true;
                if (isInputMicrophoneActive) {
                    inputMicrophoneBtn.classList.add('listening');
                }
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                
                if (event.results[0].isFinal) {
                    userInput.value = transcript;
                    userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
                    
                    // Enable send button
                    sendButton.disabled = false;
                    
                    // Auto-send after 1 second for short queries
                    if (transcript.split(' ').length <= 10) {
                        setTimeout(() => {
                            sendMessage();
                        }, 1000);
                    }
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                isInputMicrophoneActive = false;
                inputMicrophoneBtn.classList.remove('listening');
            };
            
            recognition.onend = function() {
                isListening = false;
                isInputMicrophoneActive = false;
                inputMicrophoneBtn.classList.remove('listening');
            };
            
            inputMicrophoneBtn.addEventListener('click', toggleInputVoiceRecognition);
        } else {
            inputMicrophoneBtn.style.display = 'none';
        }
        
        // Theme toggle
        themeToggle.addEventListener('click', toggleTheme);
        
        // Sidebar toggle button - UPDATED: Toggle open/close
        sidebarToggle.addEventListener('click', function() {
            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
            } else {
                sidebar.classList.add('active');
                sidebarOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        });
        
        sidebarClose.addEventListener('click', function() {
            sidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
            document.body.style.overflow = '';
        });
        
        sidebarOverlay.addEventListener('click', function() {
            sidebar.classList.remove('active');
            this.classList.remove('active');
            document.body.style.overflow = '';
        });
        
        // New chat button (in sidebar)
        newChatBtn.addEventListener('click', createNewChat);
        
        // New chat button (in header) - NEW
        newChatHeaderBtn.addEventListener('click', createNewChat);
        
        clearChatBtn.addEventListener('click', clearCurrentChat);
        
        // Guest login button click
        if (guestLoginBtn) {
            guestLoginBtn.addEventListener('click', function() {
                initializeAppForGuest();
            });
        }
        
        // Header login button click
        headerLoginBtn.addEventListener('click', function() {
            document.getElementById('loginModal').classList.add('active');
        });
        
        // User profile click
        userProfile.addEventListener('click', toggleUserDropdown);
        
        // Logout button
        logoutBtn.addEventListener('click', handleLogout);
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('userDropdown');
            const profile = document.getElementById('userProfile');
            
            if (dropdown.classList.contains('active') && 
                !dropdown.contains(event.target) && 
                !profile.contains(event.target)) {
                dropdown.classList.remove('active');
            }
            
            // Close sidebar when clicking outside on mobile
            const isMobile = window.innerWidth < 1024;
            if (isMobile && sidebar.classList.contains('active') && 
                !sidebar.contains(event.target) && 
                !sidebarToggle.contains(event.target)) {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        });
        
        // Focus input on load
        userInput.focus();
        
        // Adjust textarea height on page load
        setTimeout(() => {
            userInput.style.height = 'auto';
            userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
        }, 100);
        
        // Initialize scroll to bottom button
        const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
        if (scrollToBottomBtn) {
            scrollToBottomBtn.addEventListener('click', scrollToBottom);
        }
        
        // Monitor scroll position
        if (chatMessages) {
            chatMessages.addEventListener('scroll', checkScrollPosition);
            // Initial check
            setTimeout(checkScrollPosition, 500);
            
            // Also check when new messages are added
            const observer = new MutationObserver(checkScrollPosition);
            observer.observe(chatMessages, { childList: true, subtree: true });
        }
        
        // Initialize send button state
        sendButton.disabled = userInput.value.trim() === '' && attachedFiles.length === 0;
        
        // Adjust chat layout
        setTimeout(adjustChatLayout, 100);
        
        // File upload functionality
        attachmentBtn.addEventListener('click', openFileUploadModal);
        
        // Download notification close
        document.getElementById('closeDownloadNotification').addEventListener('click', function() {
            document.getElementById('downloadNotification').classList.remove('show');
        });
        
        // Download notification click to open file
        document.getElementById('downloadNotification').addEventListener('click', function() {
            if (lastDownloadedFileUrl) {
                window.open(lastDownloadedFileUrl, '_blank');
                this.classList.remove('show');
            }
        });
        
        console.log("Chat app initialized successfully");
    }
    
    // Show download notification
    function showDownloadNotification(fileName, fileType) {
        const notification = document.getElementById('downloadNotification');
        const title = document.getElementById('downloadNotificationTitle');
        const message = document.getElementById('downloadNotificationMessage');
        
        title.textContent = `${fileType} Downloaded `;
        message.textContent = `Click to open ${fileName}`;
        
        notification.classList.add('show');
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            notification.classList.remove('show');
        }, 5000);
    }
    
    // Load current chat messages
    function loadCurrentChatMessages() {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = '';
        
        // Add welcome message if no conversation history
        if (conversationHistory.length === 0) {
            const welcomeContainer = document.createElement('div');
            welcomeContainer.innerHTML = WELCOME_MESSAGE_HTML;
            chatMessages.appendChild(welcomeContainer);
            addDraftTemplateListeners();
            return;
        }
        
        // Add all messages from history
        conversationHistory.forEach(msg => {
            const isDocument = msg.isDocument || false;
            const hasSources = msg.sources && msg.sources.length > 0;
            addMessageToChat(msg.content, msg.role === 'user', true, isDocument, msg.attachments || [], hasSources ? msg.sources : null, msg.language || 'english');
        });
        
        // Add copy/edit buttons to user messages
        setTimeout(addCopyEditButtonsToUserMessages, 100);
    }
    
    // Add draft template listeners
    function addDraftTemplateListeners() {
        const draftTemplates = document.querySelectorAll('.draft-template');
        draftTemplates.forEach(template => {
            template.addEventListener('click', function() {
                const templateType = this.dataset.template;
                let requestText = '';
                
                switch(templateType) {
                    case 'nda':
                        requestText = 'Create a comprehensive non-disclosure agreement for Indian business use';
                        break;
                    case 'employment':
                        requestText = 'Draft an employment contract template for Indian companies';
                        break;
                    case 'rental':
                        requestText = 'Create a rental/tenancy agreement for residential property in India';
                        break;
                    case 'loan':
                        requestText = 'Draft a loan agreement template for personal lending in India';
                        break;
                }
                
                const userInput = document.getElementById('userInput');
                userInput.value = requestText;
                userInput.focus();
                userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
                document.getElementById('sendButton').disabled = false;
                
                // Auto-send after 1 second
                setTimeout(() => {
                    sendMessage();
                }, 1000);
            });
        });
    }
    
    // Send message function
    async function sendMessage() {
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const message = userInput.value.trim();
        
        // Check if there's either text or attachments
        if (!message && attachedFiles.length === 0) {
            return;
        }
        
        // Stop voice recognition if active
        if (isListening && recognition) {
            recognition.stop();
        }
        
        // Detect language if there's text
        let detectedLanguage = 'english';
        if (message) {
            detectedLanguage = detectLanguage(message);
        }
        
        // Add user message to chat with attachments
        const messageId = addMessageToChat(message, true, false, false, attachedFiles, null, detectedLanguage);
        userInput.value = '';
        userInput.style.height = '52px';
        
        // Update send button to stop button
        sendButton.disabled = false;
        sendButton.classList.add('stop-button');
        sendButton.innerHTML = '<i class="fas fa-stop"></i> <span class="hide-on-mobile">Stop</span>';
        isStreamingActive = true;
        stopStreamingRequested = false;
        
        // Clear attachments after sending
        clearAttachments();
        
        try {
            // Store message in conversation history
            const userMessage = {
                role: 'user',
                content: message,
                language: detectedLanguage,
                attachments: [...attachedFiles],
                timestamp: new Date().toISOString()
            };
            
            conversationHistory.push(userMessage);
            
            // If there are files, read their contents
            let fileContents = '';
            if (attachedFiles.length > 0) {
                for (const file of attachedFiles) {
                    const content = await readFileContent(file);
                    if (content) {
                        fileContents += `\n\n[Content from ${file.name}]:\n${content.substring(0, 2000)}${content.length > 2000 ? '... (truncated)' : ''}`;
                    }
                }
            }
            
            // Combine user message with file contents
            const fullMessage = message + fileContents;
            
            // Call AI API with multiple key rotation
            const response = await callGroqAPIWithRotation(fullMessage, detectedLanguage);
            
            // If streaming was stopped, don't process the response
            if (stopStreamingRequested) {
                console.log('Streaming was stopped, not processing response');
                return;
            }
            
            // Extract ONLY sources from the response
            const sourcesData = extractSourcesFromResponse(response);
            
            // Store AI response in conversation history
            const aiMessage = {
                role: 'assistant',
                content: response,
                language: detectedLanguage,
                isDocument: isDocumentRequest(message),
                sources: sourcesData.sources,
                timestamp: new Date().toISOString()
            };
            
            conversationHistory.push(aiMessage);
            
            // Save current chat to history
            saveCurrentChat();
            
            // Create AI message container for streaming
            const aiMessageId = createStreamingMessage();
            
            // Start streaming the response
            startStreamingResponse(aiMessageId, response, isDocumentRequest(message), detectedLanguage);
            
            // After streaming completes, add sources ONLY
            setTimeout(() => {
                if (sourcesData && sourcesData.hasSources) {
                    addResponseSources(aiMessageId, sourcesData);
                }
            }, 500);
            
        } catch (error) {
            console.error('AI Service Error:', error);
            
            // Update with error message
            const errorMessage = "I apologize for the inconvenience. I'm currently experiencing technical difficulties. Please try again in a moment.";
            addMessageToChat(errorMessage, false, false, false, [], null, 'english');
            
            // Add error to conversation history
            conversationHistory.push({
                role: 'assistant',
                content: errorMessage,
                language: 'english',
                timestamp: new Date().toISOString()
            });
            
            // Reset send button
            sendButton.disabled = userInput.value.trim() === '' && attachedFiles.length === 0;
            sendButton.classList.remove('stop-button');
            sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> <span class="hide-on-mobile">Send</span>';
            isStreamingActive = false;
        } finally {
            document.getElementById('userInput').focus();
            
            // Adjust layout
            setTimeout(adjustChatLayout, 100);
            
            // Add copy/edit buttons to the new user message
            setTimeout(addCopyEditButtonsToUserMessages, 100);
        }
    }
    
    // Stop streaming function
    function stopStreaming() {
        stopStreamingRequested = true;
        isStreamingActive = false;
        isStreamingPaused = false;
        
        // Reset send button
        const sendButton = document.getElementById('sendButton');
        sendButton.disabled = document.getElementById('userInput').value.trim() === '' && attachedFiles.length === 0;
        sendButton.classList.remove('stop-button');
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> <span class="hide-on-mobile">Send</span>';
        
        // If there's a streaming message, finalize it
        if (currentStreamingMessageId) {
            const messageDiv = document.getElementById(currentStreamingMessageId);
            if (messageDiv) {
                const messageText = messageDiv.querySelector('.message-text');
                const streamControls = messageDiv.querySelector('.stream-controls');
                
                if (streamControls) {
                    streamControls.remove();
                }
                
                // Add action buttons
                const messageActions = document.createElement('div');
                messageActions.className = 'message-actions';
                messageActions.innerHTML = `
                    <button class="action-btn copy" onclick="copyMessage(this)" title="Copy response">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                    <button class="action-btn regenerate" onclick="regenerateResponse('${currentStreamingMessageId}')" title="Regenerate response">
                        <i class="fas fa-sync-alt"></i> Regenerate
                    </button>
                    <button class="action-btn like" onclick="likeMessage(this)" title="Mark as helpful">
                        <i class="far fa-thumbs-up"></i> Helpful
                    </button>
                    <button class="action-btn dislike" onclick="dislikeMessage(this)" title="Mark as not helpful">
                        <i class="far fa-thumbs-down"></i> Not Helpful
                    </button>
                    <button class="action-btn share" onclick="shareResponse('${currentStreamingMessageId}')" title="Share response">
                        <i class="fas fa-share"></i> Share
                    </button>
                    <button class="action-btn document" onclick="downloadThisMessage('${currentStreamingMessageId}')" title="Download document">
                        <i class="fas fa-file-download"></i> Download
                    </button>
                `;
                
                messageText.parentElement.appendChild(messageActions);
                
                // Remove streaming cursor
                const cursor = messageText.querySelector('.streaming-cursor');
                if (cursor) cursor.remove();
                
                // Remove paused indicator
                const pausedIndicator = messageText.querySelector('.paused-indicator');
                if (pausedIndicator) pausedIndicator.remove();
                
                // Format the content
                if (isDocumentRequest(currentStreamingContent)) {
                    messageText.innerHTML = formatDocumentResponse(currentStreamingContent);
                    addDocumentDownloadButton(currentStreamingMessageId, currentStreamingContent);
                } else {
                    messageText.innerHTML = formatLegalResponse(currentStreamingContent);
                }
            }
            
            // Reset streaming variables
            currentStreamingMessageId = null;
            currentStreamingContent = '';
            currentStreamingBuffer = '';
            streamingTextChunks = [];
            streamingTextIndex = 0;
        }
    }
    
    // Read file content
    async function readFileContent(file) {
        return new Promise((resolve, reject) => {
            if (file.type.startsWith('image/')) {
                // For images, we can't read text content easily
                // We'll just note that it's an image
                resolve(`[Image file: ${file.name}. Size: ${(file.size / 1024).toFixed(2)} KB]`);
            } else if (file.type === 'application/pdf') {
                // For PDF files, we can't read them directly in browser without a library
                resolve(`[PDF file: ${file.name}. Size: ${(file.size / 1024).toFixed(2)} KB. Content preview not available in browser.]`);
            } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                // For text files
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve(e.target.result);
                };
                reader.onerror = reject;
                reader.readAsText(file.file);
            } else if (file.type.includes('document') || file.name.endsWith('.doc') || file.name.endsWith('.docx')) {
                // For Word documents
                resolve(`[Document file: ${file.name}. Size: ${(file.size / 1024).toFixed(2)} KB. Content preview not available in browser.]`);
            } else {
                resolve(`[File: ${file.name}. Type: ${file.type}. Size: ${(file.size / 1024).toFixed(2)} KB]`);
            }
        });
    }
    
    // Extract ONLY sources from AI response (NO SUMMARY)
    function extractSourcesFromResponse(response) {
        const sources = [];
        
        // Indian Acts and Statutes (with year recognition)
        const indianActsPatterns = [
            /(Indian Contract Act,?\s*1872)/gi,
            /(Indian Penal Code,?\s*1860)/gi,
            /(Code of Civil Procedure,?\s*1908)/gi,
            /(Code of Criminal Procedure,?\s*1973)/gi,
            /(Constitution of India)/gi,
            /(Evidence Act,?\s*1872)/gi,
            /(Specific Relief Act,?\s*1963)/gi,
            /(Transfer of Property Act,?\s*1882)/gi,
            /(Hindu Marriage Act,?\s*1955)/gi,
            /(Hindu Succession Act,?\s*1956)/gi,
            /(Companies Act,?\s*2013)/gi,
            /(Consumer Protection Act,?\s*2019)/gi,
            /(Information Technology Act,?\s*2000)/gi,
            /(Right to Information Act,?\s*2005)/gi,
            /(Arbitration and Conciliation Act,?\s*1996)/gi,
            /(Protection of Children from Sexual Offences Act,?\s*2012)/gi,
            /(Motor Vehicles Act,?\s*1988)/gi,
            /(Negotiable Instruments Act,?\s*1881)/gi,
            /(Sale of Goods Act,?\s*1930)/gi,
            /(Partnership Act,?\s*1932)/gi
        ];
        
        // Case Law Citations
        const caseLawPatterns = [
            /([A-Z][a-z]+\s+v\.\s+[A-Z][a-z]+)/g, // Plaintiff v. Defendant
            /(AIR\s+\d{4}\s+(?:SC|Bom|Del|Cal|Mad|Ker|Guj|Raj|All|Pat|Ori|MP|AP|HP|P&H|J&K|Kar)\s+\d+)/gi,
            /(SCC\s+\d+)/gi, // Supreme Court Cases
            /((\d+)\s+SCC\s+\d+)/gi, // Volume SCC
            /(SCR\s+\d+)/gi, // Supreme Court Reports
            /((\d+)\s+SCR\s+\d+)/gi,
            /(JT\s+\d+)/gi, // Judgment Today
            /((\d+)\s+JT\s+\d+)/gi
        ];
        
        // Sections, Articles, Rules
        const sectionPatterns = [
            /(Section\s+\d+[A-Z]?)/gi,
            /(Article\s+\d+)/gi,
            /(Rule\s+\d+)/gi,
            /(Regulation\s+\d+)/gi,
            /(Clause\s+\d+)/gi,
            /(Schedule\s+[IVXLCDM]+)/gi
        ];
        
        // Extract Indian Acts
        indianActsPatterns.forEach(pattern => {
            const matches = response.match(pattern);
            if (matches) {
                matches.forEach(match => {
                    const formatted = match.replace(/,?\s*(\d{4})/, ', $1');
                    if (!sources.some(s => s.toLowerCase() === formatted.toLowerCase())) {
                        sources.push(formatted);
                    }
                });
            }
        });
        
        // Extract Case Laws
        caseLawPatterns.forEach(pattern => {
            const matches = response.match(pattern);
            if (matches) {
                matches.forEach(match => {
                    if (!sources.some(s => s.toLowerCase() === match.toLowerCase())) {
                        sources.push(match);
                    }
                });
            }
        });
        
        // Extract Sections
        sectionPatterns.forEach(pattern => {
            const matches = response.match(pattern);
            if (matches) {
                matches.forEach(match => {
                    if (!sources.some(s => s.toLowerCase() === match.toLowerCase())) {
                        sources.push(match);
                    }
                });
            }
        });
        
        // Remove duplicates while preserving case
        const uniqueSources = [];
        const seen = new Set();
        
        sources.forEach(source => {
            const lower = source.toLowerCase();
            if (!seen.has(lower)) {
                seen.add(lower);
                uniqueSources.push(source);
            }
        });
        
        return {
            sources: uniqueSources.slice(0, 8), // Return max 8 sources
            hasSources: uniqueSources.length > 0
        };
    }
    
    // Show ONLY sources after response
    function addResponseSources(messageId, sourcesData) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv || !sourcesData || !sourcesData.hasSources) return;
        
        // Wait for streaming to complete
        const checkStreaming = setInterval(() => {
            const isStillStreaming = currentStreamingMessageId === messageId;
            const messageText = messageDiv.querySelector('.message-text');
            const hasStreamingCursor = messageText && messageText.querySelector('.streaming-cursor');
            
            if (!isStillStreaming && !hasStreamingCursor) {
                clearInterval(checkStreaming);
                
                // Create sources container
                const sourcesContainer = document.createElement('div');
                sourcesContainer.className = 'sources-container';
                
                let sourcesHTML = '';
                if (sourcesData.sources && sourcesData.sources.length > 0) {
                    sourcesHTML = `
                        <div class="sources-header">
                            <i class="fas fa-gavel"></i>
                            <span>Legal Sources & References</span>
                        </div>
                        <div class="sources-list">
                            ${sourcesData.sources.map(source => `
                                <div class="source-tag" title="${source}">
                                    <i class="fas fa-bookmark"></i>
                                    <span>${source.length > 40 ? source.substring(0, 40) + '...' : source}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="sources-info">
                            <i class="fas fa-info-circle"></i>
                            Sources extracted from the AI response above
                        </div>
                    `;
                    
                    sourcesContainer.innerHTML = sourcesHTML;
                    
                    // Insert after the AI message
                    messageDiv.parentNode.insertBefore(sourcesContainer, messageDiv.nextSibling);
                    
                    // Scroll to show sources
                    setTimeout(() => {
                        sourcesContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 300);
                    
                    // Save sources to conversation history
                    const aiMessageIndex = conversationHistory.findIndex(msg => 
                        msg.role === 'assistant' && msg.content && msg.content.includes(messageDiv.querySelector('.message-text').textContent.substring(0, 100))
                    );
                    
                    if (aiMessageIndex !== -1) {
                        conversationHistory[aiMessageIndex].sources = sourcesData.sources;
                        saveCurrentChat();
                    }
                }
            }
        }, 100);
        
        // Set timeout to prevent infinite checking
        setTimeout(() => clearInterval(checkStreaming), 10000);
    }
    
    // API call with multiple key rotation
    async function callGroqAPIWithRotation(message, responseLanguage, maxRetries = 3) {
        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                const currentApiKey = API_KEYS[currentApiKeyIndex];
                console.log(`Attempt ${attempt + 1} with API key ${currentApiKeyIndex + 1}`);
                
                const response = await callSingleGroqAPI(currentApiKey, message, responseLanguage);
                
                // Increment request count and rotate key if needed
                requestCount++;
                if (requestCount >= REQUEST_LIMIT_PER_KEY) {
                    requestCount = 0;
                    currentApiKeyIndex = (currentApiKeyIndex + 1) % API_KEYS.length;
                    console.log(`Rotating to API key ${currentApiKeyIndex + 1}`);
                }
                
                return response;
            } catch (error) {
                console.error(`Attempt ${attempt + 1} failed:`, error);
                
                // Rotate to next API key
                currentApiKeyIndex = (currentApiKeyIndex + 1) % API_KEYS.length;
                requestCount = 0;
                
                if (attempt === maxRetries - 1) {
                    throw error;
                }
                
                // Wait before retrying
                await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
            }
        }
    }
    
    // Single API call
    async function callSingleGroqAPI(apiKey, message, responseLanguage) {
        const isDocumentReq = isDocumentRequest(message);
        const hasFiles = attachedFiles.length > 0;
        const systemPrompt = getSystemPrompt(responseLanguage, isDocumentReq, hasFiles);
        
        // Prepare messages array
        const messages = [
            { role: 'system', content: systemPrompt },
            ...conversationHistory.slice(-6).map(msg => ({
                role: msg.role,
                content: msg.content
            })),
            { role: 'user', content: message }
        ];
        
        console.log(`Calling Groq API with model: ${currentModel} and key index: ${currentApiKeyIndex}`);
        
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: currentModel,
                messages: messages,
                temperature: 0.7,
                max_tokens: 4000
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error(`API error: ${response.status}`, errorText);
            throw new Error(`API error: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("API response received successfully");
        
        return data.choices[0].message.content;
    }
    
    // Save current chat to history
    function saveCurrentChat() {
        if (!currentChatId || conversationHistory.length === 0) return;
        
        // Find chat in history
        const chatIndex = chatHistory.findIndex(chat => chat.id === currentChatId);
        
        // Generate title from first user message
        let title = 'New Chat';
        let preview = 'No messages yet';
        
        if (conversationHistory.length > 0) {
            const firstUserMessage = conversationHistory.find(msg => msg.role === 'user');
            if (firstUserMessage) {
                title = firstUserMessage.content.substring(0, 30);
                if (firstUserMessage.content.length > 30) {
                    title += '...';
                }
            }
            
            const lastMessage = conversationHistory[conversationHistory.length - 1];
            if (lastMessage) {
                preview = lastMessage.content.substring(0, 50);
                if (lastMessage.content.length > 50) {
                    preview += '...';
                }
            }
        }
        
        const chatData = {
            id: currentChatId,
            title: title,
            preview: preview,
            date: new Date().toISOString(),
            messages: [...conversationHistory],
            userId: currentUser ? currentUser.id : 'guest'
        };
        
        if (chatIndex !== -1) {
            // Update existing chat
            chatHistory[chatIndex] = chatData;
        } else {
            // Add new chat
            chatHistory.unshift(chatData);
        }
        
        // Save to user-specific storage
        saveUserChatHistory();
        
        // Update history list display
        loadHistoryList();
    }
    
    // Check if user is asking for document
    function isDocumentRequest(message) {
        if (!message) return false;
        
        const docKeywords = [
            'draft', 'template', 'format', 'document', 'agreement', 
            'contract', 'nda', 'non disclosure', 'employment', 
            'rental', 'loan', 'will', 'testament', 'legal document',
            'ready made', 'sample', 'example', 'form', '',
            '', '', '', '', '',
            '', '', '', '', 'create',
            'generate', 'make', 'prepare', 'write'
        ];
        
        const lowerMessage = message.toLowerCase();
        return docKeywords.some(keyword => lowerMessage.includes(keyword));
    }
    
    // Get system prompt with file reading capability
    function getSystemPrompt(language, isDocumentRequest = false, hasFiles = false) {
        let basePrompt = '';
        
        if (isDocumentRequest) {
            const documentPrompts = {
                'english': `You are LegalSwami, an expert AI legal assistant specializing in Indian law.
                
IMPORTANT: When the user asks for a legal document draft, you MUST create a complete, ready-to-use legal document template. Include:
1. Proper document title and headings.
2. All necessary legal clauses.
3. Placeholders for personal information [like this].
4. Signature sections.
5. Date and witness sections if applicable.

Make sure the document is:
- Legally sound for Indian context.
- Professionally formatted.
- Ready for immediate download and use.
- Includes all standard legal clauses.

Format your response as a complete legal document.

ALWAYS include this disclaimer at the end:
"Disclaimer: This template is for educational purposes only. Consult a qualified attorney before use."`,

                'hindi': ` LegalSwami ,     AI  

:        ,    ,           :
1.     
2.    
3.      [ ]
4.  
5.        

   :
-         
-     
-        
-      

           

      :
":                "`,

                'marathi': ` LegalSwami ,    AI  

:      ,    ,           :
1.     
2.    
3.    [ ]
4.  
5.      

    :
-     
-   
-      
-      

        

     :
":           "`
            };
            
            basePrompt = documentPrompts[language] || documentPrompts['english'];
        } else {
            const generalPrompts = {
                'english': `You are LegalSwami, an expert AI legal assistant specializing in Indian law.
                
CRITICAL RULE: Respond in the same language as the user's query. If user writes in Hindi, respond in Hindi. If in Marathi, respond in Marathi. If in English, respond in English.

Provide comprehensive, detailed legal information about Indian laws.
Cite relevant Indian laws, acts, and sections when applicable.
Mention important Indian legal precedents and case laws.
Explain legal concepts clearly with practical examples.
Include practical implications for Indian context.
Provide actionable advice when appropriate.

${hasFiles ? 'IMPORTANT: The user has attached files with their query. Read and analyze the file contents provided in the message. Reference specific parts of the files in your response when relevant.' : ''}

When answering:
- Structure your response with clear headings.
- Use bullet points for lists.
- Bold important terms and sections.
- Include references to relevant laws.
- Provide practical next steps.
- If files are attached, mention what you found in them.

ALWAYS include this disclaimer at the end:
"Disclaimer: This information is for educational purposes only and not legal advice. Consult a qualified attorney for specific legal matters."`,

                'hindi': ` LegalSwami ,     AI  

 :               ,         ,         ,     

           
  ,      
         
          
       
       

${hasFiles ? ':                                   ' : ''}

  :
-         
-        
-       
-      
-     
-    ,        

      :
":                       "`,

                'marathi': ` LegalSwami ,    AI  

 :     .      .     .     .

        .
  ,      .
        .
      .
     .
     .

${hasFiles ? ':      .         .         .' : ''}

 :
-      .
-    .
-      .
-     .
-     .
-   ,       .

     :
":          .       "`
            };
            
            basePrompt = generalPrompts[language] || generalPrompts['english'];
        }
        
        return basePrompt;
    }
    
    // Enhanced language detection
    function detectLanguage(text) {
        if (!text) return 'english';
        
        const hasNonEnglishScript = /[\u0900-\u097F\u0B80-\u0BFF\u0C00-\u0C7F\u0C80-\u0CFF\u0A00-\u0A7F\u0A80-\u0AFF\u0980-\u09FF]/.test(text);
        
        if (!hasNonEnglishScript) {
            const hindiMarathiWords = [
                /\bmujhe\b/i, /\btumhe\b/i, /\bhindi\b/i, /\bmarathi\b/i,
                /\bkya\b/i, /\bkyu\b/i, /\bkaise\b/i, /\bkab\b/i,
                /\bmala\b/i, /\bmahiti\b/i, /\bsahayata\b/i, /\bkich\b/i
            ];
            
            let hindiMarathiScore = 0;
            hindiMarathiWords.forEach(pattern => {
                if (pattern.test(text)) hindiMarathiScore++;
            });
            
            if (hindiMarathiScore >= 2) {
                if (/\bmala\b/i.test(text) || /\bmahiti\b/i.test(text) || /\bsahayata\b/i.test(text)) {
                    return 'marathi';
                }
                if (/\bmujhe\b/i.test(text) || /\bkya\b/i.test(text) || /\bkyu\b/i.test(text)) {
                    return 'hindi';
                }
            }
            
            return 'english';
        }
        
        if (/[\u0900-\u097F]/.test(text)) {
            let marathiScore = 0;
            let hindiScore = 0;
            
            const marathiWords = ['', '', '', '', '', '', '', '', '', '', '', ''];
            marathiWords.forEach(word => {
                if (text.includes(word)) marathiScore++;
            });
            
            const hindiWords = ['', '', '', '', '', '', '', '', '', ''];
            hindiWords.forEach(word => {
                if (text.includes(word)) hindiScore++;
            });
            
            if (marathiScore > hindiScore) {
                return 'marathi';
            } else if (hindiScore > 0) {
                return 'hindi';
            }
            
            return 'hindi';
        }
        
        if (/[\u0B80-\u0BFF]/.test(text)) return 'tamil';
        if (/[\u0C00-\u0C7F]/.test(text)) return 'telugu';
        if (/[\u0C80-\u0CFF]/.test(text)) return 'kannada';
        if (/[\u0A00-\u0A7F]/.test(text)) return 'punjabi';
        if (/[\u0A80-\u0AFF]/.test(text)) return 'gujarati';
        if (/[\u0980-\u09FF]/.test(text)) return 'bengali';
        
        return 'english';
    }
    
    // Add message to chat with sources parameter and language
    function addMessageToChat(content, isUser, fromHistory = false, isDocument = false, attachments = [], sources = null, language = 'english') {
        const chatMessages = document.getElementById('chatMessages');
        
        // Remove welcome message if it exists and this is a new message
        if (!fromHistory && isUser) {
            const welcomeMessage = document.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
        const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        messageDiv.id = messageId;
        
        // Avatar
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        if (isUser) {
            if (currentUser && currentUser.picture) {
                avatar.innerHTML = `<img src="${currentUser.picture}" alt="${currentUser.name}" style="width: 100%; height: 100%; border-radius: 8px;">`;
            } else {
                avatar.innerHTML = '<i class="fas fa-user"></i>';
            }
        } else {
            // LegalSwami logo for AI avatar
            avatar.innerHTML = '<i class="fas fa-scale-balanced"></i>';
            avatar.style.background = 'linear-gradient(135deg, var(--secondary) 0%, #5e35b1 100%)';
        }
        
        // Message content
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        
        const messageText = document.createElement('div');
        messageText.className = 'message-text';
        
        if (isUser) {
            // User message with attachments
            if (content) {
                messageText.innerHTML = content.replace(/\n/g, '<br>');
            }
            
            // Add attachments if any
            if (attachments && attachments.length > 0) {
                messageDiv.dataset.attachments = JSON.stringify(attachments.map(file => ({
                    name: file.name,
                    data: file.data,
                    type: file.type
                })));
            }
            
            // Add copy and edit buttons for user messages (not from history)
            if (!fromHistory) {
                const controlsContainer = document.createElement('div');
                controlsContainer.className = 'user-message-controls';
                
                controlsContainer.innerHTML = `
                    <button class="user-message-btn copy-btn" onclick="copyUserMessage('${messageId}')" title="Copy question">
                        <i class="fas fa-copy"></i>
                        <span class="hide-on-mobile">Copy</span>
                    </button>
                    <button class="user-message-btn edit-btn" onclick="editUserMessage('${messageId}')" title="Edit question">
                        <i class="fas fa-pencil-alt"></i>
                        <span class="hide-on-mobile">Edit</span>
                    </button>
                `;
                
                messageContent.appendChild(controlsContainer);
            }
            
        } else {
            // AI message
            if (isDocument) {
                messageText.innerHTML = formatDocumentResponse(content);
            } else {
                messageText.innerHTML = formatLegalResponse(content);
            }
            
            // Add AI response footer (Responded by LegalSwami)
            const aiFooter = document.createElement('div');
            aiFooter.className = 'ai-response-footer';
            
            // Set footer text based on language
            let footerText = '';
            if (language === 'hindi') {
                footerText = 'LegalSwami    ';
            } else if (language === 'marathi') {
                footerText = 'LegalSwami   ';
            } else {
                footerText = 'Responded by LegalSwami';
            }
            
            aiFooter.innerHTML = `
                <i class="fas fa-robot"></i>
                <span class="ai-signature">${footerText}</span>
                <span style="margin-left: auto; font-size: 0.75rem;">
                    <i class="fas fa-clock"></i> ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </span>
            `;
            
            messageContent.appendChild(aiFooter);
            
            // Add sources if available and not from history
            if (sources && sources.length > 0 && !fromHistory) {
                // Add sources after a delay
                setTimeout(() => {
                    addResponseSources(messageId, { sources: sources, hasSources: true });
                }, 100);
            }
        }
        
        messageContent.appendChild(messageText);
        
        // Action buttons for AI messages (not from history)
        if (!isUser && !fromHistory) {
            const messageActions = document.createElement('div');
            messageActions.className = 'message-actions';
            messageActions.innerHTML = `
                <button class="action-btn copy" onclick="copyMessage(this)" title="Copy response">
                    <i class="fas fa-copy"></i> Copy
                </button>
                <button class="action-btn regenerate" onclick="regenerateResponse('${messageId}')" title="Regenerate response">
                    <i class="fas fa-sync-alt"></i> Regenerate
                </button>
                <button class="action-btn like" onclick="likeMessage(this)" title="Mark as helpful">
                    <i class="far fa-thumbs-up"></i> Helpful
                </button>
                <button class="action-btn dislike" onclick="dislikeMessage(this)" title="Mark as not helpful">
                    <i class="far fa-thumbs-down"></i> Not Helpful
                </button>
                <button class="action-btn share" onclick="shareResponse('${messageId}')" title="Share response">
                    <i class="fas fa-share"></i> Share
                </button>
                <button class="action-btn document" onclick="downloadThisMessage('${messageId}')" title="Download document">
                    <i class="fas fa-file-download"></i> Download
                </button>
            `;
            messageContent.appendChild(messageActions);
        }
        
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(messageContent);
        chatMessages.appendChild(messageDiv);
        
        // If this is a user message with attachments, show them below the message
        if (isUser && attachments && attachments.length > 0) {
            showAttachedFilesBelowUserMessage(messageId, attachments);
        }
        
        // Scroll to show new message
        setTimeout(checkScrollPosition, 100);
        
        return messageId;
    }
    
    // Show attached files with content preview
    function showAttachedFilesBelowUserMessage(messageId, attachments) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv || !attachments || attachments.length === 0) return;
        
        const messageContent = messageDiv.querySelector('.message-content');
        
        attachments.forEach((attachment, index) => {
            // Create file display container
            const fileContainer = document.createElement('div');
            fileContainer.className = 'attachment-item';
            fileContainer.style.maxWidth = '280px';
            fileContainer.style.marginTop = '8px';
            
            if (attachment.type.startsWith('image/')) {
                // Image preview
                fileContainer.innerHTML = `
                    <img src="${attachment.data}" alt="${attachment.name}" class="attachment-image" style="max-height: 130px;">
                    <div class="attachment-name">${attachment.name}</div>
                `;
            } else if (attachment.type === 'application/pdf' || attachment.name.endsWith('.pdf')) {
                // PDF icon
                fileContainer.innerHTML = `
                    <div style="padding: 15px; text-align: center; background: var(--dark-surface-light);">
                        <i class="fas fa-file-pdf" style="font-size: 1.8rem; color: var(--error);"></i>
                        <div class="attachment-name">${attachment.name}</div>
                        <div style="font-size: 0.65rem; color: var(--dark-text-secondary);">PDF Document</div>
                    </div>
                `;
            } else if (attachment.type === 'text/plain' || attachment.name.endsWith('.txt')) {
                // Text file icon with content preview button
                fileContainer.innerHTML = `
                    <div style="padding: 12px; background: var(--dark-surface-light); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class="fas fa-file-alt" style="font-size: 1.3rem; color: var(--primary);"></i>
                            <div style="flex: 1;">
                                <div class="attachment-name">${attachment.name}</div>
                                <div style="font-size: 0.65rem; color: var(--dark-text-secondary);">Text Document</div>
                            </div>
                        </div>
                        <button class="action-btn" style="width: 100%; padding: 6px;" onclick="showFileContent('${attachment.data}', '${attachment.name.replace(/'/g, "\\'")}')">
                            <i class="fas fa-eye"></i> Preview Content
                        </button>
                    </div>
                `;
            } else {
                // Generic file icon
                fileContainer.innerHTML = `
                    <div style="padding: 15px; text-align: center; background: var(--dark-surface-light);">
                        <i class="fas fa-file" style="font-size: 1.8rem; color: var(--dark-text-secondary);"></i>
                        <div class="attachment-name">${attachment.name}</div>
                        <div style="font-size: 0.65rem; color: var(--dark-text-secondary);">${attachment.type || 'File'}</div>
                    </div>
                `;
            }
            
            // Insert after the message text
            const messageText = messageContent.querySelector('.message-text');
            messageContent.insertBefore(fileContainer, messageText.nextSibling);
        });
    }
    
    // Show file content in a preview box
    window.showFileContent = async function(dataUrl, fileName) {
        try {
            // Decode base64 data URL
            const response = await fetch(dataUrl);
            const text = await response.text();
            
            // Create file content display
            const contentDiv = document.createElement('div');
            contentDiv.className = 'file-content-display';
            contentDiv.innerHTML = `
                <div class="file-content-header">
                    <div class="file-content-title">
                        <i class="fas fa-file-alt"></i>
                        <span>${fileName}</span>
                    </div>
                    <button class="file-content-close" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div style="max-height: 180px; overflow-y: auto; font-family: monospace; font-size: 0.75rem;">
                    ${text.substring(0, 4000)}
                    ${text.length > 4000 ? '<div style="color: var(--dark-text-secondary); margin-top: 8px;">... (content truncated)</div>' : ''}
                </div>
            `;
            
            // Add to chat messages
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.appendChild(contentDiv);
            
            // Scroll to show the content
            setTimeout(() => {
                contentDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
            
        } catch (error) {
            console.error('Error reading file content:', error);
        }
    };
    
    // Regenerate response function
    window.regenerateResponse = function(messageId) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;
        
        // Find the user message that came before this AI response
        const allMessages = document.querySelectorAll('.message');
        let userMessageContent = '';
        let userMessageId = '';
        
        for (let i = 0; i < allMessages.length; i++) {
            if (allMessages[i].id === messageId) {
                // Found the AI message, now look for previous user message
                for (let j = i - 1; j >= 0; j--) {
                    if (allMessages[j].classList.contains('user-message')) {
                        const userMessageText = allMessages[j].querySelector('.message-text');
                        if (userMessageText) {
                            userMessageContent = userMessageText.textContent;
                            userMessageId = allMessages[j].id;
                        }
                        break;
                    }
                }
                break;
            }
        }
        
        if (userMessageContent) {
            // Remove the current AI response
            const aiMessageIndex = conversationHistory.findIndex((msg, idx) => 
                msg.role === 'assistant' && idx > 0 && conversationHistory[idx-1].content === userMessageContent
            );
            
            if (aiMessageIndex !== -1) {
                conversationHistory.splice(aiMessageIndex, 1);
            }
            
            // Remove from DOM
            messageDiv.remove();
            
            // Send the user message again
            const userInput = document.getElementById('userInput');
            userInput.value = userMessageContent;
            userInput.focus();
            userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
            
            // Trigger send after a short delay
            setTimeout(() => {
                sendMessage();
            }, 500);
        }
    };
    
    // Dislike message function
    window.dislikeMessage = function(button) {
        button.innerHTML = '<i class="fas fa-thumbs-down"></i> Feedback Sent';
        button.style.background = 'var(--error)';
        button.style.borderColor = 'var(--error)';
        button.style.color = 'white';
        button.disabled = true;
    };
    
    // Share response function
    window.shareResponse = function(messageId) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;
        
        const messageText = messageDiv.querySelector('.message-text');
        const textToShare = messageText.textContent;
        
        if (navigator.share) {
            navigator.share({
                title: 'LegalSwami AI Response',
                text: textToShare.substring(0, 100) + '...',
                url: window.location.href
            }).catch(err => {
                console.error('Share failed:', err);
                copyToClipboard(textToShare);
            });
        } else {
            copyToClipboard(textToShare);
        }
    };
    
    // Helper function to copy to clipboard
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
        }).catch(err => {
            console.error('Copy failed:', err);
        });
    }
    
    // Copy user message
    window.copyUserMessage = function(messageId) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;
        
        const messageText = messageDiv.querySelector('.message-text');
        const textToCopy = messageText.textContent;
        
        navigator.clipboard.writeText(textToCopy).then(() => {
        }).catch(err => {
            console.error('Copy failed:', err);
        });
    };
    
    // Edit user message
    window.editUserMessage = function(messageId) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;
        
        const messageText = messageDiv.querySelector('.message-text');
        const content = messageText.textContent;
        
        const userInput = document.getElementById('userInput');
        userInput.value = content;
        userInput.focus();
        
        // Adjust textarea height
        userInput.style.height = 'auto';
        userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
        
        // Enable send button
        document.getElementById('sendButton').disabled = false;
    };
    
    // Format document response
    function formatDocumentResponse(text) {
        const documentContainer = document.createElement('div');
        documentContainer.className = 'document-template';
        
        const lines = text.split('\n');
        let htmlContent = '';
        
        lines.forEach(line => {
            if (line.trim() === '') return;
            
            if (line.toUpperCase() === line && line.length > 10 && !line.includes(':')) {
                htmlContent += `<div class="document-header">
                    <h2 class="document-title">${line}</h2>
                    <div class="document-subtitle">Legal Document Template</div>
                </div>`;
            }
            else if (line.match(/^\d+\.\s+.+/) || line.match(/^[A-Z\s]+:$/)) {
                htmlContent += `<div class="document-section">
                    <h3 class="document-section-title">${line}</h3>`;
            }
            else if (line.match(/^[a-z]\)\s+.+/)) {
                htmlContent += `<div class="document-clause">
                    <div class="clause-title">${line}</div>`;
            }
            else {
                if (line.includes('___________________') || line.includes('________________')) {
                    htmlContent += `<div class="clause-content" style="border-bottom: 1px solid var(--dark-border); padding-bottom: 4px; margin-bottom: 8px;">${line}</div>`;
                } else {
                    htmlContent += `<div class="clause-content">${line}</div>`;
                }
            }
        });
        
        if (!text.includes('Signature') && !text.includes('Witness')) {
            htmlContent += `
                <div class="signature-section">
                    <div class="signature-line">
                        <div class="signature-block">
                            <div class="signature-name"></div>
                            <div class="signature-label">Signature</div>
                        </div>
                        <div class="signature-block">
                            <div class="signature-name"></div>
                            <div class="signature-label">Date</div>
                        </div>
                    </div>
                </div>`;
        }
        
        htmlContent += `<div class="legal-note">
            <strong>Disclaimer:</strong> This template is for educational purposes only. Consult a qualified attorney before use.
        </div>`;
        
        documentContainer.innerHTML = htmlContent;
        
        return documentContainer.outerHTML;
    }
    
    // Format legal response
    function formatLegalResponse(text) {
        let formatted = text
            .replace(/## (.*?)\n/g, '<h3>$1</h3>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/- (.*?)\n/g, '<li>$1</li>')
            .replace(/\n/g, '<br>');
        
        formatted = formatted.replace(/(<li>.*?<\/li>)/gs, function(match) {
            return '<ul>' + match + '</ul>';
        });
        
        if (formatted.includes('Disclaimer') || formatted.includes('') || formatted.includes('')) {
            formatted = formatted.replace(/(Disclaimer:.*?|:.*?|:.*?)(?=<br><br>|$)/is, 
                '<div class="legal-note">$1</div>');
        }
        
        const container = document.createElement('div');
        container.className = 'legal-content';
        container.innerHTML = formatted;
        
        return container.outerHTML;
    }
    
    // Format text for streaming display
    function formatStreamingText(text) {
        const container = document.createElement('div');
        container.innerHTML = text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n/g, '<br>');
        
        return container.innerHTML;
    }
    
    // Create streaming message container
    function createStreamingMessage() {
        const chatMessages = document.getElementById('chatMessages');
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ai-message';
        const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        messageDiv.id = messageId;
        
        // Avatar
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.innerHTML = '<i class="fas fa-scale-balanced"></i>';
        avatar.style.background = 'linear-gradient(135deg, var(--secondary) 0%, #5e35b1 100%)';
        
        // Message content
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        
        const messageText = document.createElement('div');
        messageText.className = 'message-text streaming-content';
        messageText.innerHTML = '<span class="streaming-cursor"></span>';
        
        messageContent.appendChild(messageText);
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(messageContent);
        chatMessages.appendChild(messageDiv);
        
        // Set as current streaming message
        currentStreamingMessageId = messageId;
        currentStreamingContent = '';
        currentStreamingBuffer = '';
        streamingTextChunks = [];
        streamingTextIndex = 0;
        
        // Add streaming controls
        const streamControls = document.createElement('div');
        streamControls.className = 'stream-controls';
        streamControls.innerHTML = `
            <button class="stream-control-btn pause-btn" id="pause-${messageId}" onclick="toggleStreamPause('${messageId}')">
                <i class="fas fa-pause"></i> Pause
            </button>
            <button class="stream-control-btn copy-btn" onclick="copyStreamedContent('${messageId}')">
                <i class="fas fa-copy"></i> Copy
            </button>
        `;
        messageContent.appendChild(streamControls);
        
        // Check scroll position
        setTimeout(checkScrollPosition, 100);
        
        return messageId;
    }
    
    // Start streaming response word by word
    function startStreamingResponse(messageId, response, isDocument = false, language = 'english') {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;
        
        let textToStream = response;
        streamingTextChunks = splitTextIntoChunks(textToStream);
        streamingTextIndex = 0;
        
        streamNextChunk(messageId, isDocument, language);
    }
    
    // Split text into chunks for streaming
    function splitTextIntoChunks(text) {
        const chunks = [];
        const regex = /[\s.,;!?]+|\S+/g;
        let match;
        
        while ((match = regex.exec(text)) !== null) {
            chunks.push(match[0]);
        }
        
        return chunks;
    }
    
    // Stream next chunk of text
    function streamNextChunk(messageId, isDocument = false, language = 'english') {
        if (stopStreamingRequested || streamingTextIndex >= streamingTextChunks.length) {
            if (stopStreamingRequested) {
                console.log('Streaming stopped by user');
            } else {
                finalizeStreamingMessage(messageId, isDocument, language);
            }
            return;
        }
        
        const chunk = streamingTextChunks[streamingTextIndex];
        streamingTextIndex++;
        
        updateStreamingMessage(messageId, chunk, isDocument, language);
        
        let delay = streamingWordDelay;
        
        if (chunk.match(/[.,;!?]/)) {
            delay += streamingPunctuationDelay;
        }
        
        if (chunk.match(/[.!?]/)) {
            delay += 150;
        }
        
        setTimeout(() => {
            if (!isStreamingPaused && !stopStreamingRequested) {
                streamNextChunk(messageId, isDocument, language);
            }
        }, delay);
    }
    
    // Toggle stream pause
    window.toggleStreamPause = function(messageId) {
        isStreamingPaused = !isStreamingPaused;
        const pauseBtn = document.getElementById(`pause-${messageId}`);
        const messageDiv = document.getElementById(messageId);
        
        if (isStreamingPaused) {
            pauseBtn.innerHTML = '<i class="fas fa-play"></i> Continue';
            pauseBtn.style.background = 'var(--success)';
            pauseBtn.style.borderColor = 'var(--success)';
            pauseBtn.style.color = 'white';
            
            const messageText = messageDiv.querySelector('.message-text');
            const existingIndicator = messageText.querySelector('.paused-indicator');
            if (!existingIndicator) {
                const indicator = document.createElement('span');
                indicator.className = 'paused-indicator';
                indicator.textContent = 'Paused';
                messageText.appendChild(indicator);
            }
        } else {
            pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
            pauseBtn.style.background = '';
            pauseBtn.style.borderColor = '';
            pauseBtn.style.color = '';
            
            const messageText = messageDiv.querySelector('.message-text');
            const existingIndicator = messageText.querySelector('.paused-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            setTimeout(() => {
                streamNextChunk(messageId, isDocumentRequest(currentStreamingContent));
            }, 100);
        }
    };
    
    // Copy streamed content
    window.copyStreamedContent = function(messageId) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;
        
        const messageText = messageDiv.querySelector('.message-text');
        const textToCopy = messageText.textContent.replace('Paused', '').trim();
        
        navigator.clipboard.writeText(textToCopy).then(() => {
        }).catch(err => {
            console.error('Copy failed:', err);
        });
    };
    
    // Update streaming message with new content
    function updateStreamingMessage(messageId, newContent, isDocument = false, language = 'english') {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;
        
        const messageText = messageDiv.querySelector('.message-text');
        
        currentStreamingBuffer += newContent;
        currentStreamingContent += newContent;
        
        if (isDocument) {
            messageText.innerHTML = formatDocumentResponse(currentStreamingContent) + '<span class="streaming-cursor"></span>';
        } else {
            messageText.innerHTML = formatStreamingText(currentStreamingBuffer) + '<span class="streaming-cursor"></span>';
        }
        
        checkScrollPosition();
    }
    
    // Finalize streaming message with language-specific footer
    function finalizeStreamingMessage(messageId, isDocument = false, language = 'english') {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;
        
        const messageText = messageDiv.querySelector('.message-text');
        
        const cursor = messageText.querySelector('.streaming-cursor');
        if (cursor) cursor.remove();
        
        const pausedIndicator = messageText.querySelector('.paused-indicator');
        if (pausedIndicator) pausedIndicator.remove();
        
        if (isDocument) {
            messageText.innerHTML = formatDocumentResponse(currentStreamingContent);
            addDocumentDownloadButton(messageId, currentStreamingContent);
        } else {
            messageText.innerHTML = formatLegalResponse(currentStreamingContent);
        }
        
        // Add AI response footer (Responded by LegalSwami)
        const aiFooter = document.createElement('div');
        aiFooter.className = 'ai-response-footer';
        
        // Set footer text based on language
        let footerText = '';
        if (language === 'hindi') {
            footerText = 'LegalSwami    ';
        } else if (language === 'marathi') {
            footerText = 'LegalSwami   ';
        } else {
            footerText = 'Responded by LegalSwami';
        }
        
        aiFooter.innerHTML = `
            <i class="fas fa-robot"></i>
            <span class="ai-signature">${footerText}</span>
            <span style="margin-left: auto; font-size: 0.75rem;">
                <i class="fas fa-clock"></i> ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
            </span>
        `;
        
        messageText.parentElement.appendChild(aiFooter);
        
        // Add action buttons
        const messageActions = document.createElement('div');
        messageActions.className = 'message-actions';
        messageActions.innerHTML = `
            <button class="action-btn copy" onclick="copyMessage(this)" title="Copy response">
                <i class="fas fa-copy"></i> Copy
            </button>
            <button class="action-btn regenerate" onclick="regenerateResponse('${messageId}')" title="Regenerate response">
                <i class="fas fa-sync-alt"></i> Regenerate
            </button>
            <button class="action-btn like" onclick="likeMessage(this)" title="Mark as helpful">
                <i class="far fa-thumbs-up"></i> Helpful
            </button>
            <button class="action-btn dislike" onclick="dislikeMessage(this)" title="Mark as not helpful">
                <i class="far fa-thumbs-down"></i> Not Helpful
            </button>
            <button class="action-btn share" onclick="shareResponse('${messageId}')" title="Share response">
                <i class="fas fa-share"></i> Share
            </button>
            <button class="action-btn document" onclick="downloadThisMessage('${messageId}')" title="Download document">
                <i class="fas fa-file-download"></i> Download
            </button>
        `;
        
        messageText.parentElement.appendChild(messageActions);
        
        const streamControls = messageDiv.querySelector('.stream-controls');
        if (streamControls) {
            streamControls.remove();
        }
        
        if (attachedFiles.length > 0) {
            showAttachedFilesBelowResponse(messageId);
        }
        
        currentStreamingMessageId = null;
        currentStreamingContent = '';
        currentStreamingBuffer = '';
        streamingTextChunks = [];
        streamingTextIndex = 0;
        isStreamingPaused = false;
        isStreamingActive = false;
        stopStreamingRequested = false;
        
        // Reset send button
        const sendButton = document.getElementById('sendButton');
        sendButton.disabled = document.getElementById('userInput').value.trim() === '' && attachedFiles.length === 0;
        sendButton.classList.remove('stop-button');
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> <span class="hide-on-mobile">Send</span>';
    }
    
    // Show attached files below AI response
    function showAttachedFilesBelowResponse(messageId) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv || attachedFiles.length === 0) return;
        
        const messageContent = messageDiv.querySelector('.message-content');
        const attachmentsContainer = document.createElement('div');
        attachmentsContainer.className = 'message-attachments';
        
        attachedFiles.forEach((attachment, index) => {
            const attachmentItem = document.createElement('div');
            attachmentItem.className = 'attachment-item';
            
            attachmentItem.innerHTML = `
                <img src="${attachment.data}" alt="${attachment.name}" class="attachment-image">
                <div class="attachment-name">${attachment.name}</div>
            `;
            
            attachmentsContainer.appendChild(attachmentItem);
        });
        
        const messageText = messageContent.querySelector('.message-text');
        messageContent.insertBefore(attachmentsContainer, messageText.nextSibling);
        
        clearAttachments();
    }
    
    // Add document download button to message
    function addDocumentDownloadButton(messageId, content) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;
        
        const messageContent = messageDiv.querySelector('.message-content');
        const existingBtn = messageContent.querySelector('.document-download-btn');
        
        if (existingBtn) return;
        
        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'document-download-btn';
        downloadBtn.innerHTML = '<i class="fas fa-file-download"></i> Download Document';
        downloadBtn.title = 'Download this document template';
        
        downloadBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openMessageDownloadModal(content);
        });
        
        messageContent.appendChild(downloadBtn);
    }
    
    // Copy message function
    window.copyMessage = function(button) {
        const messageText = button.closest('.message-content').querySelector('.message-text');
        let textToCopy = messageText.innerText || messageText.textContent;
        
        const textarea = document.createElement('textarea');
        textarea.value = textToCopy;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        textarea.setSelectionRange(0, 99999);
        
        try {
            document.execCommand('copy');
        } catch (err) {
            console.error('Copy failed:', err);
        }
        
        document.body.removeChild(textarea);
    };
    
    // Like message function
    window.likeMessage = function(button) {
        button.innerHTML = '<i class="fas fa-thumbs-up"></i> Thank you!';
        button.style.background = 'var(--success)';
        button.style.borderColor = 'var(--success)';
        button.style.color = 'white';
        button.disabled = true;
    };
    
    // Download this specific message
    window.downloadThisMessage = function(messageId) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;
        
        const messageText = messageDiv.querySelector('.message-text');
        const content = messageText.innerText || messageText.textContent;
        
        openMessageDownloadModal(content);
    };
    
    // Clear current chat
    function clearCurrentChat() {
        if (conversationHistory.length === 0 && attachedFiles.length === 0) {
            return;
        }
        
        if (confirm('Are you sure you want to clear the current chat?')) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            conversationHistory = [];
            clearAttachments();
            
            createNewChat();
        }
    }
    
    // Check scroll position and show/hide down arrow
    function checkScrollPosition() {
        const chatMessages = document.getElementById('chatMessages');
        const scrollBtn = document.getElementById('scrollToBottomBtn');
        
        if (!chatMessages) return;
        
        const isAtBottom = chatMessages.scrollHeight - chatMessages.clientHeight <= chatMessages.scrollTop + 50;
        
        if (!isAtBottom) {
            scrollBtn.classList.add('visible');
        } else {
            scrollBtn.classList.remove('visible');
        }
        
        scrollPosition = chatMessages.scrollTop;
    }
    
    // Scroll to bottom function
    function scrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });
            document.getElementById('scrollToBottomBtn').classList.remove('visible');
        }
    }
    
    // Add copy and edit buttons to user messages
    function addCopyEditButtonsToUserMessages() {
        const userMessages = document.querySelectorAll('.user-message:not(.from-history) .message-content');
        userMessages.forEach((messageContent, index) => {
            if (!messageContent.querySelector('.user-message-controls')) {
                const messageDiv = messageContent.closest('.message');
                const messageId = messageDiv.id;
                const messageText = messageContent.querySelector('.message-text');
                
                if (messageText && messageText.textContent.trim()) {
                    const controlsContainer = document.createElement('div');
                    controlsContainer.className = 'user-message-controls';
                    
                    // Create copy button
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'user-message-btn copy-btn';
                    copyBtn.title = 'Copy question';
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i><span class="hide-on-mobile">Copy</span>';
                    copyBtn.addEventListener('click', () => copyUserMessage(messageId));
                    
                    // Create edit button
                    const editBtn = document.createElement('button');
                    editBtn.className = 'user-message-btn edit-btn';
                    editBtn.title = 'Edit question';
                    editBtn.innerHTML = '<i class="fas fa-pencil-alt"></i><span class="hide-on-mobile">Edit</span>';
                    editBtn.addEventListener('click', () => editUserMessage(messageId));
                    
                    // Add buttons to container
                    controlsContainer.appendChild(copyBtn);
                    controlsContainer.appendChild(editBtn);
                    
                    messageContent.appendChild(controlsContainer);
                }
            }
        });
    }
    
    function loadThemePreference() {
        const savedTheme = localStorage.getItem('legalSwamiTheme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
            document.querySelector('.theme-toggle i').className = 'fas fa-moon';
            isLightMode = true;
        }
    }
    
    function toggleTheme() {
        const themeIcon = document.querySelector('.theme-toggle i');
        if (isLightMode) {
            document.body.classList.remove('light-mode');
            themeIcon.className = 'fas fa-sun';
            localStorage.setItem('legalSwamiTheme', 'dark');
            isLightMode = false;
        } else {
            document.body.classList.add('light-mode');
            themeIcon.className = 'fas fa-moon';
            localStorage.setItem('legalSwamiTheme', 'light');
            isLightMode = true;
        }
    }
    
    function createNewChat() {
        // Save current chat before creating new one
        if (currentChatId && conversationHistory.length > 0) {
            saveCurrentChat();
        }
        
        currentChatId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        conversationHistory = [];
        
        const chatMessages = document.getElementById('chatMessages');
        const welcomeContainer = document.createElement('div');
        welcomeContainer.innerHTML = WELCOME_MESSAGE_HTML;
        chatMessages.innerHTML = '';
        chatMessages.appendChild(welcomeContainer);
        
        addDraftTemplateListeners();
        clearAttachments();
        
        // Update history list to show new chat
        loadHistoryList();
        
        // Close sidebar on mobile
        if (window.innerWidth < 1024) {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }
    }
    
    function toggleInputVoiceRecognition() {
        if (!recognition) return;
        
        if (isListening && isInputMicrophoneActive) {
            recognition.stop();
        } else {
            isInputMicrophoneActive = true;
            recognition.start();
        }
    }
    
    function adjustChatLayout() {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }
    }
    
    function clearAttachments() {
        attachedFiles = [];
        const preview = document.getElementById('attachmentsPreview');
        if (preview) {
            preview.innerHTML = '';
            preview.style.display = 'none';
        }
    }
    
    function openFileUploadModal() {
        document.getElementById('fileUploadModal').classList.add('active');
        selectedFiles = [];
        updateUploadedFilesDisplay();
    }
    
    function updateUploadedFilesDisplay() {
        const container = document.getElementById('uploadedFiles');
        if (!container) return;
        
        container.innerHTML = '';
        
        selectedFiles.forEach((file, index) => {
            const item = document.createElement('div');
            item.className = 'uploaded-image-item';
            
            if (file.type.startsWith('image/')) {
                item.innerHTML = `
                    <img src="${file.data}" alt="${file.name}" class="uploaded-image-preview">
                    <button class="remove-uploaded-image" onclick="removeUploadedFile(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            } else if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
                item.innerHTML = `
                    <div style="padding: 12px; text-align: center; background: var(--dark-surface-light); height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <i class="fas fa-file-pdf" style="font-size: 1.8rem; color: var(--error); margin-bottom: 6px;"></i>
                        <div style="font-size: 0.65rem; color: var(--dark-text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">${file.name}</div>
                    </div>
                    <button class="remove-uploaded-image" onclick="removeUploadedFile(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                item.innerHTML = `
                    <div style="padding: 12px; text-align: center; background: var(--dark-surface-light); height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <i class="fas fa-file-alt" style="font-size: 1.8rem; color: var(--primary); margin-bottom: 6px;"></i>
                        <div style="font-size: 0.65rem; color: var(--dark-text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">${file.name}</div>
                    </div>
                    <button class="remove-uploaded-image" onclick="removeUploadedFile(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            } else {
                item.innerHTML = `
                    <div style="padding: 12px; text-align: center; background: var(--dark-surface-light); height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <i class="fas fa-file" style="font-size: 1.8rem; color: var(--dark-text-secondary); margin-bottom: 6px;"></i>
                        <div style="font-size: 0.65rem; color: var(--dark-text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">${file.name}</div>
                    </div>
                    <button class="remove-uploaded-image" onclick="removeUploadedFile(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            }
            
            container.appendChild(item);
        });
    }
    
    window.removeUploadedFile = function(index) {
        selectedFiles.splice(index, 1);
        updateUploadedFilesDisplay();
    };
    
    // Close file upload modal
    document.getElementById('closeFileUploadModal').addEventListener('click', function() {
        document.getElementById('fileUploadModal').classList.remove('active');
    });
    
    document.getElementById('cancelFileUpload').addEventListener('click', function() {
        document.getElementById('fileUploadModal').classList.remove('active');
    });
    
    // Handle file selection
    document.getElementById('browseFilesBtn').addEventListener('click', function() {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.multiple = true;
        fileInput.accept = 'image/*,.pdf,.txt,.doc,.docx';
        
        fileInput.onchange = function(e) {
            handleFileSelection(e.target.files);
        };
        
        fileInput.click();
    });
    
    // Handle drag and drop
    const uploadArea = document.getElementById('uploadArea');
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        if (e.dataTransfer.files.length > 0) {
            handleFileSelection(e.dataTransfer.files);
        }
    });
    
    function handleFileSelection(files) {
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (file.type.startsWith('image/') || 
                file.type === 'application/pdf' || 
                file.type === 'text/plain' ||
                file.type.includes('document') ||
                file.name.endsWith('.txt') ||
                file.name.endsWith('.pdf') ||
                file.name.endsWith('.doc') ||
                file.name.endsWith('.docx')) {
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedFiles.push({
                        name: file.name,
                        data: e.target.result,
                        type: file.type,
                        file: file,
                        size: file.size
                    });
                    updateUploadedFilesDisplay();
                };
                reader.readAsDataURL(file);
            }
        }
    }
    
    // Confirm file upload
    document.getElementById('confirmFileUpload').addEventListener('click', function() {
        if (selectedFiles.length === 0) {
            return;
        }
        
        attachedFiles = [...attachedFiles, ...selectedFiles];
        
        const preview = document.getElementById('attachmentsPreview');
        preview.innerHTML = '';
        
        attachedFiles.forEach((file, index) => {
            const item = document.createElement('div');
            item.className = 'attachment-preview-item';
            
            if (file.type.startsWith('image/')) {
                item.innerHTML = `
                    <img src="${file.data}" alt="${file.name}" class="attachment-preview-image">
                    <button class="remove-attachment" onclick="removeAttachment(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="attachment-preview-name">${file.name}</div>
                `;
            } else if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
                item.innerHTML = `
                    <div style="padding: 8px; text-align: center; background: var(--dark-surface-light); height: 70px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <i class="fas fa-file-pdf" style="font-size: 1.3rem; color: var(--error);"></i>
                        <div style="font-size: 0.55rem; color: var(--dark-text-secondary); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">PDF</div>
                    </div>
                    <button class="remove-attachment" onclick="removeAttachment(${index})" style="top: 2px; right: 2px;">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="attachment-preview-name">${file.name.substring(0, 12)}${file.name.length > 12 ? '...' : ''}</div>
                `;
            } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                item.innerHTML = `
                    <div style="padding: 8px; text-align: center; background: var(--dark-surface-light); height: 70px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <i class="fas fa-file-alt" style="font-size: 1.3rem; color: var(--primary);"></i>
                        <div style="font-size: 0.55rem; color: var(--dark-text-secondary); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">TXT</div>
                    </div>
                    <button class="remove-attachment" onclick="removeAttachment(${index})" style="top: 2px; right: 2px;">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="attachment-preview-name">${file.name.substring(0, 12)}${file.name.length > 12 ? '...' : ''}</div>
                `;
            }else {
                item.innerHTML = `
                    <div style="padding: 8px; text-align: center; background: var(--dark-surface-light); height: 70px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <i class="fas fa-file" style="font-size: 1.3rem; color: var(--dark-text-secondary);"></i>
                        <div style="font-size: 0.55rem; color: var(--dark-text-secondary); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">DOC</div>
                    </div>
                    <button class="remove-attachment" onclick="removeAttachment(${index})" style="top: 2px; right: 2px;">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="attachment-preview-name">${file.name.substring(0, 12)}${file.name.length > 12 ? '...' : ''}</div>
                `;
            }
            
            preview.appendChild(item);
        });
        
        preview.style.display = 'flex';
        document.getElementById('sendButton').disabled = false;
        document.getElementById('fileUploadModal').classList.remove('active');
        selectedFiles = [];
    });
    
    window.removeAttachment = function(index) {
        attachedFiles.splice(index, 1);
        
        const preview = document.getElementById('attachmentsPreview');
        preview.innerHTML = '';
        
        if (attachedFiles.length === 0) {
            preview.style.display = 'none';
            document.getElementById('sendButton').disabled = document.getElementById('userInput').value.trim() === '';
        } else {
            attachedFiles.forEach((file, idx) => {
                const item = document.createElement('div');
                item.className = 'attachment-preview-item';
                
                if (file.type.startsWith('image/')) {
                    item.innerHTML = `
                        <img src="${file.data}" alt="${file.name}" class="attachment-preview-image">
                        <button class="remove-attachment" onclick="removeAttachment(${idx})">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="attachment-preview-name">${file.name}</div>
                    `;
                } else if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
                    item.innerHTML = `
                        <div style="padding: 8px; text-align: center; background: var(--dark-surface-light); height: 70px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <i class="fas fa-file-pdf" style="font-size: 1.3rem; color: var(--error);"></i>
                            <div style="font-size: 0.55rem; color: var(--dark-text-secondary); margin-top: 4px;">PDF</div>
                        </div>
                        <button class="remove-attachment" onclick="removeAttachment(${idx})" style="top: 2px; right: 2px;">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="attachment-preview-name">${file.name.substring(0, 12)}${file.name.length > 12 ? '...' : ''}</div>
                    `;
                } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                    item.innerHTML = `
                        <div style="padding: 8px; text-align: center; background: var(--dark-surface-light); height: 70px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <i class="fas fa-file-alt" style="font-size: 1.3rem; color: var(--primary);"></i>
                            <div style="font-size: 0.55rem; color: var(--dark-text-secondary); margin-top: 4px;">TXT</div>
                        </div>
                        <button class="remove-attachment" onclick="removeAttachment(${idx})" style="top: 2px; right: 2px;">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="attachment-preview-name">${file.name.substring(0, 12)}${file.name.length > 12 ? '...' : ''}</div>
                    `;
                } else {
                    item.innerHTML = `
                        <div style="padding: 8px; text-align: center; background: var(--dark-surface-light); height: 70px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <i class="fas fa-file" style="font-size: 1.3rem; color: var(--dark-text-secondary);"></i>
                            <div style="font-size: 0.55rem; color: var(--dark-text-secondary); margin-top: 4px;">DOC</div>
                        </div>
                        <button class="remove-attachment" onclick="removeAttachment(${idx})" style="top: 2px; right: 2px;">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="attachment-preview-name">${file.name.substring(0, 12)}${file.name.length > 12 ? '...' : ''}</div>
                    `;
                }
                
                preview.appendChild(item);
            });
            preview.style.display = 'flex';
        }
    };
    
    // Load history list
    function loadHistoryList() {
        const historyList = document.getElementById('historyList');
        if (!historyList) return;
        
        if (chatHistory.length === 0) {
            historyList.innerHTML = `
                <div class="empty-history">
                    <i class="fas fa-comments"></i>
                    <p>No chat history yet</p>
                    <p style="font-size: 0.75rem; margin-top: 0.4rem;">Start a conversation to see it here</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        chatHistory.forEach(chat => {
            const isActive = chat.id === currentChatId;
            const date = new Date(chat.date);
            const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            html += `
                <div class="history-item ${isActive ? 'active' : ''}" data-chat-id="${chat.id}">
                    <div class="history-title">${chat.title}</div>
                    <div class="history-preview">${chat.preview}</div>
                    <div class="history-date">${formattedDate}</div>
                    <div class="history-item-actions">
                        <button class="history-item-btn download" onclick="downloadChatHistory('${chat.id}')" title="Download chat">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="history-item-btn delete" onclick="confirmDeleteChat('${chat.id}')" title="Delete chat">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        historyList.innerHTML = html;
        
        document.querySelectorAll('.history-item').forEach(item => {
            item.addEventListener('click', function(e) {
                if (!e.target.closest('.history-item-actions')) {
                    const chatId = this.dataset.chatId;
                    loadChatFromHistory(chatId);
                }
            });
        });
    }
    
    function loadChatFromHistory(chatId) {
        const chat = chatHistory.find(c => c.id === chatId);
        if (!chat) return;
        
        currentChatId = chatId;
        conversationHistory = [...chat.messages];
        
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = '';
        
        chat.messages.forEach(msg => {
            const isDocument = msg.isDocument || false;
            const hasSources = msg.sources && msg.sources.length > 0;
            addMessageToChat(msg.content, msg.role === 'user', true, isDocument, msg.attachments || [], hasSources ? msg.sources : null, msg.language || 'english');
        });
        
        loadHistoryList();
        
        if (window.innerWidth < 1024) {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }
    }
    
    window.downloadChatHistory = function(chatId) {
        const chat = chatHistory.find(c => c.id === chatId);
        if (!chat) return;
        
        let content = `LegalSwami Chat History - ${chat.title}\n`;
        content += `Date: ${new Date(chat.date).toLocaleString()}\n\n`;
        content += '='.repeat(50) + '\n\n';
        
        chat.messages.forEach((msg, index) => {
            const role = msg.role === 'user' ? 'You' : 'LegalSwami';
            const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
            content += `${role} (${time}):\n`;
            content += msg.content + '\n\n';
            content += '-'.repeat(30) + '\n\n';
        });
        
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `legalswami-chat-${chatId}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showDownloadNotification(`legalswami-chat-${chatId}.txt`, 'Text File');
    };
    
    window.confirmDeleteChat = function(chatId) {
        const chat = chatHistory.find(c => c.id === chatId);
        if (!chat) return;
        
        document.getElementById('deleteChatTitle').textContent = `Delete "${chat.title}"?`;
        document.getElementById('deleteModal').dataset.chatId = chatId;
        document.getElementById('deleteModal').classList.add('active');
    };
    
    // Delete chat confirmation
    document.getElementById('confirmDelete').addEventListener('click', function() {
        const chatId = document.getElementById('deleteModal').dataset.chatId;
        const chatIndex = chatHistory.findIndex(chat => chat.id === chatId);
        
        if (chatIndex !== -1) {
            if (currentChatId === chatId) {
                createNewChat();
            }
            
            chatHistory.splice(chatIndex, 1);
            saveUserChatHistory();
            loadHistoryList();
            document.getElementById('deleteModal').classList.remove('active');
        }
    });
    
    document.getElementById('cancelDelete').addEventListener('click', function() {
        document.getElementById('deleteModal').classList.remove('active');
    });
    
    document.getElementById('closeDeleteModal').addEventListener('click', function() {
        document.getElementById('deleteModal').classList.remove('active');
    });
    
    // Download modal functions
    function openDownloadModal() {
        document.getElementById('downloadModal').classList.add('active');
    }
    
    function openMessageDownloadModal(content) {
        messageContentForDownload = content;
        document.getElementById('messageDownloadModal').classList.add('active');
    }
    
    // Close download modals
    document.getElementById('closeDownloadModal').addEventListener('click', function() {
        document.getElementById('downloadModal').classList.remove('active');
    });
    
    document.getElementById('closeMessageDownloadModal').addEventListener('click', function() {
        document.getElementById('messageDownloadModal').classList.remove('active');
    });
    
    // Handle download option clicks
    document.querySelectorAll('.download-option').forEach(option => {
        option.addEventListener('click', function() {
            const format = this.dataset.format;
            const isMessageModal = this.closest('#messageDownloadModal') !== null;
            
            if (isMessageModal) {
                downloadMessage(format, messageContentForDownload);
            } else {
                downloadChat(format);
            }
        });
    });
    
    function downloadMessage(format, content) {
        const indicator = document.getElementById('messageProgressIndicator');
        indicator.classList.add('active');
        
        setTimeout(() => {
            const fileName = `LegalSwami-Document-${formatDateForFilename(new Date())}`;
            
            switch(format) {
                case 'pdf':
                    downloadAsPDF(content, fileName);
                    break;
                case 'doc':
                    downloadAsDOC(content, fileName);
                    break;
                case 'txt':
                    downloadAsTXT(content, fileName);
                    break;
            }
            
            indicator.classList.remove('active');
            document.getElementById('messageDownloadModal').classList.remove('active');
        }, 500);
    }
    
    function downloadChat(format) {
        const indicator = document.getElementById('progressIndicator');
        indicator.classList.add('active');
        
        setTimeout(() => {
            let content = '';
            conversationHistory.forEach((msg, index) => {
                const role = msg.role === 'user' ? 'You' : 'LegalSwami';
                const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
                content += `${role} (${time}):\n${msg.content}\n\n`;
            });
            
            const fileName = `LegalSwami-Chat-${formatDateForFilename(new Date())}`;
            
            switch(format) {
                case 'pdf':
                    downloadAsPDF(content, fileName);
                    break;
                case 'doc':
                    downloadAsDOC(content, fileName);
                    break;
                case 'txt':
                    downloadAsTXT(content, fileName);
                    break;
            }
            
            indicator.classList.remove('active');
            document.getElementById('downloadModal').classList.remove('active');
        }, 500);
    }
    
    function downloadAsPDF(content, filename) {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Enable UTF-8 support
            doc.setFont("helvetica");
            doc.setFontSize(12);
            
            // Split content into lines
            const lines = doc.splitTextToSize(content, 180);
            
            // Add content with proper encoding
            let y = 20;
            for (let i = 0; i < lines.length; i++) {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(lines[i], 10, y);
                y += 7;
            }
            
            // Add footer
            doc.setFontSize(10);
            doc.text('Generated by LegalSwami AI Assistant', 10, 280);
            
            const blob = doc.output('blob');
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            lastDownloadedFileUrl = url;
            lastDownloadedFileName = `${filename}.pdf`;
            showDownloadNotification(`${filename}.pdf`, 'PDF Document');
        } catch (error) {
            console.error('PDF generation error:', error);
            // Fallback to TXT if PDF fails
            downloadAsTXT(content, filename);
        }
    }
    
    function downloadAsDOC(content, filename) {
        const htmlContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>${filename}</title>
                <style>
                    body { font-family: Arial, sans-serif; line-height: 1.6; margin: 40px; }
                    h1 { color: #10a37f; }
                    .timestamp { color: #666; font-size: 0.9em; }
                    .user { color: #10a37f; font-weight: bold; }
                    .ai { color: #7e57c2; font-weight: bold; }
                    .disclaimer { 
                        background-color: #f8f9fa; 
                        border-left: 4px solid #f59e0b;
                        padding: 10px;
                        margin-top: 20px;
                        font-size: 0.9em;
                    }
                </style>
            </head>
            <body>
                <h1>${filename}</h1>
                <p class="timestamp">Generated on: ${new Date().toLocaleString()}</p>
                <hr>
                <pre style="white-space: pre-wrap; font-family: inherit;">${content}</pre>
                <div class="disclaimer">
                    <strong>Disclaimer:</strong> This document is generated by LegalSwami AI Assistant for informational purposes only and does not constitute legal advice.
                </div>
            </body>
            </html>
        `;
        
        const blob = new Blob([htmlContent], { type: 'application/msword' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}.doc`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        lastDownloadedFileUrl = url;
        lastDownloadedFileName = `${filename}.doc`;
        showDownloadNotification(`${filename}.doc`, 'Word Document');
    }
    
    function downloadAsTXT(content, filename) {
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        lastDownloadedFileUrl = url;
        lastDownloadedFileName = `${filename}.txt`;
        showDownloadNotification(`${filename}.txt`, 'Text File');
    }
    
    // Format date for filename
    function formatDateForFilename(date) {
        return date.toISOString()
            .replace(/[:\-]/g, '')
            .replace('T', '_')
            .split('.')[0];
    }
    
    // Force guest login on page load
    window.addEventListener('DOMContentLoaded', function() {
        console.log("DOM loaded, checking for guest mode...");
        
        // Wait a moment then auto-login as guest
        setTimeout(function() {
            if (!isLoggedIn && !document.getElementById('loginModal').classList.contains('active')) {
                console.log("Auto-initializing guest mode...");
                initializeAppForGuest();
            }
        }, 1000);
        
        // Also add direct button binding
        const guestBtn = document.getElementById('guestLoginBtn');
        if (guestBtn) {
            guestBtn.addEventListener('click', function() {
                console.log("Guest button clicked!");
                initializeAppForGuest();
            });
        }
    });
</script>
</body>
</html>
