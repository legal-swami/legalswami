<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LegalSwami | AI-Powered Legal Assistant & Document Generator</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/chat.css">
    <link rel="stylesheet" href="css/responsive.css">
    
    <!-- Google Client ID -->
    <meta name="google-client-id" 
          content="166511615962-bohur5q8d4i5hud6icr4185kcte9enk8.apps.googleusercontent.com">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚖️</text></svg>">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#0f172a">
    
    <!-- Apple Mobile Web App Capable -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Open Graph / Social Media -->
    <meta property="og:title" content="LegalSwami - AI Legal Assistant">
    <meta property="og:description" content="Get instant legal advice, generate documents, and understand laws with AI">
    <meta property="og:image" content="https://legalswami.com/og-image.jpg">
    <meta property="og:url" content="https://legalswami.com">
    
    <style>
    /* ChatGPT-like Colors */
:root {
    /* Dark Mode (ChatGPT-like) */
    --dark-bg: #343541;
    --dark-surface: #40414f;
    --dark-surface-light: #444654;
    --dark-border: #565869;
    --dark-text: #ececf1;
    --dark-text-secondary: #8e8ea0;
    --dark-text-tertiary: #6e6e80;
    
    /* Light Mode (ChatGPT-like) */
    --light-bg: #ffffff;
    --light-surface: #f7f7f8;
    --light-surface-light: #f0f0f0;
    --light-border: #e5e5e5;
    --light-text: #000000;
    --light-text-secondary: #6e6e80;
    --light-text-tertiary: #8e8ea0;
}

/* ChatGPT-like Container */
.container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    width: 100%;
    background: var(--dark-bg);
    overflow: hidden;
    transition: all 0.2s ease;
    position: relative;
}

.light-mode .container {
    background: var(--light-bg);
}

/* ChatGPT-like Header */
header {
    background: var(--dark-surface);
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--dark-border);
    position: sticky;
    top: 0;
    z-index: 1000;
    min-height: 60px;
    transition: all 0.2s ease;
    width: 100%;
    flex-shrink: 0;
}

.light-mode header {
    background: var(--light-surface);
    border-bottom-color: var(--light-border);
}

/* ChatGPT-like Main Layout */
.main-content {
    display: flex;
    flex: 1;
    overflow: hidden;
    position: relative;
    width: 100%;
    min-height: 0;
}

/* ChatGPT-like Chat Container */
.chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--dark-bg);
    width: 100%;
    height: 100%;
    min-height: 0;
    overflow: hidden;
}

.light-mode .chat-container {
    background: var(--light-bg);
}

/* ChatGPT-like Message Area */
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1.25rem 1rem;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    min-height: 0;
    width: 100%;
}

/* Message Styles */
.message {
    display: flex;
    gap: 0.75rem;
    max-width: 100%;
    padding: 0 0.75rem;
    animation: fadeIn 0.2s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.user-message {
    background: var(--dark-surface);
    border-radius: 8px;
    padding: 1rem;
    max-width: 100%;
}

.light-mode .user-message {
    background: var(--light-surface);
}

.ai-message {
    background: transparent;
}

.avatar {
    width: 32px;
    height: 32px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
    flex-shrink: 0;
    margin-top: 4px;
}

.message-content {
    flex: 1;
    position: relative;
    width: 100%;
    min-width: 0;
}

.message-text {
    padding: 0;
    border-radius: 0;
    font-size: 0.9375rem;
    line-height: 1.6;
    word-wrap: break-word;
    overflow-wrap: break-word;
    overflow: hidden;
    color: var(--dark-text);
}

.light-mode .message-text {
    color: var(--light-text);
}

/* ChatGPT-like Input Area */
.input-container {
    padding: 0.875rem;
    background: var(--dark-bg);
    border-top: 1px solid var(--dark-border);
    position: sticky;
    bottom: 0;
    z-index: 10;
    transition: all 0.2s ease;
    width: 100%;
    flex-shrink: 0;
}

.light-mode .input-container {
    background: var(--light-bg);
    border-top-color: var(--light-border);
}

.input-area {
    max-width: 800px;
    margin: 0 auto;
    position: relative;
    width: 100%;
}

.input-area textarea {
    width: 100%;
    padding: 0.875rem 6.5rem 0.875rem 1rem;
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 12px;
    color: var(--dark-text);
    font-size: 0.9375rem;
    resize: none;
    min-height: 52px;
    max-height: 150px;
    transition: all 0.2s;
    line-height: 1.5;
    font-family: inherit;
    outline: none;
}

.light-mode .input-area textarea {
    background: var(--light-surface);
    border-color: var(--light-border);
    color: var(--light-text);
}

.input-area textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.1);
}

.input-buttons {
    position: absolute;
    right: 0.75rem;
    bottom: 0.75rem;
    display: flex;
    gap: 6px;
    align-items: center;
}

.send-button {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.5rem 0.875rem;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    min-height: 40px;
    font-size: 0.875rem;
}

.send-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
}

.send-button:disabled {
    background: var(--dark-border);
    cursor: not-allowed;
    opacity: 0.5;
}

.light-mode .send-button:disabled {
    background: var(--light-border);
}

/* Scrollbar Styles */
::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

::-webkit-scrollbar-track {
    background: var(--dark-bg);
}

.light-mode ::-webkit-scrollbar-track {
    background: var(--light-bg);
}

::-webkit-scrollbar-thumb {
    background: var(--dark-border);
    border-radius: 3px;
}

.light-mode ::-webkit-scrollbar-thumb {
    background: var(--light-border);
}

::-webkit-scrollbar-thumb:hover {
    background: var(--dark-surface-light);
}

.light-mode ::-webkit-scrollbar-thumb:hover {
    background: var(--light-surface-light);
}

    </style>
    
</head>
<body>
    <!-- Premium Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner legal-seal">
                <i class="fas fa-gavel"></i>
            </div>
            <h2 class="shimmer-text mt-4">LegalSwami</h2>
            <p class="text-light">Initializing AI Legal Assistant...</p>
            <div class="progress-bar mt-4">
                <div class="progress-fill"></div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Premium Navigation Bar -->
        <nav class="premium-navbar">
            <div class="nav-container">
                <!-- Logo with Animation -->
                <div class="nav-logo">
                    <div class="logo-icon legal-seal">
                        <i class="fas fa-gavel gavel-animation"></i>
                    </div>
                    <div class="logo-text">
                        <h1 class="logo-title shimmer-text">LegalSwami</h1>
                        <p class="logo-subtitle">AI Legal Assistant</p>
                    </div>
                </div>

                <!-- Desktop Navigation -->
                <div class="nav-menu">
                    <a href="#home" class="nav-link active" data-scroll="home">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                    <a href="#features" class="nav-link" data-scroll="features">
                        <i class="fas fa-star"></i>
                        <span>Features</span>
                    </a>
                    <a href="#documents" class="nav-link" data-scroll="documents">
                        <i class="fas fa-file-contract"></i>
                        <span>Documents</span>
                    </a>
                    <a href="#legalDatabase" class="nav-link" data-scroll="legalDatabase">
                        <i class="fas fa-database"></i>
                        <span>Legal Database</span>
                    </a>
                    <a href="#lawyerDirectory" class="nav-link" data-scroll="lawyerDirectory">
                        <i class="fas fa-user-tie"></i>
                        <span>Find Lawyers</span>
                    </a>
                    <a href="#pricing" class="nav-link" data-scroll="pricing">
                        <i class="fas fa-tag"></i>
                        <span>Pricing</span>
                    </a>
                </div>

                <!-- User Actions -->
                <div class="nav-actions">
                    <button id="headerLoginBtn" class="btn-login">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>Login</span>
                    </button>
                    
                    <div id="userProfile" class="user-profile" style="display: none;">
                        <div class="profile-avatar">
                            <div id="userAvatar"></div>
                        </div>
                        <div class="profile-info">
                            <span id="userName" class="profile-name"></span>
                            <span id="userEmail" class="profile-email"></span>
                        </div>
                        <button id="logoutBtn" class="btn-logout">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>

                <!-- Mobile Menu Toggle -->
                <button class="mobile-toggle" id="mobileToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </nav>

        <!-- Mobile Menu -->
        <div class="mobile-menu-overlay" id="mobileMenu">
            <div class="mobile-menu-container">
                <div class="mobile-menu-header">
                    <div class="logo-icon legal-seal">
                        <i class="fas fa-gavel"></i>
                    </div>
                    <button class="mobile-close" id="mobileClose">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mobile-menu-links">
                    <a href="#home" class="mobile-link active">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                    <a href="#features" class="mobile-link">
                        <i class="fas fa-star"></i>
                        <span>Features</span>
                    </a>
                    <a href="#documents" class="mobile-link">
                        <i class="fas fa-file-contract"></i>
                        <span>Documents</span>
                    </a>
                    <a href="#legalDatabase" class="mobile-link">
                        <i class="fas fa-database"></i>
                        <span>Legal Database</span>
                    </a>
                    <a href="#lawyerDirectory" class="mobile-link">
                        <i class="fas fa-user-tie"></i>
                        <span>Find Lawyers</span>
                    </a>
                    <a href="#legalGuides" class="mobile-link">
                        <i class="fas fa-book"></i>
                        <span>Legal Guides</span>
                    </a>
                    <a href="#pricing" class="mobile-link">
                        <i class="fas fa-tag"></i>
                        <span>Pricing</span>
                    </a>
                    <a href="#chat" class="mobile-link" id="mobileStartChat">
                        <i class="fas fa-comments"></i>
                        <span>Start Chat</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Hero Section -->
        <section id="home" class="hero-section">
            <div class="hero-container container">
                <!-- Animated Background Elements -->
                <div class="hero-bg-elements">
                    <div class="floating-element floating-icon-1">
                        <i class="fas fa-balance-scale floating"></i>
                    </div>
                    <div class="floating-element floating-icon-2">
                        <i class="fas fa-gavel floating"></i>
                    </div>
                    <div class="floating-element floating-icon-3">
                        <i class="fas fa-scale-balanced floating"></i>
                    </div>
                </div>
                
                <div class="hero-content">
                    <div class="hero-badge">
                        <span class="badge-text">
                            <i class="fas fa-bolt"></i>
                            AI-POWERED LEGAL ASSISTANT
                        </span>
                    </div>
                    
                    <h1 class="hero-title text-reveal">
                        Get <span class="shimmer-text">Instant Legal Help</span><br>
                        From Your AI Assistant
                    </h1>
                    
                    <p class="hero-subtitle">
                        LegalSwami provides 24/7 AI-powered legal guidance, document generation, 
                        and legal research assistance. Get instant answers to your legal questions 
                        in simple, understandable language.
                    </p>
                    
                    <div class="hero-stats">
                        <div class="stat-item">
                            <div class="stat-number shimmer-text">10,000+</div>
                            <div class="stat-label">Legal Documents Generated</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number shimmer-text">50,000+</div>
                            <div class="stat-label">Legal Questions Answered</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number shimmer-text">99.8%</div>
                            <div class="stat-label">User Satisfaction Rate</div>
                        </div>
                    </div>
                    
                    <div class="hero-actions">
                        <button id="startChatBtn" class="btn-hero-primary btn-premium">
                            <i class="fas fa-comments"></i>
                            <span>Start Free Chat Now</span>
                            <div class="btn-sparkle">
                                <i class="fas fa-sparkle"></i>
                            </div>
                        </button>
                        
                        <button id="watchDemo" class="btn-hero-secondary">
                            <i class="fas fa-play-circle"></i>
                            <span>Watch Demo Video</span>
                        </button>
                    </div>
                    
                    <div class="hero-trust">
                        <div class="trust-label">Trusted by</div>
                        <div class="trust-badges">
                            <div class="trust-badge">
                                <i class="fas fa-university"></i>
                                <span>Law Firms</span>
                            </div>
                            <div class="trust-badge">
                                <i class="fas fa-graduation-cap"></i>
                                <span>Law Students</span>
                            </div>
                            <div class="trust-badge">
                                <i class="fas fa-briefcase"></i>
                                <span>Businesses</span>
                            </div>
                            <div class="trust-badge">
                                <i class="fas fa-users"></i>
                                <span>Individuals</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="hero-illustration">
                    <div class="ai-assistant-card premium-card pulse-glow">
                        <div class="assistant-avatar legal-seal">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h3 class="assistant-title">AI Legal Assistant</h3>
                        <p class="assistant-subtitle">Available 24/7</p>
                        
                        <div class="assistant-features">
                            <div class="feature">
                                <i class="fas fa-check-circle"></i>
                                <span>Instant Responses</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-check-circle"></i>
                                <span>Multi-Language</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-check-circle"></i>
                                <span>Document Generation</span>
                            </div>
                        </div>
                        
                        <button class="btn-assistant" id="heroAssistantBtn">
                            <i class="fas fa-comment-alt"></i>
                            Ask Legal Question
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Scroll Indicator -->
            <div class="scroll-indicator">
                <div class="mouse">
                    <div class="wheel"></div>
                </div>
                <div class="arrow">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section id="features" class="features-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">
                        <span class="shimmer-text">Powerful Features</span> for All Your Legal Needs
                    </h2>
                    <p class="section-subtitle">
                        Everything you need in one comprehensive legal assistant
                    </p>
                </div>
                
                <div class="features-grid">
                    <!-- Feature 1 -->
                    <div class="feature-card premium-card">
                        <div class="feature-icon legal-seal">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h3 class="feature-title">AI Chat Assistant</h3>
                        <p class="feature-description">
                            Ask legal questions in natural language and get instant, accurate responses powered by advanced AI.
                        </p>
                        <div class="feature-tags">
                            <span class="tag">24/7 Available</span>
                            <span class="tag">Multi-Language</span>
                        </div>
                    </div>
                    
                    <!-- Feature 2 -->
                    <div class="feature-card premium-card">
                        <div class="feature-icon legal-seal">
                            <i class="fas fa-file-contract"></i>
                        </div>
                        <h3 class="feature-title">Smart Document Generation</h3>
                        <p class="feature-description">
                            Generate legal documents instantly in PDF, DOC, and TXT formats with customizable templates.
                        </p>
                        <div class="feature-tags">
                            <span class="tag">100+ Templates</span>
                            <span class="tag">Customizable</span>
                        </div>
                    </div>
                    
                    <!-- Feature 3 -->
                    <div class="feature-card premium-card">
                        <div class="feature-icon legal-seal">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h3 class="feature-title">Bank-Level Security</h3>
                        <p class="feature-description">
                            End-to-end encryption and secure authentication to protect your sensitive legal data.
                        </p>
                        <div class="feature-tags">
                            <span class="tag">AES-256</span>
                            <span class="tag">GDPR Compliant</span>
                        </div>
                    </div>
                    
                    <!-- Feature 4 -->
                    <div class="feature-card premium-card">
                        <div class="feature-icon legal-seal">
                            <i class="fas fa-history"></i>
                        </div>
                        <h3 class="feature-title">Complete Chat History</h3>
                        <p class="feature-description">
                            Access your complete chat history anytime. Export conversations as documents for record keeping.
                        </p>
                        <div class="feature-tags">
                            <span class="tag">Unlimited History</span>
                            <span class="tag">Export Options</span>
                        </div>
                    </div>
                    
                    <!-- Feature 5 -->
                    <div class="feature-card premium-card">
                        <div class="feature-icon legal-seal">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <h3 class="feature-title">Mobile Responsive</h3>
                        <p class="feature-description">
                            Access LegalSwami from any device - desktop, tablet, or mobile phone with native-like experience.
                        </p>
                        <div class="feature-tags">
                            <span class="tag">PWA Support</span>
                            <span class="tag">Offline Mode</span>
                        </div>
                    </div>
                    
                    <!-- Feature 6 -->
                    <div class="feature-card premium-card">
                        <div class="feature-icon legal-seal">
                            <i class="fas fa-language"></i>
                        </div>
                        <h3 class="feature-title">Multi-Language Support</h3>
                        <p class="feature-description">
                            Get legal advice in multiple languages including Hindi, English, Marathi, Gujarati, and more.
                        </p>
                        <div class="feature-tags">
                            <span class="tag">10+ Languages</span>
                            <span class="tag">Real-time Translation</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Legal Database Section -->
        <section id="legalDatabase" class="database-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">
                        <span class="shimmer-text">Legal Database</span> & Research Tools
                    </h2>
                    <p class="section-subtitle">
                        Access comprehensive legal resources and research materials
                    </p>
                </div>
                
                <div class="database-grid">
                    <!-- Legal Acts Database -->
                    <div class="database-card premium-card">
                        <div class="database-icon">
                            <i class="fas fa-book"></i>
                        </div>
                        <h3 class="database-title">Acts & Statutes</h3>
                        <ul class="database-list">
                            <li><i class="fas fa-search"></i> IPC (Indian Penal Code)</li>
                            <li><i class="fas fa-search"></i> CrPC (Criminal Procedure Code)</li>
                            <li><i class="fas fa-search"></i> CPC (Civil Procedure Code)</li>
                            <li><i class="fas fa-search"></i> Constitution of India</li>
                            <li><i class="fas fa-search"></i> Consumer Protection Act</li>
                        </ul>
                        <button class="btn-database" onclick="searchActs()">
                            <i class="fas fa-search"></i>
                            Search Acts
                        </button>
                    </div>
                    
                    <!-- Case Laws Database -->
                    <div class="database-card premium-card">
                        <div class="database-icon">
                            <i class="fas fa-gavel"></i>
                        </div>
                        <h3 class="database-title">Case Laws Database</h3>
                        <ul class="database-list">
                            <li><i class="fas fa-balance-scale"></i> Supreme Court Judgments</li>
                            <li><i class="fas fa-balance-scale"></i> High Court Judgments</li>
                            <li><i class="fas fa-balance-scale"></i> Landmark Cases</li>
                            <li><i class="fas fa-balance-scale"></i> Recent Judgments</li>
                            <li><i class="fas fa-balance-scale"></i> Case Citations</li>
                        </ul>
                        <button class="btn-database" onclick="searchCaseLaws()">
                            <i class="fas fa-gavel"></i>
                            Search Case Laws
                        </button>
                    </div>
                    
                    <!-- Legal Calculator -->
                    <div class="database-card premium-card">
                        <div class="database-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <h3 class="database-title">Legal Calculators</h3>
                        <ul class="database-list">
                            <li><i class="fas fa-calculator"></i> Court Fee Calculator</li>
                            <li><i class="fas fa-calculator"></i> Stamp Duty Calculator</li>
                            <li><i class="fas fa-calculator"></i> Compensation Calculator</li>
                            <li><i class="fas fa-calculator"></i> Interest Calculator</li>
                            <li><i class="fas fa-calculator"></i> Tax Calculator</li>
                        </ul>
                        <button class="btn-database" onclick="openLegalCalculator()">
                            <i class="fas fa-calculator"></i>
                            Open Calculator
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Document Types Section -->
        <section id="documents" class="documents-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">
                        Generate <span class="shimmer-text">Legal Documents</span> Instantly
                    </h2>
                    <p class="section-subtitle">
                        Professional legal documents at your fingertips
                    </p>
                </div>
                
                <div class="documents-grid">
                    <!-- Document Category 1 -->
                    <div class="document-category premium-card">
                        <div class="category-icon">
                            <i class="fas fa-handshake"></i>
                        </div>
                        <h3 class="category-title">Agreements & Contracts</h3>
                        <ul class="document-list">
                            <li><i class="fas fa-check-circle"></i> Rental Agreement</li>
                            <li><i class="fas fa-check-circle"></i> Non-Disclosure Agreement</li>
                            <li><i class="fas fa-check-circle"></i> Employment Contract</li>
                            <li><i class="fas fa-check-circle"></i> Service Agreement</li>
                            <li><i class="fas fa-check-circle"></i> Partnership Agreement</li>
                        </ul>
                        <button class="btn-generate" onclick="generateDocument('rental-agreement')">
                            <i class="fas fa-magic"></i>
                            Generate Now
                        </button>
                    </div>
                    
                    <!-- Document Category 2 -->
                    <div class="document-category premium-card">
                        <div class="category-icon">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <h3 class="category-title">Legal Notices & Letters</h3>
                        <ul class="document-list">
                            <li><i class="fas fa-check-circle"></i> Legal Notice</li>
                            <li><i class="fas fa-check-circle"></i> Cease & Desist Notice</li>
                            <li><i class="fas fa-check-circle"></i> Demand Letter</li>
                            <li><i class="fas fa-check-circle"></i> Notice to Quit</li>
                            <li><i class="fas fa-check-circle"></i> Consumer Complaint</li>
                        </ul>
                        <button class="btn-generate" onclick="generateDocument('legal-notice')">
                            <i class="fas fa-magic"></i>
                            Generate Now
                        </button>
                    </div>
                    
                    <!-- Document Category 3 -->
                    <div class="document-category premium-card">
                        <div class="category-icon">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <h3 class="category-title">Personal & Family</h3>
                        <ul class="document-list">
                            <li><i class="fas fa-check-circle"></i> Will & Testament</li>
                            <li><i class="fas fa-check-circle"></i> Power of Attorney</li>
                            <li><i class="fas fa-check-circle"></i> Affidavit</li>
                            <li><i class="fas fa-check-circle"></i> Gift Deed</li>
                            <li><i class="fas fa-check-circle"></i> Divorce Papers</li>
                        </ul>
                        <button class="btn-generate" onclick="generateDocument('will-testament')">
                            <i class="fas fa-magic"></i>
                            Generate Now
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Lawyer Directory Section -->
        <section id="lawyerDirectory" class="lawyer-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">
                        Find <span class="shimmer-text">Qualified Lawyers</span>
                    </h2>
                    <p class="section-subtitle">
                        Connect with experienced legal professionals
                    </p>
                </div>
                
                <div class="lawyer-search">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="lawyerSearch" placeholder="Search by specialization, location, or name...">
                        <button class="btn-search" onclick="searchLawyers()">
                            <i class="fas fa-search"></i>
                            Search
                        </button>
                    </div>
                    
                    <div class="specialization-filters">
                        <button class="filter-btn active" data-specialization="all">All</button>
                        <button class="filter-btn" data-specialization="criminal">Criminal</button>
                        <button class="filter-btn" data-specialization="civil">Civil</button>
                        <button class="filter-btn" data-specialization="corporate">Corporate</button>
                        <button class="filter-btn" data-specialization="family">Family</button>
                        <button class="filter-btn" data-specialization="property">Property</button>
                    </div>
                </div>
                
                <div class="lawyers-grid" id="lawyersGrid">
                    <!-- Lawyers will be dynamically loaded here -->
                </div>
            </div>
        </section>

        <!-- Legal Procedure Guides Section -->
        <section id="legalGuides" class="guides-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">
                        <span class="shimmer-text">Step-by-Step</span> Legal Guides
                    </h2>
                    <p class="section-subtitle">
                        Understand legal procedures with easy-to-follow guides
                    </p>
                </div>
                
                <div class="guides-grid">
                    <div class="guide-card premium-card">
                        <div class="guide-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <h3 class="guide-title">How to File a Case</h3>
                        <p class="guide-description">
                            Complete step-by-step guide for filing different types of cases in Indian courts.
                        </p>
                        <div class="guide-steps">
                            <span class="step">1. Document Preparation</span>
                            <span class="step">2. Court Selection</span>
                            <span class="step">3. Fee Payment</span>
                            <span class="step">4. Case Number</span>
                        </div>
                        <button class="btn-guide" onclick="openGuide('file-case')">
                            <i class="fas fa-book-open"></i>
                            View Guide
                        </button>
                    </div>
                    
                    <div class="guide-card premium-card">
                        <div class="guide-icon">
                            <i class="fas fa-file-contract"></i>
                        </div>
                        <h3 class="guide-title">Document Registration Process</h3>
                        <p class="guide-description">
                            Learn how to register legal documents with proper procedures and fees.
                        </p>
                        <div class="guide-steps">
                            <span class="step">1. Stamp Duty</span>
                            <span class="step">2. Witness Arrangement</span>
                            <span class="step">3. Registration Office</span>
                            <span class="step">4. Final Registration</span>
                        </div>
                        <button class="btn-guide" onclick="openGuide('registration')">
                            <i class="fas fa-book-open"></i>
                            View Guide
                        </button>
                    </div>
                    
                    <div class="guide-card premium-card">
                        <div class="guide-icon">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <h3 class="guide-title">Consumer Complaint Process</h3>
                        <p class="guide-description">
                            Guide to filing consumer complaints with proper documentation and procedures.
                        </p>
                        <div class="guide-steps">
                            <span class="step">1. Complaint Drafting</span>
                            <span class="step">2. Evidence Collection</span>
                            <span class="step">3. Forum Selection</span>
                            <span class="step">4. Hearing Process</span>
                        </div>
                        <button class="btn-guide" onclick="openGuide('consumer-complaint')">
                            <i class="fas fa-book-open"></i>
                            View Guide
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Testimonials Section -->
        <section id="testimonials" class="testimonials-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">
                        Trusted by <span class="shimmer-text">Thousands</span> of Users
                    </h2>
                    <p class="section-subtitle">
                        See what our users have to say about LegalSwami
                    </p>
                </div>
                
                <div class="testimonials-carousel">
                    <!-- Testimonial 1 -->
                    <div class="testimonial-card premium-card">
                        <div class="testimonial-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                        </div>
                        <p class="testimonial-text">
                            "LegalSwami helped me draft a professional rental agreement in minutes. The AI understood exactly what I needed and generated a perfect document. Saved me ₹5000 in lawyer fees!"
                        </p>
                        <div class="testimonial-author">
                            <div class="author-avatar">
                                <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Rahul Sharma">
                            </div>
                            <div class="author-info">
                                <h4 class="author-name">Rahul Sharma</h4>
                                <p class="author-title">Small Business Owner</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Testimonial 2 -->
                    <div class="testimonial-card premium-card">
                        <div class="testimonial-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star-half-alt"></i>
                        </div>
                        <p class="testimonial-text">
                            "As a law student, LegalSwami is a game-changer! It helps me understand complex legal concepts and provides excellent research assistance. Like having a personal tutor 24/7."
                        </p>
                        <div class="testimonial-author">
                            <div class="author-avatar">
                                <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="Priya Patel">
                            </div>
                            <div class="author-info">
                                <h4 class="author-name">Priya Patel</h4>
                                <p class="author-title">Law Student, NLU Delhi</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Testimonial 3 -->
                    <div class="testimonial-card premium-card">
                        <div class="testimonial-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                        </div>
                        <p class="testimonial-text">
                            "The document generation feature saved our startup thousands! We needed multiple NDAs and service agreements. LegalSwami generated perfect documents in minutes. Incredible tool!"
                        </p>
                        <div class="testimonial-author">
                            <div class="author-avatar">
                                <img src="https://randomuser.me/api/portraits/men/67.jpg" alt="Ankit Verma">
                            </div>
                            <div class="author-info">
                                <h4 class="author-name">Ankit Verma</h4>
                                <p class="author-title">Tech Entrepreneur</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Pricing Section -->
        <section id="pricing" class="pricing-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">
                        Simple, <span class="shimmer-text">Transparent</span> Pricing
                    </h2>
                    <p class="section-subtitle">
                        Choose the perfect plan for your legal needs
                    </p>
                </div>
                
                <div class="pricing-cards">
                    <!-- Free Plan -->
                    <div class="pricing-card premium-card">
                        <div class="pricing-badge">FREE</div>
                        <h3 class="pricing-title">Basic</h3>
                        <div class="pricing-price">
                            <span class="currency">₹</span>
                            <span class="amount">0</span>
                            <span class="period">/month</span>
                        </div>
                        <p class="pricing-description">Perfect for trying out LegalSwami</p>
                        
                        <ul class="pricing-features">
                            <li><i class="fas fa-check-circle"></i> 10 AI Chat Messages/Day</li>
                            <li><i class="fas fa-check-circle"></i> 3 Document Generations/Month</li>
                            <li><i class="fas fa-check-circle"></i> Basic Legal Questions</li>
                            <li><i class="fas fa-times-circle"></i> No Priority Support</li>
                            <li><i class="fas fa-times-circle"></i> No Document History</li>
                        </ul>
                        
                        <button class="btn-pricing" id="freePlanBtn">
                            Get Started Free
                        </button>
                    </div>
                    
                    <!-- Pro Plan -->
                    <div class="pricing-card premium-card premium-plan">
                        <div class="pricing-badge popular">POPULAR</div>
                        <h3 class="pricing-title">Professional</h3>
                        <div class="pricing-price">
                            <span class="currency">₹</span>
                            <span class="amount">499</span>
                            <span class="period">/month</span>
                        </div>
                        <p class="pricing-description">Perfect for professionals & businesses</p>
                        
                        <ul class="pricing-features">
                            <li><i class="fas fa-check-circle"></i> Unlimited AI Chat Messages</li>
                            <li><i class="fas fa-check-circle"></i> 50 Document Generations/Month</li>
                            <li><i class="fas fa-check-circle"></i> All Document Templates</li>
                            <li><i class="fas fa-check-circle"></i> Priority Support</li>
                            <li><i class="fas fa-check-circle"></i> Complete Chat History</li>
                        </ul>
                        
                        <button class="btn-pricing btn-premium" id="proPlanBtn">
                            <i class="fas fa-crown"></i>
                            Get Professional
                        </button>
                    </div>
                    
                    <!-- Business Plan -->
                    <div class="pricing-card premium-card">
                        <div class="pricing-badge">BUSINESS</div>
                        <h3 class="pricing-title">Enterprise</h3>
                        <div class="pricing-price">
                            <span class="currency">₹</span>
                            <span class="amount">1,499</span>
                            <span class="period">/month</span>
                        </div>
                        <p class="pricing-description">For law firms & large organizations</p>
                        
                        <ul class="pricing-features">
                            <li><i class="fas fa-check-circle"></i> Everything in Professional</li>
                            <li><i class="fas fa-check-circle"></i> Unlimited Document Generation</li>
                            <li><i class="fas fa-check-circle"></i> Team Collaboration</li>
                            <li><i class="fas fa-check-circle"></i> Custom Templates</li>
                            <li><i class="fas fa-check-circle"></i> Dedicated Account Manager</li>
                        </ul>
                        
                        <button class="btn-pricing" id="businessPlanBtn">
                            Contact Sales
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- CTA Section -->
        <section class="cta-section">
            <div class="container">
                <div class="cta-content">
                    <h2 class="cta-title">
                        Ready to Experience <br>
                        AI-Powered Legal Assistance?
                    </h2>
                    <p class="cta-description">
                        Join thousands of satisfied users who trust LegalSwami for their legal needs. 
                        No credit card required to get started.
                    </p>
                    
                    <div class="cta-actions">
                        <button id="ctaStartChat" class="btn-cta-primary btn-premium">
                            <i class="fas fa-rocket"></i>
                            Start Free Chat Now
                        </button>
                        
                        <button id="ctaScheduleDemo" class="btn-cta-secondary">
                            <i class="fas fa-calendar"></i>
                            Schedule Demo
                        </button>
                    </div>
                    
                    <div class="cta-guarantee">
                        <div class="guarantee-item">
                            <i class="fas fa-shield-alt"></i>
                            <span>100% Secure & Private</span>
                        </div>
                        <div class="guarantee-item">
                            <i class="fas fa-clock"></i>
                            <span>Available 24/7</span>
                        </div>
                        <div class="guarantee-item">
                            <i class="fas fa-headset"></i>
                            <span>Priority Support</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="premium-footer">
            <div class="container">
                <div class="footer-content">
                    <!-- Company Info -->
                    <div class="footer-section">
                        <div class="footer-logo">
                            <div class="logo-icon legal-seal">
                                <i class="fas fa-gavel"></i>
                            </div>
                            <div class="logo-text">
                                <h3 class="logo-title shimmer-text">LegalSwami</h3>
                                <p class="logo-subtitle">AI Legal Assistant</p>
                            </div>
                        </div>
                        <p class="footer-description">
                            Making legal assistance accessible to everyone with AI-powered technology.
                        </p>
                        <div class="social-links">
                            <a href="#" class="social-link">
                                <i class="fab fa-twitter"></i>
                            </a>
                            <a href="#" class="social-link">
                                <i class="fab fa-linkedin"></i>
                            </a>
                            <a href="#" class="social-link">
                                <i class="fab fa-github"></i>
                            </a>
                            <a href="#" class="social-link">
                                <i class="fab fa-youtube"></i>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Quick Links -->
                    <div class="footer-section">
                        <h4 class="footer-heading">Quick Links</h4>
                        <ul class="footer-links">
                            <li><a href="#home">Home</a></li>
                            <li><a href="#features">Features</a></li>
                            <li><a href="#documents">Documents</a></li>
                            <li><a href="#legalDatabase">Legal Database</a></li>
                            <li><a href="#lawyerDirectory">Find Lawyers</a></li>
                            <li><a href="#legalGuides">Legal Guides</a></li>
                            <li><a href="#testimonials">Testimonials</a></li>
                            <li><a href="#pricing">Pricing</a></li>
                        </ul>
                    </div>
                    
                    <!-- Legal -->
                    <div class="footer-section">
                        <h4 class="footer-heading">Legal</h4>
                        <ul class="footer-links">
                            <li><a href="#" id="termsLink">Terms of Service</a></li>
                            <li><a href="#" id="privacyLink">Privacy Policy</a></li>
                            <li><a href="#" id="disclaimerLink">Legal Disclaimer</a></li>
                            <li><a href="#" id="cookieLink">Cookie Policy</a></li>
                        </ul>
                    </div>
                    
                    <!-- Contact -->
                    <div class="footer-section">
                        <h4 class="footer-heading">Contact Us</h4>
                        <ul class="footer-contact">
                            <li>
                                <i class="fas fa-envelope"></i>
                                <a href="mailto:support@legalswami.com">support@legalswami.com</a>
                            </li>
                            <li>
                                <i class="fas fa-phone"></i>
                                <a href="tel:+919876543210">+91 9876543210</a>
                            </li>
                            <li>
                                <i class="fas fa-map-marker-alt"></i>
                                <span>Mumbai, India</span>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="footer-bottom">
                    <p class="copyright">
                        &copy; 2024 LegalSwami. All rights reserved.
                    </p>
                    <div class="disclaimer">
                        <i class="fas fa-exclamation-triangle"></i>
                        LegalSwami provides AI-powered legal assistance. It is not a substitute for professional legal advice.
                    </div>
                </div>
            </div>
        </footer>

        <!-- Back to Top -->
        <button id="backToTop" class="back-to-top">
            <i class="fas fa-chevron-up"></i>
        </button>
    </div>

    <!-- CHATGPT-LIKE CHAT INTERFACE -->
    <div class="container" id="appContainer">
        <header>
            <div class="logo">
                <button class="back-btn" id="backToHome">
                    <i class="fas fa-arrow-left"></i>
                    <span class="hide-on-mobile">Back to Home</span>
                </button>
                <div class="logo-icon">
                    <i class="fas fa-scale-balanced"></i>
                </div>
                <h1>LegalSwami</h1>
            </div>
            
            <div class="header-actions">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span class="hide-on-mobile">AI Assistant Ready</span>
                </div>
                
                <!-- Search Counter Display -->
                <div class="search-counter" id="searchCounter">
                    <i class="fas fa-search"></i>
                    <span class="hide-on-mobile">Free searches: 500/500</span>
                </div>
                
                <!-- Login Button -->
                <button class="login-btn" id="chatHeaderLoginBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span class="hide-on-mobile">Login</span>
                </button>
                
                <button class="header-btn voice-search-btn" id="voiceSearchBtn" title="Voice Search">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="header-btn theme-toggle" id="themeToggle" title="Toggle Theme">
                    <i class="fas fa-sun"></i>
                </button>
                <button class="header-btn" id="clearChatBtn">
                    <i class="fas fa-broom"></i>
                    <span class="hide-on-mobile">Clear Chat</span>
                </button>
                <button class="header-btn" id="downloadCurrentBtn">
                    <i class="fas fa-download"></i>
                    <span class="hide-on-mobile">Download Chat</span>
                </button>
                <button class="header-btn" id="suggestionsBtn">
                    <i class="fas fa-lightbulb"></i>
                    <span class="hide-on-mobile">Suggestions</span>
                </button>
                
                <!-- User Profile -->
                <div class="user-profile" id="userProfileChat" style="display: none;">
                    <div class="user-avatar" id="userAvatarChat">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="userNameChat">Guest User</div>
                        <div class="user-email" id="userEmailChat">Local Browser Mode</div>
                    </div>
                    <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                </div>
            </div>
        </header>
        
        <!-- User Dropdown Menu -->
        <div class="user-dropdown" id="userDropdownChat">
            <div class="dropdown-header">
                <div class="user-avatar" id="dropdownAvatarChat">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-info">
                    <div class="user-name" id="dropdownNameChat">Guest User</div>
                    <div class="user-email" id="dropdownEmailChat">Local Browser Mode</div>
                </div>
            </div>
            
            <div class="dropdown-items">
                <button class="dropdown-item" id="profileBtn">
                    <i class="fas fa-user-circle"></i>
                    <span>My Profile</span>
                </button>
                <button class="dropdown-item" id="settingsBtn">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </button>
                <button class="dropdown-item" id="historyBtn">
                    <i class="fas fa-history"></i>
                    <span>Chat History</span>
                </button>
                <button class="dropdown-item" id="helpBtn">
                    <i class="fas fa-question-circle"></i>
                    <span>Help & Support</span>
                </button>
                <div class="dropdown-footer">
                    <button class="dropdown-item logout" id="logoutBtnChat">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Clear Local Data</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Down Arrow Button (Scroll to Bottom) -->
            <button class="scroll-to-bottom-btn" id="scrollToBottomBtn" title="Scroll to bottom">
                <i class="fas fa-chevron-down"></i>
            </button>
            
            <div class="sidebar-overlay" id="sidebarOverlay"></div>
            
            <aside class="sidebar" id="sidebar">
                <!-- Sidebar Close Button -->
                <button class="sidebar-close" id="sidebarClose">
                    <i class="fas fa-times"></i>
                </button>
                
                <!-- Sidebar Tabs -->
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" data-tab="legal-topics">
                        <i class="fas fa-book"></i>
                        <span class="hide-on-mobile">Legal Topics</span>
                    </button>
                    <button class="sidebar-tab" data-tab="chat-history">
                        <i class="fas fa-history"></i>
                        <span class="hide-on-mobile">Chat History</span>
                    </button>
                </div>
                
                <!-- Legal Topics Tab Content -->
                <div class="tab-content active" id="legal-topics-content">
                    <div class="sidebar-header">
                        <h2><i class="fas fa-book"></i> Legal Topics</h2>
                    </div>
                    
                    <div class="sidebar-section">
                        <h3><i class="fas fa-gavel"></i> Common Legal Areas</h3>
                        <div class="topic-list">
                            <button class="topic-item" data-topic="contract">
                                <i class="fas fa-file-contract"></i>
                                <span>Contract Law</span>
                            </button>
                            <button class="topic-item" data-topic="employment">
                                <i class="fas fa-briefcase"></i>
                                <span>Employment Law</span>
                            </button>
                            <button class="topic-item" data-topic="intellectual">
                                <i class="fas fa-lightbulb"></i>
                                <span>Intellectual Property</span>
                            </button>
                            <button class="topic-item" data-topic="realestate">
                                <i class="fas fa-house"></i>
                                <span>Real Estate Law</span>
                            </button>
                            <button class="topic-item" data-topic="family">
                                <i class="fas fa-heart"></i>
                                <span>Family Law</span>
                            </button>
                            <button class="topic-item" data-topic="criminal">
                                <i class="fas fa-gavel"></i>
                                <span>Criminal Law</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Active Topics Tabs Section -->
                    <div class="sidebar-section" id="activeTopicsSection" style="display: none;">
                        <h3><i class="fas fa-folder-open"></i> Active Topics</h3>
                        <div class="topic-list" id="activeTopicsList">
                            <!-- Active topics will be added here dynamically -->
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                        <div class="quick-actions">
                            <button class="action-item" data-action="document-drafts">
                                <i class="fas fa-file-alt"></i>
                                <span>Document Drafts</span>
                            </button>
                            <button class="action-item" data-action="legal-research">
                                <i class="fas fa-search"></i>
                                <span>Legal Research</span>
                            </button>
                            <button class="action-item" data-action="case-analysis">
                                <i class="fas fa-chart-bar"></i>
                                <span>Case Analysis</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Chat History Tab Content -->
                <div class="tab-content" id="chat-history-content">
                    <div class="history-header">
                        <h2><i class="fas fa-history"></i> Chat History</h2>
                        <button class="new-chat-btn" id="newChatBtn">
                            <i class="fas fa-plus"></i>
                            <span class="hide-on-mobile">New Chat</span>
                        </button>
                    </div>
                    
                    <div class="history-list" id="historyList">
                        <!-- History items will be loaded here -->
                        <div class="empty-history">
                            <i class="fas fa-comments"></i>
                            <p>No chat history yet</p>
                            <p style="font-size: 0.8125rem; margin-top: 0.5rem;">Start a conversation to see it here</p>
                        </div>
                    </div>
                </div>
            </aside>
            
            <main class="chat-container" id="chatContainer">
                <div class="chat-messages" id="chatMessages">
                    <!-- Welcome Message will be added dynamically -->
                </div>
                
                <!-- Scroll Position Indicator -->
                <div class="scroll-position-indicator" id="scrollPositionIndicator">
                    Scroll to see more messages
                </div>
                
                <div class="input-container">
                    <div class="input-area">
                        <!-- Attachments Preview -->
                        <div class="attachments-preview" id="attachmentsPreview" style="display: none;"></div>
                        
                        <div class="voice-input-status" id="voiceInputStatus">
                            <div class="voice-animation">
                                <div class="voice-bar"></div>
                                <div class="voice-bar"></div>
                                <div class="voice-bar"></div>
                                <div class="voice-bar"></div>
                                <div class="voice-bar"></div>
                            </div>
                            <span>Listening... Speak now</span>
                        </div>
                        
                        <textarea 
                            id="userInput" 
                            placeholder="Ask any legal question or attach files (images, PDF, TXT)... (Press Enter for new line, Ctrl+Enter to send)"
                            rows="1"
                        ></textarea>
                        
                        <div class="voice-input-text" id="voiceInputText"></div>
                        
                        <div class="input-buttons">
                            <!-- Emoji Picker Button -->
                            <button class="emoji-picker-btn" id="emojiPickerBtn" title="Insert emoji">
                                <i class="far fa-smile"></i>
                            </button>
                            
                            <!-- Attachment Button -->
                            <button class="attachment-btn" id="attachmentBtn" title="Attach files (images, PDF, TXT)">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            
                            <!-- Voice Input Button -->
                            <button class="input-microphone-btn" id="inputMicrophoneBtn" title="Voice input">
                                <i class="fas fa-microphone"></i>
                            </button>
                            
                            <!-- Send/Stop Button -->
                            <button class="send-button" id="sendButton">
                                <i class="fas fa-paper-plane"></i> <span class="hide-on-mobile">Send</span>
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- Download Modal (for full chat) -->
        <div class="modal-overlay" id="downloadModal">
            <div class="modal">
                <div class="modal-header">
                    <h2><i class="fas fa-download"></i> Download Chat</h2>
                    <button class="modal-close" id="closeDownloadModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <p>Select the format you want to download your chat in:</p>
                    
                    <div class="download-options">
                        <div class="download-option" data-format="doc">
                            <i class="fas fa-file-word"></i>
                            <h3>Word Document</h3>
                            <p>.doc format</p>
                        </div>
                        <div class="download-option" data-format="pdf">
                            <i class="fas fa-file-pdf"></i>
                            <h3>PDF Document</h3>
                            <p>.pdf format</p>
                        </div>
                        <div class="download-option" data-format="txt">
                            <i class="fas fa-file-alt"></i>
                            <h3>Text File</h3>
                            <p>.txt format</p>
                        </div>
                    </div>
                    
                    <div class="progress-indicator" id="progressIndicator">
                        <div class="progress-spinner"></div>
                        <p>Preparing your document...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <p>The document will include the complete chat conversation with timestamps.</p>
                </div>
            </div>
        </div>
        
        <!-- Delete Confirmation Modal -->
        <div class="modal-overlay" id="deleteModal">
            <div class="modal confirmation-modal">
                <div class="modal-header">
                    <h2><i class="fas fa-trash"></i> Delete Chat</h2>
                    <button class="modal-close" id="closeDeleteModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <div class="confirmation-text">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Are you sure you want to delete this chat?</h3>
                        <p id="deleteChatTitle">This action cannot be undone and the chat will be permanently deleted.</p>
                    </div>
                    
                    <div class="confirmation-buttons">
                        <button class="confirmation-btn cancel" id="cancelDelete">Cancel</button>
                        <button class="confirmation-btn delete" id="confirmDelete">Delete Permanently</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Individual Message Download Modal -->
        <div class="modal-overlay" id="messageDownloadModal">
            <div class="modal">
                <div class="modal-header">
                    <h2><i class="fas fa-file-download"></i> Download Document</h2>
                    <button class="modal-close" id="closeMessageDownloadModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <p>Select the format for this specific response:</p>
                    
                    <div class="download-options">
                        <div class="download-option" data-format="doc">
                            <i class="fas fa-file-word"></i>
                            <h3>Word Document</h3>
                            <p>.doc format</p>
                        </div>
                        <div class="download-option" data-format="pdf">
                            <i class="fas fa-file-pdf"></i>
                            <h3>PDF Document</h3>
                            <p>.pdf format</p>
                        </div>
                        <div class="download-option" data-format="txt">
                            <i class="fas fa-file-alt"></i>
                            <h3>Text File</h3>
                            <p>.txt format</p>
                        </div>
                    </div>
                    
                    <div class="progress-indicator" id="messageProgressIndicator">
                        <div class="progress-spinner"></div>
                        <p>Preparing your document...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <p>The document will include only this specific AI response.</p>
                </div>
            </div>
        </div>
        
        <!-- File Upload Modal -->
        <div class="modal-overlay image-upload-modal" id="fileUploadModal">
            <div class="image-upload-content">
                <div class="modal-header">
                    <h2><i class="fas fa-paperclip"></i> Attach Files</h2>
                    <button class="modal-close" id="closeFileUploadModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">
                            <h3>Drag & Drop Files Here</h3>
                            <p>or click to browse files</p>
                            <p style="font-size: 0.8125rem; color: var(--dark-text-secondary);">
                                Supported formats: Images (JPG, PNG, GIF), PDF, TXT, DOC
                            </p>
                            <button class="upload-btn" id="browseFilesBtn">
                                <i class="fas fa-folder-open"></i> Browse Files
                            </button>
                        </div>
                    </div>
                    
                    <div class="uploaded-images" id="uploadedFiles">
                        <!-- Uploaded files will appear here -->
                    </div>
                    
                    <div class="confirmation-buttons" style="margin-top: 1.25rem;">
                        <button class="confirmation-btn cancel" id="cancelFileUpload">
                            Cancel
                        </button>
                        <button class="confirmation-btn" id="confirmFileUpload" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white;">
                            <i class="fas fa-paperclip"></i> Attach Selected Files
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Download Notification -->
        <div class="download-notification" id="downloadNotification">
            <i class="fas fa-file-download"></i>
            <div class="download-notification-content">
                <div class="download-notification-title" id="downloadNotificationTitle">Document Downloaded</div>
                <div class="download-notification-message" id="downloadNotificationMessage">Click to open the file</div>
            </div>
            <button class="download-notification-close" id="closeDownloadNotification">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="toast" id="toast">
            <i class="fas fa-check-circle"></i>
            <span id="toast-message">Message sent successfully</span>
        </div>
    </div>

    <!-- Legal Tools Modal -->
    <div id="legalToolsModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <button id="closeLegalTools" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="modal-header">
                <div class="modal-icon legal-seal">
                    <i class="fas fa-tools"></i>
                </div>
                <h3>Legal Tools & Calculators</h3>
                <p>Access various legal utilities</p>
            </div>
            
            <div class="modal-body">
                <div class="tools-grid">
                    <button class="tool-card" onclick="openCalculator('court-fee')">
                        <i class="fas fa-calculator"></i>
                        <h4>Court Fee Calculator</h4>
                        <p>Calculate court fees for different cases</p>
                    </button>
                    
                    <button class="tool-card" onclick="openCalculator('stamp-duty')">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <h4>Stamp Duty Calculator</h4>
                        <p>Calculate stamp duty for documents</p>
                    </button>
                    
                    <button class="tool-card" onclick="openCalculator('compensation')">
                        <i class="fas fa-money-check-alt"></i>
                        <h4>Compensation Calculator</h4>
                        <p>Calculate compensation amounts</p>
                    </button>
                    
                    <button class="tool-card" onclick="openLegalActSearch()">
                        <i class="fas fa-search"></i>
                        <h4>Act & Statute Search</h4>
                        <p>Search legal acts and statutes</p>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modern Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <button id="closeLoginModal" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="modal-header">
                <div class="modal-icon legal-seal">
                    <i class="fas fa-balance-scale"></i>
                </div>
                <h3>Welcome to LegalSwami</h3>
                <p>Secure login to access all features</p>
            </div>
            
            <div class="modal-body">
                <!-- Google Sign-In Container -->
                <div id="googleSignInContainer"></div>
                
                <!-- Custom Google Button -->
                <button id="customGoogleBtn" class="google-signin-btn">
                    <i class="fab fa-google"></i>
                    Continue with Google
                </button>
                
                <div class="divider">
                    <span>or</span>
                </div>
                
                <!-- Demo Login Button -->
                <button id="demoLoginBtn" class="demo-login-btn">
                    <i class="fas fa-user"></i> Try Demo Version
                </button>
                
                <div class="login-info">
                    <p><i class="fas fa-lock"></i> Your data is encrypted and secure</p>
                    <p><i class="fas fa-shield-alt"></i> We never share your personal information</p>
                    <p><i class="fas fa-bolt"></i> No credit card required</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Main App Script -->
    <script>
    // ============================================
    // 1. FIXED: GOOGLE LOGIN ISSUE
    // ============================================
    
    let googleGISInitialized = false;
    let isLoginModalOpen = false;
    
    // Enhanced Google Auth Initialization with retry mechanism
    function initializeGoogleAuth() {
        console.log('🔐 Initializing Google Authentication...');
        
        if (typeof google === 'undefined') {
            console.log('⏳ Google Identity Services not loaded yet, retrying in 1 second...');
            setTimeout(initializeGoogleAuth, 1000);
            return;
        }
        
        try {
            // Check if already initialized
            if (window.googleAuthInitialized) {
                console.log('✅ Google Auth already initialized');
                return;
            }
            
            google.accounts.id.initialize({
                client_id: '166511615962-bohur5q8d4i5hud6icr4185kcte9enk8.apps.googleusercontent.com',
                callback: handleGoogleCredentialResponse,
                auto_select: false,
                cancel_on_tap_outside: true,
                context: 'signin',
                ux_mode: 'popup',
                prompt_parent_id: 'googleSignInContainer'
            });
            
            googleGISInitialized = true;
            window.googleAuthInitialized = true;
            console.log('✅ Google Authentication initialized successfully');
            
            // Try to render button immediately if modal is open
            if (isLoginModalOpen) {
                setTimeout(renderGoogleSignInButton, 100);
            }
            
        } catch (error) {
            console.error('❌ Google Authentication initialization failed:', error);
            // Show custom button as fallback
            const customBtn = document.getElementById('customGoogleBtn');
            if (customBtn) customBtn.style.display = 'flex';
        }
    }
    
    // Handle Google Credential Response
    function handleGoogleCredentialResponse(response) {
        console.log('🔐 Google credential received');
        
        try {
            // Decode JWT payload
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            
            const userData = {
                id: 'google_' + payload.sub,
                name: payload.name || 'Google User',
                email: payload.email,
                picture: payload.picture || `https://ui-avatars.com/api/?name=${encodeURIComponent(payload.name || 'User')}&background=1a56db&color=fff&size=128`,
                provider: 'google',
                token: response.credential
            };
            
            console.log('✅ Google user authenticated:', userData.email);
            
            // Save to localStorage
            localStorage.setItem('legalSwamiUser', JSON.stringify(userData));
            localStorage.setItem('legalSwamiToken', response.credential);
            
            // Update global user state
            currentUser = userData;
            isLoggedIn = true;
            userToken = response.credential;
            
            // Update UI
            updateUserUI();
            
            // Close login modal
            closeLoginModal();
            
            // Show success message
            showToast(`Welcome ${userData.name}!`, 'success');
            
            // Initialize chat for logged-in user
            if (isChatOpen) {
                initializeAppForUser();
            }
            
        } catch (error) {
            console.error('❌ Failed to process Google credential:', error);
            showToast('Login failed. Please try again.', 'error');
        }
    }
    
    // Render Google Sign-In Button
    function renderGoogleSignInButton() {
        try {
            const container = document.getElementById('googleSignInContainer');
            if (!container) {
                console.log('⚠️ Google Sign-In container not found');
                return;
            }
            
            if (!googleGISInitialized) {
                console.log('⚠️ Google GIS not initialized yet');
                return;
            }
            
            // Clear the container first
            container.innerHTML = '';
            
            // Render Google Sign-In button
            google.accounts.id.renderButton(
                container,
                {
                    theme: 'outline',
                    size: 'large',
                    text: 'signin_with',
                    shape: 'rectangular',
                    logo_alignment: 'left',
                    width: '400',
                    locale: 'en_US'
                }
            );
            
            console.log('✅ Google Sign-In button rendered');
            
            // Hide custom button
            const customBtn = document.getElementById('customGoogleBtn');
            if (customBtn) customBtn.style.display = 'none';
            
        } catch (error) {
            console.error('❌ Failed to render Google Sign-In button:', error);
            // Show custom button as fallback
            const customBtn = document.getElementById('customGoogleBtn');
            if (customBtn) customBtn.style.display = 'flex';
        }
    }
    
    // Handle Custom Google Login (fallback)
    function handleCustomGoogleLogin() {
        console.log('🔐 Custom Google login triggered');
        
        if (!googleGISInitialized) {
            showToast('Google Sign-In is initializing. Please wait...', 'info');
            setTimeout(initializeGoogleAuth, 500);
            return;
        }
        
        try {
            google.accounts.id.prompt();
        } catch (error) {
            console.error('❌ Google login failed:', error);
            showToast('Google Sign-In failed. Using demo login instead.', 'warning');
            handleDemoLogin();
        }
    }
    
    // Handle Demo Login
    function handleDemoLogin() {
        console.log('👤 Demo login triggered');
        
        const demoUsers = [
            {
                id: 'demo_lawyer_1',
                name: 'Advocate Rajesh Kumar',
                email: 'demo.lawyer@example.com',
                role: 'lawyer',
                specialization: 'Corporate Law'
            },
            {
                id: 'demo_client_1',
                name: 'Priya Sharma',
                email: 'demo.client@example.com',
                role: 'client',
                caseType: 'Property Dispute'
            },
            {
                id: 'demo_student_1',
                name: 'Amit Patel',
                email: 'demo.student@example.com',
                role: 'student',
                institution: 'NLSIU Bangalore'
            }
        ];
        
        const randomUser = demoUsers[Math.floor(Math.random() * demoUsers.length)];
        
        const userData = {
            id: randomUser.id,
            name: randomUser.name,
            email: randomUser.email,
            role: randomUser.role,
            picture: 'https://ui-avatars.com/api/?name=' + encodeURIComponent(randomUser.name) + '&background=1a56db&color=fff&size=128',
            provider: 'demo',
            isDemo: true
        };
        
        localStorage.setItem('legalSwamiUser', JSON.stringify(userData));
        localStorage.setItem('legalSwamiToken', 'demo_token_' + Date.now());
        
        currentUser = userData;
        isLoggedIn = true;
        userToken = 'demo_token';
        
        updateUserUI();
        closeLoginModal();
        showToast('Welcome ' + userData.name + '! (Demo Mode)', 'success');
        
        if (isChatOpen) {
            initializeAppForUser();
        }
    }
    
    // Show Login Modal
    function showLoginModal() {
        const modal = document.getElementById('loginModal');
        const overlay = modal.querySelector('.modal-overlay');
        
        if (modal) {
            modal.classList.add('active');
            overlay.classList.add('active');
            isLoginModalOpen = true;
            
            // Render Google Sign-In button after a short delay
            setTimeout(function() {
                renderGoogleSignInButton();
            }, 300);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }
    }
    
    // Close Login Modal
    function closeLoginModal() {
        const modal = document.getElementById('loginModal');
        const overlay = modal.querySelector('.modal-overlay');
        
        if (modal) {
            modal.classList.remove('active');
            overlay.classList.remove('active');
            isLoginModalOpen = false;
            
            // Restore body scroll
            document.body.style.overflow = '';
        }
    }
    
    // ============================================
    // 2. FIXED: CHAT INTERFACE NOT OPENING
    // ============================================
    
    let isChatOpen = false;
    
    // Function to open chat interface
    function openChatInterface() {
        console.log('💬 Opening chat interface...');
        
        // Hide main container
        document.querySelector('.main-container').classList.add('hidden');
        
        // Show chat container
        document.getElementById('appContainer').classList.add('active');
        
        isChatOpen = true;
        
        // Initialize chat app if not already initialized
        if (!window.chatInitialized) {
            setTimeout(initializeChatApp, 100);
            window.chatInitialized = true;
        }
        
        // Focus on input
        setTimeout(() => {
            const userInput = document.getElementById('userInput');
            if (userInput) {
                userInput.focus();
            }
        }, 300);
        
        // Update user UI for chat
        updateChatUserUI();
        
        showToast('Chat interface opened. Start asking legal questions! ⚖️', 'success');
    }
    
    // Function to close chat interface and return to home
    function closeChatInterface() {
        console.log('🏠 Closing chat interface...');
        
        // Show main container
        document.querySelector('.main-container').classList.remove('hidden');
        
        // Hide chat container
        document.getElementById('appContainer').classList.remove('active');
        
        isChatOpen = false;
        
        // Scroll to top of home page
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Update user UI in chat interface
    function updateChatUserUI() {
        if (isLoggedIn && currentUser) {
            document.getElementById('chatHeaderLoginBtn').style.display = 'none';
            document.getElementById('userProfileChat').style.display = 'flex';
            document.getElementById('userNameChat').textContent = currentUser.name;
            document.getElementById('userEmailChat').textContent = currentUser.email;
            document.getElementById('dropdownNameChat').textContent = currentUser.name;
            document.getElementById('dropdownEmailChat').textContent = currentUser.email;
            
            const avatar = document.getElementById('userAvatarChat');
            const dropdownAvatar = document.getElementById('dropdownAvatarChat');
            
            if (currentUser.picture) {
                avatar.innerHTML = `<img src="${currentUser.picture}" alt="${currentUser.name}" style="width: 100%; height: 100%; border-radius: 50%;">`;
                dropdownAvatar.innerHTML = `<img src="${currentUser.picture}" alt="${currentUser.name}" style="width: 100%; height: 100%; border-radius: 50%;">`;
            } else {
                avatar.innerHTML = '<i class="fas fa-user"></i>';
                dropdownAvatar.innerHTML = '<i class="fas fa-user"></i>';
            }
            
            document.getElementById('logoutBtnChat').innerHTML = `
                <i class="fas fa-sign-out-alt"></i>
                <span>${currentUser.isGuest ? 'Clear Local Data' : 'Logout'}</span>
            `;
        } else {
            document.getElementById('chatHeaderLoginBtn').style.display = 'flex';
            document.getElementById('userProfileChat').style.display = 'none';
        }
        
        updateSearchCounterDisplay();
    }
    
    // Initialize app for logged-in user
    function initializeAppForUser() {
        console.log("Initializing app for user:", currentUser.name);
        
        // Load user's chat history
        loadUserChatHistory();
        
        // Update UI
        updateChatUserUI();
        
        // Initialize chat if in chat interface
        if (isChatOpen) {
            initializeChatApp();
        }
    }
    
    // ============================================
    // 3. FIXED: MOBILE MENU NOT WORKING
    // ============================================
    
    let isMobileMenuOpen = false;
    
    // Setup mobile menu
    function setupMobileMenu() {
        const mobileToggle = document.getElementById('mobileToggle');
        const mobileMenu = document.getElementById('mobileMenu');
        const mobileClose = document.getElementById('mobileClose');
        const mobileLinks = document.querySelectorAll('.mobile-link');
        
        if (mobileToggle && mobileMenu) {
            mobileToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleMobileMenu();
            });
        }
        
        if (mobileClose) {
            mobileClose.addEventListener('click', function(e) {
                e.stopPropagation();
                closeMobileMenu();
            });
        }
        
        // Close mobile menu when clicking on links
        mobileLinks.forEach(link => {
            link.addEventListener('click', function() {
                closeMobileMenu();
            });
        });
        
        // Close mobile menu when clicking outside
        document.addEventListener('click', function(e) {
            if (isMobileMenuOpen && !mobileMenu.contains(e.target) && !mobileToggle.contains(e.target)) {
                closeMobileMenu();
            }
        });
        
        // Close mobile menu on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && isMobileMenuOpen) {
                closeMobileMenu();
            }
        });
        
        // Mobile start chat button
        const mobileStartChat = document.getElementById('mobileStartChat');
        if (mobileStartChat) {
            mobileStartChat.addEventListener('click', function(e) {
                e.preventDefault();
                closeMobileMenu();
                setTimeout(openChatInterface, 300);
            });
        }
    }
    
    // Toggle mobile menu
    function toggleMobileMenu() {
        const mobileMenu = document.getElementById('mobileMenu');
        const mobileToggle = document.getElementById('mobileToggle');
        
        if (!isMobileMenuOpen) {
            // Open menu
            mobileMenu.classList.add('active');
            mobileToggle.innerHTML = '<i class="fas fa-times"></i>';
            isMobileMenuOpen = true;
            document.body.style.overflow = 'hidden';
        } else {
            // Close menu
            closeMobileMenu();
        }
    }
    
    // Close mobile menu
    function closeMobileMenu() {
        const mobileMenu = document.getElementById('mobileMenu');
        const mobileToggle = document.getElementById('mobileToggle');
        
        mobileMenu.classList.remove('active');
        mobileToggle.innerHTML = '<i class="fas fa-bars"></i>';
        isMobileMenuOpen = false;
        document.body.style.overflow = '';
    }
    
    // ============================================
    // CORE VARIABLES AND FUNCTIONS
    // ============================================
    
    // Core variables
    let chatHistory = [];
    let currentChatId = null;
    let conversationHistory = [];
    let messageContentForDownload = "";
    let isListening = false;
    let recognition = null;
    let isInputMicrophoneActive = false;
    let isLightMode = false;
    let currentStreamingMessageId = null;
    let currentStreamingContent = '';
    let currentStreamingBuffer = '';
    let streamingTextChunks = [];
    let streamingTextIndex = 0;
    let streamingWordDelay = 20;
    let streamingPunctuationDelay = 100;
    let attachedFiles = [];
    let selectedFiles = [];
    let activeLegalTopics = [];
    let isStreamingPaused = false;
    let isStreamingActive = false;
    let stopStreamingRequested = false;
    let currentUser = null;
    let isLoggedIn = false;
    let userToken = null;
    let searchCount = 0;
    const MAX_FREE_SEARCHES = 500;
    const MAX_PREMIUM_SEARCHES = 1000;
    let scrollPosition = 0;
    let lastDownloadedFileUrl = null;
    let lastDownloadedFileName = '';
    
    // Backend integration variables
    let isProcessing = false;
    
    // Check device type
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const isTablet = window.innerWidth <= 1024 && window.innerWidth > 480;
    
    const WELCOME_MESSAGE_HTML = `
        <div class="welcome-message">
            <h2>Welcome to LegalSwami</h2>
            <p>Your AI-powered legal assistant for accurate, comprehensive legal information and guidance.</p>
            <p style="color: #10a37f; margin-top: 10px; font-size: 0.875rem;">
                <i class="fas fa-language"></i> Supports multiple Indian languages including Marathi, Hindi, and more!
            </p>
            <div style="margin-top: 1.5rem;">
                <h3 style="color: #10a37f; margin-bottom: 0.875rem; font-size: 1rem;">Ready-to-Use Legal Documents:</h3>
                <div class="draft-templates">
                    <div class="draft-template" data-template="nda">
                        <i class="fas fa-file-signature"></i>
                        <h4>Non-Disclosure Agreement</h4>
                        <p>Confidentiality agreement template</p>
                    </div>
                    <div class="draft-template" data-template="employment">
                        <i class="fas fa-briefcase"></i>
                        <h4>Employment Contract</h4>
                        <p>Employee agreement template</p>
                    </div>
                    <div class="draft-template" data-template="rental">
                        <i class="fas fa-house"></i>
                        <h4>Rental Agreement</h4>
                        <p>Tenancy agreement template</p>
                    </div>
                    <div class="draft-template" data-template="loan">
                        <i class="fas fa-money-bill-wave"></i>
                        <h4>Loan Agreement</h4>
                        <p>Money lending agreement</p>
                    </div>
                </div>
            </div>
            <div class="section-divider"></div>
            <div class="welcome-features">
                <div class="feature">
                    <i class="fas fa-bolt"></i>
                    <h4>Instant Responses</h4>
                    <p>Get immediate legal insights powered by advanced AI</p>
                </div>
                <div class="feature">
                    <i class="fas fa-shield-alt"></i>
                    <h4>Confidential & Secure</h4>
                    <p>Your conversations are private and encrypted</p>
                </div>
                <div class="feature">
                    <i class="fas fa-language"></i>
                    <h4>Multi-Language</h4>
                    <p>Responds in same language as your query</p>
                </div>
                <div class="feature">
                    <i class="fas fa-microphone"></i>
                    <h4>Voice Search</h4>
                    <p>Speak your queries in natural language</p>
                </div>
                <div class="feature">
                    <i class="fas fa-file-upload"></i>
                    <h4>File Analysis</h4>
                    <p>Upload and analyze documents, images</p>
                </div>
            </div>
        </div>
    `;
    
    // Initialize app for guest users
    function initializeAppForGuest() {
        console.log("Initializing in guest mode...");
        currentUser = {
            id: 'guest_' + Date.now(),
            name: 'Guest User',
            email: 'Local Browser Mode',
            isGuest: true,
            picture: null
        };
        isLoggedIn = false;
        
        // Open chat interface
        openChatInterface();
        
        // Initialize chat app
        initializeChatApp();
        
        // Load user chat history
        loadUserChatHistory();
        
        showToast('Welcome to LegalSwami! You have 500 free searches per day.', 'info');
    }
    
    // Update User UI in main interface
    function updateUserUI() {
        if (isLoggedIn && currentUser) {
            document.getElementById('headerLoginBtn').style.display = 'none';
            document.getElementById('userProfile').style.display = 'flex';
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            
            const avatar = document.getElementById('userAvatar');
            if (currentUser.picture) {
                avatar.innerHTML = `<img src="${currentUser.picture}" alt="${currentUser.name}">`;
            } else {
                avatar.innerHTML = '<i class="fas fa-user"></i>';
            }
        } else {
            document.getElementById('headerLoginBtn').style.display = 'flex';
            document.getElementById('userProfile').style.display = 'none';
        }
    }
    
    // Check for existing user on page load
    function checkExistingUser() {
        console.log('👤 Checking for existing user...');
        
        const userStr = localStorage.getItem('legalSwamiUser');
        if (userStr) {
            try {
                const user = JSON.parse(userStr);
                console.log('✅ Found existing user:', user.name);
                
                currentUser = user;
                isLoggedIn = true;
                userToken = localStorage.getItem('legalSwamiToken');
                
                updateUserUI();
                return;
            } catch (e) {
                console.error('Error parsing user data:', e);
                localStorage.removeItem('legalSwamiUser');
                localStorage.removeItem('legalSwamiToken');
            }
        }
        
        updateUserUI();
    }
    
    // Load User's Chat History
    function loadUserChatHistory() {
        const userId = currentUser ? currentUser.id : 'guest';
        const storageKey = `legalSwamiChatHistory_${userId}`;
        try {
            const savedHistory = localStorage.getItem(storageKey);
            if (savedHistory) {
                chatHistory = JSON.parse(savedHistory);
            }
            const savedChatId = localStorage.getItem(`legalSwamiCurrentChatId_${userId}`);
            if (savedChatId) {
                currentChatId = savedChatId;
                const currentChat = chatHistory.find(chat => chat.id === currentChatId);
                if (currentChat) {
                    conversationHistory = [...currentChat.messages];
                }
            }
        } catch (error) {
            console.error('Error loading chat history:', error);
            chatHistory = [];
        }
    }
    
    // Save User's Chat History
    function saveUserChatHistory() {
        const userId = currentUser ? currentUser.id : 'guest';
        const storageKey = `legalSwamiChatHistory_${userId}`;
        try {
            localStorage.setItem(storageKey, JSON.stringify(chatHistory));
            localStorage.setItem(`legalSwamiCurrentChatId_${userId}`, currentChatId);
        } catch (error) {
            console.error('Error saving chat history:', error);
        }
    }
    
    // Initialize search counter
    function initializeSearchCounter() {
        try {
            const savedCount = localStorage.getItem('legalSwamiSearchCount');
            if (savedCount) {
                searchCount = parseInt(savedCount);
            }
            const savedDate = localStorage.getItem('legalSwamiSearchDate');
            if (savedDate) {
                const lastDate = new Date(savedDate);
                const today = new Date();
                if (lastDate.getDate() !== today.getDate() || 
                    lastDate.getMonth() !== today.getMonth() || 
                    lastDate.getFullYear() !== today.getFullYear()) {
                    searchCount = 0;
                    saveSearchCounter();
                }
            }
            updateSearchCounterDisplay();
        } catch (error) {
            console.error('Error loading search counter:', error);
        }
    }
    
    // Save search counter
    function saveSearchCounter() {
        try {
            localStorage.setItem('legalSwamiSearchCount', searchCount.toString());
            localStorage.setItem('legalSwamiSearchDate', new Date().toISOString());
        } catch (error) {
            console.error('Error saving search counter:', error);
        }
    }
    
    // Update search counter display in header
    function updateSearchCounterDisplay() {
        const searchCounterElement = document.getElementById('searchCounter');
        if (searchCounterElement) {
            const maxSearches = MAX_FREE_SEARCHES;
            const remaining = maxSearches - searchCount;
            searchCounterElement.innerHTML = `<i class="fas fa-search"></i><span class="hide-on-mobile">Free searches: ${remaining}/${maxSearches}</span>`;
            if (remaining <= 50) {
                searchCounterElement.style.color = '#f59e0b';
            } else if (remaining <= 10) {
                searchCounterElement.style.color = '#ef4444';
            } else {
                searchCounterElement.style.color = 'var(--dark-text-secondary)';
            }
        }
    }
    
    // Initialize Chat App
    function initializeChatApp() {
        console.log("Initializing chat app...");
        
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.querySelector('.sidebar-toggle');
        const sidebarClose = document.getElementById('sidebarClose');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const downloadCurrentBtn = document.getElementById('downloadCurrentBtn');
        const suggestionsBtn = document.getElementById('suggestionsBtn');
        const voiceSearchBtn = document.getElementById('voiceSearchBtn');
        const inputMicrophoneBtn = document.getElementById('inputMicrophoneBtn');
        const themeToggle = document.getElementById('themeToggle');
        const topicItems = document.querySelectorAll('.topic-item');
        const actionItems = document.querySelectorAll('.action-item');
        const sidebarTabs = document.querySelectorAll('.sidebar-tab');
        const newChatBtn = document.getElementById('newChatBtn');
        const attachmentBtn = document.getElementById('attachmentBtn');
        const backToHomeBtn = document.getElementById('backToHome');
        const chatHeaderLoginBtn = document.getElementById('chatHeaderLoginBtn');
        const logoutBtnChat = document.getElementById('logoutBtnChat');
        const userProfileChat = document.getElementById('userProfileChat');
        
        // Hide sidebar by default on mobile
        const isDesktop = window.innerWidth >= 1025;
        if (isDesktop) {
            sidebar.classList.add('active');
        }
        
        // Load theme preference
        loadThemePreference();
        
        // Initialize search counter
        initializeSearchCounter();
        
        // Load or create new chat
        if (!currentChatId || conversationHistory.length === 0) {
            createNewChat();
        } else {
            loadCurrentChatMessages();
        }
        
        // Event listeners for chat functionality
        sendButton.addEventListener('click', function() {
            if (isStreamingActive) {
                stopStreaming();
            } else {
                sendMessage();
            }
        });
        
        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                if (isStreamingActive) {
                    stopStreaming();
                } else {
                    sendMessage();
                }
            }
            if (e.key === 'Enter' && !e.ctrlKey) {
                setTimeout(() => {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 150) + 'px';
                }, 10);
            }
        });
        
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            if (isStreamingActive) {
                sendButton.disabled = false;
                sendButton.classList.add('stop-button');
                sendButton.innerHTML = '<i class="fas fa-stop"></i> <span class="hide-on-mobile">Stop</span>';
            } else {
                sendButton.disabled = this.value.trim() === '' && attachedFiles.length === 0;
                sendButton.classList.remove('stop-button');
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> <span class="hide-on-mobile">Send</span>';
            }
        });
        
        // Back to home button
        if (backToHomeBtn) {
            backToHomeBtn.addEventListener('click', closeChatInterface);
        }
        
        // Chat header login button
        if (chatHeaderLoginBtn) {
            chatHeaderLoginBtn.addEventListener('click', showLoginModal);
        }
        
        // Chat user profile dropdown
        if (userProfileChat) {
            userProfileChat.addEventListener('click', function() {
                const dropdown = document.getElementById('userDropdownChat');
                dropdown.classList.toggle('active');
            });
        }
        
        // Chat logout button
        if (logoutBtnChat) {
            logoutBtnChat.addEventListener('click', function() {
                if (currentUser && currentUser.isGuest) {
                    if (confirm('Are you sure you want to clear all local data? This will delete all chat history and settings.')) {
                        localStorage.clear();
                        chatHistory = [];
                        conversationHistory = [];
                        currentChatId = null;
                        searchCount = 0;
                        currentUser = null;
                        isLoggedIn = false;
                        
                        updateChatUserUI();
                        createNewChat();
                        showToast('Local data cleared', 'success');
                    }
                } else {
                    if (confirm('Are you sure you want to logout?')) {
                        localStorage.removeItem('legalSwamiUser');
                        localStorage.removeItem('legalSwamiToken');
                        currentUser = null;
                        userToken = null;
                        isLoggedIn = false;
                        
                        updateChatUserUI();
                        showToast('Logged out successfully', 'success');
                    }
                }
            });
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('userDropdownChat');
            const profile = document.getElementById('userProfileChat');
            if (dropdown && dropdown.classList.contains('active') && 
                !dropdown.contains(event.target) && 
                !profile.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });
        
        // Focus input on load
        setTimeout(() => {
            userInput.focus();
            userInput.style.height = 'auto';
            userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
        }, 100);
        
        console.log("Chat app initialized successfully");
    }
    
    // ============================================
    // EVENT LISTENERS SETUP
    // ============================================
    
    // Setup all event listeners
    function setupEventListeners() {
        console.log('🔧 Setting up event listeners...');
        
        // Login button in header
        const headerLoginBtn = document.getElementById('headerLoginBtn');
        if (headerLoginBtn) {
            headerLoginBtn.addEventListener('click', showLoginModal);
        }
        
        // Demo login button
        const demoLoginBtn = document.getElementById('demoLoginBtn');
        if (demoLoginBtn) {
            demoLoginBtn.addEventListener('click', handleDemoLogin);
        }
        
        // Custom Google login button
        const customGoogleBtn = document.getElementById('customGoogleBtn');
        if (customGoogleBtn) {
            customGoogleBtn.addEventListener('click', handleCustomGoogleLogin);
        }
        
        // Close login modal button
        const closeLoginModalBtn = document.getElementById('closeLoginModal');
        if (closeLoginModalBtn) {
            closeLoginModalBtn.addEventListener('click', closeLoginModal);
        }
        
        // Close login modal when clicking overlay
        const loginModalOverlay = document.querySelector('#loginModal .modal-overlay');
        if (loginModalOverlay) {
            loginModalOverlay.addEventListener('click', closeLoginModal);
        }
        
        // Start chat buttons
        const startChatButtons = ['#startChatBtn', '#heroAssistantBtn', '#ctaStartChat'];
        startChatButtons.forEach(selector => {
            const button = document.querySelector(selector);
            if (button) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    openChatInterface();
                });
            }
        });
        
        // Setup mobile menu
        setupMobileMenu();
        
        // Back to top button
        const backToTopBtn = document.getElementById('backToTop');
        if (backToTopBtn) {
            backToTopBtn.addEventListener('click', function() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            // Show/hide back to top button on scroll
            window.addEventListener('scroll', function() {
                if (window.scrollY > 300) {
                    backToTopBtn.classList.add('visible');
                } else {
                    backToTopBtn.classList.remove('visible');
                }
            });
        }
        
        console.log('✅ Event listeners setup complete');
    }
    
    // ============================================
    // MAIN INITIALIZATION
    // ============================================
    
    // DOM Content Loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 LegalSwami Premium Frontend Initialized');
        console.log('📱 Device Type:', isMobile ? 'Mobile' : isTablet ? 'Tablet' : 'Desktop');
        
        // Hide loading screen
        setTimeout(function() {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(function() {
                    loadingScreen.style.display = 'none';
                    console.log('✅ Loading screen hidden');
                }, 300);
            }
        }, 1500);
        
        // Initialize Google Authentication
        setTimeout(initializeGoogleAuth, 2000);
        
        // Check for existing user
        checkExistingUser();
        
        // Setup event listeners
        setupEventListeners();
        
        // Auto-initialize guest mode for testing
        setTimeout(function() {
            if (!isLoggedIn && !isLoginModalOpen && !isChatOpen) {
                console.log("✅ App ready. Click 'Start Free Chat Now' to begin!");
            }
        }, 2000);
        
        console.log('✅ All initialization complete');
    });
    
    // ============================================
    // HELPER FUNCTIONS (simplified for brevity)
    // ============================================
    
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        if (toast && toastMessage) {
            toastMessage.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    }
    
    function createNewChat() {
        currentChatId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        conversationHistory = [];
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            const welcomeContainer = document.createElement('div');
            welcomeContainer.innerHTML = WELCOME_MESSAGE_HTML;
            chatMessages.innerHTML = '';
            chatMessages.appendChild(welcomeContainer);
        }
        clearAttachments();
        showToast('New chat started 💬', 'success');
    }
    
    function clearAttachments() {
        attachedFiles = [];
        const preview = document.getElementById('attachmentsPreview');
        if (preview) {
            preview.innerHTML = '';
            preview.style.display = 'none';
        }
    }
    
    function loadThemePreference() {
        const savedTheme = localStorage.getItem('legalSwamiTheme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
            const themeIcon = document.querySelector('.theme-toggle i');
            if (themeIcon) {
                themeIcon.className = 'fas fa-moon';
            }
            isLightMode = true;
        }
    }
    
// ============================================
// COMPLETE CHAT FUNCTIONALITY
// ============================================

// Send message function
async function sendMessage() {
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const message = userInput.value.trim();
    
    if (!message && attachedFiles.length === 0) {
        showToast('Please enter a message or attach a file 📝', 'warning');
        return;
    }
    
    if (!isLoggedIn && searchCount >= MAX_FREE_SEARCHES) {
        showToast(`You've used ${MAX_FREE_SEARCHES} free searches today. Please wait until tomorrow or clear local data to reset counter. ⏰`, 'warning');
        return;
    }
    
    if (isListening && recognition) {
        recognition.stop();
    }
    
    let detectedLanguage = 'english';
    if (message) {
        detectedLanguage = detectLanguage(message);
    }
    
    const messageId = addMessageToChat(message, true, false, false, attachedFiles);
    userInput.value = '';
    userInput.style.height = '52px';
    sendButton.disabled = false;
    sendButton.classList.add('stop-button');
    sendButton.innerHTML = '<i class="fas fa-stop"></i> <span class="hide-on-mobile">Stop</span>';
    isStreamingActive = true;
    stopStreamingRequested = false;
    clearAttachments();
    
    try {
        const userMessage = {
            role: 'user',
            content: message,
            language: detectedLanguage,
            attachments: [...attachedFiles],
            timestamp: new Date().toISOString()
        };
        conversationHistory.push(userMessage);
        
        if (!isLoggedIn) {
            searchCount++;
            saveSearchCounter();
            updateSearchCounterDisplay();
            const remaining = MAX_FREE_SEARCHES - searchCount;
            if (remaining === 50) {
                showToast(`You have ${remaining} free searches remaining. ⚠️`, 'warning');
            } else if (remaining === 10) {
                showToast(`Only ${remaining} free searches left! ⚠️`, 'warning');
            } else if (remaining === 0) {
                showToast(`Daily limit reached! You've used ${MAX_FREE_SEARCHES} searches today. ⏰`, 'warning');
            }
        }
        
        let fileContents = '';
        if (attachedFiles.length > 0) {
            for (const file of attachedFiles) {
                const content = await readFileContent(file);
                if (content) {
                    fileContents += `\n\n[Content from ${file.name}]:\n${content.substring(0, 2000)}${content.length > 2000 ? '... (truncated)' : ''}`;
                }
            }
        }
        
        const fullMessage = message + fileContents;
        
        // Simulate AI response for demo
        // In production, replace with actual API call
        setTimeout(() => {
            if (stopStreamingRequested) {
                console.log('Streaming was stopped, not processing response');
                return;
            }
            
            // Generate demo response based on query
            const aiResponse = generateDemoAIResponse(fullMessage, detectedLanguage);
            const sourcesData = extractSourcesFromResponse(aiResponse);
            
            const aiMessage = {
                role: 'assistant',
                content: aiResponse,
                language: detectedLanguage,
                isDocument: isDocumentRequest(message),
                sources: sourcesData.sources,
                timestamp: new Date().toISOString()
            };
            
            conversationHistory.push(aiMessage);
            const aiMessageId = createStreamingMessage();
            startStreamingResponse(aiMessageId, aiMessage.content, isDocumentRequest(message));
            
            setTimeout(() => {
                if (sourcesData && sourcesData.hasSources) {
                    addResponseSources(aiMessageId, sourcesData);
                }
            }, 500);
            
            // Save chat
            saveCurrentChat();
            
        }, 1000);
        
    } catch (error) {
        console.error('AI Service Error:', error);
        const errorMessage = "I apologize for the inconvenience. I'm currently experiencing technical difficulties. Please try again in a moment. ⚠️";
        addMessageToChat(errorMessage, false);
        conversationHistory.push({
            role: 'assistant',
            content: errorMessage,
            language: 'english',
            timestamp: new Date().toISOString()
        });
        showToast('Service temporarily unavailable ⚠️', 'warning');
    } finally {
        sendButton.disabled = userInput.value.trim() === '' && attachedFiles.length === 0;
        sendButton.classList.remove('stop-button');
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> <span class="hide-on-mobile">Send</span>';
        isStreamingActive = false;
        document.getElementById('userInput').focus();
        setTimeout(adjustChatLayout, 100);
        setTimeout(addCopyEditButtonsToUserMessages, 100);
    }
}

// Generate demo AI response for testing
function generateDemoAIResponse(query, language) {
    const queryLower = query.toLowerCase();
    
    // Document requests
    if (queryLower.includes('nda') || queryLower.includes('non-disclosure') || queryLower.includes('non disclosure')) {
        return `**NON-DISCLOSURE AGREEMENT**

This Non-Disclosure Agreement (the "Agreement") is made and entered into as of ___________ (the "Effective Date") by and between:

**DISCLOSING PARTY:**
Name: __________________________
Address: ________________________

**RECEIVING PARTY:**
Name: __________________________
Address: ________________________

**1. DEFINITION OF CONFIDENTIAL INFORMATION**
For purposes of this Agreement, "Confidential Information" shall include all information or material that has or could have commercial value or other utility in the business in which Disclosing Party is engaged.

**2. OBLIGATIONS OF RECEIVING PARTY**
Receiving Party shall hold and maintain the Confidential Information in strictest confidence for the sole and exclusive benefit of the Disclosing Party.

**3. TIME PERIODS**
The obligations of this Agreement shall survive until such time as all Confidential Information disclosed hereunder becomes publicly known and made generally available through no action or inaction of the Receiving Party.

**4. GOVERNING LAW**
This Agreement shall be governed by the laws of India.

IN WITNESS WHEREOF, the parties have executed this Agreement as of the Effective Date.

__________________________
Disclosing Party Signature

__________________________
Receiving Party Signature

Date: ____________________`;
    }
    
    if (queryLower.includes('rental') || queryLower.includes('tenancy')) {
        return `**RENTAL AGREEMENT**

This Rental Agreement (the "Agreement") is made on ___________ between:

**LANDLORD:**
Name: __________________________
Address: ________________________
PAN: ___________________________

**TENANT:**
Name: __________________________
Address: ________________________
PAN: ___________________________

**1. PREMISES**
The Landlord rents to Tenant and Tenant rents from Landlord the premises located at: __________________________ (the "Premises").

**2. TERM**
The term of this Agreement shall commence on ___________ and shall continue as a monthly tenancy.

**3. RENT**
Tenant shall pay as rent the amount of ₹__________ per month, payable in advance on the first day of each calendar month.

**4. SECURITY DEPOSIT**
Upon execution of this Agreement, Tenant shall deposit with Landlord the sum of ₹__________ as security for any damage caused to the Premises during the term hereof.

**5. MAINTENANCE AND REPAIRS**
Tenant will keep the Premises in clean, sanitary, and good condition.

**6. GOVERNING LAW**
This Agreement shall be governed by the laws of India and the Rent Control Act applicable in the respective state.

IN WITNESS WHEREOF, the parties have executed this Agreement.

__________________________
Landlord Signature

__________________________
Tenant Signature

Witness: _________________
Date: ____________________`;
    }
    
    if (queryLower.includes('employment') || queryLower.includes('contract')) {
        return `**EMPLOYMENT AGREEMENT**

This Employment Agreement (the "Agreement") is made on ___________ between:

**EMPLOYER:**
Company Name: ____________________
Address: _________________________
Registration No.: _________________

**EMPLOYEE:**
Name: __________________________
Address: ________________________
PAN: ___________________________
Aadhaar: _______________________

**1. POSITION**
Employee shall be employed in the position of ________________ with such duties and responsibilities as are normally associated with this position.

**2. TERM**
Employment under this Agreement shall commence on ___________ and shall continue until terminated as provided herein.

**3. COMPENSATION**
As compensation for services rendered, Employer shall pay Employee a monthly salary of ₹__________, payable on the last working day of each month.

**4. WORKING HOURS**
Employee's normal working hours shall be from 9:00 AM to 6:00 PM, Monday through Friday, with one hour lunch break.

**5. LEAVE**
Employee shall be entitled to 12 days of paid leave per year, in addition to national and festival holidays as declared by the company.

**6. CONFIDENTIALITY**
Employee agrees not to disclose any confidential information of the Employer during or after the term of employment.

**7. TERMINATION**
Either party may terminate this Agreement by giving 30 days' written notice to the other party.

**8. GOVERNING LAW**
This Agreement shall be governed by and construed in accordance with the laws of India.

IN WITNESS WHEREOF, the parties have executed this Agreement.

__________________________
Employer Representative

__________________________
Employee Signature

Date: ____________________`;
    }
    
    // Legal advice responses
    if (queryLower.includes('consumer') && queryLower.includes('complaint')) {
        return `**Consumer Complaint Process in India**

**Step-by-Step Guide:**

1. **Document Preparation:**
   - Gather all relevant documents (invoice, warranty, receipts, photos)
   - Write a detailed complaint with dates and facts
   - Include evidence of communication with the seller/service provider

2. **Approach Consumer Forum:**
   - File complaint at the appropriate consumer forum based on claim value:
     - District Forum: Claims up to ₹1 crore
     - State Commission: Claims ₹1 crore to ₹10 crores
     - National Commission: Claims above ₹10 crores

3. **Filing Requirements:**
   - File within 2 years from cause of action
   - Pay required court fees (nominal)
   - Submit 3 copies of complaint + additional copies for each opposite party

4. **Hearing Process:**
   - First hearing scheduled within 21 days
   - Both parties present their case
   - Forum may attempt settlement

5. **Time Frame:**
   - Disposal within 3-5 months if no adjournments
   - Appeal possible within 30 days of order

**Key Rights under Consumer Protection Act, 2019:**
- Right to be protected against hazardous goods
- Right to be informed about quality, quantity, purity, standard and price
- Right to choose
- Right to be heard
- Right to seek redressal
- Right to consumer education

**Important Sections:**
- Section 2(7): Definition of consumer
- Section 35: Jurisdiction of District Commission
- Section 47: Appeals to State Commission
- Section 58: Appeals to National Commission`;
    }
    
    if (queryLower.includes('divorce') || queryLower.includes('तलाक')) {
        return `**Divorce Process under Hindu Marriage Act, 1955**

**Grounds for Divorce:**

1. **Mutual Consent (Section 13B):**
   - Both parties agree to divorce
   - Living separately for at least one year
   - Unable to live together
   - Two-step process with 6-18 months gap

2. **Fault Grounds (Section 13):**
   - Adultery
   - Cruelty (physical or mental)
   - Desertion for 2+ years
   - Conversion to another religion
   - Unsound mind
   - Venereal disease
   - Renunciation of world
   - Presumed dead (7+ years missing)

3. **Special Grounds for Women (Section 13):**
   - Bigamy by husband
   - Rape, sodomy or bestiality
   - No cohabitation after maintenance order
   - Repudiation of marriage (if married before 15)

**Procedure:**

1. **File Petition:**
   - In district court where marriage was solemnized or where parties last resided
   - Required documents: Marriage certificate, proof of residence, photographs

2. **Court Process:**
   - First motion (if mutual consent)
   - Counseling attempt by court
   - Recording of statements
   - Second motion after 6 months (mutual consent)
   - Final decree

3. **Time Frame:**
   - Mutual consent: 6-18 months
   - Contested: 1-3 years or more
   - Can be expedited in cases of cruelty/domestic violence

**Maintenance (Section 24):**
- Interim maintenance during proceedings
- Permanent alimony after decree (Section 25)
- Based on husband's income and wife's needs`;
    }
    
    if (queryLower.includes('ipc') || queryLower.includes('indian penal code')) {
        return `**Indian Penal Code, 1860 - Key Provisions**

**Important Sections:**

**1. Offenses Against Body:**
- Section 299: Culpable homicide
- Section 300: Murder
- Section 304: Punishment for culpable homicide not amounting to murder
- Section 307: Attempt to murder
- Section 308: Attempt to commit culpable homicide
- Section 323: Punishment for voluntarily causing hurt
- Section 324: Voluntarily causing hurt by dangerous weapons
- Section 325: Punishment for voluntarily causing grievous hurt

**2. Offenses Against Property:**
- Section 378: Theft
- Section 383: Extortion
- Section 390: Robbery
- Section 391: Dacoity
- Section 405: Criminal breach of trust
- Section 415: Cheating
- Section 420: Cheating and dishonestly inducing delivery of property

**3. Offenses Against Women:**
- Section 354: Assault or criminal force to woman with intent to outrage her modesty
- Section 354A: Sexual harassment
- Section 354B: Assault or use of criminal force to woman with intent to disrobe
- Section 354C: Voyeurism
- Section 354D: Stalking
- Section 375: Rape
- Section 376: Punishment for rape
- Section 376D: Gang rape
- Section 498A: Cruelty by husband or relatives of husband

**4. General Provisions:**
- Section 34: Acts done by several persons in furtherance of common intention
- Section 120B: Punishment of criminal conspiracy
- Section 149: Every member of unlawful assembly guilty of offense committed in prosecution of common object

**Important Case Laws:**
- **K.M. Nanavati vs State of Maharashtra** (1962): Last case decided by jury trial in India
- **State of U.P. vs Krishna Master** (2010): Appreciation of circumstantial evidence
- **Lalita Kumari vs Govt. of U.P.** (2013): Mandatory FIR registration`;
    }
    
    // General legal advice
    return `**Legal Advice on Your Query**

Based on your question about "${query.substring(0, 50)}...", here is the general legal guidance:

**Key Principles:**

1. **Consult a Qualified Lawyer:** While I can provide general information, always consult a qualified lawyer for your specific situation. Legal matters can be complex and fact-specific.

2. **Document Everything:** Maintain records of all communications, agreements, payments, and evidence related to your legal matter.

3. **Know Your Rights:** Under Indian law, every citizen has certain fundamental rights and legal protections. The specific rights applicable depend on the nature of your issue.

4. **Timely Action:** Most legal remedies have limitation periods (usually 3 years for civil matters, varies for criminal). Don't delay taking appropriate action.

5. **Alternative Dispute Resolution:** Consider mediation, conciliation, or arbitration as faster and less expensive alternatives to court proceedings.

**Next Steps:**

1. **Gather Documentation:** Collect all relevant documents related to your case.
2. **Legal Research:** Research specific laws applicable to your situation.
3. **Professional Consultation:** Schedule a consultation with a lawyer specializing in the relevant area of law.
4. **Cost Assessment:** Understand the potential costs and time involved.

**Disclaimer:** This information is for educational purposes only and does not constitute legal advice. Laws vary by state and change over time. Please consult with a qualified legal professional for advice specific to your situation.`;
}

// Read file content
async function readFileContent(file) {
    return new Promise((resolve, reject) => {
        if (file.type.startsWith('image/')) {
            resolve(`[Image file: ${file.name}. Size: ${(file.size / 1024).toFixed(2)} KB]`);
        } else if (file.type === 'application/pdf') {
            resolve(`[PDF file: ${file.name}. Size: ${(file.size / 1024).toFixed(2)} KB. Content preview not available in browser.]`);
        } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                resolve(e.target.result);
            };
            reader.onerror = reject;
            reader.readAsText(file.file);
        } else if (file.type.includes('document') || file.name.endsWith('.doc') || file.name.endsWith('.docx')) {
            resolve(`[Document file: ${file.name}. Size: ${(file.size / 1024).toFixed(2)} KB. Content preview not available in browser.]`);
        } else {
            resolve(`[File: ${file.name}. Type: ${file.type}. Size: ${(file.size / 1024).toFixed(2)} KB]`);
        }
    });
}

// Extract sources from response
function extractSourcesFromResponse(response) {
    const sources = [];
    const indianActsPatterns = [
        /(Indian Contract Act,?\s*1872)/gi,
        /(Indian Penal Code,?\s*1860)/gi,
        /(Code of Civil Procedure,?\s*1908)/gi,
        /(Code of Criminal Procedure,?\s*1973)/gi,
        /(Constitution of India)/gi,
        /(Evidence Act,?\s*1872)/gi,
        /(Specific Relief Act,?\s*1963)/gi,
        /(Transfer of Property Act,?\s*1882)/gi,
        /(Hindu Marriage Act,?\s*1955)/gi,
        /(Hindu Succession Act,?\s*1956)/gi,
        /(Companies Act,?\s*2013)/gi,
        /(Consumer Protection Act,?\s*2019)/gi,
        /(Information Technology Act,?\s*2000)/gi,
        /(Right to Information Act,?\s*2005)/gi,
        /(Arbitration and Conciliation Act,?\s*1996)/gi,
        /(Protection of Children from Sexual Offences Act,?\s*2012)/gi,
        /(Motor Vehicles Act,?\s*1988)/gi,
        /(Negotiable Instruments Act,?\s*1881)/gi,
        /(Sale of Goods Act,?\s*1930)/gi,
        /(Partnership Act,?\s*1932)/gi
    ];
    
    const caseLawPatterns = [
        /([A-Z][a-z]+\s+v\.\s+[A-Z][a-z]+)/g,
        /(AIR\s+\d{4}\s+(?:SC|Bom|Del|Cal|Mad|Ker|Guj|Raj|All|Pat|Ori|MP|AP|HP|P&H|J&K|Kar)\s+\d+)/gi,
        /(SCC\s+\d+)/gi,
        /((\d+)\s+SCC\s+\d+)/gi,
        /(SCR\s+\d+)/gi,
        /((\d+)\s+SCR\s+\d+)/gi,
        /(JT\s+\d+)/gi,
        /((\d+)\s+JT\s+\d+)/gi
    ];
    
    const sectionPatterns = [
        /(Section\s+\d+[A-Z]?)/gi,
        /(Article\s+\d+)/gi,
        /(Rule\s+\d+)/gi,
        /(Regulation\s+\d+)/gi,
        /(Clause\s+\d+)/gi,
        /(Schedule\s+[IVXLCDM]+)/gi
    ];
    
    indianActsPatterns.forEach(pattern => {
        const matches = response.match(pattern);
        if (matches) {
            matches.forEach(match => {
                const formatted = match.replace(/,?\s*(\d{4})/, ', $1');
                if (!sources.some(s => s.toLowerCase() === formatted.toLowerCase())) {
                    sources.push(formatted);
                }
            });
        }
    });
    
    caseLawPatterns.forEach(pattern => {
        const matches = response.match(pattern);
        if (matches) {
            matches.forEach(match => {
                if (!sources.some(s => s.toLowerCase() === match.toLowerCase())) {
                    sources.push(match);
                }
            });
        }
    });
    
    sectionPatterns.forEach(pattern => {
        const matches = response.match(pattern);
        if (matches) {
            matches.forEach(match => {
                if (!sources.some(s => s.toLowerCase() === match.toLowerCase())) {
                    sources.push(match);
                }
            });
        }
    });
    
    const uniqueSources = [];
    const seen = new Set();
    sources.forEach(source => {
        const lower = source.toLowerCase();
        if (!seen.has(lower)) {
            seen.add(lower);
            uniqueSources.push(source);
        }
    });
    
    return {
        sources: uniqueSources.slice(0, 8),
        hasSources: uniqueSources.length > 0
    };
}

// Add message to chat
function addMessageToChat(content, isUser, fromHistory = false, isDocument = false, attachments = [], sources = null) {
    const chatMessages = document.getElementById('chatMessages');
    if (!fromHistory && isUser) {
        const welcomeMessage = document.querySelector('.welcome-message');
        if (welcomeMessage) {
            welcomeMessage.remove();
        }
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
    const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    messageDiv.id = messageId;
    
    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    if (isUser) {
        if (currentUser && currentUser.picture) {
            avatar.innerHTML = `<img src="${currentUser.picture}" alt="${currentUser.name}" style="width: 100%; height: 100%; border-radius: 8px;">`;
        } else {
            avatar.innerHTML = '<i class="fas fa-user"></i>';
        }
    } else {
        avatar.innerHTML = '<i class="fas fa-scale-balanced"></i>';
        avatar.style.background = 'linear-gradient(135deg, #7e57c2 0%, #5e35b1 100%)';
    }
    
    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';
    
    const messageText = document.createElement('div');
    messageText.className = 'message-text';
    
    if (isUser) {
        if (content) {
            messageText.innerHTML = content.replace(/\n/g, '<br>');
        }
        
        if (attachments && attachments.length > 0) {
            messageDiv.dataset.attachments = JSON.stringify(attachments.map(file => ({
                name: file.name,
                data: file.data,
                type: file.type
            })));
        }
        
        if (!fromHistory) {
            const controlsContainer = document.createElement('div');
            controlsContainer.className = 'user-message-controls';
            controlsContainer.innerHTML = `
                <button class="user-message-btn copy-btn" onclick="copyUserMessage('${messageId}')" title="Copy question">
                    <i class="fas fa-copy"></i>
                    <span class="hide-on-mobile">Copy</span>
                </button>
                <button class="user-message-btn edit-btn" onclick="editUserMessage('${messageId}')" title="Edit question">
                    <i class="fas fa-pencil-alt"></i>
                    <span class="hide-on-mobile">Edit</span>
                </button>
            `;
            messageContent.appendChild(controlsContainer);
        }
    } else {
        if (isDocument) {
            messageText.innerHTML = formatDocumentResponse(content);
        } else {
            messageText.innerHTML = formatLegalResponse(content);
        }
        
        if (sources && sources.length > 0 && !fromHistory) {
            setTimeout(() => {
                addResponseSources(messageId, { sources: sources, hasSources: true });
            }, 100);
        }
    }
    
    messageContent.appendChild(messageText);
    
    if (!isUser && !fromHistory) {
        const messageActions = document.createElement('div');
        messageActions.className = 'message-actions';
        messageActions.innerHTML = `
            <button class="action-btn copy" onclick="copyMessage(this)" title="Copy response">
                <i class="fas fa-copy"></i> Copy
            </button>
            <button class="action-btn regenerate" onclick="regenerateResponse('${messageId}')" title="Regenerate response">
                <i class="fas fa-sync-alt"></i> Regenerate
            </button>
            <button class="action-btn like" onclick="likeMessage(this)" title="Mark as helpful">
                <i class="far fa-thumbs-up"></i> Helpful
            </button>
            <button class="action-btn dislike" onclick="dislikeMessage(this)" title="Mark as not helpful">
                <i class="far fa-thumbs-down"></i> Not Helpful
            </button>
            <button class="action-btn share" onclick="shareResponse('${messageId}')" title="Share response">
                <i class="fas fa-share"></i> Share
            </button>
            <button class="action-btn document" onclick="downloadThisMessage('${messageId}')" title="Download document">
                <i class="fas fa-file-download"></i> Download
            </button>
        `;
        messageContent.appendChild(messageActions);
    }
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(messageContent);
    chatMessages.appendChild(messageDiv);
    
    if (isUser && attachments && attachments.length > 0) {
        showAttachedFilesBelowUserMessage(messageId, attachments);
    }
    
    setTimeout(checkScrollPosition, 100);
    return messageId;
}

// Show attached files
function showAttachedFilesBelowUserMessage(messageId, attachments) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv || !attachments || attachments.length === 0) return;
    
    const messageContent = messageDiv.querySelector('.message-content');
    attachments.forEach((attachment, index) => {
        const fileContainer = document.createElement('div');
        fileContainer.className = 'attachment-item';
        fileContainer.style.maxWidth = '280px';
        fileContainer.style.marginTop = '8px';
        
        if (attachment.type.startsWith('image/')) {
            fileContainer.innerHTML = `
                <img src="${attachment.data}" alt="${attachment.name}" class="attachment-image" style="max-height: 130px;">
                <div class="attachment-name">${attachment.name}</div>
            `;
        } else if (attachment.type === 'application/pdf' || attachment.name.endsWith('.pdf')) {
            fileContainer.innerHTML = `
                <div style="padding: 15px; text-align: center; background: var(--dark-surface-light);">
                    <i class="fas fa-file-pdf" style="font-size: 1.8rem; color: #ef4444;"></i>
                    <div class="attachment-name">${attachment.name}</div>
                    <div style="font-size: 0.65rem; color: var(--dark-text-secondary);">PDF Document</div>
                </div>
            `;
        } else if (attachment.type === 'text/plain' || attachment.name.endsWith('.txt')) {
            fileContainer.innerHTML = `
                <div style="padding: 12px; background: var(--dark-surface-light); border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <i class="fas fa-file-alt" style="font-size: 1.3rem; color: #10a37f;"></i>
                        <div style="flex: 1;">
                            <div class="attachment-name">${attachment.name}</div>
                            <div style="font-size: 0.65rem; color: var(--dark-text-secondary);">Text Document</div>
                        </div>
                    </div>
                    <button class="action-btn" style="width: 100%; padding: 6px;" onclick="showFileContent('${attachment.data}', '${attachment.name.replace(/'/g, "\\'")}')">
                        <i class="fas fa-eye"></i> Preview Content
                    </button>
                </div>
            `;
        } else {
            fileContainer.innerHTML = `
                <div style="padding: 15px; text-align: center; background: var(--dark-surface-light);">
                    <i class="fas fa-file" style="font-size: 1.8rem; color: var(--dark-text-secondary);"></i>
                    <div class="attachment-name">${attachment.name}</div>
                    <div style="font-size: 0.65rem; color: var(--dark-text-secondary);">${attachment.type || 'File'}</div>
                </div>
            `;
        }
        
        const messageText = messageContent.querySelector('.message-text');
        messageContent.insertBefore(fileContainer, messageText.nextSibling);
    });
}

// Show file content
window.showFileContent = async function(dataUrl, fileName) {
    try {
        const response = await fetch(dataUrl);
        const text = await response.text();
        const contentDiv = document.createElement('div');
        contentDiv.className = 'file-content-display';
        contentDiv.innerHTML = `
            <div class="file-content-header">
                <div class="file-content-title">
                    <i class="fas fa-file-alt"></i>
                    <span>${fileName}</span>
                </div>
                <button class="file-content-close" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="max-height: 180px; overflow-y: auto; font-family: monospace; font-size: 0.75rem;">
                ${text.substring(0, 4000)}
                ${text.length > 4000 ? '<div style="color: var(--dark-text-secondary); margin-top: 8px;">... (content truncated)</div>' : ''}
            </div>
        `;
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.appendChild(contentDiv);
        setTimeout(() => {
            contentDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
    } catch (error) {
        console.error('Error reading file content:', error);
        showToast('Could not read file content 📄', 'error');
    }
};

// Add response sources
function addResponseSources(messageId, sourcesData) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv || !sourcesData || !sourcesData.hasSources) return;
    
    const checkStreaming = setInterval(() => {
        const isStillStreaming = currentStreamingMessageId === messageId;
        const messageText = messageDiv.querySelector('.message-text');
        const hasStreamingCursor = messageText && messageText.querySelector('.streaming-cursor');
        
        if (!isStillStreaming && !hasStreamingCursor) {
            clearInterval(checkStreaming);
            
            const sourcesContainer = document.createElement('div');
            sourcesContainer.className = 'sources-container';
            
            let sourcesHTML = '';
            if (sourcesData.sources && sourcesData.sources.length > 0) {
                sourcesHTML = `
                    <div class="sources-header">
                        <i class="fas fa-gavel"></i>
                        <span>Legal Sources & References ⚖️</span>
                    </div>
                    <div class="sources-list">
                        ${sourcesData.sources.map(source => `
                            <div class="source-tag" title="${source}">
                                <i class="fas fa-bookmark"></i>
                                <span>${source.length > 40 ? source.substring(0, 40) + '...' : source}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="sources-info">
                        <i class="fas fa-info-circle"></i>
                        Sources extracted from the AI response above 📚
                    </div>
                `;
                
                sourcesContainer.innerHTML = sourcesHTML;
                messageDiv.parentNode.insertBefore(sourcesContainer, messageDiv.nextSibling);
                
                setTimeout(() => {
                    sourcesContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 300);
                
                const aiMessageIndex = conversationHistory.findIndex(msg => 
                    msg.role === 'assistant' && msg.content && msg.content.includes(messageDiv.querySelector('.message-text').textContent.substring(0, 100))
                );
                
                if (aiMessageIndex !== -1) {
                    conversationHistory[aiMessageIndex].sources = sourcesData.sources;
                    saveCurrentChat();
                }
            }
        }
    }, 100);
    
    setTimeout(() => clearInterval(checkStreaming), 10000);
}

// Save current chat
function saveCurrentChat() {
    if (!currentChatId || conversationHistory.length === 0) return;
    
    const chatIndex = chatHistory.findIndex(chat => chat.id === currentChatId);
    let title = 'New Chat';
    let preview = 'No messages yet';
    
    if (conversationHistory.length > 0) {
        const firstUserMessage = conversationHistory.find(msg => msg.role === 'user');
        if (firstUserMessage) {
            title = firstUserMessage.content.substring(0, 30);
            if (firstUserMessage.content.length > 30) {
                title += '...';
            }
        }
        
        const lastMessage = conversationHistory[conversationHistory.length - 1];
        if (lastMessage) {
            preview = lastMessage.content.substring(0, 50);
            if (lastMessage.content.length > 50) {
                preview += '...';
            }
        }
    }
    
    const chatData = {
        id: currentChatId,
        title: title,
        preview: preview,
        date: new Date().toISOString(),
        messages: [...conversationHistory],
        userId: currentUser ? currentUser.id : 'guest'
    };
    
    if (chatIndex !== -1) {
        chatHistory[chatIndex] = chatData;
    } else {
        chatHistory.unshift(chatData);
    }
    
    saveUserChatHistory();
}

// Check if document request
function isDocumentRequest(message) {
    if (!message) return false;
    
    const docKeywords = [
        'draft', 'template', 'format', 'document', 'agreement', 
        'contract', 'nda', 'non disclosure', 'employment', 
        'rental', 'loan', 'will', 'testament', 'legal document',
        'ready made', 'sample', 'example', 'form', 'प्रारूप',
        'मसौदा', 'दस्तावेज़', 'समझौता', 'अनुबंध', 'करार',
        'ड्राफ्ट', 'टेम्पलेट', 'फॉर्मेट', 'सैंपल', 'create',
        'generate', 'make', 'prepare', 'write'
    ];
    
    const lowerMessage = message.toLowerCase();
    return docKeywords.some(keyword => lowerMessage.includes(keyword));
}

// Detect language
function detectLanguage(text) {
    if (!text) return 'english';
    
    const hasNonEnglishScript = /[\u0900-\u097F\u0B80-\u0BFF\u0C00-\u0C7F\u0C80-\u0CFF\u0A00-\u0A7F\u0A80-\u0AFF\u0980-\u09FF]/.test(text);
    
    if (!hasNonEnglishScript) {
        const hindiMarathiWords = [
            /\bmujhe\b/i, /\btumhe\b/i, /\bhindi\b/i, /\bmarathi\b/i,
            /\bkya\b/i, /\bkyu\b/i, /\bkaise\b/i, /\bkab\b/i,
            /\bmala\b/i, /\bmahiti\b/i, /\bsahayata\b/i, /\bkich\b/i
        ];
        
        let hindiMarathiScore = 0;
        hindiMarathiWords.forEach(pattern => {
            if (pattern.test(text)) hindiMarathiScore++;
        });
        
        if (hindiMarathiScore >= 2) {
            if (/\bmala\b/i.test(text) || /\bmahiti\b/i.test(text) || /\bsahayata\b/i.test(text)) {
                return 'marathi';
            }
            if (/\bmujhe\b/i.test(text) || /\bkya\b/i.test(text) || /\bkyu\b/i.test(text)) {
                return 'hindi';
            }
        }
        return 'english';
    }
    
    if (/[\u0900-\u097F]/.test(text)) {
        let marathiScore = 0;
        let hindiScore = 0;
        
        const marathiWords = ['आहे', 'मी', 'तू', 'आपण', 'होय', 'नाही', 'मला', 'पाहिजे', 'कृपया', 'धन्यवाद', 'महाराष्ट्र', 'मराठी'];
        marathiWords.forEach(word => {
            if (text.includes(word)) marathiScore++;
        });
        
        const hindiWords = ['क्या', 'क्यों', 'कैसे', 'मुझे', 'तुम्हें', 'आप', 'है', 'हैं', 'हिन्दी', 'भारत'];
        hindiWords.forEach(word => {
            if (text.includes(word)) hindiScore++;
        });
        
        if (marathiScore > hindiScore) {
            return 'marathi';
        } else if (hindiScore > 0) {
            return 'hindi';
        }
        return 'hindi';
    }
    
    if (/[\u0B80-\u0BFF]/.test(text)) return 'tamil';
    if (/[\u0C00-\u0C7F]/.test(text)) return 'telugu';
    if (/[\u0C80-\u0CFF]/.test(text)) return 'kannada';
    if (/[\u0A00-\u0A7F]/.test(text)) return 'punjabi';
    if (/[\u0A80-\u0AFF]/.test(text)) return 'gujarati';
    if (/[\u0980-\u09FF]/.test(text)) return 'bengali';
    
    return 'english';
}

// Format document response
function formatDocumentResponse(text) {
    const documentContainer = document.createElement('div');
    documentContainer.className = 'document-template';
    
    const lines = text.split('\n');
    let htmlContent = '';
    
    lines.forEach(line => {
        if (line.trim() === '') return;
        
        if (line.toUpperCase() === line && line.length > 10 && !line.includes(':')) {
            htmlContent += `<div class="document-header">
                <h2 class="document-title">${line}</h2>
                <div class="document-subtitle">Legal Document Template ⚖️</div>
            </div>`;
        } else if (line.match(/^\d+\.\s+.+/) || line.match(/^[A-Z\s]+:$/)) {
            htmlContent += `<div class="document-section">
                <h3 class="document-section-title">${line}</h3>`;
        } else if (line.match(/^[a-z]\)\s+.+/)) {
            htmlContent += `<div class="document-clause">
                <div class="clause-title">${line}</div>`;
        } else {
            if (line.includes('___________________') || line.includes('________________')) {
                htmlContent += `<div class="clause-content" style="border-bottom: 1px solid var(--dark-border); padding-bottom: 4px; margin-bottom: 8px;">${line}</div>`;
            } else {
                htmlContent += `<div class="clause-content">${line}</div>`;
            }
        }
    });
    
    if (!text.includes('Signature') && !text.includes('Witness')) {
        htmlContent += `
            <div class="signature-section">
                <div class="signature-line">
                    <div class="signature-block">
                        <div class="signature-name"></div>
                        <div class="signature-label">Signature ✍️</div>
                    </div>
                    <div class="signature-block">
                        <div class="signature-name"></div>
                        <div class="signature-label">Date 📅</div>
                    </div>
                </div>
            </div>`;
    }
    
    htmlContent += `<div class="legal-note">
        <strong>Disclaimer:</strong> This template is for educational purposes only. Consult a qualified attorney before use. ⚖️
    </div>`;
    
    documentContainer.innerHTML = htmlContent;
    return documentContainer.outerHTML;
}

// Format legal response
function formatLegalResponse(text) {
    let formatted = text
        .replace(/## (.*?)\n/g, '<h3>$1</h3>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/- (.*?)\n/g, '<li>$1</li>')
        .replace(/\n/g, '<br>');
    
    formatted = formatted.replace(/(<li>.*?<\/li>)/gs, function(match) {
        return '<ul>' + match + '</ul>';
    });
    
    if (formatted.includes('Disclaimer') || formatted.includes('अस्वीकरण') || formatted.includes('सूचना')) {
        formatted = formatted.replace(/(Disclaimer:.*?|अस्वीकरण:.*?|सूचना:.*?)(?=<br><br>|$)/is, 
            '<div class="legal-note">$1</div>');
    }
    
    const container = document.createElement('div');
    container.className = 'legal-content';
    container.innerHTML = formatted;
    return container.outerHTML;
}

// Format streaming text
function formatStreamingText(text) {
    const container = document.createElement('div');
    container.innerHTML = text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
    return container.innerHTML;
}

// Create streaming message
function createStreamingMessage() {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ai-message';
    const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    messageDiv.id = messageId;
    
    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.innerHTML = '<i class="fas fa-scale-balanced"></i>';
    avatar.style.background = 'linear-gradient(135deg, #7e57c2 0%, #5e35b1 100%)';
    
    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';
    
    const messageText = document.createElement('div');
    messageText.className = 'message-text streaming-content';
    messageText.innerHTML = '<span class="streaming-cursor"></span>';
    
    messageContent.appendChild(messageText);
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(messageContent);
    chatMessages.appendChild(messageDiv);
    
    currentStreamingMessageId = messageId;
    currentStreamingContent = '';
    currentStreamingBuffer = '';
    streamingTextChunks = [];
    streamingTextIndex = 0;
    
    const streamControls = document.createElement('div');
    streamControls.className = 'stream-controls';
    streamControls.innerHTML = `
        <button class="stream-control-btn pause-btn" id="pause-${messageId}" onclick="toggleStreamPause('${messageId}')">
            <i class="fas fa-pause"></i> Pause
        </button>
        <button class="stream-control-btn copy-btn" onclick="copyStreamedContent('${messageId}')">
            <i class="fas fa-copy"></i> Copy
        </button>
    `;
    messageContent.appendChild(streamControls);
    
    setTimeout(checkScrollPosition, 100);
    return messageId;
}

// Start streaming response
function startStreamingResponse(messageId, response, isDocument = false) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    
    let textToStream = response;
    streamingTextChunks = splitTextIntoChunks(textToStream);
    streamingTextIndex = 0;
    streamNextChunk(messageId, isDocument);
}

// Split text into chunks
function splitTextIntoChunks(text) {
    const chunks = [];
    const regex = /[\s.,;!?।।॥]+|\S+/g;
    let match;
    while ((match = regex.exec(text)) !== null) {
        chunks.push(match[0]);
    }
    return chunks;
}

// Stream next chunk
function streamNextChunk(messageId, isDocument = false) {
    if (stopStreamingRequested || streamingTextIndex >= streamingTextChunks.length) {
        if (stopStreamingRequested) {
            console.log('Streaming stopped by user');
        } else {
            finalizeStreamingMessage(messageId, isDocument);
        }
        return;
    }
    
    const chunk = streamingTextChunks[streamingTextIndex];
    streamingTextIndex++;
    updateStreamingMessage(messageId, chunk, isDocument);
    
    let delay = streamingWordDelay;
    if (chunk.match(/[.,;!?।।॥]/)) {
        delay += streamingPunctuationDelay;
    }
    if (chunk.match(/[.!?।।॥]/)) {
        delay += 150;
    }
    
    setTimeout(() => {
        if (!isStreamingPaused && !stopStreamingRequested) {
            streamNextChunk(messageId, isDocument);
        }
    }, delay);
}

// Toggle stream pause
window.toggleStreamPause = function(messageId) {
    isStreamingPaused = !isStreamingPaused;
    const pauseBtn = document.getElementById(`pause-${messageId}`);
    const messageDiv = document.getElementById(messageId);
    
    if (isStreamingPaused) {
        pauseBtn.innerHTML = '<i class="fas fa-play"></i> Continue';
        pauseBtn.style.background = 'var(--success)';
        pauseBtn.style.borderColor = 'var(--success)';
        pauseBtn.style.color = 'white';
        
        const messageText = messageDiv.querySelector('.message-text');
        const existingIndicator = messageText.querySelector('.paused-indicator');
        if (!existingIndicator) {
            const indicator = document.createElement('span');
            indicator.className = 'paused-indicator';
            indicator.textContent = 'Paused';
            messageText.appendChild(indicator);
        }
        
        showToast('Response paused ⏸️', 'info');
    } else {
        pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
        pauseBtn.style.background = '';
        pauseBtn.style.borderColor = '';
        pauseBtn.style.color = '';
        
        const messageText = messageDiv.querySelector('.message-text');
        const existingIndicator = messageText.querySelector('.paused-indicator');
        if (existingIndicator) {
            existingIndicator.remove();
        }
        
        setTimeout(() => {
            streamNextChunk(messageId, isDocumentRequest(currentStreamingContent));
        }, 100);
        
        showToast('Response continued ▶️', 'success');
    }
};

// Copy streamed content
window.copyStreamedContent = function(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    
    const messageText = messageDiv.querySelector('.message-text');
    const textToCopy = messageText.textContent.replace('Paused', '').trim();
    
    navigator.clipboard.writeText(textToCopy).then(() => {
        showToast('Copied to clipboard! 📋', 'success');
    }).catch(err => {
        console.error('Copy failed:', err);
        showToast('Failed to copy ❌', 'error');
    });
};

// Update streaming message
function updateStreamingMessage(messageId, newContent, isDocument = false) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    
    const messageText = messageDiv.querySelector('.message-text');
    currentStreamingBuffer += newContent;
    currentStreamingContent += newContent;
    
    if (isDocument) {
        messageText.innerHTML = formatDocumentResponse(currentStreamingContent) + '<span class="streaming-cursor"></span>';
    } else {
        messageText.innerHTML = formatStreamingText(currentStreamingBuffer) + '<span class="streaming-cursor"></span>';
    }
    
    checkScrollPosition();
}

// Finalize streaming message
function finalizeStreamingMessage(messageId, isDocument = false) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    
    const messageText = messageDiv.querySelector('.message-text');
    const cursor = messageText.querySelector('.streaming-cursor');
    if (cursor) cursor.remove();
    
    const pausedIndicator = messageText.querySelector('.paused-indicator');
    if (pausedIndicator) pausedIndicator.remove();
    
    if (isDocument) {
        messageText.innerHTML = formatDocumentResponse(currentStreamingContent);
        addDocumentDownloadButton(messageId, currentStreamingContent);
    } else {
        messageText.innerHTML = formatLegalResponse(currentStreamingContent);
    }
    
    const messageActions = document.createElement('div');
    messageActions.className = 'message-actions';
    messageActions.innerHTML = `
        <button class="action-btn copy" onclick="copyMessage(this)" title="Copy response">
            <i class="fas fa-copy"></i> Copy
        </button>
        <button class="action-btn regenerate" onclick="regenerateResponse('${messageId}')" title="Regenerate response">
            <i class="fas fa-sync-alt"></i> Regenerate
        </button>
        <button class="action-btn like" onclick="likeMessage(this)" title="Mark as helpful">
            <i class="far fa-thumbs-up"></i> Helpful
        </button>
        <button class="action-btn dislike" onclick="dislikeMessage(this)" title="Mark as not helpful">
            <i class="far fa-thumbs-down"></i> Not Helpful
        </button>
        <button class="action-btn share" onclick="shareResponse('${messageId}')" title="Share response">
            <i class="fas fa-share"></i> Share
        </button>
        <button class="action-btn document" onclick="downloadThisMessage('${messageId}')" title="Download document">
            <i class="fas fa-file-download"></i> Download
        </button>
    `;
    messageText.parentElement.appendChild(messageActions);
    
    const streamControls = messageDiv.querySelector('.stream-controls');
    if (streamControls) {
        streamControls.remove();
    }
    
    if (attachedFiles.length > 0) {
        showAttachedFilesBelowResponse(messageId);
    }
    
    currentStreamingMessageId = null;
    currentStreamingContent = '';
    currentStreamingBuffer = '';
    streamingTextChunks = [];
    streamingTextIndex = 0;
    isStreamingPaused = false;
    isStreamingActive = false;
    stopStreamingRequested = false;
    
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = document.getElementById('userInput').value.trim() === '' && attachedFiles.length === 0;
    sendButton.classList.remove('stop-button');
    sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> <span class="hide-on-mobile">Send</span>';
}

// Add document download button
function addDocumentDownloadButton(messageId, content) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    
    const messageContent = messageDiv.querySelector('.message-content');
    const existingBtn = messageContent.querySelector('.document-download-btn');
    if (existingBtn) return;
    
    const downloadBtn = document.createElement('button');
    downloadBtn.className = 'document-download-btn';
    downloadBtn.innerHTML = '<i class="fas fa-file-download"></i> Download Document';
    downloadBtn.title = 'Download this document template';
    downloadBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        openMessageDownloadModal(content);
    });
    
    messageContent.appendChild(downloadBtn);
}

// Stop streaming
function stopStreaming() {
    stopStreamingRequested = true;
    isStreamingActive = false;
    isStreamingPaused = false;
    
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = document.getElementById('userInput').value.trim() === '' && attachedFiles.length === 0;
    sendButton.classList.remove('stop-button');
    sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> <span class="hide-on-mobile">Send</span>';
    
    if (currentStreamingMessageId) {
        const messageDiv = document.getElementById(currentStreamingMessageId);
        if (messageDiv) {
            const messageText = messageDiv.querySelector('.message-text');
            const streamControls = messageDiv.querySelector('.stream-controls');
            if (streamControls) {
                streamControls.remove();
            }
            
            const messageActions = document.createElement('div');
            messageActions.className = 'message-actions';
            messageActions.innerHTML = `
                <button class="action-btn copy" onclick="copyMessage(this)" title="Copy response">
                    <i class="fas fa-copy"></i> Copy
                </button>
                <button class="action-btn regenerate" onclick="regenerateResponse('${currentStreamingMessageId}')" title="Regenerate response">
                    <i class="fas fa-sync-alt"></i> Regenerate
                </button>
                <button class="action-btn like" onclick="likeMessage(this)" title="Mark as helpful">
                    <i class="far fa-thumbs-up"></i> Helpful
                </button>
                <button class="action-btn dislike" onclick="dislikeMessage(this)" title="Mark as not helpful">
                    <i class="far fa-thumbs-down"></i> Not Helpful
                </button>
                <button class="action-btn share" onclick="shareResponse('${currentStreamingMessageId}')" title="Share response">
                    <i class="fas fa-share"></i> Share
                </button>
                <button class="action-btn document" onclick="downloadThisMessage('${currentStreamingMessageId}')" title="Download document">
                    <i class="fas fa-file-download"></i> Download
                </button>
            `;
            messageText.parentElement.appendChild(messageActions);
            
            const cursor = messageText.querySelector('.streaming-cursor');
            if (cursor) cursor.remove();
            const pausedIndicator = messageText.querySelector('.paused-indicator');
            if (pausedIndicator) pausedIndicator.remove();
            
            if (isDocumentRequest(currentStreamingContent)) {
                messageText.innerHTML = formatDocumentResponse(currentStreamingContent);
                addDocumentDownloadButton(currentStreamingMessageId, currentStreamingContent);
            } else {
                messageText.innerHTML = formatLegalResponse(currentStreamingContent);
            }
        }
        
        currentStreamingMessageId = null;
        currentStreamingContent = '';
        currentStreamingBuffer = '';
        streamingTextChunks = [];
        streamingTextIndex = 0;
    }
    
    showToast('Response stopped ⏹️', 'info');
}

// ============================================
// CHAT HELPER FUNCTIONS
// ============================================

// Load current chat messages
function loadCurrentChatMessages() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '';
    
    if (conversationHistory.length === 0) {
        const welcomeContainer = document.createElement('div');
        welcomeContainer.innerHTML = WELCOME_MESSAGE_HTML;
        chatMessages.appendChild(welcomeContainer);
        addDraftTemplateListeners();
        return;
    }
    
    conversationHistory.forEach(msg => {
        const isDocument = msg.isDocument || false;
        const hasSources = msg.sources && msg.sources.length > 0;
        addMessageToChat(msg.content, msg.role === 'user', true, isDocument, msg.attachments || [], hasSources ? msg.sources : null);
    });
    
    setTimeout(addCopyEditButtonsToUserMessages, 100);
}

// Add draft template listeners
function addDraftTemplateListeners() {
    const draftTemplates = document.querySelectorAll('.draft-template');
    draftTemplates.forEach(template => {
        template.addEventListener('click', function() {
            const templateType = this.dataset.template;
            let requestText = '';
            
            switch(templateType) {
                case 'nda':
                    requestText = 'Create a comprehensive non-disclosure agreement for Indian business use 🤝';
                    break;
                case 'employment':
                    requestText = 'Draft an employment contract template for Indian companies 💼';
                    break;
                case 'rental':
                    requestText = 'Create a rental/tenancy agreement for residential property in India 🏠';
                    break;
                case 'loan':
                    requestText = 'Draft a loan agreement template for personal lending in India 💰';
                    break;
            }
            
            const userInput = document.getElementById('userInput');
            userInput.value = requestText;
            userInput.focus();
            userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
            document.getElementById('sendButton').disabled = false;
            
            setTimeout(() => {
                sendMessage();
            }, 1000);
        });
    });
}

// Show attached files below response
function showAttachedFilesBelowResponse(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv || attachedFiles.length === 0) return;
    
    const messageContent = messageDiv.querySelector('.message-content');
    const attachmentsContainer = document.createElement('div');
    attachmentsContainer.className = 'message-attachments';
    
    attachedFiles.forEach((attachment, index) => {
        const attachmentItem = document.createElement('div');
        attachmentItem.className = 'attachment-item';
        attachmentItem.innerHTML = `
            <img src="${attachment.data}" alt="${attachment.name}" class="attachment-image">
            <div class="attachment-name">${attachment.name}</div>
        `;
        attachmentsContainer.appendChild(attachmentItem);
    });
    
    const messageText = messageContent.querySelector('.message-text');
    messageContent.insertBefore(attachmentsContainer, messageText.nextSibling);
    clearAttachments();
}

// Regenerate response
window.regenerateResponse = function(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    
    const allMessages = document.querySelectorAll('.message');
    let userMessageContent = '';
    let userMessageId = '';
    
    for (let i = 0; i < allMessages.length; i++) {
        if (allMessages[i].id === messageId) {
            for (let j = i - 1; j >= 0; j--) {
                if (allMessages[j].classList.contains('user-message')) {
                    const userMessageText = allMessages[j].querySelector('.message-text');
                    if (userMessageText) {
                        userMessageContent = userMessageText.textContent;
                        userMessageId = allMessages[j].id;
                    }
                    break;
                }
            }
            break;
        }
    }
    
    if (userMessageContent) {
        const aiMessageIndex = conversationHistory.findIndex((msg, idx) => 
            msg.role === 'assistant' && idx > 0 && conversationHistory[idx-1].content === userMessageContent
        );
        
        if (aiMessageIndex !== -1) {
            conversationHistory.splice(aiMessageIndex, 1);
        }
        
        messageDiv.remove();
        
        const userInput = document.getElementById('userInput');
        userInput.value = userMessageContent;
        userInput.focus();
        userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
        
        setTimeout(() => {
            sendMessage();
        }, 500);
        
        showToast('Regenerating response... 🔄', 'info');
    }
};

// Dislike message
window.dislikeMessage = function(button) {
    button.innerHTML = '<i class="fas fa-thumbs-down"></i> Feedback Sent';
    button.style.background = '#ef4444';
    button.style.borderColor = '#ef4444';
    button.style.color = 'white';
    button.disabled = true;
    showToast('Thank you for your feedback! 👍', 'info');
};

// Share response
window.shareResponse = function(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    
    const messageText = messageDiv.querySelector('.message-text');
    const textToShare = messageText.textContent;
    
    if (navigator.share) {
        navigator.share({
            title: 'LegalSwami AI Response ⚖️',
            text: textToShare.substring(0, 100) + '...',
            url: window.location.href
        }).then(() => {
            showToast('Response shared successfully! 📤', 'success');
        }).catch(err => {
            console.error('Share failed:', err);
            copyToClipboard(textToShare);
        });
    } else {
        copyToClipboard(textToShare);
    }
};

// Copy to clipboard helper
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Response copied to clipboard! 📋', 'success');
    }).catch(err => {
        console.error('Copy failed:', err);
        showToast('Failed to copy response ❌', 'error');
    });
}

// Copy message
window.copyMessage = function(button) {
    const messageText = button.closest('.message-content').querySelector('.message-text');
    let textToCopy = messageText.innerText || messageText.textContent;
    
    const textarea = document.createElement('textarea');
    textarea.value = textToCopy;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    textarea.setSelectionRange(0, 99999);
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showToast('Document copied to clipboard! 📋', 'success');
        } else {
            showToast('Failed to copy text ❌', 'error');
        }
    } catch (err) {
        console.error('Copy failed:', err);
        showToast('Failed to copy: ' + err, 'error');
    }
    
    document.body.removeChild(textarea);
};

// Like message
window.likeMessage = function(button) {
    button.innerHTML = '<i class="fas fa-thumbs-up"></i> Thank you!';
    button.style.background = '#10a37f';
    button.style.borderColor = '#10a37f';
    button.style.color = 'white';
    button.disabled = true;
    showToast('Thank you for your feedback! 👍', 'success');
};

// Copy user message
window.copyUserMessage = function(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    
    const messageText = messageDiv.querySelector('.message-text');
    const textToCopy = messageText.textContent;
    
    navigator.clipboard.writeText(textToCopy).then(() => {
        showToast('Question copied to clipboard! 📋', 'success');
    }).catch(err => {
        console.error('Copy failed:', err);
        showToast('Failed to copy question ❌', 'error');
    });
};

// Edit user message
window.editUserMessage = function(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    
    const messageText = messageDiv.querySelector('.message-text');
    const content = messageText.textContent;
    
    const userInput = document.getElementById('userInput');
    userInput.value = content;
    userInput.focus();
    userInput.style.height = 'auto';
    userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
    document.getElementById('sendButton').disabled = false;
    
    showToast('Question loaded for editing. Press Ctrl+Enter to send. ✏️', 'info');
};

// Download this message
window.downloadThisMessage = function(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    
    const messageText = messageDiv.querySelector('.message-text');
    const content = messageText.innerText || messageText.textContent;
    openMessageDownloadModal(content);
};

// Clear current chat
function clearCurrentChat() {
    if (conversationHistory.length === 0 && attachedFiles.length === 0) {
        showToast('Chat is already empty 🗑️', 'warning');
        return;
    }
    
    if (confirm('Are you sure you want to clear the current chat?')) {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = '';
        conversationHistory = [];
        clearAttachments();
        createNewChat();
        showToast('Current chat cleared 🗑️', 'success');
    }
}

// Show suggestions
function showSuggestions() {
    const suggestions = [
        "Create a non-disclosure agreement draft 📝",
        "I need an employment contract template 💼",
        "Generate a rental agreement for me 🏠",
        "Draft a loan agreement document 💰",
        "What are the essential elements of a valid contract? ⚖️"
    ];
    
    addMessageToChat(
        `<h3>Suggested Questions:</h3>
        <ul>
            ${suggestions.map(q => `<li style="cursor: pointer; padding: 6px; border-radius: 6px; transition: background 0.3s;" 
                onmouseover="this.style.background='var(--dark-surface-light)'" 
                onmouseout="this.style.background='transparent'"
                onclick="document.getElementById('userInput').value = '${q}'; document.getElementById('userInput').focus(); document.getElementById('userInput').style.height = Math.min(document.getElementById('userInput').scrollHeight, 180) + 'px'; document.getElementById('sendButton').disabled = false;">
                ${q}
            </li>`).join('')}
        </ul>
        <p>Click any question to add it to the input field. 👆</p>`,
        false
    );
}

// Check scroll position
function checkScrollPosition() {
    const chatMessages = document.getElementById('chatMessages');
    const scrollBtn = document.getElementById('scrollToBottomBtn');
    const indicator = document.getElementById('scrollPositionIndicator');
    
    if (!chatMessages) return;
    
    const isAtBottom = chatMessages.scrollHeight - chatMessages.clientHeight <= chatMessages.scrollTop + 50;
    
    if (!isAtBottom) {
        scrollBtn.classList.add('visible');
        if (chatMessages.scrollTop < scrollPosition) {
            indicator.classList.add('visible');
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 2000);
        }
    } else {
        scrollBtn.classList.remove('visible');
        indicator.classList.remove('visible');
    }
    
    scrollPosition = chatMessages.scrollTop;
}

// Scroll to bottom
function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.scrollTo({
            top: chatMessages.scrollHeight,
            behavior: 'smooth'
        });
        document.getElementById('scrollToBottomBtn').classList.remove('visible');
    }
}

// Add copy and edit buttons to user messages
function addCopyEditButtonsToUserMessages() {
    const userMessages = document.querySelectorAll('.user-message:not(.from-history) .message-content');
    userMessages.forEach((messageContent, index) => {
        if (!messageContent.querySelector('.user-message-controls')) {
            const messageDiv = messageContent.closest('.message');
            const messageId = messageDiv.id;
            const messageText = messageContent.querySelector('.message-text');
            
            if (messageText && messageText.textContent.trim()) {
                const controlsContainer = document.createElement('div');
                controlsContainer.className = 'user-message-controls';
                
                const copyBtn = document.createElement('button');
                copyBtn.className = 'user-message-btn copy-btn';
                copyBtn.title = 'Copy question';
                copyBtn.innerHTML = '<i class="fas fa-copy"></i><span class="hide-on-mobile">Copy</span>';
                copyBtn.addEventListener('click', () => copyUserMessage(messageId));
                
                const editBtn = document.createElement('button');
                editBtn.className = 'user-message-btn edit-btn';
                editBtn.title = 'Edit question';
                editBtn.innerHTML = '<i class="fas fa-pencil-alt"></i><span class="hide-on-mobile">Edit</span>';
                editBtn.addEventListener('click', () => editUserMessage(messageId));
                
                controlsContainer.appendChild(copyBtn);
                controlsContainer.appendChild(editBtn);
                messageContent.appendChild(controlsContainer);
            }
        }
    });
}

// Toggle theme
function toggleTheme() {
    const themeIcon = document.querySelector('.theme-toggle i');
    if (isLightMode) {
        document.body.classList.remove('light-mode');
        themeIcon.className = 'fas fa-sun';
        localStorage.setItem('legalSwamiTheme', 'dark');
        isLightMode = false;
    } else {
        document.body.classList.add('light-mode');
        themeIcon.className = 'fas fa-moon';
        localStorage.setItem('legalSwamiTheme', 'light');
        isLightMode = true;
    }
}

// Voice recognition
function toggleVoiceRecognition() {
    if (!recognition) return;
    
    if (isListening && !isInputMicrophoneActive) {
        recognition.stop();
    } else {
        isInputMicrophoneActive = false;
        recognition.start();
    }
}

function toggleInputVoiceRecognition() {
    if (!recognition) return;
    
    if (isListening && isInputMicrophoneActive) {
        recognition.stop();
    } else {
        isInputMicrophoneActive = true;
        recognition.start();
    }
}

// Adjust chat layout
function adjustChatLayout() {
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 100);
    }
}

// File upload functionality
function openFileUploadModal() {
    document.getElementById('fileUploadModal').classList.add('active');
    selectedFiles = [];
    updateUploadedFilesDisplay();
}

// Update uploaded files display
function updateUploadedFilesDisplay() {
    const container = document.getElementById('uploadedFiles');
    if (!container) return;
    
    container.innerHTML = '';
    
    selectedFiles.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'uploaded-image-item';
        
        if (file.type.startsWith('image/')) {
            item.innerHTML = `
                <img src="${file.data}" alt="${file.name}" class="uploaded-image-preview">
                <button class="remove-uploaded-image" onclick="removeUploadedFile(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
        } else if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
            item.innerHTML = `
                <div style="padding: 12px; text-align: center; background: var(--dark-surface-light); height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <i class="fas fa-file-pdf" style="font-size: 1.8rem; color: #ef4444; margin-bottom: 6px;"></i>
                    <div style="font-size: 0.65rem; color: var(--dark-text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">${file.name}</div>
                </div>
                <button class="remove-uploaded-image" onclick="removeUploadedFile(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
        } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
            item.innerHTML = `
                <div style="padding: 12px; text-align: center; background: var(--dark-surface-light); height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <i class="fas fa-file-alt" style="font-size: 1.8rem; color: #10a37f; margin-bottom: 6px;"></i>
                    <div style="font-size: 0.65rem; color: var(--dark-text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">${file.name}</div>
                </div>
                <button class="remove-uploaded-image" onclick="removeUploadedFile(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
        } else {
            item.innerHTML = `
                <div style="padding: 12px; text-align: center; background: var(--dark-surface-light); height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <i class="fas fa-file" style="font-size: 1.8rem; color: var(--dark-text-secondary); margin-bottom: 6px;"></i>
                    <div style="font-size: 0.65rem; color: var(--dark-text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">${file.name}</div>
                </div>
                <button class="remove-uploaded-image" onclick="removeUploadedFile(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
        }
        
        container.appendChild(item);
    });
}

// Remove uploaded file
window.removeUploadedFile = function(index) {
    selectedFiles.splice(index, 1);
    updateUploadedFilesDisplay();
};

// Remove attachment
window.removeAttachment = function(index) {
    attachedFiles.splice(index, 1);
    const preview = document.getElementById('attachmentsPreview');
    preview.innerHTML = '';
    
    if (attachedFiles.length === 0) {
        preview.style.display = 'none';
        document.getElementById('sendButton').disabled = document.getElementById('userInput').value.trim() === '';
    } else {
        attachedFiles.forEach((file, idx) => {
            const item = document.createElement('div');
            item.className = 'attachment-preview-item';
            
            if (file.type.startsWith('image/')) {
                item.innerHTML = `
                    <img src="${file.data}" alt="${file.name}" class="attachment-preview-image">
                    <button class="remove-attachment" onclick="removeAttachment(${idx})">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="attachment-preview-name">${file.name}</div>
                `;
            } else if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
                item.innerHTML = `
                    <div style="padding: 8px; text-align: center; background: var(--dark-surface-light); height: 70px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <i class="fas fa-file-pdf" style="font-size: 1.3rem; color: #ef4444;"></i>
                        <div style="font-size: 0.55rem; color: var(--dark-text-secondary); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">PDF</div>
                    </div>
                    <button class="remove-attachment" onclick="removeAttachment(${idx})" style="top: 2px; right: 2px;">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="attachment-preview-name">${file.name.substring(0, 12)}${file.name.length > 12 ? '...' : ''}</div>
                `;
            } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                item.innerHTML = `
                    <div style="padding: 8px; text-align: center; background: var(--dark-surface-light); height: 70px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <i class="fas fa-file-alt" style="font-size: 1.3rem; color: #10a37f;"></i>
                        <div style="font-size: 0.55rem; color: var(--dark-text-secondary); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">TXT</div>
                    </div>
                    <button class="remove-attachment" onclick="removeAttachment(${idx})" style="top: 2px; right: 2px;">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="attachment-preview-name">${file.name.substring(0, 12)}${file.name.length > 12 ? '...' : ''}</div>
                `;
            } else {
                item.innerHTML = `
                    <div style="padding: 8px; text-align: center; background: var(--dark-surface-light); height: 70px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <i class="fas fa-file" style="font-size: 1.3rem; color: var(--dark-text-secondary);"></i>
                        <div style="font-size: 0.55rem; color: var(--dark-text-secondary); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">DOC</div>
                    </div>
                    <button class="remove-attachment" onclick="removeAttachment(${idx})" style="top: 2px; right: 2px;">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="attachment-preview-name">${file.name.substring(0, 12)}${file.name.length > 12 ? '...' : ''}</div>
                `;
            }
            
            preview.appendChild(item);
        });
        preview.style.display = 'flex';
    }
};

// Load history list
function loadHistoryList() {
    const historyList = document.getElementById('historyList');
    if (!historyList) return;
    
    if (chatHistory.length === 0) {
        historyList.innerHTML = `
            <div class="empty-history">
                <i class="fas fa-comments"></i>
                <p>No chat history yet</p>
                <p style="font-size: 0.75rem; margin-top: 0.4rem;">Start a conversation to see it here</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    chatHistory.forEach(chat => {
        const isActive = chat.id === currentChatId;
        const date = new Date(chat.date);
        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        html += `
            <div class="history-item ${isActive ? 'active' : ''}" data-chat-id="${chat.id}">
                <div class="history-title">${chat.title}</div>
                <div class="history-preview">${chat.preview}</div>
                <div class="history-date">${formattedDate}</div>
                <div class="history-item-actions">
                    <button class="history-item-btn download" onclick="downloadChatHistory('${chat.id}')" title="Download chat">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="history-item-btn delete" onclick="confirmDeleteChat('${chat.id}')" title="Delete chat">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    historyList.innerHTML = html;
    
    document.querySelectorAll('.history-item').forEach(item => {
        item.addEventListener('click', function(e) {
            if (!e.target.closest('.history-item-actions')) {
                const chatId = this.dataset.chatId;
                loadChatFromHistory(chatId);
            }
        });
    });
}

// Load chat from history
function loadChatFromHistory(chatId) {
    const chat = chatHistory.find(c => c.id === chatId);
    if (!chat) return;
    
    currentChatId = chatId;
    conversationHistory = [...chat.messages];
    
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '';
    
    chat.messages.forEach(msg => {
        const isDocument = msg.isDocument || false;
        const hasSources = msg.sources && msg.sources.length > 0;
        addMessageToChat(msg.content, msg.role === 'user', true, isDocument, msg.attachments || [], hasSources ? msg.sources : null);
    });
    
    loadHistoryList();
    
    if (window.innerWidth < 1024) {
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('sidebarOverlay').classList.remove('active');
        document.body.style.overflow = '';
    }
    
    showToast('Chat loaded from history 📚', 'success');
}

// Download chat history
window.downloadChatHistory = function(chatId) {
    const chat = chatHistory.find(c => c.id === chatId);
    if (!chat) return;
    
    let content = `LegalSwami Chat History - ${chat.title}\n`;
    content += `Date: ${new Date(chat.date).toLocaleString()}\n\n`;
    content += '='.repeat(50) + '\n\n';
    
    chat.messages.forEach((msg, index) => {
        const role = msg.role === 'user' ? 'You' : 'LegalSwami';
        const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
        content += `${role} (${time}):\n`;
        content += msg.content + '\n\n';
        content += '-'.repeat(30) + '\n\n';
    });
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `legalswami-chat-${chatId}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showDownloadNotification(`legalswami-chat-${chatId}.txt`, 'Text File');
    showToast('Chat history downloaded 📥', 'success');
};

// Confirm delete chat
window.confirmDeleteChat = function(chatId) {
    const chat = chatHistory.find(c => c.id === chatId);
    if (!chat) return;
    
    document.getElementById('deleteChatTitle').textContent = `Delete "${chat.title}"?`;
    document.getElementById('deleteModal').dataset.chatId = chatId;
    document.getElementById('deleteModal').classList.add('active');
};

// Download modal functions
function openDownloadModal() {
    document.getElementById('downloadModal').classList.add('active');
}

function openMessageDownloadModal(content) {
    messageContentForDownload = content;
    document.getElementById('messageDownloadModal').classList.add('active');
}

// Download functions
function downloadMessage(format, content) {
    const indicator = document.getElementById('messageProgressIndicator');
    indicator.classList.add('active');
    
    setTimeout(() => {
        const fileName = `LegalSwami-Document-${formatDateForFilename(new Date())}`;
        
        switch(format) {
            case 'pdf':
                downloadAsPDF(content, fileName);
                break;
            case 'doc':
                downloadAsDOC(content, fileName);
                break;
            case 'txt':
                downloadAsTXT(content, fileName);
                break;
        }
        
        indicator.classList.remove('active');
        document.getElementById('messageDownloadModal').classList.remove('active');
    }, 500);
}

function downloadChat(format) {
    const indicator = document.getElementById('progressIndicator');
    indicator.classList.add('active');
    
    setTimeout(() => {
        let content = '';
        conversationHistory.forEach((msg, index) => {
            const role = msg.role === 'user' ? 'You' : 'LegalSwami';
            const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
            content += `${role} (${time}):\n${msg.content}\n\n`;
        });
        
        const fileName = `LegalSwami-Chat-${formatDateForFilename(new Date())}`;
        
        switch(format) {
            case 'pdf':
                downloadAsPDF(content, fileName);
                break;
            case 'doc':
                downloadAsDOC(content, fileName);
                break;
            case 'txt':
                downloadAsTXT(content, fileName);
                break;
        }
        
        indicator.classList.remove('active');
        document.getElementById('downloadModal').classList.remove('active');
    }, 500);
}

// Format date for filename
function formatDateForFilename(date) {
    return date.toISOString()
        .replace(/[:\-]/g, '')
        .replace('T', '_')
        .split('.')[0];
}

// Show download notification
function showDownloadNotification(fileName, fileType) {
    const notification = document.getElementById('downloadNotification');
    const title = document.getElementById('downloadNotificationTitle');
    const message = document.getElementById('downloadNotificationMessage');
    
    title.textContent = `${fileType} Downloaded 📥`;
    message.textContent = `Click to open ${fileName}`;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 5000);
}

// Initialize voice recognition
function initializeVoiceRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = 'en-IN,hi-IN,mr-IN,ta-IN,te-IN';
        
        recognition.onstart = function() {
            isListening = true;
            if (isInputMicrophoneActive) {
                document.getElementById('inputMicrophoneBtn').classList.add('listening');
            } else {
                document.getElementById('voiceSearchBtn').classList.add('listening');
            }
            document.getElementById('voiceInputStatus').classList.add('active');
            showToast('Listening... Speak now 🎤', 'info');
        };
        
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            const voiceInputText = document.getElementById('voiceInputText');
            
            if (event.results[0].isFinal) {
                document.getElementById('userInput').value = transcript;
                document.getElementById('userInput').style.height = Math.min(document.getElementById('userInput').scrollHeight, 180) + 'px';
                voiceInputText.style.display = 'none';
                document.getElementById('sendButton').disabled = false;
                
                if (transcript.split(' ').length <= 10) {
                    setTimeout(() => {
                        sendMessage();
                    }, 1000);
                }
            } else {
                voiceInputText.textContent = transcript;
                voiceInputText.style.display = 'block';
            }
        };
        
        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            isListening = false;
            isInputMicrophoneActive = false;
            document.getElementById('inputMicrophoneBtn').classList.remove('listening');
            document.getElementById('voiceSearchBtn').classList.remove('listening');
            document.getElementById('voiceInputStatus').classList.remove('active');
            
            if (event.error === 'not-allowed') {
                showToast('Microphone access denied. Please allow microphone access. 🎤', 'error');
            } else {
                showToast('Voice recognition failed. Please try again. ❌', 'error');
            }
        };
        
        recognition.onend = function() {
            isListening = false;
            isInputMicrophoneActive = false;
            document.getElementById('inputMicrophoneBtn').classList.remove('listening');
            document.getElementById('voiceSearchBtn').classList.remove('listening');
            document.getElementById('voiceInputStatus').classList.remove('active');
            document.getElementById('voiceInputText').style.display = 'none';
        };
        
        // Add event listeners
        document.getElementById('voiceSearchBtn').addEventListener('click', toggleVoiceRecognition);
        document.getElementById('inputMicrophoneBtn').addEventListener('click', toggleInputVoiceRecognition);
    } else {
        document.getElementById('voiceSearchBtn').style.display = 'none';
        document.getElementById('inputMicrophoneBtn').style.display = 'none';
        showToast('Voice search not supported in your browser 🎤', 'warning');
    }
}

// Initialize all chat event listeners
function initializeChatEventListeners() {
    console.log('🔧 Initializing chat event listeners...');
    
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.querySelector('.sidebar-toggle');
    const sidebarClose = document.getElementById('sidebarClose');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const clearChatBtn = document.getElementById('clearChatBtn');
    const downloadCurrentBtn = document.getElementById('downloadCurrentBtn');
    const suggestionsBtn = document.getElementById('suggestionsBtn');
    const themeToggle = document.getElementById('themeToggle');
    const topicItems = document.querySelectorAll('.topic-item');
    const actionItems = document.querySelectorAll('.action-item');
    const sidebarTabs = document.querySelectorAll('.sidebar-tab');
    const newChatBtn = document.getElementById('newChatBtn');
    const attachmentBtn = document.getElementById('attachmentBtn');
    const browseFilesBtn = document.getElementById('browseFilesBtn');
    const confirmFileUpload = document.getElementById('confirmFileUpload');
    const cancelFileUpload = document.getElementById('cancelFileUpload');
    const closeFileUploadModal = document.getElementById('closeFileUploadModal');
    const uploadArea = document.getElementById('uploadArea');
    
    // Send message on Ctrl+Enter
    userInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.ctrlKey) {
            e.preventDefault();
            if (isStreamingActive) {
                stopStreaming();
            } else {
                sendMessage();
            }
        }
    });
    
    // Auto-resize textarea
    userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        
        if (isStreamingActive) {
            sendButton.disabled = false;
            sendButton.classList.add('stop-button');
            sendButton.innerHTML = '<i class="fas fa-stop"></i> <span class="hide-on-mobile">Stop</span>';
        } else {
            sendButton.disabled = this.value.trim() === '' && attachedFiles.length === 0;
            sendButton.classList.remove('stop-button');
            sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> <span class="hide-on-mobile">Send</span>';
        }
    });
    
    // Send button
    sendButton.addEventListener('click', function() {
        if (isStreamingActive) {
            stopStreaming();
        } else {
            sendMessage();
        }
    });
    
    // Theme toggle
    themeToggle.addEventListener('click', toggleTheme);
    
    // Sidebar toggle
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.add('active');
            sidebarOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        });
    }
    
    if (sidebarClose) {
        sidebarClose.addEventListener('click', function() {
            sidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
            document.body.style.overflow = '';
        });
    }
    
    if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', function() {
            sidebar.classList.remove('active');
            this.classList.remove('active');
            document.body.style.overflow = '';
        });
    }
    
    // Sidebar tabs
    sidebarTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const tabId = this.dataset.tab;
            sidebarTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.getElementById(`${tabId}-content`).classList.add('active');
            
            if (tabId === 'chat-history') {
                loadHistoryList();
            }
        });
    });
    
    // New chat
    if (newChatBtn) {
        newChatBtn.addEventListener('click', createNewChat);
    }
    
    // Clear chat
    if (clearChatBtn) {
        clearChatBtn.addEventListener('click', clearCurrentChat);
    }
    
    // Download current chat
    if (downloadCurrentBtn) {
        downloadCurrentBtn.addEventListener('click', function() {
            if (conversationHistory.length === 0) {
                showToast('No chat content to download 📄', 'warning');
                return;
            }
            openDownloadModal();
        });
    }
    
    // Suggestions
    if (suggestionsBtn) {
        suggestionsBtn.addEventListener('click', showSuggestions);
    }
    
    // Topic items
    topicItems.forEach(item => {
        item.addEventListener('click', function() {
            const topic = this.dataset.topic;
            const topicName = this.querySelector('span').textContent;
            const isActive = this.classList.contains('active-tab');
            
            if (isActive) {
                this.classList.remove('active-tab');
                removeActiveTopic(topic);
                clearTopicFileContent(topic);
                showToast(`${topicName} tab closed ✖️`, 'info');
            } else {
                this.classList.add('active-tab');
                addActiveTopic(topic, topicName);
                
                const questions = {
                    'contract': 'What are the essential elements of a valid contract under Indian law? ⚖️',
                    'employment': 'What are the rights of employees regarding workplace harassment in India? 💼',
                    'intellectual': 'How does copyright protection work for software in India? 🧠',
                    'realestate': 'What documents are required for property registration in India? 🏠',
                    'family': 'What are the grounds for divorce under Hindu Marriage Act? 👨‍👩‍👧',
                    'criminal': 'What is the difference between bailable and non-bailable offenses? ⚖️'
                };
                
                userInput.value = questions[topic] || `Tell me about ${topicName.toLowerCase()} in Indian law. ⚖️`;
                userInput.focus();
                userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
                sendButton.disabled = false;
                showToast(`${topicName} tab opened 📂`, 'success');
            }
            
            if (window.innerWidth < 1024) {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        });
    });
    
    // Action items
    actionItems.forEach(item => {
        item.addEventListener('click', function() {
            const action = this.dataset.action;
            
            if (action === 'document-drafts') {
                userInput.value = 'Create a non-disclosure agreement draft for me 📝';
                userInput.focus();
            } else if (action === 'legal-research') {
                userInput.value = 'Can you help me research case laws related to breach of contract? 🔍';
                userInput.focus();
            } else if (action === 'case-analysis') {
                userInput.value = 'Can you analyze the legal principles in landmark privacy law cases? 📊';
                userInput.focus();
            }
            
            userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
            sendButton.disabled = false;
            
            if (window.innerWidth < 1024) {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        });
    });
    
    // Attachment button
    if (attachmentBtn) {
        attachmentBtn.addEventListener('click', openFileUploadModal);
    }
    
    // File upload functionality
    if (browseFilesBtn) {
        browseFilesBtn.addEventListener('click', function() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = true;
            fileInput.accept = 'image/*,.pdf,.txt,.doc,.docx';
            
            fileInput.onchange = function(e) {
                handleFileSelection(e.target.files);
            };
            
            fileInput.click();
        });
    }
    
    // Handle drag and drop
    if (uploadArea) {
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFileSelection(e.dataTransfer.files);
            }
        });
    }
    
    // Confirm file upload
    if (confirmFileUpload) {
        confirmFileUpload.addEventListener('click', function() {
            if (selectedFiles.length === 0) {
                showToast('Please select at least one file 📎', 'warning');
                return;
            }
            
            attachedFiles = [...attachedFiles, ...selectedFiles];
            const preview = document.getElementById('attachmentsPreview');
            preview.innerHTML = '';
            
            attachedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'attachment-preview-item';
                
                if (file.type.startsWith('image/')) {
                    item.innerHTML = `
                        <img src="${file.data}" alt="${file.name}" class="attachment-preview-image">
                        <button class="remove-attachment" onclick="removeAttachment(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="attachment-preview-name">${file.name}</div>
                    `;
                } else if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
                    item.innerHTML = `
                        <div style="padding: 8px; text-align: center; background: var(--dark-surface-light); height: 70px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <i class="fas fa-file-pdf" style="font-size: 1.3rem; color: #ef4444;"></i>
                            <div style="font-size: 0.55rem; color: var(--dark-text-secondary); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">PDF</div>
                        </div>
                        <button class="remove-attachment" onclick="removeAttachment(${index})" style="top: 2px; right: 2px;">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="attachment-preview-name">${file.name.substring(0, 12)}${file.name.length > 12 ? '...' : ''}</div>
                    `;
                } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                    item.innerHTML = `
                        <div style="padding: 8px; text-align: center; background: var(--dark-surface-light); height: 70px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <i class="fas fa-file-alt" style="font-size: 1.3rem; color: #10a37f;"></i>
                            <div style="font-size: 0.55rem; color: var(--dark-text-secondary); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">TXT</div>
                        </div>
                        <button class="remove-attachment" onclick="removeAttachment(${index})" style="top: 2px; right: 2px;">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="attachment-preview-name">${file.name.substring(0, 12)}${file.name.length > 12 ? '...' : ''}</div>
                    `;
                } else {
                    item.innerHTML = `
                        <div style="padding: 8px; text-align: center; background: var(--dark-surface-light); height: 70px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <i class="fas fa-file" style="font-size: 1.3rem; color: var(--dark-text-secondary);"></i>
                            <div style="font-size: 0.55rem; color: var(--dark-text-secondary); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">DOC</div>
                        </div>
                        <button class="remove-attachment" onclick="removeAttachment(${index})" style="top: 2px; right: 2px;">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="attachment-preview-name">${file.name.substring(0, 12)}${file.name.length > 12 ? '...' : ''}</div>
                    `;
                }
                
                preview.appendChild(item);
            });
            
            preview.style.display = 'flex';
            document.getElementById('sendButton').disabled = false;
            document.getElementById('fileUploadModal').classList.remove('active');
            showToast(`${selectedFiles.length} file(s) attached 📎`, 'success');
            selectedFiles = [];
        });
    }
    
    // Cancel file upload
    if (cancelFileUpload) {
        cancelFileUpload.addEventListener('click', function() {
            document.getElementById('fileUploadModal').classList.remove('active');
            selectedFiles = [];
        });
    }
    
    // Close file upload modal
    if (closeFileUploadModal) {
        closeFileUploadModal.addEventListener('click', function() {
            document.getElementById('fileUploadModal').classList.remove('active');
        });
    }
    
    // Download modal close buttons
    document.getElementById('closeDownloadModal')?.addEventListener('click', function() {
        document.getElementById('downloadModal').classList.remove('active');
    });
    
    document.getElementById('closeMessageDownloadModal')?.addEventListener('click', function() {
        document.getElementById('messageDownloadModal').classList.remove('active');
    });
    
    // Delete modal buttons
    document.getElementById('confirmDelete')?.addEventListener('click', function() {
        const chatId = document.getElementById('deleteModal').dataset.chatId;
        const chatIndex = chatHistory.findIndex(chat => chat.id === chatId);
        
        if (chatIndex !== -1) {
            if (currentChatId === chatId) {
                createNewChat();
            }
            
            chatHistory.splice(chatIndex, 1);
            saveUserChatHistory();
            loadHistoryList();
            
            document.getElementById('deleteModal').classList.remove('active');
            showToast('Chat deleted successfully 🗑️', 'success');
        }
    });
    
    document.getElementById('cancelDelete')?.addEventListener('click', function() {
        document.getElementById('deleteModal').classList.remove('active');
    });
    
    document.getElementById('closeDeleteModal')?.addEventListener('click', function() {
        document.getElementById('deleteModal').classList.remove('active');
    });
    
    // Download option clicks
    document.querySelectorAll('.download-option').forEach(option => {
        option.addEventListener('click', function() {
            const format = this.dataset.format;
            const isMessageModal = this.closest('#messageDownloadModal') !== null;
            
            if (isMessageModal) {
                downloadMessage(format, messageContentForDownload);
            } else {
                downloadChat(format);
            }
        });
    });
    
    // Download notification close
    document.getElementById('closeDownloadNotification')?.addEventListener('click', function() {
        document.getElementById('downloadNotification').classList.remove('show');
    });
    
    // Download notification click to open file
    document.getElementById('downloadNotification')?.addEventListener('click', function() {
        if (lastDownloadedFileUrl) {
            window.open(lastDownloadedFileUrl, '_blank');
            this.classList.remove('show');
        }
    });
    
    // Scroll to bottom button
    const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
    if (scrollToBottomBtn) {
        scrollToBottomBtn.addEventListener('click', scrollToBottom);
    }
    
    // Monitor scroll position
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.addEventListener('scroll', checkScrollPosition);
        setTimeout(checkScrollPosition, 500);
        
        const observer = new MutationObserver(checkScrollPosition);
        observer.observe(chatMessages, { childList: true, subtree: true });
    }
    
    // Initialize voice recognition
    initializeVoiceRecognition();
    
    console.log('✅ Chat event listeners initialized');
}

// Active topics management
function addActiveTopic(topicId, topicName) {
    const existingIndex = activeLegalTopics.findIndex(t => t.id === topicId);
    if (existingIndex !== -1) return;
    
    activeLegalTopics.push({
        id: topicId,
        name: topicName,
        timestamp: new Date().toISOString()
    });
    
    updateActiveTopicsUI();
}

function removeActiveTopic(topicId) {
    activeLegalTopics = activeLegalTopics.filter(t => t.id !== topicId);
    updateActiveTopicsUI();
}

function updateActiveTopicsUI() {
    const activeTopicsSection = document.getElementById('activeTopicsSection');
    const activeTopicsList = document.getElementById('activeTopicsList');
    
    if (activeLegalTopics.length === 0) {
        activeTopicsSection.style.display = 'none';
        return;
    }
    
    activeTopicsSection.style.display = 'block';
    activeTopicsList.innerHTML = '';
    
    activeLegalTopics.forEach(topic => {
        const topicItem = document.createElement('div');
        topicItem.className = 'topic-item active-tab';
        topicItem.innerHTML = `
            <i class="fas fa-folder-open"></i>
            <span>${topic.name}</span>
        `;
        
        topicItem.addEventListener('click', function(e) {
            e.stopPropagation();
            const originalTopic = document.querySelector(`.topic-item[data-topic="${topic.id}"]`);
            if (originalTopic) {
                originalTopic.click();
            }
        });
        
        activeTopicsList.appendChild(topicItem);
    });
}

function clearTopicFileContent(topicId) {
    const fileContents = document.querySelectorAll(`.file-content-display[data-topic="${topicId}"]`);
    fileContents.forEach(content => {
        content.remove();
    });
}

// Handle file selection
function handleFileSelection(files) {
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        if (file.type.startsWith('image/') || 
            file.type === 'application/pdf' || 
            file.type === 'text/plain' ||
            file.type.includes('document') ||
            file.name.endsWith('.txt') ||
            file.name.endsWith('.pdf') ||
            file.name.endsWith('.doc') ||
            file.name.endsWith('.docx')) {
            
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedFiles.push({
                    name: file.name,
                    data: e.target.result,
                    type: file.type,
                    file: file,
                    size: file.size
                });
                updateUploadedFilesDisplay();
            };
            reader.readAsDataURL(file);
        } else {
            showToast(`File type not supported: ${file.name} ❌`, 'warning');
        }
    }
}

// Initialize complete chat app
function initializeCompleteChatApp() {
    console.log('💬 Initializing complete chat app...');
    
    // Initialize search counter
    initializeSearchCounter();
    
    // Load or create new chat
    if (!currentChatId || conversationHistory.length === 0) {
        createNewChat();
    } else {
        loadCurrentChatMessages();
    }
    
    // Initialize all event listeners
    initializeChatEventListeners();
    
    // Focus on input
    setTimeout(() => {
        const userInput = document.getElementById('userInput');
        if (userInput) {
            userInput.focus();
            userInput.style.height = 'auto';
            userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
        }
    }, 100);
    
    console.log('✅ Complete chat app initialized');
}

// Update the main DOMContentLoaded to include complete chat initialization
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 LegalSwami Premium Frontend Initialized');
    
    // Hide loading screen
    setTimeout(function() {
        const loadingScreen = document.getElementById('loadingScreen');
        if (loadingScreen) {
            loadingScreen.style.opacity = '0';
            setTimeout(function() {
                loadingScreen.style.display = 'none';
                console.log('✅ Loading screen hidden');
            }, 300);
        }
    }, 1500);
    
    // Initialize Google Authentication
    setTimeout(initializeGoogleAuth, 2000);
    
    // Check for existing user
    checkExistingUser();
    
    // Setup event listeners
    setupEventListeners();
    
    // When chat interface is opened, initialize complete chat
    document.querySelectorAll('#startChatBtn, #heroAssistantBtn, #ctaStartChat').forEach(btn => {
        btn.addEventListener('click', function() {
            // Give some time for chat interface to open
            setTimeout(initializeCompleteChatApp, 300);
        });
    });
    
    console.log('✅ All initialization complete');
});
    
    </script>
</body>
</html>
