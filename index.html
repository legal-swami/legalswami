<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LegalSwami | AI-Powered Legal Assistant & Document Generator</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Google Client ID -->
    <meta name="google-client-id" 
          content="166511615962-bohur5q8d4i5hud6icr4185kcte9enk8.apps.googleusercontent.com">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚖️</text></svg>">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#0f172a">
    
    <!-- Apple Mobile Web App Capable -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Open Graph / Social Media -->
    <meta property="og:title" content="LegalSwami - AI Legal Assistant">
    <meta property="og:description" content="Get instant legal advice, generate documents, and understand laws with AI">
    <meta property="og:image" content="https://legalswami.com/og-image.jpg">
    <meta property="og:url" content="https://legalswami.com">
    
    <style>
:root {
    /* ChatGPT-like Colors */
    --primary: #10a37f;
    --primary-dark: #0d8c6d;
    --primary-light: #12b886;
    --secondary: #7e57c2;
    --accent: #ec4899;
    
    /* Dark Mode (ChatGPT-like) */
    --dark-bg: #343541;
    --dark-surface: #40414f;
    --dark-surface-light: #444654;
    --dark-border: #565869;
    --dark-text: #ececf1;
    --dark-text-secondary: #8e8ea0;
    --dark-text-tertiary: #6e6e80;
    
    /* Light Mode (ChatGPT-like) */
    --light-bg: #ffffff;
    --light-surface: #f7f7f8;
    --light-surface-light: #f0f0f0;
    --light-border: #e5e5e5;
    --light-text: #000000;
    --light-text-secondary: #6e6e80;
    --light-text-tertiary: #8e8ea0;
    
    /* Status Colors */
    --success: #10b981;
    --warning: #f59e0b;
    --error: #ef4444;
    --info: #3b82f6;
}
        
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
    -webkit-tap-highlight-color: transparent;
}
        
body {
    background: var(--dark-bg);
    color: var(--dark-text);
    line-height: 1.5;
    min-height: 100vh;
    overflow-x: hidden;
    transition: all 0.2s ease;
    overflow-y: auto;
    font-size: 14px;
}
        
body.light-mode {
    background: var(--light-bg);
    color: var(--light-text);
}

/* ChatGPT-like Container */
.container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    width: 100%;
    background: var(--dark-bg);
    overflow: hidden;
    transition: all 0.2s ease;
    position: relative;
}
        
.light-mode .container {
    background: var(--light-bg);
}

/* ChatGPT-like Header - FIXED FOR MOBILE */
header {
    background: var(--dark-surface);
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--dark-border);
    position: sticky;
    top: 0;
    z-index: 1000;
    min-height: 60px;
    transition: all 0.2s ease;
    width: 100%;
    flex-shrink: 0;
    overflow-x: auto;
    overflow-y: hidden;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
}
        
.light-mode header {
    background: var(--light-surface);
    border-bottom-color: var(--light-border);
}
        
/* Hide scrollbar but keep functionality */
header::-webkit-scrollbar {
    height: 0;
    background: transparent;
}
        
.logo {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
    position: sticky;
    left: 0;
    background: inherit;
    padding-right: 10px;
    z-index: 2;
}
        
.logo-icon {
    font-size: 1.1rem;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
        
.logo h1 {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--dark-text);
    white-space: nowrap;
}
        
.light-mode .logo h1 {
    color: var(--light-text);
}
        
.header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: nowrap;
    justify-content: flex-end;
    min-width: max-content;
    padding-left: 10px;
}
        
.header-btn {
    background: var(--dark-surface-light);
    color: var(--dark-text);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
    min-height: 36px;
    font-weight: 500;
    flex-shrink: 0;
}
        
.light-mode .header-btn {
    background: var(--light-surface-light);
    color: var(--light-text);
    border-color: var(--light-border);
}
        
.header-btn:hover {
    background: var(--dark-border);
}
        
.light-mode .header-btn:hover {
    background: var(--light-border);
}
        
.status-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 0.4rem 0.75rem;
    background: rgba(16, 163, 127, 0.1);
    border: 1px solid rgba(16, 163, 127, 0.3);
    border-radius: 6px;
    font-size: 0.85rem;
    white-space: nowrap;
    flex-shrink: 0;
    min-height: 36px;
    font-weight: 500;
}
        
.light-mode .status-indicator {
    background: rgba(16, 163, 127, 0.08);
    border-color: rgba(16, 163, 127, 0.2);
}
        
.status-dot {
    width: 8px;
    height: 8px;
    background-color: var(--success);
    border-radius: 50%;
    animation: pulse 2s infinite;
}
        
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
        
.theme-toggle {
    background: var(--dark-surface-light);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    flex-shrink: 0;
}
        
.light-mode .theme-toggle {
    background: var(--light-surface-light);
    border-color: var(--light-border);
}
        
.theme-toggle:hover {
    transform: rotate(15deg);
}
        
.theme-toggle i {
    color: var(--dark-text);
    transition: all 0.2s;
    font-size: 1rem;
}
        
.light-mode .theme-toggle i {
    color: var(--light-text);
}

/* ChatGPT-like Main Layout */
.main-content {
    display: flex;
    flex: 1;
    overflow: hidden;
    position: relative;
    width: 100%;
    min-height: 0;
}

/* ChatGPT-like Sidebar */
.sidebar {
    width: 260px;
    background: var(--dark-surface);
    border-right: 1px solid var(--dark-border);
    display: flex;
    flex-direction: column;
    transition: transform 0.2s ease;
    z-index: 50;
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    overflow: hidden;
    transform: translateX(-100%);
}
        
.light-mode .sidebar {
    background: var(--light-surface);
    border-right-color: var(--light-border);
}
        
.sidebar.active {
    transform: translateX(0);
}
        
.sidebar-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: var(--dark-surface-light);
    color: var(--dark-text);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    padding: 0.5rem;
    cursor: pointer;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
}
        
.light-mode .sidebar-close {
    background: var(--light-surface-light);
    color: var(--light-text);
    border-color: var(--light-border);
}
        
.sidebar-close:hover {
    background: var(--dark-border);
}
        
.light-mode .sidebar-close:hover {
    background: var(--light-border);
}
        
.sidebar-tabs {
    display: flex;
    border-bottom: 1px solid var(--dark-border);
    background: var(--dark-surface);
    position: sticky;
    top: 0;
    z-index: 20;
}
        
.light-mode .sidebar-tabs {
    background: var(--light-surface);
    border-bottom-color: var(--light-border);
}
        
.sidebar-tab {
    flex: 1;
    padding: 0.875rem 0.5rem;
    background: transparent;
    border: none;
    color: var(--dark-text-secondary);
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    position: relative;
    white-space: nowrap;
}
        
.light-mode .sidebar-tab {
    color: var(--light-text-secondary);
}
        
.sidebar-tab:hover {
    color: var(--dark-text);
    background: var(--dark-surface-light);
}
        
.light-mode .sidebar-tab:hover {
    color: var(--light-text);
    background: var(--light-surface-light);
}
        
.sidebar-tab.active {
    color: var(--primary);
    background: var(--dark-surface-light);
}
        
.light-mode .sidebar-tab.active {
    background: var(--light-surface-light);
}
        
.tab-content {
    flex: 1;
    overflow-y: auto;
    display: none;
}
        
.tab-content.active {
    display: block;
}
        
.sidebar-header {
    padding: 0.875rem 1rem;
    border-bottom: 1px solid var(--dark-border);
    position: sticky;
    top: 0;
    background: var(--dark-surface);
    z-index: 10;
}
        
.light-mode .sidebar-header {
    background: var(--light-surface);
    border-bottom-color: var(--light-border);
}
        
.sidebar-header h2 {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--dark-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 8px;
}
        
.light-mode .sidebar-header h2 {
    color: var(--light-text-secondary);
}
        
.sidebar-section {
    padding: 0.875rem 1rem;
}
        
.sidebar-section h3 {
    font-size: 0.85rem;
    margin-bottom: 0.75rem;
    color: var(--dark-text-secondary);
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
}
        
.light-mode .sidebar-section h3 {
    color: var(--light-text-secondary);
}
        
.topic-list, .quick-actions {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
        
.topic-item, .action-item {
    padding: 0.75rem;
    background: transparent;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--dark-text);
    min-height: 40px;
    text-align: left;
    width: 100%;
    font-size: 0.875rem;
    font-weight: 500;
}
        
.light-mode .topic-item,
.light-mode .action-item {
    color: var(--light-text);
}
        
.topic-item:hover, .action-item:hover {
    background: var(--dark-surface-light);
}
        
.light-mode .topic-item:hover,
.light-mode .action-item:hover {
    background: var(--light-surface-light);
}
        
.topic-item i, .action-item i {
    width: 18px;
    text-align: center;
    font-size: 0.9rem;
    flex-shrink: 0;
}
        
.history-header {
    padding: 0.875rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--dark-border);
    position: sticky;
    top: 0;
    background: var(--dark-surface);
    z-index: 10;
}
        
.light-mode .history-header {
    background: var(--light-surface);
    border-bottom-color: var(--light-border);
}
        
.history-header h2 {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--dark-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 8px;
}
        
.light-mode .history-header h2 {
    color: var(--light-text-secondary);
}
        
.new-chat-btn {
    background: var(--dark-surface-light);
    color: var(--dark-text);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
}
        
.light-mode .new-chat-btn {
    background: var(--light-surface-light);
    color: var(--light-text);
    border-color: var(--light-border);
}
        
.new-chat-btn:hover {
    background: var(--dark-border);
}
        
.light-mode .new-chat-btn:hover {
    background: var(--light-border);
}
        
.history-list {
    padding: 0.5rem;
}
        
.history-item {
    padding: 0.75rem;
    background: transparent;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    display: flex;
    flex-direction: column;
    gap: 4px;
    color: var(--dark-text);
    margin-bottom: 4px;
    position: relative;
    text-align: left;
    width: 100%;
}
        
.light-mode .history-item {
    color: var(--light-text);
}
        
.history-item:hover {
    background: var(--dark-surface-light);
}
        
.light-mode .history-item:hover {
    background: var(--light-surface-light);
}
        
.history-item.active {
    background: rgba(16, 163, 127, 0.1);
    border: 1px solid rgba(16, 163, 127, 0.3);
}
        
.light-mode .history-item.active {
    background: rgba(16, 163, 127, 0.08);
    border-color: rgba(16, 163, 127, 0.2);
}
        
.history-title {
    font-size: 0.875rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding-right: 60px;
}
        
.history-preview {
    font-size: 0.8rem;
    color: var(--dark-text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding-right: 60px;
}
        
.light-mode .history-preview {
    color: var(--light-text-secondary);
}
        
.history-date {
    font-size: 0.75rem;
    color: var(--dark-text-secondary);
}
        
.light-mode .history-date {
    color: var(--light-text-secondary);
}
        
.history-item-actions {
    display: none;
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    gap: 4px;
    background: var(--dark-surface);
    padding: 4px;
    border-radius: 6px;
    border: 1px solid var(--dark-border);
    z-index: 5;
}
        
.light-mode .history-item-actions {
    background: var(--light-surface);
    border-color: var(--light-border);
}
        
.history-item:hover .history-item-actions {
    display: flex;
}
        
.history-item-btn {
    background: transparent;
    border: none;
    color: var(--dark-text-secondary);
    cursor: pointer;
    padding: 4px 6px;
    border-radius: 4px;
    font-size: 0.8rem;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
}
        
.light-mode .history-item-btn {
    color: var(--light-text-secondary);
}
        
.history-item-btn:hover {
    background: var(--dark-surface-light);
}
        
.light-mode .history-item-btn:hover {
    background: var(--light-surface-light);
}
        
.history-item-btn.delete:hover {
    color: var(--error);
}
        
.history-item-btn.download:hover {
    color: var(--primary);
}
        
.empty-history {
    text-align: center;
    padding: 2.5rem 1rem;
    color: var(--dark-text-secondary);
}
        
.light-mode .empty-history {
    color: var(--light-text-secondary);
}
        
.empty-history i {
    font-size: 1.75rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}
        
.empty-history p {
    font-size: 0.875rem;
}

/* ChatGPT-like Chat Container */
.chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--dark-bg);
    width: 100%;
    height: 100%;
    min-height: 0;
    overflow: hidden;
}
        
.light-mode .chat-container {
    background: var(--light-bg);
}
        
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1.25rem 1rem;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    min-height: 0;
    width: 100%;
}
        
.message {
    display: flex;
    gap: 0.75rem;
    max-width: 100%;
    padding: 0 0.75rem;
    animation: fadeIn 0.2s ease-out;
}
        
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
        
.user-message {
    background: var(--dark-surface);
    border-radius: 8px;
    padding: 1rem;
    max-width: 100%;
}
        
.light-mode .user-message {
    background: var(--light-surface);
}
        
.ai-message {
    background: transparent;
}
        
.avatar {
    width: 32px;
    height: 32px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
    flex-shrink: 0;
    margin-top: 4px;
}
        
.user-message .avatar {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
}
        
.ai-message .avatar {
    background: linear-gradient(135deg, var(--secondary) 0%, #5e35b1 100%);
}
        
.message-content {
    flex: 1;
    position: relative;
    width: 100%;
    min-width: 0;
}
        
.message-text {
    padding: 0;
    border-radius: 0;
    font-size: 0.9375rem;
    line-height: 1.6;
    word-wrap: break-word;
    overflow-wrap: break-word;
    overflow: hidden;
    color: var(--dark-text);
}
        
.light-mode .message-text {
    color: var(--light-text);
}
        
.user-message .message-text {
    color: white;
}
        
.message-attachments {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
        
.attachment-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    max-width: 200px;
    border: 1px solid var(--dark-border);
}
        
.light-mode .attachment-item {
    border-color: var(--light-border);
}
        
.attachment-image {
    max-width: 100%;
    max-height: 200px;
    object-fit: cover;
    display: block;
}
        
.attachment-name {
    padding: 4px 8px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    font-size: 0.75rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
        
/* ChatGPT-like Message Actions */
.message-actions {
    display: flex;
    gap: 8px;
    margin-top: 0.75rem;
    flex-wrap: wrap;
    opacity: 0;
    transition: opacity 0.2s ease;
}
        
.message:hover .message-actions {
    opacity: 1;
}
        
.action-btn {
    background: var(--dark-surface-light);
    color: var(--dark-text-secondary);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    padding: 0.375rem 0.75rem;
    cursor: pointer;
    font-size: 0.8125rem;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    min-height: 32px;
    font-weight: 500;
    white-space: nowrap;
}
        
.light-mode .action-btn {
    background: var(--light-surface-light);
    color: var(--light-text-secondary);
    border-color: var(--light-border);
}
        
.action-btn:hover {
    background: var(--dark-border);
    color: var(--dark-text);
}
        
.light-mode .action-btn:hover {
    background: var(--light-border);
    color: var(--light-text);
}
        
.action-btn.copy:hover {
    background: var(--success);
    border-color: var(--success);
    color: white;
}
        
.action-btn.like:hover {
    background: var(--success);
    border-color: var(--success);
    color: white;
}
        
.action-btn.dislike:hover {
    background: var(--error);
    border-color: var(--error);
    color: white;
}
        
.action-btn.download:hover {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
}
        
.document-download-btn {
    position: absolute;
    top: -12px;
    right: 8px;
    background: var(--dark-surface);
    border: 1px solid var(--primary);
    border-radius: 20px;
    padding: 6px 12px;
    color: var(--primary);
    cursor: pointer;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: all 0.2s;
    z-index: 5;
    opacity: 0;
    transform: translateY(5px);
    font-weight: 500;
}
        
.light-mode .document-download-btn {
    background: var(--light-surface);
    border-color: var(--primary);
    color: var(--primary);
}
        
.ai-message .message-content:hover .document-download-btn {
    opacity: 1;
    transform: translateY(0);
}
        
.document-download-btn:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
}
        
.document-template {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 8px;
    padding: 1.25rem;
    margin: 0.75rem 0;
    overflow: hidden;
}
        
.light-mode .document-template {
    background: var(--light-surface);
    border-color: var(--light-border);
}
        
.document-header {
    text-align: center;
    border-bottom: 2px solid var(--primary);
    padding-bottom: 1rem;
    margin-bottom: 1.25rem;
}
        
.document-title {
    font-size: 1.375rem;
    color: var(--primary);
    margin-bottom: 0.5rem;
    word-wrap: break-word;
    font-weight: 600;
}
        
.document-subtitle {
    color: var(--dark-text-secondary);
    font-size: 0.875rem;
}
        
.light-mode .document-subtitle {
    color: var(--light-text-secondary);
}
        
.document-section {
    margin-bottom: 1.25rem;
}
        
.document-section-title {
    color: var(--primary);
    font-size: 1rem;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--dark-border);
    word-wrap: break-word;
    font-weight: 600;
}
        
.light-mode .document-section-title {
    border-bottom-color: var(--light-border);
}
        
.document-clause {
    margin-bottom: 0.875rem;
    padding-left: 1rem;
    border-left: 3px solid var(--primary-light);
}
        
.clause-title {
    font-weight: 600;
    color: var(--dark-text);
    margin-bottom: 0.5rem;
    word-wrap: break-word;
}
        
.light-mode .clause-title {
    color: var(--light-text);
}
        
.clause-content {
    color: var(--dark-text-secondary);
    line-height: 1.6;
    word-wrap: break-word;
}
        
.light-mode .clause-content {
    color: var(--light-text-secondary);
}
        
.signature-section {
    margin-top: 1.75rem;
    padding-top: 1.25rem;
    border-top: 1px solid var(--dark-border);
}
        
.light-mode .signature-section {
    border-top-color: var(--light-border);
}
        
.signature-line {
    display: flex;
    justify-content: space-between;
    margin-top: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}
        
.signature-block {
    flex: 1;
    padding: 0.875rem;
    min-width: 150px;
}
        
.signature-name {
    border-bottom: 1px solid var(--dark-border);
    padding-bottom: 0.5rem;
    margin-bottom: 0.5rem;
    min-height: 30px;
}
        
.light-mode .signature-name {
    border-bottom-color: var(--light-border);
}
        
.signature-label {
    font-size: 0.8125rem;
    color: var(--dark-text-secondary);
}
        
.light-mode .signature-label {
    color: var(--light-text-secondary);
}
        
.welcome-message {
    text-align: center;
    max-width: 600px;
    margin: 1.5rem auto;
    padding: 1.25rem;
    background: linear-gradient(135deg, rgba(16, 163, 127, 0.1) 0%, rgba(30, 64, 175, 0.1) 100%);
    border: 1px solid var(--dark-border);
    border-radius: 12px;
    width: 90%;
}
        
.light-mode .welcome-message {
    background: linear-gradient(135deg, rgba(16, 163, 127, 0.08) 0%, rgba(30, 64, 175, 0.08) 100%);
    border-color: var(--light-border);
}
        
.welcome-message h2 {
    font-size: 1.5rem;
    margin-bottom: 0.75rem;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    word-wrap: break-word;
    font-weight: 600;
}
        
.welcome-message p {
    color: var(--dark-text-secondary);
    font-size: 0.9375rem;
    margin-bottom: 1rem;
    line-height: 1.5;
    word-wrap: break-word;
}
        
.light-mode .welcome-message p {
    color: var(--light-text-secondary);
}
        
.welcome-features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 0.875rem;
    margin-top: 1.25rem;
}
        
.feature {
    background: var(--dark-surface);
    padding: 0.875rem;
    border-radius: 8px;
    border: 1px solid var(--dark-border);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    word-wrap: break-word;
}
        
.light-mode .feature {
    background: var(--light-surface);
    border-color: var(--light-border);
}
        
.feature i {
    font-size: 1.375rem;
    color: var(--primary);
    margin-bottom: 0.5rem;
}
        
.feature h4 {
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
    color: var(--dark-text);
    font-weight: 600;
}
        
.light-mode .feature h4 {
    color: var(--light-text);
}
        
.feature p {
    font-size: 0.8125rem;
    color: var(--dark-text-secondary);
}
        
.light-mode .feature p {
    color: var(--light-text-secondary);
}

/* ChatGPT-like Input Area */
.input-container {
    padding: 0.875rem;
    background: var(--dark-bg);
    border-top: 1px solid var(--dark-border);
    position: sticky;
    bottom: 0;
    z-index: 10;
    transition: all 0.2s ease;
    width: 100%;
    flex-shrink: 0;
}
        
.light-mode .input-container {
    background: var(--light-bg);
    border-top-color: var(--light-border);
}
        
.input-area {
    max-width: 800px;
    margin: 0 auto;
    position: relative;
    width: 100%;
}
        
.attachments-preview {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 8px;
    padding: 6px;
    background: var(--dark-surface-light);
    border-radius: 8px;
    border: 1px solid var(--dark-border);
    max-height: 100px;
    overflow-y: auto;
}
        
.light-mode .attachments-preview {
    background: var(--light-surface-light);
    border-color: var(--light-border);
}
        
.attachment-preview-item {
    position: relative;
    width: 70px;
    height: 70px;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid var(--dark-border);
}
        
.light-mode .attachment-preview-item {
    border-color: var(--light-border);
}
        
.attachment-preview-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
        
.remove-attachment {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 20px;
    height: 20px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
}
        
.attachment-preview-name {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 2px 4px;
    font-size: 0.625rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
        
.input-area textarea {
    width: 100%;
    padding: 0.875rem 6.5rem 0.875rem 1rem;
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 12px;
    color: var(--dark-text);
    font-size: 0.9375rem;
    resize: none;
    min-height: 52px;
    max-height: 150px;
    transition: all 0.2s;
    line-height: 1.5;
    font-family: inherit;
    outline: none;
}
        
.light-mode .input-area textarea {
    background: var(--light-surface);
    border-color: var(--light-border);
    color: var(--light-text);
}
        
.input-area textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.1);
}
        
.input-buttons {
    position: absolute;
    right: 0.75rem;
    bottom: 0.75rem;
    display: flex;
    gap: 6px;
    align-items: center;
}
        
.attachment-btn {
    background: transparent;
    border: none;
    color: var(--dark-text-secondary);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
}
        
.light-mode .attachment-btn {
    color: var(--light-text-secondary);
}
        
.attachment-btn:hover {
    background: var(--dark-surface-light);
    color: var(--dark-text);
}
        
.light-mode .attachment-btn:hover {
    background: var(--light-surface-light);
    color: var(--light-text);
}
        
.input-microphone-btn {
    background: transparent;
    border: none;
    color: var(--dark-text-secondary);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
}
        
.light-mode .input-microphone-btn {
    color: var(--light-text-secondary);
}
        
.input-microphone-btn:hover {
    background: var(--dark-surface-light);
    color: var(--dark-text);
}
        
.light-mode .input-microphone-btn:hover {
    background: var(--light-surface-light);
    color: var(--light-text);
}
        
.input-microphone-btn.listening {
    color: var(--error);
    animation: pulse 1.5s infinite;
}
        
.input-microphone-btn.listening:hover {
    background: rgba(239, 68, 68, 0.1);
}
        
.send-button {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.5rem 0.875rem;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    min-height: 40px;
    font-size: 0.875rem;
}
        
.send-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
}
        
.send-button:disabled {
    background: var(--dark-border);
    cursor: not-allowed;
    opacity: 0.5;
}
        
.light-mode .send-button:disabled {
    background: var(--light-border);
}
        
.voice-input-status {
    position: absolute;
    left: 12px;
    bottom: 8px;
    background: rgba(239, 68, 68, 0.1);
    color: var(--error);
    padding: 4px 8px;
    border-radius: 8px;
    font-size: 0.75rem;
    display: none;
    align-items: center;
    gap: 4px;
    animation: fadeIn 0.2s ease;
}
        
.voice-input-status.active {
    display: flex;
}
        
.typing-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0.875rem 1rem;
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 12px;
    max-width: fit-content;
    margin-left: 2.5rem;
    margin-top: 0.5rem;
}
        
.light-mode .typing-indicator {
    background: var(--light-surface);
    border-color: var(--light-border);
}
        
.typing-dot {
    width: 8px;
    height: 8px;
    background-color: var(--primary);
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
}
        
.typing-dot:nth-child(1) {
    animation-delay: -0.32s;
}
        
.typing-dot:nth-child(2) {
    animation-delay: -0.16s;
}
        
@keyframes typing {
    0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}
        
.toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--dark-surface);
    color: var(--dark-text);
    padding: 0.875rem 1rem;
    border-radius: 8px;
    border: 1px solid var(--dark-border);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    gap: 8px;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.2s ease;
    z-index: 1000;
    max-width: 300px;
}
        
.light-mode .toast {
    background: var(--light-surface);
    color: var(--light-text);
    border-color: var(--light-border);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}
        
.toast.show {
    transform: translateY(0);
    opacity: 1;
}
        
.toast.success {
    border-left: 4px solid var(--success);
}
        
.toast.error {
    border-left: 4px solid var(--error);
}
        
.toast.warning {
    border-left: 4px solid var(--warning);
}
        
.toast.info {
    border-left: 4px solid var(--primary);
}
        
.sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 45;
}
        
.light-mode .sidebar-overlay {
    background: rgba(0, 0, 0, 0.3);
}
        
.sidebar-overlay.active {
    display: block;
}
        
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 16px;
}
        
.light-mode .modal-overlay {
    background: rgba(0, 0, 0, 0.5);
}
        
.modal-overlay.active {
    display: flex;
}
        
.modal {
    background: var(--dark-surface);
    border-radius: 12px;
    border: 1px solid var(--dark-border);
    width: 100%;
    max-width: 480px;
    max-height: 90vh;
    overflow: hidden;
    animation: modalSlideIn 0.2s ease-out;
}
        
.light-mode .modal {
    background: var(--light-surface);
    border-color: var(--light-border);
}
        
@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
        
.modal-header {
    padding: 1.25rem;
    border-bottom: 1px solid var(--dark-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
        
.light-mode .modal-header {
    border-bottom-color: var(--light-border);
}
        
.modal-header h2 {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--dark-text);
}
        
.light-mode .modal-header h2 {
    color: var(--light-text);
}
        
.modal-close {
    background: transparent;
    border: none;
    color: var(--dark-text-secondary);
    cursor: pointer;
    font-size: 1.125rem;
    padding: 4px;
    border-radius: 6px;
    transition: all 0.2s;
}
        
.light-mode .modal-close {
    color: var(--light-text-secondary);
}
        
.modal-close:hover {
    background: var(--dark-surface-light);
    color: var(--dark-text);
}
        
.light-mode .modal-close:hover {
    background: var(--light-surface-light);
    color: var(--light-text);
}
        
.modal-content {
    padding: 1.25rem;
}
        
.download-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.875rem;
    margin: 1.25rem 0;
}
        
.download-option {
    background: var(--dark-surface-light);
    border: 1px solid var(--dark-border);
    border-radius: 8px;
    padding: 1.25rem 0.875rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}
        
.light-mode .download-option {
    background: var(--light-surface-light);
    border-color: var(--light-border);
}
        
.download-option:hover {
    background: var(--dark-border);
    border-color: var(--primary);
    transform: translateY(-2px);
}
        
.light-mode .download-option:hover {
    background: var(--light-border);
}
        
.download-option i {
    font-size: 1.75rem;
    color: var(--primary);
}
        
.download-option h3 {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--dark-text);
}
        
.light-mode .download-option h3 {
    color: var(--light-text);
}
        
.download-option p {
    font-size: 0.8125rem;
    color: var(--dark-text-secondary);
}
        
.light-mode .download-option p {
    color: var(--light-text-secondary);
}
        
.modal-footer {
    padding: 1.25rem;
    border-top: 1px solid var(--dark-border);
    text-align: center;
}
        
.light-mode .modal-footer {
    border-top-color: var(--light-border);
}
        
.modal-footer p {
    font-size: 0.8125rem;
    color: var(--dark-text-secondary);
}
        
.light-mode .modal-footer p {
    color: var(--light-text-secondary);
}
        
.progress-indicator {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 0.875rem;
    padding: 1.5rem;
}
        
.progress-indicator.active {
    display: flex;
}
        
.progress-spinner {
    width: 36px;
    height: 36px;
    border: 3px solid var(--dark-border);
    border-top: 3px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
        
.light-mode .progress-spinner {
    border-color: var(--light-border);
}
        
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
        
.confirmation-modal {
    max-width: 360px;
}
        
.confirmation-text {
    text-align: center;
    margin-bottom: 1.25rem;
}
        
.confirmation-text i {
    font-size: 2.5rem;
    color: var(--error);
    margin-bottom: 0.875rem;
}
        
.confirmation-buttons {
    display: flex;
    gap: 0.875rem;
    margin-top: 1.5rem;
}
        
.confirmation-btn {
    flex: 1;
    padding: 0.75rem;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
    font-size: 0.875rem;
}
        
.confirmation-btn.cancel {
    background: var(--dark-surface-light);
    color: var(--dark-text);
    border: 1px solid var(--dark-border);
}
        
.light-mode .confirmation-btn.cancel {
    background: var(--light-surface-light);
    color: var(--light-text);
    border-color: var(--light-border);
}
        
.confirmation-btn.cancel:hover {
    background: var(--dark-border);
}
        
.light-mode .confirmation-btn.cancel:hover {
    background: var(--light-border);
}
        
.confirmation-btn.delete {
    background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
    color: white;
}
        
.confirmation-btn.delete:hover {
    opacity: 0.9;
    transform: translateY(-2px);
}
        
/* Scroll to Bottom Button */
.scroll-to-bottom-btn {
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: 40px;
    height: 40px;
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 50%;
    color: var(--dark-text);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    z-index: 900;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    opacity: 0;
    transform: translateY(20px);
}
        
.light-mode .scroll-to-bottom-btn {
    background: var(--light-surface);
    border-color: var(--light-border);
    color: var(--light-text);
}
        
.scroll-to-bottom-btn.visible {
    opacity: 1;
    transform: translateY(0);
}
        
.scroll-to-bottom-btn:hover {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(16, 163, 127, 0.3);
}
        
.user-message-controls {
    position: relative;
    margin-top: 8px;
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    opacity: 1 !important;
    z-index: 5;
}
        
.user-message-btn {
    background: var(--dark-surface-light);
    color: var(--dark-text);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    cursor: pointer;
    padding: 6px 10px;
    font-size: 0.75rem;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
    min-width: 32px;
    min-height: 32px;
    justify-content: center;
    font-weight: 500;
}
        
.light-mode .user-message-btn {
    background: var(--light-surface-light);
    color: var(--light-text);
    border-color: var(--light-border);
}
        
.user-message-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}
        
.user-message-btn.copy-btn {
    background: rgba(16, 163, 127, 0.1);
    border-color: rgba(16, 163, 127, 0.3);
    color: var(--primary);
}
        
.user-message-btn.copy-btn:hover {
    background: rgba(16, 163, 127, 0.3);
    border-color: rgba(16, 163, 127, 0.5);
}
        
.user-message-btn.edit-btn {
    background: rgba(59, 130, 246, 0.1);
    border-color: rgba(59, 130, 246, 0.3);
    color: #3b82f6;
}
        
.user-message-btn.edit-btn:hover {
    background: rgba(59, 130, 246, 0.3);
    border-color: rgba(59, 130, 246, 0.5);
}
        
.user-message:hover .user-message-controls {
    opacity: 1;
}
        
.stream-controls {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    padding: 0 8px;
}
        
.stream-control-btn {
    background: var(--dark-surface-light);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    padding: 6px 10px;
    color: var(--dark-text-secondary);
    cursor: pointer;
    font-size: 0.75rem;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: 500;
}
        
.light-mode .stream-control-btn {
    background: var(--light-surface-light);
    border-color: var(--light-border);
    color: var(--light-text-secondary);
}
        
.stream-control-btn:hover {
    background: var(--dark-border);
    color: var(--dark-text);
}
        
.light-mode .stream-control-btn:hover {
    background: var(--light-border);
    color: var(--light-text);
}
        
.stream-control-btn.pause-btn:hover {
    background: var(--warning);
    border-color: var(--warning);
    color: white;
}
        
.stream-control-btn.copy-btn:hover {
    background: var(--success);
    border-color: var(--success);
    color: white;
}
        
.scroll-position-indicator {
    position: absolute;
    bottom: -25px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--dark-surface);
    color: var(--dark-text-secondary);
    padding: 4px 12px;
    border-radius: 8px;
    font-size: 0.75rem;
    border: 1px solid var(--dark-border);
    display: none;
    z-index: 10;
}
        
.light-mode .scroll-position-indicator {
    background: var(--light-surface);
    color: var(--light-text-secondary);
    border-color: var(--light-border);
}
        
.scroll-position-indicator.visible {
    display: block;
}
        
.image-upload-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 16px;
}
        
.image-upload-modal.active {
    display: flex;
}
        
.image-upload-content {
    background: var(--dark-surface);
    border-radius: 12px;
    border: 1px solid var(--dark-border);
    width: 100%;
    max-width: 480px;
    max-height: 90vh;
    overflow: hidden;
    animation: modalSlideIn 0.2s ease-out;
}
        
.light-mode .image-upload-content {
    background: var(--light-surface);
    border-color: var(--light-border);
}
        
.upload-area {
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    border: 2px dashed var(--dark-border);
    border-radius: 8px;
    margin: 1.25rem;
    transition: all 0.2s;
}
        
.light-mode .upload-area {
    border-color: var(--light-border);
}
        
.upload-area:hover {
    border-color: var(--primary);
    background: rgba(16, 163, 127, 0.05);
}
        
.light-mode .upload-area:hover {
    background: rgba(16, 163, 127, 0.02);
}
        
.upload-area.dragover {
    border-color: var(--primary);
    background: rgba(16, 163, 127, 0.1);
}
        
.upload-icon {
    font-size: 2.5rem;
    color: var(--primary);
    margin-bottom: 0.875rem;
}
        
.upload-text h3 {
    font-size: 1.125rem;
    margin-bottom: 0.5rem;
    color: var(--dark-text);
    font-weight: 600;
}
        
.light-mode .upload-text h3 {
    color: var(--light-text);
}
        
.upload-text p {
    color: var(--dark-text-secondary);
    font-size: 0.875rem;
    margin-bottom: 0.875rem;
}
        
.light-mode .upload-text p {
    color: var(--light-text-secondary);
}
        
.upload-btn {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    font-size: 0.9375rem;
    font-weight: 500;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}
        
.upload-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
}
        
.uploaded-images {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 8px;
    margin: 1.25rem;
    max-height: 250px;
    overflow-y: auto;
}
        
.uploaded-image-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--dark-border);
}
        
.light-mode .uploaded-image-item {
    border-color: var(--light-border);
}
        
.uploaded-image-preview {
    width: 100%;
    height: 100px;
    object-fit: cover;
    display: block;
}
        
.remove-uploaded-image {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 24px;
    height: 24px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
}
        
.share-btn {
    position: absolute;
    top: 4px;
    left: 4px;
    background: rgba(16, 163, 127, 0.9);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    gap: 4px;
    z-index: 2;
    font-weight: 500;
}
        
.share-btn:hover {
    background: rgba(16, 163, 127, 1);
}
        
.streaming-content {
    min-height: 20px;
}
        
.streaming-cursor {
    display: inline-block;
    width: 8px;
    height: 20px;
    background-color: var(--primary);
    margin-left: 4px;
    vertical-align: middle;
    animation: cursorBlink 1s infinite;
}
        
@keyframes cursorBlink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}
        
.streaming-loader {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 8px;
}
        
.streaming-loader .dot {
    width: 8px;
    height: 8px;
    background-color: var(--primary);
    border-radius: 50%;
    animation: streamingDots 1.4s infinite ease-in-out both;
}
        
.streaming-loader .dot:nth-child(1) {
    animation-delay: -0.32s;
}
        
.streaming-loader .dot:nth-child(2) {
    animation-delay: -0.16s;
}
        
@keyframes streamingDots {
    0%, 80%, 100% { 
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% { 
        transform: scale(1);
        opacity: 1;
    }
}
        
.request-attachments {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
}
        
.message-text p {
    margin-bottom: 0.5rem;
}
        
.message-text p:last-child {
    margin-bottom: 0;
}
        
.message-text ul, .message-text ol {
    margin-left: 1.5rem;
    margin-bottom: 0.5rem;
}
        
.message-text li {
    margin-bottom: 0.25rem;
}
        
.paused-indicator {
    display: inline-block;
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    margin-left: 8px;
    border: 1px solid rgba(245, 158, 11, 0.3);
    font-weight: 500;
}
        
.file-content-display {
    background: var(--dark-surface-light);
    border: 1px solid var(--dark-border);
    border-radius: 8px;
    padding: 0.875rem;
    margin: 8px 0;
    max-height: 250px;
    overflow-y: auto;
    font-size: 0.8125rem;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
    position: relative;
}
    
.light-mode .file-content-display {
    background: var(--light-surface-light);
    border-color: var(--light-border);
}
    
.file-content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--dark-border);
}
    
.light-mode .file-content-header {
    border-bottom-color: var(--light-border);
}
    
.file-content-title {
    font-weight: 600;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.875rem;
}
    
.file-content-close {
    background: transparent;
    border: none;
    color: var(--dark-text-secondary);
    cursor: pointer;
    font-size: 0.9375rem;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s;
}
    
.file-content-close:hover {
    background: var(--dark-border);
    color: var(--dark-text);
}
    
.light-mode .file-content-close:hover {
    background: var(--light-border);
    color: var(--light-text);
}
    
.sources-container {
    background: linear-gradient(135deg, rgba(16, 163, 127, 0.08) 0%, rgba(126, 87, 194, 0.08) 100%);
    border: 1px solid var(--dark-border);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    margin-bottom: 0.875rem;
    border-left: 4px solid var(--primary);
}
    
.light-mode .sources-container {
    background: linear-gradient(135deg, rgba(16, 163, 127, 0.05) 0%, rgba(126, 87, 194, 0.05) 100%);
    border-color: var(--light-border);
}
    
.sources-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    color: var(--primary);
    font-weight: 600;
    font-size: 0.875rem;
}
    
.sources-header i {
    color: var(--primary);
    font-size: 0.9375rem;
}
    
.sources-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 10px;
}
    
.source-tag {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 0.75rem;
    color: var(--dark-text);
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-weight: 500;
}
    
.light-mode .source-tag {
    background: var(--light-surface);
    border-color: var(--light-border);
    color: var(--light-text);
}
    
.source-tag:hover {
    background: var(--dark-surface-light);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}
    
.light-mode .source-tag:hover {
    background: var(--light-surface-light);
}
    
.source-tag i {
    color: var(--primary);
    font-size: 0.75rem;
    flex-shrink: 0;
}
    
.sources-info {
    font-size: 0.75rem;
    color: var(--dark-text-secondary);
    margin-top: 10px;
    font-style: italic;
    display: flex;
    align-items: center;
    gap: 6px;
    padding-top: 8px;
    border-top: 1px dashed var(--dark-border);
}
    
.light-mode .sources-info {
    color: var(--light-text-secondary);
    border-top-color: var(--light-border);
}
    
.sources-info i {
    color: var(--primary);
    font-size: 0.75rem;
}
    
.topic-item.active-tab {
    background: var(--primary);
    color: white !important;
    border-color: var(--primary);
}
    
.topic-item.active-tab i {
    color: white !important;
}

.download-notification {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: var(--dark-surface);
    color: var(--dark-text);
    padding: 12px 16px;
    border-radius: 8px;
    border: 1px solid var(--dark-border);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    gap: 8px;
    z-index: 1001;
    transform: translateX(-100%);
    transition: transform 0.2s ease;
    max-width: 300px;
}

.download-notification.show {
    transform: translateX(0);
}

.light-mode .download-notification {
    background: var(--light-surface);
    color: var(--light-text);
    border-color: var(--light-border);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.download-notification i {
    color: var(--primary);
    font-size: 1.125rem;
}

.download-notification-content {
    flex: 1;
}

.download-notification-title {
    font-weight: 600;
    margin-bottom: 2px;
    font-size: 0.875rem;
}

.download-notification-message {
    font-size: 0.8125rem;
    color: var(--dark-text-secondary);
}

.light-mode .download-notification-message {
    color: var(--light-text-secondary);
}

.download-notification-close {
    background: transparent;
    border: none;
    color: var(--dark-text-secondary);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
}

.download-notification-close:hover {
    background: var(--dark-border);
    color: var(--dark-text);
}

.light-mode .download-notification-close:hover {
    background: var(--light-border);
    color: var(--light-text);
}

.send-button:disabled {
    background: var(--dark-border) !important;
    cursor: not-allowed !important;
    opacity: 0.5 !important;
}

.stop-button {
    background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%) !important;
    color: white !important;
}

.stop-button:hover {
    background: linear-gradient(135deg, var(--error) 0%, #b91c1c 100%) !important;
}

/* Login Modal */
.login-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    padding: 16px;
    backdrop-filter: blur(5px);
}
        
.login-modal-overlay.active {
    display: flex;
}
        
.login-modal {
    background: var(--dark-surface);
    border-radius: 12px;
    border: 1px solid var(--dark-border);
    width: 100%;
    max-width: 420px;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalSlideIn 0.2s ease-out;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}
        
.light-mode .login-modal {
    background: var(--light-surface);
    border-color: var(--light-border);
}
        
.login-header {
    padding: 1.75rem;
    text-align: center;
    border-bottom: 1px solid var(--dark-border);
}
        
.light-mode .login-header {
    border-bottom-color: var(--light-border);
}
        
.login-icon {
    font-size: 2.5rem;
    margin-bottom: 0.875rem;
    color: var(--primary);
}
        
.login-header h2 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    color: var(--dark-text);
    font-weight: 600;
}
        
.light-mode .login-header h2 {
    color: var(--light-text);
}
        
.login-header p {
    color: var(--dark-text-secondary);
    font-size: 0.875rem;
}
        
.light-mode .login-header p {
    color: var(--light-text-secondary);
}
        
.login-content {
    padding: 1.75rem;
    overflow-y: visible;
}
        
.login-features {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.875rem;
    margin-bottom: 1.5rem;
}
        
.login-feature {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 0.75rem;
    background: var(--dark-surface-light);
    border-radius: 8px;
    border: 1px solid var(--dark-border);
}
        
.light-mode .login-feature {
    background: var(--light-surface-light);
    border-color: var(--light-border);
}
        
.login-feature i {
    color: var(--primary);
    font-size: 1.125rem;
    width: 24px;
    text-align: center;
}
        
.login-feature h4 {
    font-size: 0.875rem;
    margin-bottom: 2px;
    color: var(--dark-text);
    font-weight: 600;
}
        
.light-mode .login-feature h4 {
    color: var(--light-text);
}
        
.login-feature p {
    font-size: 0.8125rem;
    color: var(--dark-text-secondary);
}
        
.light-mode .login-feature p {
    color: var(--light-text-secondary);
}
        
.google-login-btn {
    width: 100%;
    padding: 0.875rem;
    background: var(--dark-surface-light);
    color: var(--dark-text);
    border: 1px solid var(--dark-border);
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9375rem;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 1.25rem;
}
        
.light-mode .google-login-btn {
    background: var(--light-surface-light);
    color: var(--light-text);
    border-color: var(--light-border);
}
        
.google-login-btn:hover {
    background: var(--dark-border);
}
        
.light-mode .google-login-btn:hover {
    background: var(--light-border);
}
        
.login-footer {
    padding: 1.25rem 1.75rem;
    border-top: 1px solid var(--dark-border);
    text-align: center;
    font-size: 0.8125rem;
    color: var(--dark-text-secondary);
}
        
.light-mode .login-footer {
    border-top-color: var(--light-border);
}
        
.login-footer a {
    color: var(--primary);
    text-decoration: none;
    font-weight: 500;
}
        
.login-footer a:hover {
    text-decoration: underline;
}

/* User Profile */
.user-profile {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 6px;
    transition: all 0.2s;
    border: 1px solid transparent;
    flex-shrink: 0;
}
        
.user-profile:hover {
    background: var(--dark-surface-light);
    border-color: var(--dark-border);
}
        
.light-mode .user-profile:hover {
    background: var(--light-surface-light);
    border-color: var(--light-border);
}
        
.user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    overflow: hidden;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 500;
    font-size: 0.875rem;
    flex-shrink: 0;
}
        
.user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
        
.user-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
}
        
.user-name {
    font-size: 0.875rem;
    font-weight: 500;
    white-space: nowrap;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
}
        
.user-email {
    font-size: 0.75rem;
    color: var(--dark-text-secondary);
    white-space: nowrap;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
}
        
.light-mode .user-email {
    color: var(--light-text-secondary);
}
        
.user-dropdown {
    position: absolute;
    top: 65px;
    right: 12px;
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 8px;
    min-width: 220px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    display: none;
    overflow: hidden;
    animation: fadeIn 0.2s ease;
}
        
.light-mode .user-dropdown {
    background: var(--light-surface);
    border-color: var(--light-border);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
}
        
.user-dropdown.active {
    display: block;
}
        
.dropdown-header {
    padding: 1rem;
    border-bottom: 1px solid var(--dark-border);
    display: flex;
    align-items: center;
    gap: 10px;
}
        
.light-mode .dropdown-header {
    border-bottom-color: var(--light-border);
}
        
.dropdown-header .user-avatar {
    width: 40px;
    height: 40px;
}
        
.dropdown-header .user-info {
    flex: 1;
}
        
.dropdown-header .user-name {
    font-size: 0.9375rem;
}
        
.dropdown-items {
    padding: 0.5rem;
}
        
.dropdown-item {
    padding: 0.75rem;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--dark-text);
    text-decoration: none;
    border-radius: 6px;
    transition: all 0.2s;
    cursor: pointer;
    border: none;
    background: transparent;
    width: 100%;
    text-align: left;
    font-size: 0.875rem;
    font-weight: 500;
}
        
.light-mode .dropdown-item {
    color: var(--light-text);
}
        
.dropdown-item:hover {
    background: var(--dark-surface-light);
}
        
.light-mode .dropdown-item:hover {
    background: var(--light-surface-light);
}
        
.dropdown-item i {
    width: 20px;
    text-align: center;
    color: var(--dark-text-secondary);
    font-size: 0.9375rem;
}
        
.light-mode .dropdown-item i {
    color: var(--light-text-secondary);
}
        
.dropdown-item.logout {
    color: var(--error);
}
        
.dropdown-item.logout:hover {
    background: rgba(239, 68, 68, 0.1);
}
        
.dropdown-footer {
    padding: 0.75rem;
    border-top: 1px solid var(--dark-border);
    font-size: 0.75rem;
    color: var(--dark-text-secondary);
    text-align: center;
}
        
.light-mode .dropdown-footer {
    border-top-color: var(--light-border);
    color: var(--light-text-secondary);
}
        
.login-btn {
    background: var(--dark-surface-light);
    color: var(--dark-text);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    padding: 0.5rem 0.875rem;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    min-height: 36px;
    flex-shrink: 0;
    white-space: nowrap;
}
        
.login-btn:hover {
    background: var(--dark-border);
}
        
.login-btn i {
    font-size: 0.875rem;
}
        
.search-counter {
    padding: 0.375rem 0.75rem;
    background: var(--dark-surface-light);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    font-size: 0.8125rem;
    color: var(--dark-text-secondary);
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 500;
    flex-shrink: 0;
    min-height: 36px;
}
        
.light-mode .search-counter {
    background: var(--light-surface-light);
    border-color: var(--light-border);
    color: var(--light-text-secondary);
}
        
.search-counter i {
    font-size: 0.875rem;
    color: var(--primary);
}

/* Voice Search Button */
.voice-search-btn {
    background: var(--dark-surface-light);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    flex-shrink: 0;
}
        
.light-mode .voice-search-btn {
    background: var(--light-surface-light);
    border-color: var(--light-border);
}
        
.voice-search-btn:hover {
    background: var(--dark-border);
}
        
.voice-search-btn.listening {
    background: rgba(239, 68, 68, 0.1);
    border-color: rgba(239, 68, 68, 0.3);
    animation: pulse 1.5s infinite;
}
        
.voice-search-btn i {
    color: var(--dark-text);
    font-size: 1rem;
}
        
.light-mode .voice-search-btn i {
    color: var(--light-text);
}
        
.sidebar-toggle {
    background: transparent;
    border: none;
    color: var(--dark-text);
    font-size: 1.375rem;
    cursor: pointer;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    border-radius: 6px;
    width: 36px;
    height: 36px;
    flex-shrink: 0;
}
        
.light-mode .sidebar-toggle {
    color: var(--light-text);
}
        
.sidebar-toggle:hover {
    background: var(--dark-surface-light);
}
        
.light-mode .sidebar-toggle:hover {
    background: var(--light-surface-light);
}

/* CHAT INTERFACE STYLES */
#chatInterface {
    display: none !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: var(--dark-bg) !important;
    z-index: 99999 !important;
}

#chatInterface.active {
    display: flex !important;
    flex-direction: column !important;
}

#chatInterface .container {
    height: 100vh !important;
    width: 100vw !important;
    max-height: 100vh !important;
    min-height: 100vh !important;
    overflow: hidden !important;
    display: flex !important;
    flex-direction: column !important;
}

#chatInterface .chat-container {
    height: 100% !important;
    width: 100% !important;
    display: flex !important;
    flex-direction: column !important;
}

#chatInterface .chat-messages {
    flex: 1 !important;
    overflow-y: auto !important;
    min-height: 0 !important;
}

/* When chat is active, hide homepage */
body.chat-active .main-container {
    display: none;
}

body.chat-active {
    overflow: hidden !important;
}

/* Mobile Optimization */
@media (max-width: 768px) {
    header {
        padding: 0.625rem 0.75rem;
        min-height: 56px;
        gap: 4px;
    }
            
    .logo h1 {
        font-size: 1rem;
    }
            
    .header-btn span {
        display: none;
    }
            
    .header-btn i {
        margin: 0;
    }
            
    .status-indicator span {
        display: none;
    }
            
    .header-actions {
        gap: 6px;
    }
            
    .chat-messages {
        padding: 0.75rem 0.5rem;
        gap: 1rem;
    }
            
    .message {
        padding: 0 0.5rem;
        gap: 0.625rem;
    }
            
    .avatar {
        width: 28px;
        height: 28px;
        font-size: 0.75rem;
    }
            
    .message-text {
        font-size: 0.875rem;
    }
            
    .document-download-btn {
        opacity: 1;
        transform: translateY(0);
        top: -8px;
        right: 4px;
        padding: 4px 8px;
        font-size: 0.625rem;
    }
            
    .welcome-message {
        padding: 0.875rem;
        margin: 0.875rem auto;
    }
            
    .welcome-message h2 {
        font-size: 1.25rem;
    }
            
    .welcome-features {
        grid-template-columns: 1fr;
    }
            
    .input-container {
        padding: 0.75rem;
    }
            
    .input-area textarea {
        padding: 0.75rem 5.5rem 0.75rem 0.875rem;
        font-size: 0.875rem;
        min-height: 48px;
    }
            
    .input-buttons {
        right: 0.5rem;
        bottom: 0.5rem;
        gap: 4px;
    }
            
    .send-button {
        padding: 0.5rem 0.75rem;
        min-height: 36px;
        font-size: 0.8125rem;
    }
            
    .input-microphone-btn,
    .attachment-btn,
    .emoji-picker-btn {
        width: 28px;
        height: 28px;
        padding: 0.375rem;
    }
            
    .sidebar {
        width: 85vw;
        max-width: 280px;
    }
            
    .download-options {
        grid-template-columns: 1fr;
    }
            
    .history-item-actions {
        display: flex !important;
        opacity: 0.9;
    }
            
    .document-template {
        padding: 0.875rem;
    }
            
    .signature-line {
        flex-direction: column;
        gap: 0.875rem;
    }
            
    .attachment-item {
        max-width: 140px;
    }
            
    .scroll-to-bottom-btn {
        bottom: 80px;
        right: 12px;
        width: 36px;
        height: 36px;
    }
            
    .user-message-controls {
        gap: 6px;
        margin-top: 6px;
    }
            
    .user-message-btn {
        padding: 4px 6px;
        font-size: 0.75rem;
        min-width: 28px;
        min-height: 28px;
    }
            
    .action-btn {
        padding: 0.375rem 0.625rem;
        font-size: 0.75rem;
        min-height: 28px;
    }
            
    .sources-container {
        padding: 0.75rem;
        margin-top: 0.75rem;
    }
            
    .sources-list {
        gap: 4px;
    }
            
    .source-tag {
        padding: 4px 8px;
        font-size: 0.75rem;
    }
}
        
@media (min-width: 481px) and (max-width: 768px) {
    .header-btn span {
        display: none;
    }
            
    .status-indicator {
        padding: 0.375rem;
    }
            
    .status-indicator span {
        display: none;
    }
            
    .welcome-features {
        grid-template-columns: repeat(2, 1fr);
    }
            
    .history-item-actions {
        display: flex !important;
        opacity: 0.9;
    }
            
    .input-area textarea {
        padding: 0.875rem 6rem 0.875rem 1rem;
    }
            
    .sidebar {
        width: 85vw;
        max-width: 300px;
    }
}
        
@media (min-width: 769px) and (max-width: 1024px) {
    .sidebar {
        position: fixed;
        transform: translateX(-100%);
        width: 300px;
    }
            
    .sidebar.active {
        transform: translateX(0);
    }
            
    .chat-container {
        margin-left: 0;
    }
            
    .sidebar-toggle {
        display: flex;
    }
            
    .welcome-features {
        grid-template-columns: repeat(3, 1fr);
    }
            
    .message-content {
        max-width: 80%;
    }
}
        
@media (min-width: 1025px) {
    .sidebar {
        position: relative;
        transform: translateX(0);
        flex-shrink: 0;
    }
            
    .sidebar-toggle {
        display: none;
    }
            
    .sidebar-close {
        display: none;
    }
            
    .sidebar-overlay {
        display: none !important;
    }
            
    .chat-messages {
        padding: 1.25rem 1.5rem;
    }
            
    .input-container {
        padding: 1.25rem;
    }
            
    .welcome-message {
        margin: 2rem auto;
        padding: 1.5rem;
    }
            
    .welcome-message h2 {
        font-size: 1.75rem;
    }
            
    .main-content {
        overflow: hidden;
    }
}
        
/* Scrollbar */
::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}
        
::-webkit-scrollbar-track {
    background: var(--dark-bg);
}
        
.light-mode ::-webkit-scrollbar-track {
    background: var(--light-bg);
}
        
::-webkit-scrollbar-thumb {
    background: var(--dark-border);
    border-radius: 3px;
}
        
.light-mode ::-webkit-scrollbar-thumb {
    background: var(--light-border);
}
        
::-webkit-scrollbar-thumb:hover {
    background: var(--dark-surface-light);
}
        
.light-mode ::-webkit-scrollbar-thumb:hover {
    background: var(--light-surface-light);
}

/* Emoji support */
.emoji {
    font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    font-size: 1.2em;
    vertical-align: middle;
}

/* Emoji picker button */
.emoji-picker-btn {
    background: transparent;
    border: none;
    color: var(--dark-text-secondary);
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
}

.emoji-picker-btn:hover {
    background: var(--dark-surface-light);
    color: var(--dark-text);
}

.light-mode .emoji-picker-btn:hover {
    background: var(--light-surface-light);
    color: var(--light-text);
}

/* Voice animation */
.voice-animation {
    display: flex;
    align-items: center;
    gap: 3px;
    height: 20px;
}
        
.voice-bar {
    width: 3px;
    background: var(--primary);
    border-radius: 3px;
    animation: voicePulse 0.8s ease-in-out infinite;
}
        
.voice-bar:nth-child(1) {
    height: 8px;
    animation-delay: 0.1s;
}
        
.voice-bar:nth-child(2) {
    height: 12px;
    animation-delay: 0.2s;
}
        
.voice-bar:nth-child(3) {
    height: 16px;
    animation-delay: 0.3s;
}
        
.voice-bar:nth-child(4) {
    height: 12px;
    animation-delay: 0.4s;
}
        
.voice-bar:nth-child(5) {
    height: 8px;
    animation-delay: 0.5s;
}
        
@keyframes voicePulse {
    0%, 100% {
        opacity: 0.4;
        transform: scaleY(0.8);
    }
    50% {
        opacity: 1;
        transform: scaleY(1.2);
    }
}

/* Hide/show on mobile */
.hide-on-mobile {
    display: none;
}
        
.show-on-mobile {
    display: flex;
}
        
@media (min-width: 769px) {
    .hide-on-mobile {
        display: flex;
    }
            
    .show-on-mobile {
        display: none;
    }
}

/* Active Topics Section */
#activeTopicsSection {
    display: none;
}

#activeTopicsList {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

/* FIXED: Added scope for chat interface to prevent conflicts */
#chatInterface .premium-navbar {
    display: none !important;
}

#chatInterface .legal-seal {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
}

#chatInterface .shimmer-text {
    background: linear-gradient(90deg, var(--primary), var(--secondary), var(--primary));
    background-size: 200% auto;
    color: transparent;
    -webkit-background-clip: text;
    background-clip: text;
    animation: shimmer 2s linear infinite;
}

@keyframes shimmer {
    to { background-position: 200% center; }
}

.premium-card {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

.btn-premium {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.3s;
}

.loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--dark-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

/* Additional styles for homepage */
.main-container {
    display: block;
}

/* Homepage specific styles */
.premium-navbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background: rgba(52, 53, 65, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--dark-border);
}

.hero-section {
    padding-top: 100px;
    min-height: 100vh;
    display: flex;
    align-items: center;
    position: relative;
    overflow: hidden;
}

.features-section,
.database-section,
.documents-section,
.lawyer-section,
.guides-section,
.testimonials-section,
.pricing-section,
.cta-section {
    padding: 80px 0;
}

.section-header {
    text-align: center;
    margin-bottom: 60px;
}

.section-title {
    font-size: 2.5rem;
    margin-bottom: 1rem;
}

.section-subtitle {
    color: var(--dark-text-secondary);
    font-size: 1.1rem;
}

/* Hide debug borders */
#chatInterface {
    border: none !important;
}

#chatInterface .container {
    border: none !important;
}

#chatInterface .chat-container {
    border: none !important;
}

/* Remove emergency debug styles */
#chatInterface {
    background: var(--dark-bg) !important;
    opacity: 1 !important;
    visibility: visible !important;
}

/* Force chat to show */
#chatInterface .container {
    display: flex !important;
    flex-direction: column !important;
    height: 100vh !important;
}

#chatInterface .chat-container {
    display: flex !important;
    flex-direction: column !important;
    height: 100% !important;
    flex: 1 !important;
}

#chatInterface .chat-messages {
    flex: 1 !important;
    overflow-y: auto !important;
    min-height: 200px !important;
    background: var(--dark-bg) !important;
}

/* Hide any overlay that might be blocking */
.sidebar-overlay {
    display: none !important;
}

/* Draft template styles in welcome message */
.draft-templates {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-top: 20px;
}

.draft-template {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 10px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.draft-template:hover {
    transform: translateY(-5px);
    border-color: var(--primary);
    box-shadow: 0 10px 25px rgba(16, 163, 127, 0.2);
}

.draft-template i {
    font-size: 2rem;
    color: var(--primary);
    margin-bottom: 10px;
}

.draft-template h4 {
    font-size: 1rem;
    margin-bottom: 5px;
    color: var(--dark-text);
}

.draft-template p {
    font-size: 0.8rem;
    color: var(--dark-text-secondary);
}

.section-divider {
    height: 1px;
    background: var(--dark-border);
    margin: 25px 0;
    width: 100%;
}

.legal-note {
    background: rgba(245, 158, 11, 0.1);
    border-left: 4px solid var(--warning);
    padding: 12px;
    margin-top: 20px;
    border-radius: 6px;
    font-size: 0.85rem;
    color: var(--dark-text);
}

/* Language hint */
.language-hint {
    position: absolute;
    left: 12px;
    top: -30px;
    background: var(--dark-surface);
    color: var(--primary);
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    border: 1px solid var(--primary-light);
    display: none;
    z-index: 10;
    font-weight: 500;
}

/* Homepage Styles */
.nav-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

.nav-logo {
    display: flex;
    align-items: center;
    gap: 12px;
}

.logo-icon {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    width: 42px;
    height: 42px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
}

.logo-text {
    display: flex;
    flex-direction: column;
}

.logo-title {
    font-size: 1.5rem;
    font-weight: 700;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    animation: shimmer 2s linear infinite;
}

.logo-subtitle {
    font-size: 0.75rem;
    color: var(--dark-text-secondary);
    letter-spacing: 1px;
}

.nav-menu {
    display: flex;
    gap: 2rem;
    align-items: center;
}

.nav-link {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--dark-text);
    text-decoration: none;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    padding: 8px 12px;
    border-radius: 8px;
}

.nav-link:hover, .nav-link.active {
    background: var(--dark-surface);
    color: var(--primary);
}

.nav-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.btn-login {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    color: var(--dark-text);
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.btn-login:hover {
    background: var(--dark-surface-light);
    transform: translateY(-2px);
}

.user-profile {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    background: var(--dark-surface);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.user-profile:hover {
    background: var(--dark-surface-light);
}

.profile-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 500;
}

.profile-info {
    display: flex;
    flex-direction: column;
}

.profile-name {
    font-size: 0.9rem;
    font-weight: 500;
}

.profile-email {
    font-size: 0.75rem;
    color: var(--dark-text-secondary);
}

.btn-logout {
    background: transparent;
    border: none;
    color: var(--dark-text-secondary);
    cursor: pointer;
    padding: 8px;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.btn-logout:hover {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error);
}

.mobile-toggle {
    display: none;
    background: transparent;
    border: none;
    color: var(--dark-text);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 8px;
}

.hero-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
    gap: 4rem;
}

.hero-content {
    flex: 1;
    max-width: 600px;
}

.hero-badge {
    display: inline-block;
    background: rgba(16, 163, 127, 0.1);
    border: 1px solid rgba(16, 163, 127, 0.3);
    border-radius: 20px;
    padding: 8px 16px;
    margin-bottom: 2rem;
}

.badge-text {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 6px;
}

.hero-title {
    font-size: 3.5rem;
    font-weight: 800;
    line-height: 1.2;
    margin-bottom: 1.5rem;
}

.hero-subtitle {
    font-size: 1.1rem;
    color: var(--dark-text-secondary);
    line-height: 1.6;
    margin-bottom: 2rem;
}

.hero-stats {
    display: flex;
    gap: 3rem;
    margin-bottom: 2rem;
}

.stat-item {
    display: flex;
    flex-direction: column;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    animation: shimmer 2s linear infinite;
}

.stat-label {
    font-size: 0.9rem;
    color: var(--dark-text-secondary);
    margin-top: 4px;
}

.hero-actions {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
}

.btn-hero-primary {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    border: none;
    padding: 16px 32px;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.btn-hero-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 20px 40px rgba(16, 163, 127, 0.3);
}

.btn-sparkle {
    position: absolute;
    top: 0;
    right: 0;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0 12px 0 12px;
}

.btn-hero-secondary {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    color: var(--dark-text);
    padding: 16px 32px;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
}

.btn-hero-secondary:hover {
    background: var(--dark-surface-light);
    transform: translateY(-2px);
}

.hero-trust {
    margin-top: 2rem;
}

.trust-label {
    font-size: 0.9rem;
    color: var(--dark-text-secondary);
    margin-bottom: 1rem;
}

.trust-badges {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.trust-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--dark-surface);
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 0.9rem;
}

.hero-illustration {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
}

.ai-assistant-card {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 20px;
    padding: 2rem;
    width: 100%;
    max-width: 400px;
    text-align: center;
    animation: float 6s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
}

.assistant-avatar {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    color: white;
    font-size: 2rem;
}

.assistant-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.assistant-subtitle {
    color: var(--dark-text-secondary);
    margin-bottom: 1.5rem;
}

.assistant-features {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
    margin-bottom: 1.5rem;
}

.assistant-features .feature {
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: flex-start;
    background: transparent;
    border: none;
    padding: 0;
}

.btn-assistant {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
    width: 100%;
    transition: all 0.3s ease;
}

.btn-assistant:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(16, 163, 127, 0.3);
}

.scroll-indicator {
    position: absolute;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.mouse {
    width: 30px;
    height: 50px;
    border: 2px solid var(--dark-border);
    border-radius: 20px;
    position: relative;
}

.wheel {
    width: 4px;
    height: 8px;
    background: var(--primary);
    border-radius: 2px;
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    animation: scrollWheel 2s infinite;
}

@keyframes scrollWheel {
    0% { top: 10px; opacity: 1; }
    100% { top: 30px; opacity: 0; }
}

.arrow i {
    animation: bounce 2s infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(10px); }
}

/* Features Grid */
.features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    max-width: 1200px;
    margin: 0 auto;
}

.feature-card {
    padding: 2rem;
    transition: all 0.3s ease;
}

.feature-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
}

.feature-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1.5rem;
    color: white;
    font-size: 1.5rem;
}

.feature-title {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 1rem;
}

.feature-description {
    color: var(--dark-text-secondary);
    line-height: 1.6;
    margin-bottom: 1.5rem;
}

.feature-tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.tag {
    background: rgba(16, 163, 127, 0.1);
    color: var(--primary);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

/* Database Grid */
.database-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    max-width: 1200px;
    margin: 0 auto;
}

.database-card {
    padding: 2rem;
}

.database-icon {
    font-size: 2.5rem;
    color: var(--primary);
    margin-bottom: 1.5rem;
}

.database-title {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
}

.database-list {
    list-style: none;
    margin-bottom: 2rem;
}

.database-list li {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    color: var(--dark-text-secondary);
}

.database-list li i {
    color: var(--primary);
}

.btn-database {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    color: var(--dark-text);
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    width: 100%;
    justify-content: center;
}

.btn-database:hover {
    background: var(--dark-surface-light);
    transform: translateY(-2px);
}

/* Documents Grid */
.documents-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    max-width: 1200px;
    margin: 0 auto;
}

.document-category {
    padding: 2rem;
    transition: all 0.3s ease;
}

.document-category:hover {
    transform: translateY(-10px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
}

.category-icon {
    font-size: 2.5rem;
    color: var(--primary);
    margin-bottom: 1.5rem;
}

.category-title {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
}

.document-list {
    list-style: none;
    margin-bottom: 2rem;
}

.document-list li {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    color: var(--dark-text-secondary);
}

.document-list li i {
    color: var(--primary);
}

.btn-generate {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    width: 100%;
    justify-content: center;
}

.btn-generate:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(16, 163, 127, 0.3);
}

/* Lawyer Search */
.lawyer-search {
    max-width: 800px;
    margin: 0 auto 3rem;
}

.search-container {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.search-container input {
    flex: 1;
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    color: var(--dark-text);
    font-size: 1rem;
}

.search-container input:focus {
    outline: none;
    border-color: var(--primary);
}

.btn-search {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.btn-search:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(16, 163, 127, 0.3);
}

.specialization-filters {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    justify-content: center;
}

.filter-btn {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    color: var(--dark-text);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.filter-btn:hover, .filter-btn.active {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
}

.lawyers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    max-width: 1200px;
    margin: 0 auto;
}

.lawyer-card {
    padding: 1.5rem;
    text-align: center;
}

.lawyer-avatar {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    color: white;
    font-size: 2rem;
}

.lawyer-name {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.lawyer-specialization {
    color: var(--primary);
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.lawyer-experience {
    color: var(--dark-text-secondary);
    font-size: 0.9rem;
    margin-bottom: 1.5rem;
}

.btn-consult {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
    width: 100%;
    transition: all 0.3s ease;
}

.btn-consult:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(16, 163, 127, 0.3);
}

/* Guides Grid */
.guides-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    max-width: 1200px;
    margin: 0 auto;
}

.guide-card {
    padding: 2rem;
}

.guide-icon {
    font-size: 2.5rem;
    color: var(--primary);
    margin-bottom: 1.5rem;
}

.guide-title {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 1rem;
}

.guide-description {
    color: var(--dark-text-secondary);
    line-height: 1.6;
    margin-bottom: 1.5rem;
}

.guide-steps {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 2rem;
}

.step {
    background: rgba(16, 163, 127, 0.1);
    color: var(--primary);
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
}

.btn-guide {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    color: var(--dark-text);
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    width: 100%;
    justify-content: center;
}

.btn-guide:hover {
    background: var(--dark-surface-light);
    transform: translateY(-2px);
}

/* Testimonials Carousel */
.testimonials-carousel {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    max-width: 1200px;
    margin: 0 auto;
}

.testimonial-card {
    padding: 2rem;
}

.testimonial-rating {
    color: #f59e0b;
    margin-bottom: 1.5rem;
}

.testimonial-text {
    font-style: italic;
    line-height: 1.6;
    margin-bottom: 1.5rem;
}

.testimonial-author {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.author-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    overflow: hidden;
}

.author-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.author-info {
    flex: 1;
}

.author-name {
    font-weight: 600;
    margin-bottom: 2px;
}

.author-title {
    color: var(--dark-text-secondary);
    font-size: 0.9rem;
}

/* Pricing Cards */
.pricing-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    max-width: 1200px;
    margin: 0 auto;
}

.pricing-card {
    padding: 2rem;
    position: relative;
    transition: all 0.3s ease;
}

.pricing-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
}

.pricing-card.premium-plan {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
}

.pricing-card.premium-plan .pricing-title,
.pricing-card.premium-plan .pricing-price,
.pricing-card.premium-plan .pricing-description,
.pricing-card.premium-plan .pricing-features li,
.pricing-card.premium-plan .btn-pricing {
    color: white;
}

.pricing-badge {
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--primary);
    color: white;
    padding: 6px 20px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.pricing-badge.popular {
    background: var(--accent);
}

.pricing-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
    text-align: center;
}

.pricing-price {
    text-align: center;
    margin-bottom: 1rem;
}

.pricing-price .currency {
    font-size: 1.2rem;
    vertical-align: top;
}

.pricing-price .amount {
    font-size: 3rem;
    font-weight: 700;
    line-height: 1;
}

.pricing-price .period {
    font-size: 1rem;
    color: var(--dark-text-secondary);
}

.pricing-card.premium-plan .pricing-price .period {
    color: rgba(255, 255, 255, 0.8);
}

.pricing-description {
    text-align: center;
    color: var(--dark-text-secondary);
    margin-bottom: 2rem;
}

.pricing-features {
    list-style: none;
    margin-bottom: 2rem;
}

.pricing-features li {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
}

.pricing-features li i.fa-check-circle {
    color: var(--success);
}

.pricing-features li i.fa-times-circle {
    color: var(--dark-text-secondary);
}

.pricing-card.premium-plan .pricing-features li i {
    color: white;
}

.btn-pricing {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    width: 100%;
    justify-content: center;
}

.pricing-card.premium-plan .btn-pricing {
    background: white;
    color: var(--primary);
}

.btn-pricing:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(16, 163, 127, 0.3);
}

.pricing-card.premium-plan .btn-pricing:hover {
    box-shadow: 0 10px 20px rgba(255, 255, 255, 0.3);
}

/* CTA Section */
.cta-content {
    text-align: center;
    max-width: 800px;
    margin: 0 auto;
}

.cta-title {
    font-size: 3rem;
    font-weight: 800;
    line-height: 1.2;
    margin-bottom: 1.5rem;
}

.cta-description {
    font-size: 1.2rem;
    color: var(--dark-text-secondary);
    line-height: 1.6;
    margin-bottom: 2rem;
}

.cta-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-bottom: 2rem;
}

.btn-cta-primary {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    border: none;
    padding: 16px 32px;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
}

.btn-cta-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 20px 40px rgba(16, 163, 127, 0.3);
}

.btn-cta-secondary {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    color: var(--dark-text);
    padding: 16px 32px;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
}

.btn-cta-secondary:hover {
    background: var(--dark-surface-light);
    transform: translateY(-2px);
}

.cta-guarantee {
    display: flex;
    gap: 2rem;
    justify-content: center;
    flex-wrap: wrap;
}

.guarantee-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--dark-text-secondary);
}

/* Footer */
.premium-footer {
    background: var(--dark-surface);
    border-top: 1px solid var(--dark-border);
    padding: 4rem 0 2rem;
}

.footer-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 3rem;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
}

.footer-logo {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 1.5rem;
}

.footer-description {
    color: var(--dark-text-secondary);
    line-height: 1.6;
    margin-bottom: 1.5rem;
}

.social-links {
    display: flex;
    gap: 1rem;
}

.social-link {
    width: 40px;
    height: 40px;
    background: var(--dark-surface-light);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--dark-text);
    transition: all 0.3s ease;
}

.social-link:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
}

.footer-heading {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
}

.footer-links {
    list-style: none;
}

.footer-links li {
    margin-bottom: 0.8rem;
}

.footer-links a {
    color: var(--dark-text-secondary);
    text-decoration: none;
    transition: all 0.3s ease;
}

.footer-links a:hover {
    color: var(--primary);
    padding-left: 5px;
}

.footer-contact {
    list-style: none;
}

.footer-contact li {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 1rem;
    color: var(--dark-text-secondary);
}

.footer-contact a {
    color: var(--dark-text-secondary);
    text-decoration: none;
    transition: all 0.3s ease;
}

.footer-contact a:hover {
    color: var(--primary);
}

.footer-bottom {
    max-width: 1200px;
    margin: 3rem auto 0;
    padding: 2rem 2rem 0;
    border-top: 1px solid var(--dark-border);
    text-align: center;
}

.copyright {
    color: var(--dark-text-secondary);
    margin-bottom: 1rem;
}

.disclaimer {
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 8px;
    padding: 1rem;
    color: var(--warning);
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: center;
}

.back-to-top {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 50px;
    height: 50px;
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 50%;
    color: var(--dark-text);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 1000;
}

.back-to-top:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-5px);
}

.toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 10000;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.modal.active {
    display: flex;
}

.modal .modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
}

.modal .modal-content {
    background: var(--dark-surface);
    border-radius: 20px;
    padding: 2rem;
    max-width: 500px;
    width: 100%;
    position: relative;
    z-index: 10001;
    animation: modalSlideIn 0.3s ease-out;
}

.modal .modal-header {
    text-align: center;
    margin-bottom: 2rem;
}

.modal .modal-icon {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
    color: white;
    font-size: 2rem;
}

.modal .modal-header h3 {
    font-size: 1.8rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.modal .modal-header p {
    color: var(--dark-text-secondary);
}

.modal .modal-body {
    margin-bottom: 2rem;
}

.modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: transparent;
    border: none;
    color: var(--dark-text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.modal-close:hover {
    background: var(--dark-surface-light);
    color: var(--dark-text);
}

.google-signin-btn {
    background: white;
    border: 1px solid #ddd;
    color: #444;
    padding: 1rem;
    border-radius: 12px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    justify-content: center;
    width: 100%;
    transition: all 0.3s ease;
}

.google-signin-btn:hover {
    background: #f8f8f8;
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}

.divider {
    display: flex;
    align-items: center;
    margin: 2rem 0;
    color: var(--dark-text-secondary);
}

.divider::before,
.divider::after {
    content: "";
    flex: 1;
    height: 1px;
    background: var(--dark-border);
}

.divider span {
    padding: 0 1rem;
}

.demo-login-btn {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    color: var(--dark-text);
    padding: 1rem;
    border-radius: 12px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    justify-content: center;
    width: 100%;
    transition: all 0.3s ease;
}

.demo-login-btn:hover {
    background: var(--dark-surface-light);
    transform: translateY(-2px);
}

.login-info {
    margin-top: 2rem;
    padding: 1.5rem;
    background: rgba(16, 163, 127, 0.1);
    border-radius: 12px;
    border: 1px solid rgba(16, 163, 127, 0.3);
}

.login-info p {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 0.8rem;
    color: var(--dark-text);
    font-size: 0.9rem;
}

.login-info p:last-child {
    margin-bottom: 0;
}

.login-info p i {
    color: var(--primary);
}

.tools-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.tool-card {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.tool-card:hover {
    background: var(--dark-surface-light);
    transform: translateY(-5px);
    border-color: var(--primary);
}

.tool-card i {
    font-size: 2rem;
    color: var(--primary);
    margin-bottom: 1rem;
}

.tool-card h4 {
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
}

.tool-card p {
    color: var(--dark-text-secondary);
    font-size: 0.9rem;
}

/* Mobile Menu */
.mobile-menu-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 2000;
    backdrop-filter: blur(5px);
}

.mobile-menu-container {
    background: var(--dark-surface);
    height: 100vh;
    width: 300px;
    padding: 2rem;
    position: relative;
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from { transform: translateX(-100%); }
    to { transform: translateX(0); }
}

.mobile-menu-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
}

.mobile-close {
    background: transparent;
    border: none;
    color: var(--dark-text);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
}

.mobile-close:hover {
    background: var(--dark-surface-light);
}

.mobile-menu-links {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.mobile-link {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 1rem;
    color: var(--dark-text);
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.3s ease;
}

.mobile-link:hover, .mobile-link.active {
    background: var(--dark-surface-light);
    color: var(--primary);
}

@media (max-width: 768px) {
    .nav-menu {
        display: none;
    }
    
    .mobile-toggle {
        display: block;
    }
    
    .hero-container {
        flex-direction: column;
        text-align: center;
    }
    
    .hero-title {
        font-size: 2.5rem;
    }
    
    .hero-stats {
        flex-direction: column;
        gap: 1.5rem;
    }
    
    .hero-actions {
        flex-direction: column;
    }
    
    .cta-title {
        font-size: 2.5rem;
    }
    
    .cta-actions {
        flex-direction: column;
    }
    
    .footer-content {
        grid-template-columns: 1fr;
        text-align: center;
    }
    
    .footer-logo {
        justify-content: center;
    }
    
    .social-links {
        justify-content: center;
    }
}

/* Background Elements */
.hero-bg-elements {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
    z-index: -1;
}

.floating-element {
    position: absolute;
    opacity: 0.1;
}

.floating-icon-1 {
    top: 20%;
    left: 10%;
    animation: float 6s ease-in-out infinite;
}

.floating-icon-2 {
    top: 60%;
    right: 15%;
    animation: float 8s ease-in-out infinite reverse;
}

.floating-icon-3 {
    bottom: 20%;
    left: 20%;
    animation: float 7s ease-in-out infinite;
}

.floating {
    font-size: 3rem;
    color: var(--primary);
}

.pulse-glow {
    animation: pulseGlow 2s ease-in-out infinite;
}

@keyframes pulseGlow {
    0%, 100% { box-shadow: 0 0 20px rgba(16, 163, 127, 0.3); }
    50% { box-shadow: 0 0 40px rgba(16, 163, 127, 0.5); }
}

.gavel-animation {
    animation: gavelSwing 3s ease-in-out infinite;
}

@keyframes gavelSwing {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(-10deg); }
    75% { transform: rotate(10deg); }
}

.text-reveal {
    animation: textReveal 1s ease-out;
}

@keyframes textReveal {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Ensure proper button states */
button:disabled {
    opacity: 0.5;
    cursor: not-allowed !important;
}

/* Modal z-index fix */
.modal-overlay {
    z-index: 10000;
}

/* Toast notification z-index */
.toast {
    z-index: 10001;
}

/* Ensure chat container fills screen */
#chatInterface .container {
    height: 100vh !important;
    max-height: 100vh !important;
    min-height: 100vh !important;
    overflow: hidden !important;
}

/* Ensure chat container inside fills available space */
#chatInterface .chat-container {
    height: 100% !important;
    max-height: 100% !important;
    min-height: 100% !important;
    display: flex !important;
    flex-direction: column !important;
}

/* Ensure chat messages area scrolls properly */
#chatInterface .chat-messages {
    flex: 1;
    overflow-y: auto;
    height: 0;
}

/* Textarea resizing fix */
.input-area textarea {
    resize: none;
    min-height: 52px;
    max-height: 150px;
    overflow-y: auto;
}

/* Mobile touch improvements */
@media (max-width: 768px) {
    button, .btn-premium, .header-btn, .action-btn {
        min-height: 44px;
        min-width: 44px;
    }
    
    #chatInterface {
        -webkit-overflow-scrolling: touch;
    }
    
    #chatInterface .chat-container {
        height: 100vh !important;
        max-height: 100vh !important;
    }
    
    #chatInterface .chat-messages {
        padding-bottom: 80px !important;
    }
}


/* FIXED: Chat Interface Display */
#chatInterface {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: var(--dark-bg);
    z-index: 99999;
    flex-direction: column;
}

#chatInterface.active {
    display: flex;
}

body.chat-active .main-container {
    display: none;
}

body.chat-active {
    overflow: hidden;
}

#chatInterface .container {
    height: 100vh !important;
    width: 100vw !important;
    max-height: 100vh !important;
    min-height: 100vh !important;
    overflow: hidden !important;
    display: flex !important;
    flex-direction: column !important;
}

#chatInterface .chat-container {
    height: 100% !important;
    width: 100% !important;
    display: flex !important;
    flex-direction: column !important;
}

#chatInterface .chat-messages {
    flex: 1 !important;
    overflow-y: auto !important;
    min-height: 0 !important;
}


/* Show chat when active */
body.chat-active #chatInterface {
    display: flex !important;
}
</style>
</head>
<body>
    <!-- Premium Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner legal-seal">
                <i class="fas fa-gavel"></i>
            </div>
            <h2 class="shimmer-text mt-4">LegalSwami</h2>
            <p class="text-light">Initializing AI Legal Assistant...</p>
            <div class="progress-bar mt-4">
                <div class="progress-fill"></div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Premium Navigation Bar -->
        <nav class="premium-navbar">
            <div class="nav-container">
                <!-- Logo with Animation -->
                <div class="nav-logo">
                    <div class="logo-icon legal-seal">
                        <i class="fas fa-gavel gavel-animation"></i>
                    </div>
                    <div class="logo-text">
                        <h1 class="logo-title shimmer-text">LegalSwami</h1>
                        <p class="logo-subtitle">AI Legal Assistant</p>
                    </div>
                </div>

                <!-- Desktop Navigation -->
                <div class="nav-menu">
                    <a href="#home" class="nav-link active" data-scroll="home">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                    <a href="#features" class="nav-link" data-scroll="features">
                        <i class="fas fa-star"></i>
                        <span>Features</span>
                    </a>
                    <a href="#documents" class="nav-link" data-scroll="documents">
                        <i class="fas fa-file-contract"></i>
                        <span>Documents</span>
                    </a>
                    <a href="#legalDatabase" class="nav-link" data-scroll="legalDatabase">
                        <i class="fas fa-database"></i>
                        <span>Legal Database</span>
                    </a>
                    <a href="#lawyerDirectory" class="nav-link" data-scroll="lawyerDirectory">
                        <i class="fas fa-user-tie"></i>
                        <span>Find Lawyers</span>
                    </a>
                    <a href="#pricing" class="nav-link" data-scroll="pricing">
                        <i class="fas fa-tag"></i>
                        <span>Pricing</span>
                    </a>
                </div>

                <!-- User Actions -->
                <div class="nav-actions">
                    <button id="headerLoginBtn" class="btn-login">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>Login</span>
                    </button>
                    
                    <!-- User Profile (Hidden by default) -->
                    <div id="homeUserProfile" class="user-profile" style="display: none;">
                        <div class="profile-avatar">
                            <div id="homeUserAvatar"></div>
                        </div>
                        <div class="profile-info">
                            <span id="homeUserName" class="profile-name"></span>
                            <span id="homeUserEmail" class="profile-email"></span>
                        </div>
                        <button id="homeLogoutBtn" class="btn-logout">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>

                <!-- Mobile Menu Toggle -->
                <button class="mobile-toggle" id="mobileToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </nav>

        <!-- Mobile Menu -->
        <div class="mobile-menu-overlay" id="mobileMenu">
            <div class="mobile-menu-container">
                <div class="mobile-menu-header">
                    <div class="logo-icon legal-seal">
                        <i class="fas fa-gavel"></i>
                    </div>
                    <button class="mobile-close" id="mobileClose">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mobile-menu-links">
                    <a href="#home" class="mobile-link active">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                    <a href="#features" class="mobile-link">
                        <i class="fas fa-star"></i>
                        <span>Features</span>
                    </a>
                    <a href="#documents" class="mobile-link">
                        <i class="fas fa-file-contract"></i>
                        <span>Documents</span>
                    </a>
                    <a href="#legalDatabase" class="mobile-link">
                        <i class="fas fa-database"></i>
                        <span>Legal Database</span>
                    </a>
                    <a href="#lawyerDirectory" class="mobile-link">
                        <i class="fas fa-user-tie"></i>
                        <span>Find Lawyers</span>
                    </a>
                    <a href="#legalGuides" class="mobile-link">
                        <i class="fas fa-book"></i>
                        <span>Legal Guides</span>
                    </a>
                    <a href="#pricing" class="mobile-link">
                        <i class="fas fa-tag"></i>
                        <span>Pricing</span>
                    </a>
                    <a href="#chat" class="mobile-link" id="mobileStartChat">
                        <i class="fas fa-comments"></i>
                        <span>Start Chat</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Hero Section -->
        <section id="home" class="hero-section">
            <div class="hero-container container">
                <!-- Animated Background Elements -->
                <div class="hero-bg-elements">
                    <div class="floating-element floating-icon-1">
                        <i class="fas fa-balance-scale floating"></i>
                    </div>
                    <div class="floating-element floating-icon-2">
                        <i class="fas fa-gavel floating"></i>
                    </div>
                    <div class="floating-element floating-icon-3">
                        <i class="fas fa-scale-balanced floating"></i>
                    </div>
                </div>
                
                <div class="hero-content">
                    <div class="hero-badge">
                        <span class="badge-text">
                            <i class="fas fa-bolt"></i>
                            AI-POWERED LEGAL ASSISTANT
                        </span>
                    </div>
                    
                    <h1 class="hero-title text-reveal">
                        Get <span class="shimmer-text">Instant Legal Help</span><br>
                        From Your AI Assistant
                    </h1>
                    
                    <p class="hero-subtitle">
                        LegalSwami provides 24/7 AI-powered legal guidance, document generation, 
                        and legal research assistance. Get instant answers to your legal questions 
                        in simple, understandable language.
                    </p>
                    
                    <div class="hero-stats">
                        <div class="stat-item">
                            <div class="stat-number shimmer-text">10,000+</div>
                            <div class="stat-label">Legal Documents Generated</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number shimmer-text">50,000+</div>
                            <div class="stat-label">Legal Questions Answered</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number shimmer-text">99.8%</div>
                            <div class="stat-label">User Satisfaction Rate</div>
                        </div>
                    </div>
                    
                    <div class="hero-actions">
                        <!-- Fixed: Safe onclick handler -->
                        <button id="startChatBtn" class="btn-hero-primary btn-premium">
                            <i class="fas fa-comments"></i>
                            <span>Start Free Chat Now</span>
                            <div class="btn-sparkle">
                                <i class="fas fa-sparkle"></i>
                            </div>
                        </button>
                        
                        <button id="watchDemo" class="btn-hero-secondary">
                            <i class="fas fa-play-circle"></i>
                            <span>Watch Demo Video</span>
                        </button>
                    </div>
                    
                    <div class="hero-trust">
                        <div class="trust-label">Trusted by</div>
                        <div class="trust-badges">
                            <div class="trust-badge">
                                <i class="fas fa-university"></i>
                                <span>Law Firms</span>
                            </div>
                            <div class="trust-badge">
                                <i class="fas fa-graduation-cap"></i>
                                <span>Law Students</span>
                            </div>
                            <div class="trust-badge">
                                <i class="fas fa-briefcase"></i>
                                <span>Businesses</span>
                            </div>
                            <div class="trust-badge">
                                <i class="fas fa-users"></i>
                                <span>Individuals</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="hero-illustration">
                    <div class="ai-assistant-card premium-card pulse-glow">
                        <div class="assistant-avatar legal-seal">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h3 class="assistant-title">AI Legal Assistant</h3>
                        <p class="assistant-subtitle">Available 24/7</p>
                        
                        <div class="assistant-features">
                            <div class="feature">
                                <i class="fas fa-check-circle"></i>
                                <span>Instant Responses</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-check-circle"></i>
                                <span>Multi-Language</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-check-circle"></i>
                                <span>Document Generation</span>
                            </div>
                        </div>
                        
                        <button class="btn-assistant">
                            <i class="fas fa-comment-alt"></i>
                            Ask Legal Question
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Scroll Indicator -->
            <div class="scroll-indicator">
                <div class="mouse">
                    <div class="wheel"></div>
                </div>
                <div class="arrow">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section id="features" class="features-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">
                        <span class="shimmer-text">Powerful Features</span> for All Your Legal Needs
                    </h2>
                    <p class="section-subtitle">
                        Everything you need in one comprehensive legal assistant
                    </p>
                </div>
                
                <div class="features-grid">
                    <!-- Feature 1 -->
                    <div class="feature-card premium-card">
                        <div class="feature-icon legal-seal">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h3 class="feature-title">AI Chat Assistant</h3>
                        <p class="feature-description">
                            Ask legal questions in natural language and get instant, accurate responses powered by advanced AI.
                        </p>
                        <div class="feature-tags">
                            <span class="tag">24/7 Available</span>
                            <span class="tag">Multi-Language</span>
                        </div>
                    </div>
                    
                    <!-- Feature 2 -->
                    <div class="feature-card premium-card">
                        <div class="feature-icon legal-seal">
                            <i class="fas fa-file-contract"></i>
                        </div>
                        <h3 class="feature-title">Smart Document Generation</h3>
                        <p class="feature-description">
                            Generate legal documents instantly in PDF, DOC, and TXT formats with customizable templates.
                        </p>
                        <div class="feature-tags">
                            <span class="tag">100+ Templates</span>
                            <span class="tag">Customizable</span>
                        </div>
                    </div>
                    
                    <!-- Feature 3 -->
                    <div class="feature-card premium-card">
                        <div class="feature-icon legal-seal">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h3 class="feature-title">Bank-Level Security</h3>
                        <p class="feature-description">
                            End-to-end encryption and secure authentication to protect your sensitive legal data.
                        </p>
                        <div class="feature-tags">
                            <span class="tag">AES-256</span>
                            <span class="tag">GDPR Compliant</span>
                        </div>
                    </div>
                    
                    <!-- Feature 4 -->
                    <div class="feature-card premium-card">
                        <div class="feature-icon legal-seal">
                            <i class="fas fa-history"></i>
                        </div>
                        <h3 class="feature-title">Complete Chat History</h3>
                        <p class="feature-description">
                            Access your complete chat history anytime. Export conversations as documents for record keeping.
                        </p>
                        <div class="feature-tags">
                            <span class="tag">Unlimited History</span>
                            <span class="tag">Export Options</span>
                        </div>
                    </div>
                    
                    <!-- Feature 5 -->
                    <div class="feature-card premium-card">
                        <div class="feature-icon legal-seal">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <h3 class="feature-title">Mobile Responsive</h3>
                        <p class="feature-description">
                            Access LegalSwami from any device - desktop, tablet, or mobile phone with native-like experience.
                        </p>
                        <div class="feature-tags">
                            <span class="tag">PWA Support</span>
                            <span class="tag">Offline Mode</span>
                        </div>
                    </div>
                    
                    <!-- Feature 6 -->
                    <div class="feature-card premium-card">
                        <div class="feature-icon legal-seal">
                            <i class="fas fa-language"></i>
                        </div>
                        <h3 class="feature-title">Multi-Language Support</h3>
                        <p class="feature-description">
                            Get legal advice in multiple languages including Hindi, English, Marathi, Gujarati, and more.
                        </p>
                        <div class="feature-tags">
                            <span class="tag">10+ Languages</span>
                            <span class="tag">Real-time Translation</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Legal Database Section -->
        <section id="legalDatabase" class="database-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">
                        <span class="shimmer-text">Legal Database</span> & Research Tools
                    </h2>
                    <p class="section-subtitle">
                        Access comprehensive legal resources and research materials
                    </p>
                </div>
                
                <div class="database-grid">
                    <!-- Legal Acts Database -->
                    <div class="database-card premium-card">
                        <div class="database-icon">
                            <i class="fas fa-book"></i>
                        </div>
                        <h3 class="database-title">Acts & Statutes</h3>
                        <ul class="database-list">
                            <li><i class="fas fa-search"></i> IPC (Indian Penal Code)</li>
                            <li><i class="fas fa-search"></i> CrPC (Criminal Procedure Code)</li>
                            <li><i class="fas fa-search"></i> CPC (Civil Procedure Code)</li>
                            <li><i class="fas fa-search"></i> Constitution of India</li>
                            <li><i class="fas fa-search"></i> Consumer Protection Act</li>
                        </ul>
                        <button class="btn-database">
                            <i class="fas fa-search"></i>
                            Search Acts
                        </button>
                    </div>
                    
                    <!-- Case Laws Database -->
                    <div class="database-card premium-card">
                        <div class="database-icon">
                            <i class="fas fa-gavel"></i>
                        </div>
                        <h3 class="database-title">Case Laws Database</h3>
                        <ul class="database-list">
                            <li><i class="fas fa-balance-scale"></i> Supreme Court Judgments</li>
                            <li><i class="fas fa-balance-scale"></i> High Court Judgments</li>
                            <li><i class="fas fa-balance-scale"></i> Landmark Cases</li>
                            <li><i class="fas fa-balance-scale"></i> Recent Judgments</li>
                            <li><i class="fas fa-balance-scale"></i> Case Citations</li>
                        </ul>
                        <button class="btn-database">
                            <i class="fas fa-gavel"></i>
                            Search Case Laws
                        </button>
                    </div>
                    
                    <!-- Legal Calculator -->
                    <div class="database-card premium-card">
                        <div class="database-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <h3 class="database-title">Legal Calculators</h3>
                        <ul class="database-list">
                            <li><i class="fas fa-calculator"></i> Court Fee Calculator</li>
                            <li><i class="fas fa-calculator"></i> Stamp Duty Calculator</li>
                            <li><i class="fas fa-calculator"></i> Compensation Calculator</li>
                            <li><i class="fas fa-calculator"></i> Interest Calculator</li>
                            <li><i class="fas fa-calculator"></i> Tax Calculator</li>
                        </ul>
                        <button class="btn-database">
                            <i class="fas fa-calculator"></i>
                            Open Calculator
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Document Types Section -->
        <section id="documents" class="documents-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">
                        Generate <span class="shimmer-text">Legal Documents</span> Instantly
                    </h2>
                    <p class="section-subtitle">
                        Professional legal documents at your fingertips
                    </p>
                </div>
                
                <div class="documents-grid">
                    <!-- Document Category 1 -->
                    <div class="document-category premium-card">
                        <div class="category-icon">
                            <i class="fas fa-handshake"></i>
                        </div>
                        <h3 class="category-title">Agreements & Contracts</h3>
                        <ul class="document-list">
                            <li><i class="fas fa-check-circle"></i> Rental Agreement</li>
                            <li><i class="fas fa-check-circle"></i> Non-Disclosure Agreement</li>
                            <li><i class="fas fa-check-circle"></i> Employment Contract</li>
                            <li><i class="fas fa-check-circle"></i> Service Agreement</li>
                            <li><i class="fas fa-check-circle"></i> Partnership Agreement</li>
                        </ul>
                        <button class="btn-generate">
                            <i class="fas fa-magic"></i>
                            Generate Now
                        </button>
                    </div>
                    
                    <!-- Document Category 2 -->
                    <div class="document-category premium-card">
                        <div class="category-icon">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <h3 class="category-title">Legal Notices & Letters</h3>
                        <ul class="document-list">
                            <li><i class="fas fa-check-circle"></i> Legal Notice</li>
                            <li><i class="fas fa-check-circle"></i> Cease & Desist Notice</li>
                            <li><i class="fas fa-check-circle"></i> Demand Letter</li>
                            <li><i class="fas fa-check-circle"></i> Notice to Quit</li>
                            <li><i class="fas fa-check-circle"></i> Consumer Complaint</li>
                        </ul>
                        <button class="btn-generate">
                            <i class="fas fa-magic"></i>
                            Generate Now
                        </button>
                    </div>
                    
                    <!-- Document Category 3 -->
                    <div class="document-category premium-card">
                        <div class="category-icon">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <h3 class="category-title">Personal & Family</h3>
                        <ul class="document-list">
                            <li><i class="fas fa-check-circle"></i> Will & Testament</li>
                            <li><i class="fas fa-check-circle"></i> Power of Attorney</li>
                            <li><i class="fas fa-check-circle"></i> Affidavit</li>
                            <li><i class="fas fa-check-circle"></i> Gift Deed</li>
                            <li><i class="fas fa-check-circle"></i> Divorce Papers</li>
                        </ul>
                        <button class="btn-generate">
                            <i class="fas fa-magic"></i>
                            Generate Now
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Lawyer Directory Section -->
        <section id="lawyerDirectory" class="lawyer-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">
                        Find <span class="shimmer-text">Qualified Lawyers</span>
                    </h2>
                    <p class="section-subtitle">
                        Connect with experienced legal professionals
                    </p>
                </div>
                
                <div class="lawyer-search">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="lawyerSearch" placeholder="Search by specialization, location, or name...">
                        <button class="btn-search">
                            <i class="fas fa-search"></i>
                            Search
                        </button>
                    </div>
                    
                    <div class="specialization-filters">
                        <button class="filter-btn active" data-specialization="all">All</button>
                        <button class="filter-btn" data-specialization="criminal">Criminal</button>
                        <button class="filter-btn" data-specialization="civil">Civil</button>
                        <button class="filter-btn" data-specialization="corporate">Corporate</button>
                        <button class="filter-btn" data-specialization="family">Family</button>
                        <button class="filter-btn" data-specialization="property">Property</button>
                    </div>
                </div>
                
                <div class="lawyers-grid" id="lawyersGrid">
                    <!-- Lawyers will be dynamically loaded here -->
                    <div class="lawyer-card premium-card">
                        <div class="lawyer-avatar">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <h3 class="lawyer-name">Adv. Rajesh Kumar</h3>
                        <p class="lawyer-specialization">Criminal Law Expert</p>
                        <p class="lawyer-experience">15+ Years Experience</p>
                        <button class="btn-consult">
                            <i class="fas fa-comments"></i> Consult Now
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Legal Procedure Guides Section -->
        <section id="legalGuides" class="guides-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">
                        <span class="shimmer-text">Step-by-Step</span> Legal Guides
                    </h2>
                    <p class="section-subtitle">
                        Understand legal procedures with easy-to-follow guides
                    </p>
                </div>
                
                <div class="guides-grid">
                    <div class="guide-card premium-card">
                        <div class="guide-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <h3 class="guide-title">How to File a Case</h3>
                        <p class="guide-description">
                            Complete step-by-step guide for filing different types of cases in Indian courts.
                        </p>
                        <div class="guide-steps">
                            <span class="step">1. Document Preparation</span>
                            <span class="step">2. Court Selection</span>
                            <span class="step">3. Fee Payment</span>
                            <span class="step">4. Case Number</span>
                        </div>
                        <button class="btn-guide">
                            <i class="fas fa-book-open"></i>
                            View Guide
                        </button>
                    </div>
                    
                    <div class="guide-card premium-card">
                        <div class="guide-icon">
                            <i class="fas fa-file-contract"></i>
                        </div>
                        <h3 class="guide-title">Document Registration Process</h3>
                        <p class="guide-description">
                            Learn how to register legal documents with proper procedures and fees.
                        </p>
                        <div class="guide-steps">
                            <span class="step">1. Stamp Duty</span>
                            <span class="step">2. Witness Arrangement</span>
                            <span class="step">3. Registration Office</span>
                            <span class="step">4. Final Registration</span>
                        </div>
                        <button class="btn-guide">
                            <i class="fas fa-book-open"></i>
                            View Guide
                        </button>
                    </div>
                    
                    <div class="guide-card premium-card">
                        <div class="guide-icon">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <h3 class="guide-title">Consumer Complaint Process</h3>
                        <p class="guide-description">
                            Guide to filing consumer complaints with proper documentation and procedures.
                        </p>
                        <div class="guide-steps">
                            <span class="step">1. Complaint Drafting</span>
                            <span class="step">2. Evidence Collection</span>
                            <span class="step">3. Forum Selection</span>
                            <span class="step">4. Hearing Process</span>
                        </div>
                        <button class="btn-guide">
                            <i class="fas fa-book-open"></i>
                            View Guide
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Testimonials Section -->
        <section id="testimonials" class="testimonials-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">
                        Trusted by <span class="shimmer-text">Thousands</span> of Users
                    </h2>
                    <p class="section-subtitle">
                        See what our users have to say about LegalSwami
                    </p>
                </div>
                
                <div class="testimonials-carousel">
                    <!-- Testimonial 1 -->
                    <div class="testimonial-card premium-card">
                        <div class="testimonial-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                        </div>
                        <p class="testimonial-text">
                            "LegalSwami helped me draft a professional rental agreement in minutes. The AI understood exactly what I needed and generated a perfect document. Saved me ₹5000 in lawyer fees!"
                        </p>
                        <div class="testimonial-author">
                            <div class="author-avatar">
                                <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Rahul Sharma">
                            </div>
                            <div class="author-info">
                                <h4 class="author-name">Rahul Sharma</h4>
                                <p class="author-title">Small Business Owner</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Testimonial 2 -->
                    <div class="testimonial-card premium-card">
                        <div class="testimonial-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star-half-alt"></i>
                        </div>
                        <p class="testimonial-text">
                            "As a law student, LegalSwami is a game-changer! It helps me understand complex legal concepts and provides excellent research assistance. Like having a personal tutor 24/7."
                        </p>
                        <div class="testimonial-author">
                            <div class="author-avatar">
                                <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="Priya Patel">
                            </div>
                            <div class="author-info">
                                <h4 class="author-name">Priya Patel</h4>
                                <p class="author-title">Law Student, NLU Delhi</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Testimonial 3 -->
                    <div class="testimonial-card premium-card">
                        <div class="testimonial-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                        </div>
                        <p class="testimonial-text">
                            "The document generation feature saved our startup thousands! We needed multiple NDAs and service agreements. LegalSwami generated perfect documents in minutes. Incredible tool!"
                        </p>
                        <div class="testimonial-author">
                            <div class="author-avatar">
                                <img src="https://randomuser.me/api/portraits/men/67.jpg" alt="Ankit Verma">
                            </div>
                            <div class="author-info">
                                <h4 class="author-name">Ankit Verma</h4>
                                <p class="author-title">Tech Entrepreneur</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Pricing Section -->
        <section id="pricing" class="pricing-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">
                        Simple, <span class="shimmer-text">Transparent</span> Pricing
                    </h2>
                    <p class="section-subtitle">
                        Choose the perfect plan for your legal needs
                    </p>
                </div>
                
                <div class="pricing-cards">
                    <!-- Free Plan -->
                    <div class="pricing-card premium-card">
                        <div class="pricing-badge">FREE</div>
                        <h3 class="pricing-title">Basic</h3>
                        <div class="pricing-price">
                            <span class="currency">₹</span>
                            <span class="amount">0</span>
                            <span class="period">/month</span>
                        </div>
                        <p class="pricing-description">Perfect for trying out LegalSwami</p>
                        
                        <ul class="pricing-features">
                            <li><i class="fas fa-check-circle"></i> 10 AI Chat Messages/Day</li>
                            <li><i class="fas fa-check-circle"></i> 3 Document Generations/Month</li>
                            <li><i class="fas fa-check-circle"></i> Basic Legal Questions</li>
                            <li><i class="fas fa-times-circle"></i> No Priority Support</li>
                            <li><i class="fas fa-times-circle"></i> No Document History</li>
                        </ul>
                        
                        <button class="btn-pricing">
                            Get Started Free
                        </button>
                    </div>
                    
                    <!-- Pro Plan -->
                    <div class="pricing-card premium-card premium-plan">
                        <div class="pricing-badge popular">POPULAR</div>
                        <h3 class="pricing-title">Professional</h3>
                        <div class="pricing-price">
                            <span class="currency">₹</span>
                            <span class="amount">499</span>
                            <span class="period">/month</span>
                        </div>
                        <p class="pricing-description">Perfect for professionals & businesses</p>
                        
                        <ul class="pricing-features">
                            <li><i class="fas fa-check-circle"></i> Unlimited AI Chat Messages</li>
                            <li><i class="fas fa-check-circle"></i> 50 Document Generations/Month</li>
                            <li><i class="fas fa-check-circle"></i> All Document Templates</li>
                            <li><i class="fas fa-check-circle"></i> Priority Support</li>
                            <li><i class="fas fa-check-circle"></i> Complete Chat History</li>
                        </ul>
                        
                        <button class="btn-pricing btn-premium">
                            <i class="fas fa-crown"></i>
                            Get Professional
                        </button>
                    </div>
                    
                    <!-- Business Plan -->
                    <div class="pricing-card premium-card">
                        <div class="pricing-badge">BUSINESS</div>
                        <h3 class="pricing-title">Enterprise</h3>
                        <div class="pricing-price">
                            <span class="currency">₹</span>
                            <span class="amount">1,499</span>
                            <span class="period">/month</span>
                        </div>
                        <p class="pricing-description">For law firms & large organizations</p>
                        
                        <ul class="pricing-features">
                            <li><i class="fas fa-check-circle"></i> Everything in Professional</li>
                            <li><i class="fas fa-check-circle"></i> Unlimited Document Generation</li>
                            <li><i class="fas fa-check-circle"></i> Team Collaboration</li>
                            <li><i class="fas fa-check-circle"></i> Custom Templates</li>
                            <li><i class="fas fa-check-circle"></i> Dedicated Account Manager</li>
                        </ul>
                        
                        <button class="btn-pricing">
                            Contact Sales
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- CTA Section -->
        <section class="cta-section">
            <div class="container">
                <div class="cta-content">
                    <h2 class="cta-title">
                        Ready to Experience <br>
                        AI-Powered Legal Assistance?
                    </h2>
                    <p class="cta-description">
                        Join thousands of satisfied users who trust LegalSwami for their legal needs. 
                        No credit card required to get started.
                    </p>
                    
                    <div class="cta-actions">
                        <button id="ctaStartChat" class="btn-cta-primary btn-premium">
                            <i class="fas fa-rocket"></i>
                            Start Free Chat Now
                        </button>
                        
                        <button id="ctaScheduleDemo" class="btn-cta-secondary">
                            <i class="fas fa-calendar"></i>
                            Schedule Demo
                        </button>
                    </div>
                    
                    <div class="cta-guarantee">
                        <div class="guarantee-item">
                            <i class="fas fa-shield-alt"></i>
                            <span>100% Secure & Private</span>
                        </div>
                        <div class="guarantee-item">
                            <i class="fas fa-clock"></i>
                            <span>Available 24/7</span>
                        </div>
                        <div class="guarantee-item">
                            <i class="fas fa-headset"></i>
                            <span>Priority Support</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- CHATGPT-LIKE CHAT INTERFACE -->
        <div id="chatInterface" class="chat-interface">
            <div class="container">
                <div class="chat-container">
                    <header>
                        <div class="logo">
                            <button class="sidebar-toggle" id="sidebarToggle">
                                <i class="fas fa-bars"></i>
                            </button>
                            <div class="logo-icon">
                                <i class="fas fa-scale-balanced"></i>
                            </div>
                            <h1>LegalSwami</h1>
                        </div>
                        
                        <div class="header-actions">
                            <button id="backToHomeBtn" class="header-btn">
                                <i class="fas fa-home"></i>
                                <span class="hide-on-mobile">Back to Home</span>
                            </button>
                            
                            <div class="status-indicator">
                                <div class="status-dot"></div>
                                <span class="hide-on-mobile">AI Assistant Ready</span>
                            </div>
                            
                            <!-- Search Counter Display -->
                            <div class="search-counter" id="searchCounter">
                                <i class="fas fa-search"></i>
                                <span class="hide-on-mobile">Free searches: 500/500</span>
                            </div>
                            
                            <!-- Login Button -->
                            <button class="login-btn" id="chatHeaderLoginBtn">
                                <i class="fas fa-sign-in-alt"></i>
                                <span class="hide-on-mobile">Login</span>
                            </button>
                            
                            <button class="header-btn voice-search-btn" id="voiceSearchBtn" title="Voice Search">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button class="header-btn theme-toggle" id="themeToggle" title="Toggle Theme">
                                <i class="fas fa-sun"></i>
                            </button>
                            <button class="header-btn" id="clearChatBtn">
                                <i class="fas fa-broom"></i>
                                <span class="hide-on-mobile">Clear Chat</span>
                            </button>
                            <button class="header-btn" id="downloadCurrentBtn">
                                <i class="fas fa-download"></i>
                                <span class="hide-on-mobile">Download Chat</span>
                            </button>
                            <button class="header-btn" id="suggestionsBtn">
                                <i class="fas fa-lightbulb"></i>
                                <span class="hide-on-mobile">Suggestions</span>
                            </button>
                            
                            <!-- User Profile (Hidden by default) -->
                            <div class="user-profile" id="chatUserProfile" style="display: none;">
                                <div class="user-avatar" id="chatUserAvatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="user-info">
                                    <div class="user-name" id="chatUserName">Guest User</div>
                                    <div class="user-email" id="chatUserEmail">Local Browser Mode</div>
                                </div>
                                <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                            </div>
                        </div>
                    </header>
                    
                    <!-- User Dropdown Menu -->
                    <div class="user-dropdown" id="chatUserDropdown">
                        <div class="dropdown-header">
                            <div class="user-avatar" id="chatDropdownAvatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-info">
                                <div class="user-name" id="chatDropdownName">Guest User</div>
                                <div class="user-email" id="chatDropdownEmail">Local Browser Mode</div>
                            </div>
                        </div>
                        
                        <div class="dropdown-items">
                            <button class="dropdown-item" id="chatProfileBtn">
                                <i class="fas fa-user-circle"></i>
                                <span>My Profile</span>
                            </button>
                            <button class="dropdown-item" id="chatSettingsBtn">
                                <i class="fas fa-cog"></i>
                                <span>Settings</span>
                            </button>
                            <button class="dropdown-item" id="chatHistoryBtn">
                                <i class="fas fa-history"></i>
                                <span>Chat History</span>
                            </button>
                            <button class="dropdown-item" id="chatHelpBtn">
                                <i class="fas fa-question-circle"></i>
                                <span>Help & Support</span>
                            </button>
                            <div class="dropdown-footer">
                                <button class="dropdown-item logout" id="chatLogoutBtn">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>Clear Local Data</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="main-content">
                        <!-- Down Arrow Button (Scroll to Bottom) -->
                        <button class="scroll-to-bottom-btn" id="scrollToBottomBtn" title="Scroll to bottom">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        
                        <div class="sidebar-overlay" id="sidebarOverlay"></div>
                        
                        <aside class="sidebar" id="sidebar">
                            <!-- Sidebar Close Button -->
                            <button class="sidebar-close" id="sidebarClose">
                                <i class="fas fa-times"></i>
                            </button>
                            
                            <!-- Sidebar Tabs -->
                            <div class="sidebar-tabs">
                                <button class="sidebar-tab active" data-tab="legal-topics">
                                    <i class="fas fa-book"></i>
                                    <span class="hide-on-mobile">Legal Topics</span>
                                </button>
                                <button class="sidebar-tab" data-tab="chat-history">
                                    <i class="fas fa-history"></i>
                                    <span class="hide-on-mobile">Chat History</span>
                                </button>
                            </div>
                            
                            <!-- Legal Topics Tab Content -->
                            <div class="tab-content active" id="legal-topics-content">
                                <div class="sidebar-header">
                                    <h2><i class="fas fa-book"></i> Legal Topics</h2>
                                </div>
                                
                                <div class="sidebar-section">
                                    <h3><i class="fas fa-gavel"></i> Common Legal Areas</h3>
                                    <div class="topic-list">
                                        <button class="topic-item" data-topic="contract">
                                            <i class="fas fa-file-contract"></i>
                                            <span>Contract Law</span>
                                        </button>
                                        <button class="topic-item" data-topic="employment">
                                            <i class="fas fa-briefcase"></i>
                                            <span>Employment Law</span>
                                        </button>
                                        <button class="topic-item" data-topic="intellectual">
                                            <i class="fas fa-lightbulb"></i>
                                            <span>Intellectual Property</span>
                                        </button>
                                        <button class="topic-item" data-topic="realestate">
                                            <i class="fas fa-house"></i>
                                            <span>Real Estate Law</span>
                                        </button>
                                        <button class="topic-item" data-topic="family">
                                            <i class="fas fa-heart"></i>
                                            <span>Family Law</span>
                                        </button>
                                        <button class="topic-item" data-topic="criminal">
                                            <i class="fas fa-gavel"></i>
                                            <span>Criminal Law</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Active Topics Tabs Section -->
                                <div class="sidebar-section" id="activeTopicsSection" style="display: none;">
                                    <h3><i class="fas fa-folder-open"></i> Active Topics</h3>
                                    <div class="topic-list" id="activeTopicsList">
                                        <!-- Active topics will be added here dynamically -->
                                    </div>
                                </div>
                                
                                <div class="sidebar-section">
                                    <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                                    <div class="quick-actions">
                                        <button class="action-item" data-action="document-drafts">
                                            <i class="fas fa-file-alt"></i>
                                            <span>Document Drafts</span>
                                        </button>
                                        <button class="action-item" data-action="legal-research">
                                            <i class="fas fa-search"></i>
                                            <span>Legal Research</span>
                                        </button>
                                        <button class="action-item" data-action="case-analysis">
                                            <i class="fas fa-chart-bar"></i>
                                            <span>Case Analysis</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Chat History Tab Content -->
                            <div class="tab-content" id="chat-history-content">
                                <div class="history-header">
                                    <h2><i class="fas fa-history"></i> Chat History</h2>
                                    <button class="new-chat-btn" id="newChatBtn">
                                        <i class="fas fa-plus"></i>
                                        <span class="hide-on-mobile">New Chat</span>
                                    </button>
                                </div>
                                
                                <div class="history-list" id="historyList">
                                    <!-- History items will be loaded here -->
                                    <div class="empty-history">
                                        <i class="fas fa-comments"></i>
                                        <p>No chat history yet</p>
                                        <p style="font-size: 0.8125rem; margin-top: 0.5rem;">Start a conversation to see it here</p>
                                    </div>
                                </div>
                            </div>
                        </aside>
                        
                       <main id="chatContent">
                            <div class="chat-messages" id="chatMessages">
                                <!-- Welcome Message will be added dynamically -->
                            </div>
                            
                            <!-- Scroll Position Indicator -->
                            <div class="scroll-position-indicator" id="scrollPositionIndicator">
                                Scroll to see more messages
                            </div>
                            
                            <div class="input-container">
                                <div class="input-area">
                                    <!-- Attachments Preview -->
                                    <div class="attachments-preview" id="attachmentsPreview" style="display: none;"></div>
                                    
                                    <div class="voice-input-status" id="voiceInputStatus">
                                        <div class="voice-animation">
                                            <div class="voice-bar"></div>
                                            <div class="voice-bar"></div>
                                            <div class="voice-bar"></div>
                                            <div class="voice-bar"></div>
                                            <div class="voice-bar"></div>
                                        </div>
                                        <span>Listening... Speak now</span>
                                    </div>
                                    
                                    <textarea 
                                        id="userInput" 
                                        placeholder="Ask any legal question or attach files (images, PDF, TXT)... (Press Enter for new line, Ctrl+Enter to send)"
                                        rows="1"
                                    ></textarea>
                                    
                                    <div class="voice-input-text" id="voiceInputText"></div>
                                    
                                    <div class="input-buttons">
                                        <!-- Emoji Picker Button -->
                                        <button class="emoji-picker-btn" id="emojiPickerBtn" title="Insert emoji">
                                            <i class="far fa-smile"></i>
                                        </button>
                                        
                                        <!-- Attachment Button -->
                                        <button class="attachment-btn" id="attachmentBtn" title="Attach files (images, PDF, TXT)">
                                            <i class="fas fa-paperclip"></i>
                                        </button>
                                        
                                        <!-- Voice Input Button -->
                                        <button class="input-microphone-btn" id="inputMicrophoneBtn" title="Voice input">
                                            <i class="fas fa-microphone"></i>
                                        </button>
                                        
                                        <!-- Send/Stop Button -->
                                        <button class="send-button" id="sendButton">
                                            <i class="fas fa-paper-plane"></i> <span class="hide-on-mobile">Send</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </main>
                    </div>
                    
                    <!-- Download Modal (for full chat) -->
                    <div class="modal-overlay" id="downloadModal">
                        <div class="modal">
                            <div class="modal-header">
                                <h2><i class="fas fa-download"></i> Download Chat</h2>
                                <button class="modal-close" id="closeDownloadModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-content">
                                <p>Select the format you want to download your chat in:</p>
                                
                                <div class="download-options">
                                    <div class="download-option" data-format="doc">
                                        <i class="fas fa-file-word"></i>
                                        <h3>Word Document</h3>
                                        <p>.doc format</p>
                                    </div>
                                    <div class="download-option" data-format="pdf">
                                        <i class="fas fa-file-pdf"></i>
                                        <h3>PDF Document</h3>
                                        <p>.pdf format</p>
                                    </div>
                                    <div class="download-option" data-format="txt">
                                        <i class="fas fa-file-alt"></i>
                                        <h3>Text File</h3>
                                        <p>.txt format</p>
                                    </div>
                                </div>
                                
                                <div class="progress-indicator" id="progressIndicator">
                                    <div class="progress-spinner"></div>
                                    <p>Preparing your document...</p>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <p>The document will include the complete chat conversation with timestamps.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Delete Confirmation Modal -->
                    <div class="modal-overlay" id="deleteModal">
                        <div class="modal confirmation-modal">
                            <div class="modal-header">
                                <h2><i class="fas fa-trash"></i> Delete Chat</h2>
                                <button class="modal-close" id="closeDeleteModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-content">
                                <div class="confirmation-text">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <h3>Are you sure you want to delete this chat?</h3>
                                    <p id="deleteChatTitle">This action cannot be undone and the chat will be permanently deleted.</p>
                                </div>
                                
                                <div class="confirmation-buttons">
                                    <button class="confirmation-btn cancel" id="cancelDelete">Cancel</button>
                                    <button class="confirmation-btn delete" id="confirmDelete">Delete Permanently</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Individual Message Download Modal -->
                    <div class="modal-overlay" id="messageDownloadModal">
                        <div class="modal">
                            <div class="modal-header">
                                <h2><i class="fas fa-file-download"></i> Download Document</h2>
                                <button class="modal-close" id="closeMessageDownloadModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-content">
                                <p>Select the format for this specific response:</p>
                                
                                <div class="download-options">
                                    <div class="download-option" data-format="doc">
                                        <i class="fas fa-file-word"></i>
                                        <h3>Word Document</h3>
                                        <p>.doc format</p>
                                    </div>
                                    <div class="download-option" data-format="pdf">
                                        <i class="fas fa-file-pdf"></i>
                                        <h3>PDF Document</h3>
                                        <p>.pdf format</p>
                                    </div>
                                    <div class="download-option" data-format="txt">
                                        <i class="fas fa-file-alt"></i>
                                        <h3>Text File</h3>
                                        <p>.txt format</p>
                                    </div>
                                </div>
                                
                                <div class="progress-indicator" id="messageProgressIndicator">
                                    <div class="progress-spinner"></div>
                                    <p>Preparing your document...</p>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <p>The document will include only this specific AI response.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- File Upload Modal -->
                    <div class="modal-overlay image-upload-modal" id="fileUploadModal">
                        <div class="image-upload-content">
                            <div class="modal-header">
                                <h2><i class="fas fa-paperclip"></i> Attach Files</h2>
                                <button class="modal-close" id="closeFileUploadModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-content">
                                <div class="upload-area" id="uploadArea">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <div class="upload-text">
                                        <h3>Drag & Drop Files Here</h3>
                                        <p>or click to browse files</p>
                                        <p style="font-size: 0.8125rem; color: var(--dark-text-secondary);">
                                            Supported formats: Images (JPG, PNG, GIF), PDF, TXT, DOC
                                        </p>
                                        <button class="upload-btn" id="browseFilesBtn">
                                            <i class="fas fa-folder-open"></i> Browse Files
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="uploaded-images" id="uploadedFiles">
                                    <!-- Uploaded files will appear here -->
                                </div>
                                
                                <div class="confirmation-buttons" style="margin-top: 1.25rem;">
                                    <button class="confirmation-btn cancel" id="cancelFileUpload">
                                        Cancel
                                    </button>
                                    <button class="confirmation-btn" id="confirmFileUpload" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white;">
                                        <i class="fas fa-paperclip"></i> Attach Selected Files
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Download Notification -->
                    <div class="download-notification" id="downloadNotification">
                        <i class="fas fa-file-download"></i>
                        <div class="download-notification-content">
                            <div class="download-notification-title" id="downloadNotificationTitle">Document Downloaded</div>
                            <div class="download-notification-message" id="downloadNotificationMessage">Click to open the file</div>
                        </div>
                        <button class="download-notification-close" id="closeDownloadNotification">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="toast" id="toast">
                        <i class="fas fa-check-circle"></i>
                        <span id="toast-message">Message sent successfully</span>
                    </div>
                </div>
            </div>
        </div>
		
		<!-- Legal Tools Modal -->
        <div id="legalToolsModal" class="modal">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <button id="closeLegalTools" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
                
                <div class="modal-header">
                    <div class="modal-icon legal-seal">
                        <i class="fas fa-tools"></i>
                    </div>
                    <h3>Legal Tools & Calculators</h3>
                    <p>Access various legal utilities</p>
                </div>
                
                <div class="modal-body">
                    <div class="tools-grid">
                        <button class="tool-card">
                            <i class="fas fa-calculator"></i>
                            <h4>Court Fee Calculator</h4>
                            <p>Calculate court fees for different cases</p>
                        </button>
                        
                        <button class="tool-card">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <h4>Stamp Duty Calculator</h4>
                            <p>Calculate stamp duty for documents</p>
                        </button>
                        
                        <button class="tool-card">
                            <i class="fas fa-money-check-alt"></i>
                            <h4>Compensation Calculator</h4>
                            <p>Calculate compensation amounts</p>
                        </button>
                        
                        <button class="tool-card">
                            <i class="fas fa-search"></i>
                            <h4>Act & Statute Search</h4>
                            <p>Search legal acts and statutes</p>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modern Login Modal -->
        <div id="loginModal" class="modal">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <button id="closeLoginModal" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
                
                <div class="modal-header">
                    <div class="modal-icon legal-seal">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <h3>Welcome to LegalSwami</h3>
                    <p>Secure login to access all features</p>
                </div>
                
                <div class="modal-body">
                    <!-- Google Sign-In Container -->
                    <div id="googleSignInContainer"></div>
                    
                    <!-- Custom Google Button -->
                    <button id="customGoogleBtn" class="google-signin-btn">
                        <i class="fab fa-google"></i>
                        Continue with Google
                    </button>
                    
                    <div class="divider">
                        <span>or</span>
                    </div>
                    
                    <!-- Demo Login Button -->
                    <button id="demoLoginBtn" class="demo-login-btn">
                        <i class="fas fa-user"></i> Try Demo Version
                    </button>
                    
                    <div class="login-info">
                        <p><i class="fas fa-lock"></i> Your data is encrypted and secure</p>
                        <p><i class="fas fa-shield-alt"></i> We never share your personal information</p>
                        <p><i class="fas fa-bolt"></i> No credit card required</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="premium-footer">
            <div class="container">
                <div class="footer-content">
                    <!-- Company Info -->
                    <div class="footer-section">
                        <div class="footer-logo">
                            <div class="logo-icon legal-seal">
                                <i class="fas fa-gavel"></i>
                            </div>
                            <div class="logo-text">
                                <h3 class="logo-title shimmer-text">LegalSwami</h3>
                                <p class="logo-subtitle">AI Legal Assistant</p>
                            </div>
                        </div>
                        <p class="footer-description">
                            Making legal assistance accessible to everyone with AI-powered technology.
                        </p>
                        <div class="social-links">
                            <a href="#" class="social-link">
                                <i class="fab fa-twitter"></i>
                            </a>
                            <a href="#" class="social-link">
                                <i class="fab fa-linkedin"></i>
                            </a>
                            <a href="#" class="social-link">
                                <i class="fab fa-github"></i>
                            </a>
                            <a href="#" class="social-link">
                                <i class="fab fa-youtube"></i>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Quick Links -->
                    <div class="footer-section">
                        <h4 class="footer-heading">Quick Links</h4>
                        <ul class="footer-links">
                            <li><a href="#home">Home</a></li>
                            <li><a href="#features">Features</a></li>
                            <li><a href="#documents">Documents</a></li>
                            <li><a href="#legalDatabase">Legal Database</a></li>
                            <li><a href="#lawyerDirectory">Find Lawyers</a></li>
                            <li><a href="#legalGuides">Legal Guides</a></li>
                            <li><a href="#testimonials">Testimonials</a></li>
                            <li><a href="#pricing">Pricing</a></li>
                        </ul>
                    </div>
                    
                    <!-- Legal -->
                    <div class="footer-section">
                        <h4 class="footer-heading">Legal</h4>
                        <ul class="footer-links">
                            <li><a href="#" id="termsLink">Terms of Service</a></li>
                            <li><a href="#" id="privacyLink">Privacy Policy</a></li>
                            <li><a href="#" id="disclaimerLink">Legal Disclaimer</a></li>
                            <li><a href="#" id="cookieLink">Cookie Policy</a></li>
                        </ul>
                    </div>
                    
                    <!-- Contact -->
                    <div class="footer-section">
                        <h4 class="footer-heading">Contact Us</h4>
                        <ul class="footer-contact">
                            <li>
                                <i class="fas fa-envelope"></i>
                                <a href="mailto:support@legalswami.com">support@legalswami.com</a>
                            </li>
                            <li>
                                <i class="fas fa-phone"></i>
                                <a href="tel:+919876543210">+91 9876543210</a>
                            </li>
                            <li>
                                <i class="fas fa-map-marker-alt"></i>
                                <span>Mumbai, India</span>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="footer-bottom">
                    <p class="copyright">
                        &copy; 2024 LegalSwami. All rights reserved.
                    </p>
                    <div class="disclaimer">
                        <i class="fas fa-exclamation-triangle"></i>
                        LegalSwami provides AI-powered legal assistance. It is not a substitute for professional legal advice.
                    </div>
                </div>
            </div>
        </footer>

        <!-- Back to Top -->
        <button id="backToTop" class="back-to-top">
            <i class="fas fa-chevron-up"></i>
        </button>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
	
    <!-- Main App Script -->
    <script>
// Global variables
let chatHistory = [];
let currentChatId = null;
let conversationHistory = [];
let messageContentForDownload = "";
let isListening = false;
let recognition = null;
let isInputMicrophoneActive = false;
let isLightMode = false;
let currentStreamingMessageId = null;
let currentStreamingContent = '';
let currentStreamingBuffer = '';
let streamingTextChunks = [];
let streamingTextIndex = 0;
let streamingWordDelay = 20;
let streamingPunctuationDelay = 100;
let attachedFiles = [];
let selectedFiles = [];
let activeLegalTopics = [];
let isStreamingPaused = false;
let isStreamingActive = false;
let stopStreamingRequested = false;
let currentUser = null;
let isLoggedIn = false;
let userToken = null;
let searchCount = 0;
const MAX_FREE_SEARCHES = 500;
const MAX_PREMIUM_SEARCHES = 1000;
let scrollPosition = 0;
let lastDownloadedFileUrl = null;
let lastDownloadedFileName = '';
let isProcessing = false;
let googleGISInitialized = false;
let isMobileMenuOpen = false;
let isChatOpen = false;
let isLoginModalOpen = false;
let selectedLanguage = 'en';
let chatInitialized = false;

// Check device type
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
const isTablet = window.innerWidth <= 1024 && window.innerWidth > 480;

// Welcome message HTML
const WELCOME_MESSAGE_HTML = `
    <div class="welcome-message">
        <h2>Welcome to LegalSwami</h2>
        <p>Your AI-powered legal assistant for accurate, comprehensive legal information and guidance.</p>
        <p style="color: var(--primary); margin-top: 10px; font-size: 0.875rem;">
            <i class="fas fa-language"></i> Supports multiple Indian languages including Marathi, Hindi, and more!
        </p>
        <div style="margin-top: 1.5rem;">
            <h3 style="color: var(--primary); margin-bottom: 0.875rem; font-size: 1rem;">Ready-to-Use Legal Documents:</h3>
            <div class="draft-templates">
                <div class="draft-template" data-template="nda">
                    <i class="fas fa-file-signature"></i>
                    <h4>Non-Disclosure Agreement</h4>
                    <p>Confidentiality agreement template</p>
                </div>
                <div class="draft-template" data-template="employment">
                    <i class="fas fa-briefcase"></i>
                    <h4>Employment Contract</h4>
                    <p>Employee agreement template</p>
                </div>
                <div class="draft-template" data-template="rental">
                    <i class="fas fa-house"></i>
                    <h4>Rental Agreement</h4>
                    <p>Tenancy agreement template</p>
                </div>
                <div class="draft-template" data-template="loan">
                    <i class="fas fa-money-bill-wave"></i>
                    <h4>Loan Agreement</h4>
                    <p>Money lending agreement</p>
                </div>
            </div>
        </div>
        <div class="section-divider"></div>
        <div class="welcome-features">
            <div class="feature">
                <i class="fas fa-bolt"></i>
                <h4>Instant Responses</h4>
                <p>Get immediate legal insights powered by advanced AI</p>
            </div>
            <div class="feature">
                <i class="fas fa-shield-alt"></i>
                <h4>Confidential & Secure</h4>
                <p>Your conversations are private and encrypted</p>
            </div>
            <div class="feature">
                <i class="fas fa-language"></i>
                <h4>Multi-Language</h4>
                <p>Responds in same language as your query</p>
            </div>
            <div class="feature">
                <i class="fas fa-microphone"></i>
                <h4>Voice Search</h4>
                <p>Speak your queries in natural language</p>
            </div>
            <div class="feature">
                <i class="fas fa-file-upload"></i>
                <h4>File Analysis</h4>
                <p>Upload and analyze documents, images</p>
            </div>
        </div>
    </div>
`;

// FIXED: Show ChatGPT interface - CORRECTED VERSION
function showChatGPTInterface() {
    console.log("🚀 Showing Chat Interface");
    
    const mainContainer = document.querySelector('.main-container');
    const chatInterface = document.getElementById('chatInterface');
    
    if (!chatInterface) {
        console.error("❌ Chat interface not found!");
        return;
    }
    
    // Hide homepage
    if (mainContainer) {
        mainContainer.style.display = 'none';
    }
    
    // Show chat
    chatInterface.classList.add('active');
    document.body.classList.add('chat-active');
    
    // Initialize if needed
    if (!chatInitialized) {
        setTimeout(() => {
            initializeChatApp();
        }, 100);
    }
    
    // Focus input
    setTimeout(() => {
        const userInput = document.getElementById('userInput');
        if (userInput) {
            userInput.focus();
        }
    }, 300);
    
    console.log("✅ Chat shown successfully");
}

// FIXED: Go Back to Home
function goBackToHome() {
    console.log("🏠 Going back to home");
    
    const chatInterface = document.getElementById('chatInterface');
    const mainContainer = document.querySelector('.main-container');
    
    // Hide chat
    if (chatInterface) {
        chatInterface.classList.remove('active');
    }
    
    // Show homepage
    document.body.classList.remove('chat-active');
    if (mainContainer) {
        mainContainer.style.display = 'block';
    }
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    console.log("✅ Back to home successful");
}

// FIXED: Initialize app for guest users
function initializeAppForGuest() {
    console.log("Initializing in guest mode...");
    currentUser = {
        id: 'guest_' + Date.now(),
        name: 'Guest User',
        email: 'Local Browser Mode',
        isGuest: true,
        picture: null
    };
    isLoggedIn = false;
    updateUserUI();
    initializeChatApp();
    loadUserChatHistory();
    showToast('Welcome to LegalSwami! You have 500 free searches per day.', 'info');
}

// FIXED: Update User UI - handles both homepage and chat
function updateUserUI() {
    // Update homepage UI
    if (isLoggedIn && currentUser) {
        document.getElementById('headerLoginBtn').style.display = 'none';
        document.getElementById('homeUserProfile').style.display = 'flex';
        document.getElementById('homeUserName').textContent = currentUser.name;
        document.getElementById('homeUserEmail').textContent = currentUser.email;
        
        const avatar = document.getElementById('homeUserAvatar');
        if (currentUser.picture) {
            avatar.innerHTML = `<img src="${currentUser.picture}" alt="${currentUser.name}" style="width: 100%; height: 100%; border-radius: 8px;">`;
        } else {
            avatar.innerHTML = '<i class="fas fa-user"></i>';
        }
    } else {
        document.getElementById('headerLoginBtn').style.display = 'flex';
        document.getElementById('homeUserProfile').style.display = 'none';
    }
    
    // Update chat UI if chat interface is visible
    const chatInterface = document.getElementById('chatInterface');
    if (chatInterface && chatInterface.classList.contains('active')) {
        if (isLoggedIn && currentUser) {
            document.getElementById('chatUserProfile').style.display = 'flex';
            document.getElementById('chatUserName').textContent = currentUser.name;
            document.getElementById('chatUserEmail').textContent = currentUser.email;
            document.getElementById('chatDropdownName').textContent = currentUser.name;
            document.getElementById('chatDropdownEmail').textContent = currentUser.email;
            
            const chatAvatar = document.getElementById('chatUserAvatar');
            const dropdownAvatar = document.getElementById('chatDropdownAvatar');
            if (currentUser.picture) {
                chatAvatar.innerHTML = `<img src="${currentUser.picture}" alt="${currentUser.name}" style="width: 100%; height: 100%; border-radius: 6px;">`;
                dropdownAvatar.innerHTML = `<img src="${currentUser.picture}" alt="${currentUser.name}" style="width: 100%; height: 100%; border-radius: 6px;">`;
            } else {
                chatAvatar.innerHTML = '<i class="fas fa-user"></i>';
                dropdownAvatar.innerHTML = '<i class="fas fa-user"></i>';
            }
        } else {
            document.getElementById('chatUserProfile').style.display = 'none';
            document.getElementById('chatHeaderLoginBtn').style.display = 'flex';
        }
    }
    
    updateSearchCounterDisplay();
}

// FIXED: Toggle User Dropdown for chat
function toggleUserDropdown() {
    const dropdown = document.getElementById('chatUserDropdown');
    dropdown.classList.toggle('active');
}

// FIXED: Handle Logout
function handleLogout() {
    if (currentUser && currentUser.isGuest) {
        if (confirm('Are you sure you want to clear all local data? This will delete all chat history and settings.')) {
            localStorage.clear();
            chatHistory = [];
            conversationHistory = [];
            currentChatId = null;
            searchCount = 0;
            currentUser = null;
            isLoggedIn = false;
            document.getElementById('loginModal').classList.add('active');
            updateUserUI();
            showToast('Local data cleared', 'success');
        }
    } else {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('legalSwamiUser');
            localStorage.removeItem('legalSwamiToken');
            currentUser = null;
            userToken = null;
            isLoggedIn = false;
            document.getElementById('loginModal').classList.add('active');
            updateUserUI();
            showToast('Logged out successfully', 'success');
        }
    }
}

// Load User's Chat History
function loadUserChatHistory() {
    const userId = currentUser ? currentUser.id : 'guest';
    const storageKey = `legalSwamiChatHistory_${userId}`;
    try {
        const savedHistory = localStorage.getItem(storageKey);
        if (savedHistory) {
            chatHistory = JSON.parse(savedHistory);
        }
        const savedChatId = localStorage.getItem(`legalSwamiCurrentChatId_${userId}`);
        if (savedChatId) {
            currentChatId = savedChatId;
            const currentChat = chatHistory.find(chat => chat.id === currentChatId);
            if (currentChat) {
                conversationHistory = [...currentChat.messages];
            }
        }
    } catch (error) {
        console.error('Error loading chat history:', error);
        chatHistory = [];
    }
}

// Save User's Chat History
function saveUserChatHistory() {
    const userId = currentUser ? currentUser.id : 'guest';
    const storageKey = `legalSwamiChatHistory_${userId}`;
    try {
        localStorage.setItem(storageKey, JSON.stringify(chatHistory));
        localStorage.setItem(`legalSwamiCurrentChatId_${userId}`, currentChatId);
    } catch (error) {
        console.error('Error saving chat history:', error);
    }
}

// Initialize search counter
function initializeSearchCounter() {
    try {
        const savedCount = localStorage.getItem('legalSwamiSearchCount');
        if (savedCount) {
            searchCount = parseInt(savedCount);
        }
        const savedDate = localStorage.getItem('legalSwamiSearchDate');
        if (savedDate) {
            const lastDate = new Date(savedDate);
            const today = new Date();
            if (lastDate.getDate() !== today.getDate() || 
                lastDate.getMonth() !== today.getMonth() || 
                lastDate.getFullYear() !== today.getFullYear()) {
                searchCount = 0;
                saveSearchCounter();
            }
        }
        updateSearchCounterDisplay();
    } catch (error) {
        console.error('Error loading search counter:', error);
    }
}

// Save search counter
function saveSearchCounter() {
    try {
        localStorage.setItem('legalSwamiSearchCount', searchCount.toString());
        localStorage.setItem('legalSwamiSearchDate', new Date().toISOString());
    } catch (error) {
        console.error('Error saving search counter:', error);
    }
}

// Update search counter display in header
function updateSearchCounterDisplay() {
    const searchCounterElement = document.getElementById('searchCounter');
    if (searchCounterElement) {
        const maxSearches = MAX_FREE_SEARCHES;
        const remaining = maxSearches - searchCount;
        searchCounterElement.innerHTML = `<i class="fas fa-search"></i><span class="hide-on-mobile">Free searches: ${remaining}/${maxSearches}</span>`;
        if (remaining <= 50) {
            searchCounterElement.style.color = 'var(--warning)';
        } else if (remaining <= 10) {
            searchCounterElement.style.color = 'var(--error)';
        } else {
            searchCounterElement.style.color = 'var(--dark-text-secondary)';
        }
    }
}

// FIXED: Initialize Chat App
function initializeChatApp() {
    console.log("Initializing chat app...");
    
    try {
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarClose = document.getElementById('sidebarClose');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const downloadCurrentBtn = document.getElementById('downloadCurrentBtn');
        const suggestionsBtn = document.getElementById('suggestionsBtn');
        const voiceSearchBtn = document.getElementById('voiceSearchBtn');
        const inputMicrophoneBtn = document.getElementById('inputMicrophoneBtn');
        const themeToggle = document.getElementById('themeToggle');
        const topicItems = document.querySelectorAll('.topic-item');
        const actionItems = document.querySelectorAll('.action-item');
        const sidebarTabs = document.querySelectorAll('.sidebar-tab');
        const newChatBtn = document.getElementById('newChatBtn');
        const attachmentBtn = document.getElementById('attachmentBtn');
        const headerLoginBtn = document.getElementById('chatHeaderLoginBtn');
        const logoutBtn = document.getElementById('chatLogoutBtn');
        const userProfile = document.getElementById('chatUserProfile');
        const emojiPickerBtn = document.getElementById('emojiPickerBtn');
        const backToHomeBtn = document.getElementById('backToHomeBtn');

        const isDesktop = window.innerWidth >= 1025;
        if (isDesktop && sidebar) {
            sidebar.classList.add('active');
        }
        loadThemePreference();
        initializeSearchCounter();
        if (!currentChatId || conversationHistory.length === 0) {
            createNewChat();
        } else {
            loadCurrentChatMessages();
        }

        // Event listeners for chat functionality
        sendButton.addEventListener('click', function() {
            if (isStreamingActive) {
                stopStreaming();
            } else {
                sendMessage();
            }
        });
        
        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                if (isStreamingActive) {
                    stopStreaming();
                } else {
                    sendMessage();
                }
            }
            if (e.key === 'Enter' && !e.ctrlKey) {
                setTimeout(() => {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 150) + 'px';
                }, 10);
            }
        });
        
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            if (isStreamingActive) {
                sendButton.disabled = false;
                sendButton.classList.add('stop-button');
                sendButton.innerHTML = '<i class="fas fa-stop"></i> <span class="hide-on-mobile">Stop</span>';
            } else {
                sendButton.disabled = this.value.trim() === '' && attachedFiles.length === 0;
                sendButton.classList.remove('stop-button');
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> <span class="hide-on-mobile">Send</span>';
            }
            const text = this.value.trim();
            if (text.length > 0) {
                const lang = detectLanguage(text);
                showLanguageHint(lang);
            } else {
                hideLanguageHint();
            }
        });

        // Voice search functionality
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-IN,hi-IN,mr-IN,ta-IN,te-IN';
            
            recognition.onstart = function() {
                isListening = true;
                if (isInputMicrophoneActive) {
                    inputMicrophoneBtn.classList.add('listening');
                } else {
                    voiceSearchBtn.classList.add('listening');
                }
                document.getElementById('voiceInputStatus').classList.add('active');
                showToast('Listening... Speak now 🎤', 'info');
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                const voiceInputText = document.getElementById('voiceInputText');
                if (event.results[0].isFinal) {
                    userInput.value = transcript;
                    userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
                    voiceInputText.style.display = 'none';
                    const lang = detectLanguage(transcript);
                    showLanguageHint(lang);
                    sendButton.disabled = false;
                    if (transcript.split(' ').length <= 10) {
                        setTimeout(() => {
                            sendMessage();
                        }, 1000);
                    }
                } else {
                    voiceInputText.textContent = transcript;
                    voiceInputText.style.display = 'block';
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                isInputMicrophoneActive = false;
                inputMicrophoneBtn.classList.remove('listening');
                voiceSearchBtn.classList.remove('listening');
                document.getElementById('voiceInputStatus').classList.remove('active');
                if (event.error === 'not-allowed') {
                    showToast('Microphone access denied. Please allow microphone access. 🎤', 'error');
                } else {
                    showToast('Voice recognition failed. Please try again. ❌', 'error');
                }
            };
            
            recognition.onend = function() {
                isListening = false;
                isInputMicrophoneActive = false;
                inputMicrophoneBtn.classList.remove('listening');
                voiceSearchBtn.classList.remove('listening');
                document.getElementById('voiceInputStatus').classList.remove('active');
                document.getElementById('voiceInputText').style.display = 'none';
            };
            
            voiceSearchBtn.addEventListener('click', toggleVoiceRecognition);
            inputMicrophoneBtn.addEventListener('click', toggleInputVoiceRecognition);
        } else {
            voiceSearchBtn.style.display = 'none';
            inputMicrophoneBtn.style.display = 'none';
            showToast('Voice search not supported in your browser 🎤', 'warning');
        }

        // Theme toggle
        themeToggle.addEventListener('click', toggleTheme);
        
        // Sidebar toggle buttons
        if (sidebarToggle && sidebar && sidebarOverlay) {
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.add('active');
                sidebarOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
            
            sidebarClose.addEventListener('click', function() {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
            });
            
            sidebarOverlay.addEventListener('click', function() {
                sidebar.classList.remove('active');
                this.classList.remove('active');
                document.body.style.overflow = '';
            });
        }
        
        // Sidebar tab switching
        sidebarTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.dataset.tab;
                sidebarTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabId}-content`).classList.add('active');
                if (tabId === 'chat-history') {
                    loadHistoryList();
                }
            });
        });
        
        // New chat button
        if (newChatBtn) newChatBtn.addEventListener('click', createNewChat);
        if (clearChatBtn) clearChatBtn.addEventListener('click', clearCurrentChat);
        
        if (downloadCurrentBtn) {
            downloadCurrentBtn.addEventListener('click', () => {
                if (conversationHistory.length === 0) {
                    showToast('No chat content to download 📄', 'warning');
                    return;
                }
                openDownloadModal();
            });
        }
        
        if (suggestionsBtn) suggestionsBtn.addEventListener('click', showSuggestions);
        
        // Topic click handlers
        topicItems.forEach(item => {
            item.addEventListener('click', function() {
                const topic = this.dataset.topic;
                const topicName = this.querySelector('span').textContent;
                const isActive = this.classList.contains('active-tab');
                if (isActive) {
                    this.classList.remove('active-tab');
                    removeActiveTopic(topic);
                    clearTopicFileContent(topic);
                    showToast(`${topicName} tab closed ✖️`, 'info');
                } else {
                    this.classList.add('active-tab');
                    addActiveTopic(topic, topicName);
                    const questions = {
                        'contract': 'What are the essential elements of a valid contract under Indian law? ⚖️',
                        'employment': 'What are the rights of employees regarding workplace harassment in India? 💼',
                        'intellectual': 'How does copyright protection work for software in India? 🧠',
                        'realestate': 'What documents are required for property registration in India? 🏠',
                        'family': 'What are the grounds for divorce under Hindu Marriage Act? 👨‍👩‍👧',
                        'criminal': 'What is the difference between bailable and non-bailable offenses? ⚖️'
                    };
                    userInput.value = questions[topic] || `Tell me about ${topicName.toLowerCase()} in Indian law. ⚖️`;
                    userInput.focus();
                    userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
                    sendButton.disabled = false;
                    showToast(`${topicName} tab opened 📂`, 'success');
                }
                if (window.innerWidth < 1024) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        });
        
        // Action click handlers
        actionItems.forEach(item => {
            item.addEventListener('click', function() {
                const action = this.dataset.action;
                if (action === 'document-drafts') {
                    userInput.value = 'Create a non-disclosure agreement draft for me 📝';
                    userInput.focus();
                } else if (action === 'legal-research') {
                    userInput.value = 'Can you help me research case laws related to breach of contract? 🔍';
                    userInput.focus();
                } else if (action === 'case-analysis') {
                    userInput.value = 'Can you analyze the legal principles in landmark privacy law cases? 📊';
                    userInput.focus();
                }
                userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
                sendButton.disabled = false;
                if (window.innerWidth < 1024) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        });
        
        // Header login button click
        if (headerLoginBtn) {
            headerLoginBtn.addEventListener('click', function() {
                document.getElementById('loginModal').classList.add('active');
            });
        }
        
        // Back to home button
        if (backToHomeBtn) backToHomeBtn.addEventListener('click', goBackToHome);
        
        // User profile click
        if (userProfile) userProfile.addEventListener('click', toggleUserDropdown);
        
        // Logout button
        if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('chatUserDropdown');
            const profile = document.getElementById('chatUserProfile');
            if (dropdown && dropdown.classList.contains('active') && 
                !dropdown.contains(event.target) && 
                profile && !profile.contains(event.target)) {
                dropdown.classList.remove('active');
            }
            const isMobile = window.innerWidth < 1024;
            if (isMobile && sidebar && sidebar.classList.contains('active') && 
                !sidebar.contains(event.target) && 
                sidebarToggle && !sidebarToggle.contains(event.target)) {
                sidebar.classList.remove('active');
                if (sidebarOverlay) sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }
            const emojiPicker = document.getElementById('emojiPicker');
            const emojiBtn = document.getElementById('emojiPickerBtn');
            if (emojiPicker && emojiPicker.style.display === 'block' &&
                !emojiPicker.contains(event.target) && 
                emojiBtn && !emojiBtn.contains(event.target)) {
                emojiPicker.style.display = 'none';
            }
        });
        
        // Focus input on load
        setTimeout(() => {
            if (userInput) userInput.focus();
        }, 300);
        
        // Adjust textarea height on page load
        setTimeout(() => {
            if (userInput) {
                userInput.style.height = 'auto';
                userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
            }
        }, 100);
        
        // Initialize scroll to bottom button
        const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
        if (scrollToBottomBtn) {
            scrollToBottomBtn.addEventListener('click', scrollToBottom);
        }
        
        // FIXED: Monitor scroll position with corrected calculation
        if (chatMessages) {
            chatMessages.addEventListener('scroll', checkScrollPosition);
            setTimeout(checkScrollPosition, 500);
            const observer = new MutationObserver(checkScrollPosition);
            observer.observe(chatMessages, { childList: true, subtree: true });
        }
        
        // Initialize send button state
        if (sendButton) {
            sendButton.disabled = userInput.value.trim() === '' && attachedFiles.length === 0;
        }
        
        // Adjust chat layout
        setTimeout(adjustChatLayout, 100);
        
        // File upload functionality
        if (attachmentBtn) attachmentBtn.addEventListener('click', openFileUploadModal);
        
        // Download notification close
        const closeDownloadNotification = document.getElementById('closeDownloadNotification');
        if (closeDownloadNotification) {
            closeDownloadNotification.addEventListener('click', function() {
                document.getElementById('downloadNotification').classList.remove('show');
            });
        }
        
        // Download notification click to open file
        const downloadNotification = document.getElementById('downloadNotification');
        if (downloadNotification) {
            downloadNotification.addEventListener('click', function() {
                if (lastDownloadedFileUrl) {
                    window.open(lastDownloadedFileUrl, '_blank');
                    this.classList.remove('show');
                }
            });
        }
        
        console.log("Chat app initialized successfully");
        chatInitialized = true;
        
    } catch (error) {
        console.error("Error initializing chat app:", error);
    }
}

// FIXED: Check scroll position with corrected calculation
function checkScrollPosition() {
    const chatMessages = document.getElementById('chatMessages');
    const scrollBtn = document.getElementById('scrollToBottomBtn');
    const indicator = document.getElementById('scrollPositionIndicator');
    
    if (!chatMessages || !scrollBtn || !indicator) return;
    
    // Corrected calculation
    const scrollBottom = chatMessages.scrollHeight - chatMessages.clientHeight;
    const currentScroll = chatMessages.scrollTop;
    const isAtBottom = Math.abs(scrollBottom - currentScroll) < 10; // 10px tolerance
    
    if (!isAtBottom) {
        scrollBtn.classList.add('visible');
        if (currentScroll < scrollPosition) {
            indicator.classList.add('visible');
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 2000);
        }
    } else {
        scrollBtn.classList.remove('visible');
        indicator.classList.remove('visible');
    }
    scrollPosition = currentScroll;
}

// Show download notification
function showDownloadNotification(fileName, fileType) {
    const notification = document.getElementById('downloadNotification');
    if (!notification) return;
    
    const title = document.getElementById('downloadNotificationTitle');
    const message = document.getElementById('downloadNotificationMessage');
    
    if (title) title.textContent = `${fileType} Downloaded 📥`;
    if (message) message.textContent = `Click to open ${fileName}`;
    
    notification.classList.add('show');
    setTimeout(() => {
        notification.classList.remove('show');
    }, 5000);
}

// Add active topic to sidebar
function addActiveTopic(topicId, topicName) {
    const existingIndex = activeLegalTopics.findIndex(t => t.id === topicId);
    if (existingIndex !== -1) return;
    
    activeLegalTopics.push({
        id: topicId,
        name: topicName,
        timestamp: new Date().toISOString()
    });
    
    updateActiveTopicsUI();
}

// Remove active topic from sidebar
function removeActiveTopic(topicId) {
    activeLegalTopics = activeLegalTopics.filter(t => t.id !== topicId);
    updateActiveTopicsUI();
}

// Update active topics UI in sidebar
function updateActiveTopicsUI() {
    const activeTopicsSection = document.getElementById('activeTopicsSection');
    const activeTopicsList = document.getElementById('activeTopicsList');
    
    if (!activeTopicsSection || !activeTopicsList) return;
    
    if (activeLegalTopics.length === 0) {
        activeTopicsSection.style.display = 'none';
        return;
    }
    
    activeTopicsSection.style.display = 'block';
    activeTopicsList.innerHTML = '';
    
    activeLegalTopics.forEach(topic => {
        const topicItem = document.createElement('div');
        topicItem.className = 'topic-item active-tab';
        topicItem.innerHTML = `
            <i class="fas fa-folder-open"></i>
            <span>${topic.name}</span>
        `;
        
        topicItem.addEventListener('click', function(e) {
            e.stopPropagation();
            const originalTopic = document.querySelector(`.topic-item[data-topic="${topic.id}"]`);
            if (originalTopic) {
                originalTopic.click();
            }
        });
        
        activeTopicsList.appendChild(topicItem);
    });
}

// Clear file content display for a specific topic
function clearTopicFileContent(topicId) {
    const fileContents = document.querySelectorAll(`.file-content-display[data-topic="${topicId}"]`);
    fileContents.forEach(content => {
        content.remove();
    });
}

// Load current chat messages
function loadCurrentChatMessages() {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    chatMessages.innerHTML = '';
    
    if (conversationHistory.length === 0) {
        const welcomeContainer = document.createElement('div');
        welcomeContainer.innerHTML = WELCOME_MESSAGE_HTML;
        chatMessages.appendChild(welcomeContainer);
        addDraftTemplateListeners();
        return;
    }
    
    conversationHistory.forEach(msg => {
        const isDocument = msg.isDocument || false;
        const hasSources = msg.sources && msg.sources.length > 0;
        addMessageToChat(msg.content, msg.role === 'user', true, isDocument, msg.attachments || [], hasSources ? msg.sources : null);
    });
    
    setTimeout(addCopyEditButtonsToUserMessages, 100);
}

// Add draft template listeners
function addDraftTemplateListeners() {
    const draftTemplates = document.querySelectorAll('.draft-template');
    draftTemplates.forEach(template => {
        template.addEventListener('click', function() {
            const templateType = this.dataset.template;
            let requestText = '';
            
            switch(templateType) {
                case 'nda':
                    requestText = 'Create a comprehensive non-disclosure agreement for Indian business use 🤝';
                    break;
                case 'employment':
                    requestText = 'Draft an employment contract template for Indian companies 💼';
                    break;
                case 'rental':
                    requestText = 'Create a rental/tenancy agreement for residential property in India 🏠';
                    break;
                case 'loan':
                    requestText = 'Draft a loan agreement template for personal lending in India 💰';
                    break;
            }
            
            const userInput = document.getElementById('userInput');
            if (userInput) {
                userInput.value = requestText;
                userInput.focus();
                userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
                
                const sendButton = document.getElementById('sendButton');
                if (sendButton) {
                    sendButton.disabled = false;
                }
                
                setTimeout(() => {
                    sendMessage();
                }, 1000);
            }
        });
    });
}

// FIXED: Send message function
async function sendMessage() {
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    
    if (!userInput || !sendButton) return;
    
    const message = userInput.value.trim();
    
    if (!message && attachedFiles.length === 0) {
        showToast('Please enter a message or attach a file 📝', 'warning');
        return;
    }
    
    if (!isLoggedIn && searchCount >= MAX_FREE_SEARCHES) {
        showToast(`You've used ${MAX_FREE_SEARCHES} free searches today. Please wait until tomorrow or clear local data to reset counter. ⏰`, 'warning');
        return;
    }
    
    if (isListening && recognition) {
        recognition.stop();
    }
    
    let detectedLanguage = 'english';
    if (message) {
        detectedLanguage = detectLanguage(message);
        hideLanguageHint();
    }
    
    const messageId = addMessageToChat(message, true, false, false, attachedFiles);
    userInput.value = '';
    userInput.style.height = '52px';
    
    sendButton.disabled = false;
    sendButton.classList.add('stop-button');
    sendButton.innerHTML = '<i class="fas fa-stop"></i> <span class="hide-on-mobile">Stop</span>';
    
    isStreamingActive = true;
    stopStreamingRequested = false;
    clearAttachments();
    
    try {
        const userMessage = {
            role: 'user',
            content: message,
            language: detectedLanguage,
            attachments: [...attachedFiles],
            timestamp: new Date().toISOString()
        };
        
        conversationHistory.push(userMessage);
        
        if (!isLoggedIn) {
            searchCount++;
            saveSearchCounter();
            updateSearchCounterDisplay();
            
            const remaining = MAX_FREE_SEARCHES - searchCount;
            if (remaining === 50) {
                showToast(`You have ${remaining} free searches remaining. ⚠️`, 'warning');
            } else if (remaining === 10) {
                showToast(`Only ${remaining} free searches left! ⚠️`, 'warning');
            } else if (remaining === 0) {
                showToast(`Daily limit reached! You've used ${MAX_FREE_SEARCHES} searches today. ⏰`, 'warning');
            }
        }
        
        let fileContents = '';
        if (attachedFiles.length > 0) {
            for (const file of attachedFiles) {
                const content = await readFileContent(file);
                if (content) {
                    fileContents += `\n\n[Content from ${file.name}]:\n${content.substring(0, 2000)}${content.length > 2000 ? '... (truncated)' : ''}`;
                }
            }
        }
        
        const fullMessage = message + fileContents;
        
        // Backend API call
        const backendUrl = 'https://legal-swami-backend.onrender.com';
        const userId = currentUser ? currentUser.id : 'guest_' + Date.now();
        
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            const response = await fetch(backendUrl + '/api/v1/chat/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-user-id': userId,
                    'x-request-id': 'req_' + Date.now(),
                    'x-language': detectedLanguage
                },
                body: JSON.stringify({
                    message: fullMessage,
                    generateDocument: isDocumentRequest(message),
                    language: detectedLanguage
                }),
                signal: controller.signal
            }).finally(() => clearTimeout(timeoutId));
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${await response.text()}`);
            }
            
            const data = await response.json();
            
            if (stopStreamingRequested) {
                console.log('Streaming was stopped, not processing response');
                return;
            }
            
            const sourcesData = extractSourcesFromResponse(data.response || data.content || '');
            const aiMessage = {
                role: 'assistant',
                content: data.response || data.content || '',
                language: detectedLanguage,
                isDocument: isDocumentRequest(message),
                sources: sourcesData.sources,
                timestamp: new Date().toISOString()
            };
            
            conversationHistory.push(aiMessage);
            const aiMessageId = createStreamingMessage();
            startStreamingResponse(aiMessageId, aiMessage.content, isDocumentRequest(message));
            
            setTimeout(() => {
                if (sourcesData && sourcesData.hasSources) {
                    addResponseSources(aiMessageId, sourcesData);
                }
            }, 500);
            
        } catch (error) {
            console.error('Backend API failed, using mock response:', error);
            // Use mock response
            const mockResponse = await generateMockResponse(fullMessage);
            const sourcesData = extractSourcesFromResponse(mockResponse.response || mockResponse.content || '');
            const aiMessage = {
                role: 'assistant',
                content: mockResponse.response || mockResponse.content || '',
                language: detectedLanguage,
                isDocument: mockResponse.isDocument,
                sources: sourcesData.sources,
                timestamp: new Date().toISOString()
            };
            
            conversationHistory.push(aiMessage);
            const aiMessageId = createStreamingMessage();
            startStreamingResponse(aiMessageId, aiMessage.content, mockResponse.isDocument);
        }
        
        // Save chat to backend if logged in
        if (isLoggedIn && currentUser) {
            try {
                await fetch(backendUrl + '/api/v1/chat/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-id': currentUser.id,
                        'x-token': userToken || ''
                    },
                    body: JSON.stringify({
                        chatId: currentChatId,
                        messages: conversationHistory,
                        title: conversationHistory[0]?.content?.substring(0, 30) || 'New Chat'
                    })
                });
            } catch (error) {
                console.error('Failed to save chat to backend:', error);
            }
        }
        
    } catch (error) {
        console.error('AI Service Error:', error);
        const errorMessage = "I apologize for the inconvenience. I'm currently experiencing technical difficulties. Please try again in a moment. ⚠️";
        addMessageToChat(errorMessage, false);
        conversationHistory.push({
            role: 'assistant',
            content: errorMessage,
            language: 'english',
            timestamp: new Date().toISOString()
        });
        showToast('Service temporarily unavailable ⚠️', 'warning');
    } finally {
        if (sendButton) {
            sendButton.disabled = userInput.value.trim() === '' && attachedFiles.length === 0;
            sendButton.classList.remove('stop-button');
            sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> <span class="hide-on-mobile">Send</span>';
        }
        
        isStreamingActive = false;
        
        if (userInput) {
            userInput.focus();
        }
        
        setTimeout(adjustChatLayout, 100);
        setTimeout(addCopyEditButtonsToUserMessages, 100);
        saveCurrentChat();
    }
}

// Stop streaming function
function stopStreaming() {
    stopStreamingRequested = true;
    isStreamingActive = false;
    isStreamingPaused = false;
    
    const sendButton = document.getElementById('sendButton');
    const userInput = document.getElementById('userInput');
    
    if (sendButton && userInput) {
        sendButton.disabled = userInput.value.trim() === '' && attachedFiles.length === 0;
        sendButton.classList.remove('stop-button');
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> <span class="hide-on-mobile">Send</span>';
    }
    
    if (currentStreamingMessageId) {
        const messageDiv = document.getElementById(currentStreamingMessageId);
        if (messageDiv) {
            const messageText = messageDiv.querySelector('.message-text');
            const streamControls = messageDiv.querySelector('.stream-controls');
            
            if (streamControls) {
                streamControls.remove();
            }
            
            const messageActions = document.createElement('div');
            messageActions.className = 'message-actions';
            messageActions.innerHTML = `
                <button class="action-btn copy" onclick="copyMessage(this)" title="Copy response">
                    <i class="fas fa-copy"></i> Copy
                </button>
                <button class="action-btn regenerate" onclick="regenerateResponse('${currentStreamingMessageId}')" title="Regenerate response">
                    <i class="fas fa-sync-alt"></i> Regenerate
                </button>
                <button class="action-btn like" onclick="likeMessage(this)" title="Mark as helpful">
                    <i class="far fa-thumbs-up"></i> Helpful
                </button>
                <button class="action-btn dislike" onclick="dislikeMessage(this)" title="Mark as not helpful">
                    <i class="far fa-thumbs-down"></i> Not Helpful
                </button>
                <button class="action-btn share" onclick="shareResponse('${currentStreamingMessageId}')" title="Share response">
                    <i class="fas fa-share"></i> Share
                </button>
                <button class="action-btn document" onclick="downloadThisMessage('${currentStreamingMessageId}')" title="Download document">
                    <i class="fas fa-file-download"></i> Download
                </button>
            `;
            
            if (messageText && messageText.parentElement) {
                messageText.parentElement.appendChild(messageActions);
            }
            
            const cursor = messageText ? messageText.querySelector('.streaming-cursor') : null;
            if (cursor) cursor.remove();
            
            const pausedIndicator = messageText ? messageText.querySelector('.paused-indicator') : null;
            if (pausedIndicator) pausedIndicator.remove();
            
            if (messageText) {
                if (isDocumentRequest(currentStreamingContent)) {
                    messageText.innerHTML = formatDocumentResponse(currentStreamingContent);
                    addDocumentDownloadButton(currentStreamingMessageId, currentStreamingContent);
                } else {
                    messageText.innerHTML = formatLegalResponse(currentStreamingContent);
                }
            }
        }
        
        currentStreamingMessageId = null;
        currentStreamingContent = '';
        currentStreamingBuffer = '';
        streamingTextChunks = [];
        streamingTextIndex = 0;
    }
    
    showToast('Response stopped ⏹️', 'info');
}

// Read file content
async function readFileContent(file) {
    return new Promise((resolve, reject) => {
        if (file.type.startsWith('image/')) {
            resolve(`[Image file: ${file.name}. Size: ${(file.size / 1024).toFixed(2)} KB]`);
        } else if (file.type === 'application/pdf') {
            resolve(`[PDF file: ${file.name}. Size: ${(file.size / 1024).toFixed(2)} KB. Content preview not available in browser.]`);
        } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                resolve(e.target.result);
            };
            reader.onerror = reject;
            reader.readAsText(file.file);
        } else if (file.type.includes('document') || file.name.endsWith('.doc') || file.name.endsWith('.docx')) {
            resolve(`[Document file: ${file.name}. Size: ${(file.size / 1024).toFixed(2)} KB. Content preview not available in browser.]`);
        } else {
            resolve(`[File: ${file.name}. Type: ${file.type}. Size: ${(file.size / 1024).toFixed(2)} KB]`);
        }
    });
}

// Extract ONLY sources from AI response (NO SUMMARY)
function extractSourcesFromResponse(response) {
    const sources = [];
    const indianActsPatterns = [
        /(Indian Contract Act,?\s*1872)/gi,
        /(Indian Penal Code,?\s*1860)/gi,
        /(Code of Civil Procedure,?\s*1908)/gi,
        /(Code of Criminal Procedure,?\s*1973)/gi,
        /(Constitution of India)/gi,
        /(Evidence Act,?\s*1872)/gi,
        /(Specific Relief Act,?\s*1963)/gi,
        /(Transfer of Property Act,?\s*1882)/gi,
        /(Hindu Marriage Act,?\s*1955)/gi,
        /(Hindu Succession Act,?\s*1956)/gi,
        /(Companies Act,?\s*2013)/gi,
        /(Consumer Protection Act,?\s*2019)/gi,
        /(Information Technology Act,?\s*2000)/gi,
        /(Right to Information Act,?\s*2005)/gi,
        /(Arbitration and Conciliation Act,?\s*1996)/gi,
        /(Protection of Children from Sexual Offences Act,?\s*2012)/gi,
        /(Motor Vehicles Act,?\s*1988)/gi,
        /(Negotiable Instruments Act,?\s*1881)/gi,
        /(Sale of Goods Act,?\s*1930)/gi,
        /(Partnership Act,?\s*1932)/gi
    ];
    
    const caseLawPatterns = [
        /([A-Z][a-z]+\s+v\.\s+[A-Z][a-z]+)/g,
        /(AIR\s+\d{4}\s+(?:SC|Bom|Del|Cal|Mad|Ker|Guj|Raj|All|Pat|Ori|MP|AP|HP|P&H|J&K|Kar)\s+\d+)/gi,
        /(SCC\s+\d+)/gi,
        /((\d+)\s+SCC\s+\d+)/gi,
        /(SCR\s+\d+)/gi,
        /((\d+)\s+SCR\s+\d+)/gi,
        /(JT\s+\d+)/gi,
        /((\d+)\s+JT\s+\d+)/gi
    ];
    
    const sectionPatterns = [
        /(Section\s+\d+[A-Z]?)/gi,
        /(Article\s+\d+)/gi,
        /(Rule\s+\d+)/gi,
        /(Regulation\s+\d+)/gi,
        /(Clause\s+\d+)/gi,
        /(Schedule\s+[IVXLCDM]+)/gi
    ];
    
    indianActsPatterns.forEach(pattern => {
        const matches = response.match(pattern);
        if (matches) {
            matches.forEach(match => {
                const formatted = match.replace(/,?\s*(\d{4})/, ', $1');
                if (!sources.some(s => s.toLowerCase() === formatted.toLowerCase())) {
                    sources.push(formatted);
                }
            });
        }
    });
    
    caseLawPatterns.forEach(pattern => {
        const matches = response.match(pattern);
        if (matches) {
            matches.forEach(match => {
                if (!sources.some(s => s.toLowerCase() === match.toLowerCase())) {
                    sources.push(match);
                }
            });
        }
    });
    
    sectionPatterns.forEach(pattern => {
        const matches = response.match(pattern);
        if (matches) {
            matches.forEach(match => {
                if (!sources.some(s => s.toLowerCase() === match.toLowerCase())) {
                    sources.push(match);
                }
            });
        }
    });
    
    const uniqueSources = [];
    const seen = new Set();
    sources.forEach(source => {
        const lower = source.toLowerCase();
        if (!seen.has(lower)) {
            seen.add(lower);
            uniqueSources.push(source);
        }
    });
    
    return {
        sources: uniqueSources.slice(0, 8),
        hasSources: uniqueSources.length > 0
    };
}

// Show ONLY sources after response
function addResponseSources(messageId, sourcesData) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv || !sourcesData || !sourcesData.hasSources) return;
    
    const checkStreaming = setInterval(() => {
        const isStillStreaming = currentStreamingMessageId === messageId;
        const messageText = messageDiv.querySelector('.message-text');
        const hasStreamingCursor = messageText && messageText.querySelector('.streaming-cursor');
        
        if (!isStillStreaming && !hasStreamingCursor) {
            clearInterval(checkStreaming);
            
            const sourcesContainer = document.createElement('div');
            sourcesContainer.className = 'sources-container';
            
            let sourcesHTML = '';
            if (sourcesData.sources && sourcesData.sources.length > 0) {
                sourcesHTML = `
                    <div class="sources-header">
                        <i class="fas fa-gavel"></i>
                        <span>Legal Sources & References ⚖️</span>
                    </div>
                    <div class="sources-list">
                        ${sourcesData.sources.map(source => `
                            <div class="source-tag" title="${source}">
                                <i class="fas fa-bookmark"></i>
                                <span>${source.length > 40 ? source.substring(0, 40) + '...' : source}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="sources-info">
                        <i class="fas fa-info-circle"></i>
                        Sources extracted from the AI response above 📚
                    </div>
                `;
                sourcesContainer.innerHTML = sourcesHTML;
                messageDiv.parentNode.insertBefore(sourcesContainer, messageDiv.nextSibling);
                setTimeout(() => {
                    sourcesContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 300);
                const aiMessageIndex = conversationHistory.findIndex(msg => 
                    msg.role === 'assistant' && msg.content && msg.content.includes(messageDiv.querySelector('.message-text').textContent.substring(0, 100))
                );
                if (aiMessageIndex !== -1) {
                    conversationHistory[aiMessageIndex].sources = sourcesData.sources;
                    saveCurrentChat();
                }
            }
        }
    }, 100);
    setTimeout(() => clearInterval(checkStreaming), 10000);
}

// Save current chat to history
function saveCurrentChat() {
    if (!currentChatId || conversationHistory.length === 0) return;
    const chatIndex = chatHistory.findIndex(chat => chat.id === currentChatId);
    let title = 'New Chat';
    let preview = 'No messages yet';
    if (conversationHistory.length > 0) {
        const firstUserMessage = conversationHistory.find(msg => msg.role === 'user');
        if (firstUserMessage) {
            title = firstUserMessage.content.substring(0, 30);
            if (firstUserMessage.content.length > 30) {
                title += '...';
            }
        }
        const lastMessage = conversationHistory[conversationHistory.length - 1];
        if (lastMessage) {
            preview = lastMessage.content.substring(0, 50);
            if (lastMessage.content.length > 50) {
                preview += '...';
            }
        }
    }
    const chatData = {
        id: currentChatId,
        title: title,
        preview: preview,
        date: new Date().toISOString(),
        messages: [...conversationHistory],
        userId: 'guest'
    };
    if (chatIndex !== -1) {
        chatHistory[chatIndex] = chatData;
    } else {
        chatHistory.unshift(chatData);
    }
    saveUserChatHistory();
}

// Check if user is asking for document
function isDocumentRequest(message) {
    if (!message) return false;
    const docKeywords = [
        'draft', 'template', 'format', 'document', 'agreement', 
        'contract', 'nda', 'non disclosure', 'employment', 
        'rental', 'loan', 'will', 'testament', 'legal document',
        'ready made', 'sample', 'example', 'form', 'प्रारूप',
        'मसौदा', 'दस्तावेज़', 'समझौता', 'अनुबंध', 'करार',
        'ड्राफ्ट', 'टेम्पलेट', 'फॉर्मेट', 'सैंपल', 'create',
        'generate', 'make', 'prepare', 'write'
    ];
    const lowerMessage = message.toLowerCase();
    return docKeywords.some(keyword => lowerMessage.includes(keyword));
}

// Enhanced language detection
function detectLanguage(text) {
    if (!text) return 'english';
    const hasNonEnglishScript = /[\u0900-\u097F\u0B80-\u0BFF\u0C00-\u0C7F\u0C80-\u0CFF\u0A00-\u0A7F\u0A80-\u0AFF\u0980-\u09FF]/.test(text);
    if (!hasNonEnglishScript) {
        const hindiMarathiWords = [
            /\bmujhe\b/i, /\btumhe\b/i, /\bhindi\b/i, /\bmarathi\b/i,
            /\bkya\b/i, /\bkyu\b/i, /\bkaise\b/i, /\bkab\b/i,
            /\bmala\b/i, /\bmahiti\b/i, /\bsahayata\b/i, /\bkich\b/i
        ];
        let hindiMarathiScore = 0;
        hindiMarathiWords.forEach(pattern => {
            if (pattern.test(text)) hindiMarathiScore++;
        });
        if (hindiMarathiScore >= 2) {
            if (/\bmala\b/i.test(text) || /\bmahiti\b/i.test(text) || /\bsahayata\b/i.test(text)) {
                return 'marathi';
            }
            if (/\bmujhe\b/i.test(text) || /\bkya\b/i.test(text) || /\bkyu\b/i.test(text)) {
                return 'hindi';
            }
        }
        return 'english';
    }
    if (/[\u0900-\u097F]/.test(text)) {
        let marathiScore = 0;
        let hindiScore = 0;
        const marathiWords = ['आहे', 'मी', 'तू', 'आपण', 'होय', 'नाही', 'मला', 'पाहिजे', 'कृपया', 'धन्यवाद', 'महाराष्ट्र', 'मराठी'];
        marathiWords.forEach(word => {
            if (text.includes(word)) marathiScore++;
        });
        const hindiWords = ['क्या', 'क्यों', 'कैसे', 'मुझे', 'तुम्हें', 'आप', 'है', 'हैं', 'हिन्दी', 'भारत'];
        hindiWords.forEach(word => {
            if (text.includes(word)) hindiScore++;
        });
        if (marathiScore > hindiScore) {
            return 'marathi';
        } else if (hindiScore > 0) {
            return 'hindi';
        }
        return 'hindi';
    }
    if (/[\u0B80-\u0BFF]/.test(text)) return 'tamil';
    if (/[\u0C00-\u0C7F]/.test(text)) return 'telugu';
    if (/[\u0C80-\u0CFF]/.test(text)) return 'kannada';
    if (/[\u0A00-\u0A7F]/.test(text)) return 'punjabi';
    if (/[\u0A80-\u0AFF]/.test(text)) return 'gujarati';
    if (/[\u0980-\u09FF]/.test(text)) return 'bengali';
    return 'english';
}

// Add message to chat with sources parameter
function addMessageToChat(content, isUser, fromHistory = false, isDocument = false, attachments = [], sources = null) {
    const chatMessages = document.getElementById('chatMessages');
    if (!fromHistory && isUser) {
        const welcomeMessage = document.querySelector('.welcome-message');
        if (welcomeMessage) {
            welcomeMessage.remove();
        }
    }
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
    const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    messageDiv.id = messageId;
    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    if (isUser) {
        if (currentUser && currentUser.picture) {
            avatar.innerHTML = `<img src="${currentUser.picture}" alt="${currentUser.name}" style="width: 100%; height: 100%; border-radius: 8px;">`;
        } else {
            avatar.innerHTML = '<i class="fas fa-user"></i>';
        }
    } else {
        avatar.innerHTML = '<i class="fas fa-scale-balanced"></i>';
        avatar.style.background = 'linear-gradient(135deg, var(--secondary) 0%, #5e35b1 100%)';
    }
    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';
    const messageText = document.createElement('div');
    messageText.className = 'message-text';
    if (isUser) {
        if (content) {
            messageText.innerHTML = content.replace(/\n/g, '<br>');
        }
        if (attachments && attachments.length > 0) {
            messageDiv.dataset.attachments = JSON.stringify(attachments.map(file => ({
                name: file.name,
                data: file.data,
                type: file.type
            })));
        }
        if (!fromHistory) {
            const controlsContainer = document.createElement('div');
            controlsContainer.className = 'user-message-controls';
            controlsContainer.innerHTML = `
                <button class="user-message-btn copy-btn" onclick="copyUserMessage('${messageId}')" title="Copy question">
                    <i class="fas fa-copy"></i>
                    <span class="hide-on-mobile">Copy</span>
                </button>
                <button class="user-message-btn edit-btn" onclick="editUserMessage('${messageId}')" title="Edit question">
                    <i class="fas fa-pencil-alt"></i>
                    <span class="hide-on-mobile">Edit</span>
                </button>
            `;
            messageContent.appendChild(controlsContainer);
        }
    } else {
        if (isDocument) {
            messageText.innerHTML = formatDocumentResponse(content);
        } else {
            messageText.innerHTML = formatLegalResponse(content);
        }
        if (sources && sources.length > 0 && !fromHistory) {
            setTimeout(() => {
                addResponseSources(messageId, { sources: sources, hasSources: true });
            }, 100);
        }
    }
    messageContent.appendChild(messageText);
    if (!isUser && !fromHistory) {
        const messageActions = document.createElement('div');
        messageActions.className = 'message-actions';
        messageActions.innerHTML = `
            <button class="action-btn copy" onclick="copyMessage(this)" title="Copy response">
                <i class="fas fa-copy"></i> Copy
            </button>
            <button class="action-btn regenerate" onclick="regenerateResponse('${messageId}')" title="Regenerate response">
                <i class="fas fa-sync-alt"></i> Regenerate
            </button>
            <button class="action-btn like" onclick="likeMessage(this)" title="Mark as helpful">
                <i class="far fa-thumbs-up"></i> Helpful
            </button>
            <button class="action-btn dislike" onclick="dislikeMessage(this)" title="Mark as not helpful">
                <i class="far fa-thumbs-down"></i> Not Helpful
            </button>
            <button class="action-btn share" onclick="shareResponse('${messageId}')" title="Share response">
                <i class="fas fa-share"></i> Share
            </button>
            <button class="action-btn document" onclick="downloadThisMessage('${messageId}')" title="Download document">
                <i class="fas fa-file-download"></i> Download
            </button>
        `;
        messageContent.appendChild(messageActions);
    }
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(messageContent);
    chatMessages.appendChild(messageDiv);
    if (isUser && attachments && attachments.length > 0) {
        showAttachedFilesBelowUserMessage(messageId, attachments);
    }
    setTimeout(checkScrollPosition, 100);
    return messageId;
}

// Show attached files with content preview
function showAttachedFilesBelowUserMessage(messageId, attachments) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv || !attachments || attachments.length === 0) return;
    const messageContent = messageDiv.querySelector('.message-content');
    attachments.forEach((attachment, index) => {
        const fileContainer = document.createElement('div');
        fileContainer.className = 'attachment-item';
        fileContainer.style.maxWidth = '280px';
        fileContainer.style.marginTop = '8px';
        if (attachment.type.startsWith('image/')) {
            fileContainer.innerHTML = `
                <img src="${attachment.data}" alt="${attachment.name}" class="attachment-image" style="max-height: 130px;">
                <div class="attachment-name">${attachment.name}</div>
            `;
        } else if (attachment.type === 'application/pdf' || attachment.name.endsWith('.pdf')) {
            fileContainer.innerHTML = `
                <div style="padding: 15px; text-align: center; background: var(--dark-surface-light);">
                    <i class="fas fa-file-pdf" style="font-size: 1.8rem; color: var(--error);"></i>
                    <div class="attachment-name">${attachment.name}</div>
                    <div style="font-size: 0.65rem; color: var(--dark-text-secondary);">PDF Document</div>
                </div>
            `;
        } else if (attachment.type === 'text/plain' || attachment.name.endsWith('.txt')) {
            fileContainer.innerHTML = `
                <div style="padding: 12px; background: var(--dark-surface-light); border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <i class="fas fa-file-alt" style="font-size: 1.3rem; color: var(--primary);"></i>
                        <div style="flex: 1;">
                            <div class="attachment-name">${attachment.name}</div>
                            <div style="font-size: 0.65rem; color: var(--dark-text-secondary);">Text Document</div>
                        </div>
                    </div>
                    <button class="action-btn" style="width: 100%; padding: 6px;" onclick="showFileContent('${attachment.data}', '${attachment.name.replace(/'/g, "\\'")}')">
                        <i class="fas fa-eye"></i> Preview Content
                    </button>
                </div>
            `;
        } else {
            fileContainer.innerHTML = `
                <div style="padding: 15px; text-align: center; background: var(--dark-surface-light);">
                    <i class="fas fa-file" style="font-size: 1.8rem; color: var(--dark-text-secondary);"></i>
                    <div class="attachment-name">${attachment.name}</div>
                    <div style="font-size: 0.65rem; color: var(--dark-text-secondary);">${attachment.type || 'File'}</div>
                </div>
            `;
        }
        const messageText = messageContent.querySelector('.message-text');
        messageContent.insertBefore(fileContainer, messageText.nextSibling);
    });
}

window.showFileContent = async function(dataUrl, fileName) {
    try {
        const response = await fetch(dataUrl);
        const text = await response.text();
        const contentDiv = document.createElement('div');
        contentDiv.className = 'file-content-display';
        contentDiv.innerHTML = `
            <div class="file-content-header">
                <div class="file-content-title">
                    <i class="fas fa-file-alt"></i>
                    <span>${fileName}</span>
                </div>
                <button class="file-content-close" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="max-height: 180px; overflow-y: auto; font-family: monospace; font-size: 0.75rem;">
                ${text.substring(0, 4000)}
                ${text.length > 4000 ? '<div style="color: var(--dark-text-secondary); margin-top: 8px;">... (content truncated)</div>' : ''}
            </div>
        `;
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.appendChild(contentDiv);
        setTimeout(() => {
            contentDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
    } catch (error) {
        console.error('Error reading file content:', error);
        showToast('Could not read file content 📄', 'error');
    }
};

// Regenerate response function
window.regenerateResponse = function(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    const allMessages = document.querySelectorAll('.message');
    let userMessageContent = '';
    let userMessageId = '';
    for (let i = 0; i < allMessages.length; i++) {
        if (allMessages[i].id === messageId) {
            for (let j = i - 1; j >= 0; j--) {
                if (allMessages[j].classList.contains('user-message')) {
                    const userMessageText = allMessages[j].querySelector('.message-text');
                    if (userMessageText) {
                        userMessageContent = userMessageText.textContent;
                        userMessageId = allMessages[j].id;
                    }
                    break;
                }
            }
            break;
        }
    }
    if (userMessageContent) {
        const aiMessageIndex = conversationHistory.findIndex((msg, idx) => 
            msg.role === 'assistant' && idx > 0 && conversationHistory[idx-1].content === userMessageContent
        );
        if (aiMessageIndex !== -1) {
            conversationHistory.splice(aiMessageIndex, 1);
        }
        messageDiv.remove();
        const userInput = document.getElementById('userInput');
        userInput.value = userMessageContent;
        userInput.focus();
        userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
        setTimeout(() => {
            sendMessage();
        }, 500);
        showToast('Regenerating response... 🔄', 'info');
    }
};

// Dislike message function
window.dislikeMessage = function(button) {
    button.innerHTML = '<i class="fas fa-thumbs-down"></i> Feedback Sent';
    button.style.background = 'var(--error)';
    button.style.borderColor = 'var(--error)';
    button.style.color = 'white';
    button.disabled = true;
    showToast('Thank you for your feedback! 👍', 'info');
};

// Share response function
window.shareResponse = function(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    const messageText = messageDiv.querySelector('.message-text');
    const textToShare = messageText.textContent;
    if (navigator.share) {
        navigator.share({
            title: 'LegalSwami AI Response ⚖️',
            text: textToShare.substring(0, 100) + '...',
            url: window.location.href
        }).then(() => {
            showToast('Response shared successfully! 📤', 'success');
        }).catch(err => {
            console.error('Share failed:', err);
            copyToClipboard(textToShare);
        });
    } else {
        copyToClipboard(textToShare);
    }
};

// Helper function to copy to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Response copied to clipboard! 📋', 'success');
    }).catch(err => {
        console.error('Copy failed:', err);
        showToast('Failed to copy response ❌', 'error');
    });
}

// Copy user message
window.copyUserMessage = function(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    const messageText = messageDiv.querySelector('.message-text');
    const textToCopy = messageText.textContent;
    navigator.clipboard.writeText(textToCopy).then(() => {
        showToast('Question copied to clipboard! 📋', 'success');
    }).catch(err => {
        console.error('Copy failed:', err);
        showToast('Failed to copy question ❌', 'error');
    });
};

// Edit user message
window.editUserMessage = function(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    const messageText = messageDiv.querySelector('.message-text');
    const content = messageText.textContent;
    const userInput = document.getElementById('userInput');
    userInput.value = content;
    userInput.focus();
    userInput.style.height = 'auto';
    userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
    document.getElementById('sendButton').disabled = false;
    showToast('Question loaded for editing. Press Ctrl+Enter to send. ✏️', 'info');
};

// Format document response
function formatDocumentResponse(text) {
    const documentContainer = document.createElement('div');
    documentContainer.className = 'document-template';
    const lines = text.split('\n');
    let htmlContent = '';
    lines.forEach(line => {
        if (line.trim() === '') return;
        if (line.toUpperCase() === line && line.length > 10 && !line.includes(':')) {
            htmlContent += `<div class="document-header">
                <h2 class="document-title">${line}</h2>
                <div class="document-subtitle">Legal Document Template ⚖️</div>
            </div>`;
        }
        else if (line.match(/^\d+\.\s+.+/) || line.match(/^[A-Z\s]+:$/)) {
            htmlContent += `<div class="document-section">
                <h3 class="document-section-title">${line}</h3>`;
        }
        else if (line.match(/^[a-z]\)\s+.+/)) {
            htmlContent += `<div class="document-clause">
                <div class="clause-title">${line}</div>`;
        }
        else {
            if (line.includes('___________________') || line.includes('________________')) {
                htmlContent += `<div class="clause-content" style="border-bottom: 1px solid var(--dark-border); padding-bottom: 4px; margin-bottom: 8px;">${line}</div>`;
            } else {
                htmlContent += `<div class="clause-content">${line}</div>`;
            }
        }
    });
    if (!text.includes('Signature') && !text.includes('Witness')) {
        htmlContent += `
            <div class="signature-section">
                <div class="signature-line">
                    <div class="signature-block">
                        <div class="signature-name"></div>
                        <div class="signature-label">Signature ✍️</div>
                    </div>
                    <div class="signature-block">
                        <div class="signature-name"></div>
                        <div class="signature-label">Date 📅</div>
                    </div>
                </div>
            </div>`;
    }
    htmlContent += `<div class="legal-note">
        <strong>Disclaimer:</strong> This template is for educational purposes only. Consult a qualified attorney before use. ⚖️
    </div>`;
    documentContainer.innerHTML = htmlContent;
    return documentContainer.outerHTML;
}

// Format legal response
function formatLegalResponse(text) {
    let formatted = text
        .replace(/## (.*?)\n/g, '<h3>$1</h3>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/- (.*?)\n/g, '<li>$1</li>')
        .replace(/\n/g, '<br>');
    formatted = formatted.replace(/(<li>.*?<\/li>)/gs, function(match) {
        return '<ul>' + match + '</ul>';
    });
    if (formatted.includes('Disclaimer') || formatted.includes('अस्वीकरण') || formatted.includes('सूचना')) {
        formatted = formatted.replace(/(Disclaimer:.*?|अस्वीकरण:.*?|सूचना:.*?)(?=<br><br>|$)/is, 
            '<div class="legal-note">$1</div>');
    }
    const container = document.createElement('div');
    container.className = 'legal-content';
    container.innerHTML = formatted;
    return container.outerHTML;
}

// Format text for streaming display
function formatStreamingText(text) {
    const container = document.createElement('div');
    container.innerHTML = text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
    return container.innerHTML;
}

// Create streaming message container
function createStreamingMessage() {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ai-message';
    const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    messageDiv.id = messageId;
    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.innerHTML = '<i class="fas fa-scale-balanced"></i>';
    avatar.style.background = 'linear-gradient(135deg, var(--secondary) 0%, #5e35b1 100%)';
    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';
    const messageText = document.createElement('div');
    messageText.className = 'message-text streaming-content';
    messageText.innerHTML = '<span class="streaming-cursor"></span>';
    messageContent.appendChild(messageText);
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(messageContent);
    chatMessages.appendChild(messageDiv);
    currentStreamingMessageId = messageId;
    currentStreamingContent = '';
    currentStreamingBuffer = '';
    streamingTextChunks = [];
    streamingTextIndex = 0;
    const streamControls = document.createElement('div');
    streamControls.className = 'stream-controls';
    streamControls.innerHTML = `
        <button class="stream-control-btn pause-btn" id="pause-${messageId}" onclick="toggleStreamPause('${messageId}')">
            <i class="fas fa-pause"></i> Pause
        </button>
        <button class="stream-control-btn copy-btn" onclick="copyStreamedContent('${messageId}')">
            <i class="fas fa-copy"></i> Copy
        </button>
    `;
    messageContent.appendChild(streamControls);
    setTimeout(checkScrollPosition, 100);
    return messageId;
}

// Start streaming response word by word
function startStreamingResponse(messageId, response, isDocument = false) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    let textToStream = response;
    streamingTextChunks = splitTextIntoChunks(textToStream);
    streamingTextIndex = 0;
    streamNextChunk(messageId, isDocument);
}

// Split text into chunks for streaming
function splitTextIntoChunks(text) {
    const chunks = [];
    const regex = /[\s.,;!?।।॥]+|\S+/g;
    let match;
    while ((match = regex.exec(text)) !== null) {
        chunks.push(match[0]);
    }
    return chunks;
}

// Stream next chunk of text
function streamNextChunk(messageId, isDocument = false) {
    if (stopStreamingRequested || streamingTextIndex >= streamingTextChunks.length) {
        if (stopStreamingRequested) {
            console.log('Streaming stopped by user');
        } else {
            finalizeStreamingMessage(messageId, isDocument);
        }
        return;
    }
    const chunk = streamingTextChunks[streamingTextIndex];
    streamingTextIndex++;
    updateStreamingMessage(messageId, chunk, isDocument);
    let delay = streamingWordDelay;
    if (chunk.match(/[.,;!?।।॥]/)) {
        delay += streamingPunctuationDelay;
    }
    if (chunk.match(/[.!?।।॥]/)) {
        delay += 150;
    }
    setTimeout(() => {
        if (!isStreamingPaused && !stopStreamingRequested) {
            streamNextChunk(messageId, isDocument);
        }
    }, delay);
}

// Toggle stream pause
window.toggleStreamPause = function(messageId) {
    isStreamingPaused = !isStreamingPaused;
    const pauseBtn = document.getElementById(`pause-${messageId}`);
    const messageDiv = document.getElementById(messageId);
    if (isStreamingPaused) {
        pauseBtn.innerHTML = '<i class="fas fa-play"></i> Continue';
        pauseBtn.style.background = 'var(--success)';
        pauseBtn.style.borderColor = 'var(--success)';
        pauseBtn.style.color = 'white';
        const messageText = messageDiv.querySelector('.message-text');
        const existingIndicator = messageText.querySelector('.paused-indicator');
        if (!existingIndicator) {
            const indicator = document.createElement('span');
            indicator.className = 'paused-indicator';
            indicator.textContent = 'Paused';
            messageText.appendChild(indicator);
        }
        showToast('Response paused ⏸️', 'info');
    } else {
        pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
        pauseBtn.style.background = '';
        pauseBtn.style.borderColor = '';
        pauseBtn.style.color = '';
        const messageText = messageDiv.querySelector('.message-text');
        const existingIndicator = messageText.querySelector('.paused-indicator');
        if (existingIndicator) {
            existingIndicator.remove();
        }
        setTimeout(() => {
            streamNextChunk(messageId, isDocumentRequest(currentStreamingContent));
        }, 100);
        showToast('Response continued ▶️', 'success');
    }
};

// Copy streamed content
window.copyStreamedContent = function(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    const messageText = messageDiv.querySelector('.message-text');
    const textToCopy = messageText.textContent.replace('Paused', '').trim();
    navigator.clipboard.writeText(textToCopy).then(() => {
        showToast('Copied to clipboard! 📋', 'success');
    }).catch(err => {
        console.error('Copy failed:', err);
        showToast('Failed to copy ❌', 'error');
    });
};

// Update streaming message with new content
function updateStreamingMessage(messageId, newContent, isDocument = false) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    const messageText = messageDiv.querySelector('.message-text');
    currentStreamingBuffer += newContent;
    currentStreamingContent += newContent;
    if (isDocument) {
        messageText.innerHTML = formatDocumentResponse(currentStreamingContent) + '<span class="streaming-cursor"></span>';
    } else {
        messageText.innerHTML = formatStreamingText(currentStreamingBuffer) + '<span class="streaming-cursor"></span>';
    }
    checkScrollPosition();
}

// Finalize streaming message
function finalizeStreamingMessage(messageId, isDocument = false) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    const messageText = messageDiv.querySelector('.message-text');
    const cursor = messageText.querySelector('.streaming-cursor');
    if (cursor) cursor.remove();
    const pausedIndicator = messageText.querySelector('.paused-indicator');
    if (pausedIndicator) pausedIndicator.remove();
    if (isDocument) {
        messageText.innerHTML = formatDocumentResponse(currentStreamingContent);
        addDocumentDownloadButton(messageId, currentStreamingContent);
    } else {
        messageText.innerHTML = formatLegalResponse(currentStreamingContent);
    }
    const messageActions = document.createElement('div');
    messageActions.className = 'message-actions';
    messageActions.innerHTML = `
        <button class="action-btn copy" onclick="copyMessage(this)" title="Copy response">
            <i class="fas fa-copy"></i> Copy
        </button>
        <button class="action-btn regenerate" onclick="regenerateResponse('${messageId}')" title="Regenerate response">
            <i class="fas fa-sync-alt"></i> Regenerate
        </button>
        <button class="action-btn like" onclick="likeMessage(this)" title="Mark as helpful">
            <i class="far fa-thumbs-up"></i> Helpful
        </button>
        <button class="action-btn dislike" onclick="dislikeMessage(this)" title="Mark as not helpful">
            <i class="far fa-thumbs-down"></i> Not Helpful
        </button>
        <button class="action-btn share" onclick="shareResponse('${messageId}')" title="Share response">
            <i class="fas fa-share"></i> Share
        </button>
        <button class="action-btn document" onclick="downloadThisMessage('${messageId}')" title="Download document">
            <i class="fas fa-file-download"></i> Download
        </button>
    `;
    messageText.parentElement.appendChild(messageActions);
    const streamControls = messageDiv.querySelector('.stream-controls');
    if (streamControls) {
        streamControls.remove();
    }
    if (attachedFiles.length > 0) {
        showAttachedFilesBelowResponse(messageId);
    }
    currentStreamingMessageId = null;
    currentStreamingContent = '';
    currentStreamingBuffer = '';
    streamingTextChunks = [];
    streamingTextIndex = 0;
    isStreamingPaused = false;
    isStreamingActive = false;
    stopStreamingRequested = false;
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = document.getElementById('userInput').value.trim() === '' && attachedFiles.length === 0;
    sendButton.classList.remove('stop-button');
    sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> <span class="hide-on-mobile">Send</span>';
}

// Show attached files below AI response
function showAttachedFilesBelowResponse(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv || attachedFiles.length === 0) return;
    const messageContent = messageDiv.querySelector('.message-content');
    const attachmentsContainer = document.createElement('div');
    attachmentsContainer.className = 'message-attachments';
    attachedFiles.forEach((attachment, index) => {
        const attachmentItem = document.createElement('div');
        attachmentItem.className = 'attachment-item';
        attachmentItem.innerHTML = `
            <img src="${attachment.data}" alt="${attachment.name}" class="attachment-image">
            <div class="attachment-name">${attachment.name}</div>
        `;
        attachmentsContainer.appendChild(attachmentItem);
    });
    const messageText = messageContent.querySelector('.message-text');
    messageContent.insertBefore(attachmentsContainer, messageText.nextSibling);
    clearAttachments();
}

// Add document download button to message
function addDocumentDownloadButton(messageId, content) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    const messageContent = messageDiv.querySelector('.message-content');
    const existingBtn = messageContent.querySelector('.document-download-btn');
    if (existingBtn) return;
    const downloadBtn = document.createElement('button');
    downloadBtn.className = 'document-download-btn';
    downloadBtn.innerHTML = '<i class="fas fa-file-download"></i> Download Document';
    downloadBtn.title = 'Download this document template';
    downloadBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        openMessageDownloadModal(content);
    });
    messageContent.appendChild(downloadBtn);
}

// Copy message function
window.copyMessage = function(button) {
    const messageText = button.closest('.message-content').querySelector('.message-text');
    let textToCopy = messageText.innerText || messageText.textContent;
    const textarea = document.createElement('textarea');
    textarea.value = textToCopy;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    textarea.setSelectionRange(0, 99999);
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showToast('Document copied to clipboard! 📋', 'success');
        } else {
            showToast('Failed to copy text ❌', 'error');
        }
    } catch (err) {
        console.error('Copy failed:', err);
        showToast('Failed to copy: ' + err, 'error');
    }
    document.body.removeChild(textarea);
};

// Like message function
window.likeMessage = function(button) {
    button.innerHTML = '<i class="fas fa-thumbs-up"></i> Thank you!';
    button.style.background = 'var(--success)';
    button.style.borderColor = 'var(--success)';
    button.style.color = 'white';
    button.disabled = true;
    showToast('Thank you for your feedback! 👍', 'success');
};

// Download this specific message
window.downloadThisMessage = function(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) return;
    const messageText = messageDiv.querySelector('.message-text');
    const content = messageText.innerText || messageText.textContent;
    openMessageDownloadModal(content);
};

// Clear current chat
function clearCurrentChat() {
    if (conversationHistory.length === 0 && attachedFiles.length === 0) {
        showToast('Chat is already empty 🗑️', 'warning');
        return;
    }
    if (confirm('Are you sure you want to clear the current chat?')) {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = '';
        conversationHistory = [];
        clearAttachments();
        createNewChat();
        showToast('Current chat cleared 🗑️', 'success');
    }
}

// Show suggestions
function showSuggestions() {
    const suggestions = [
        "Create a non-disclosure agreement draft 📝",
        "I need an employment contract template 💼",
        "Generate a rental agreement for me 🏠",
        "Draft a loan agreement document 💰",
        "What are the essential elements of a valid contract? ⚖️"
    ];
    addMessageToChat(
        `<h3>Suggested Questions:</h3>
        <ul>
            ${suggestions.map(q => `<li style="cursor: pointer; padding: 6px; border-radius: 6px; transition: background 0.3s;" 
                onmouseover="this.style.background='var(--dark-surface-light)'" 
                onmouseout="this.style.background='transparent'"
                onclick="document.getElementById('userInput').value = '${q}'; document.getElementById('userInput').focus(); document.getElementById('userInput').style.height = Math.min(document.getElementById('userInput').scrollHeight, 180) + 'px'; document.getElementById('sendButton').disabled = false;">
                ${q}
            </li>`).join('')}
        </ul>
        <p>Click any question to add it to the input field. 👆</p>`,
        false
    );
}

// Scroll to bottom function
function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.scrollTo({
            top: chatMessages.scrollHeight,
            behavior: 'smooth'
        });
        document.getElementById('scrollToBottomBtn').classList.remove('visible');
    }
}

// Add copy and edit buttons to user messages
function addCopyEditButtonsToUserMessages() {
    const userMessages = document.querySelectorAll('.user-message:not(.from-history) .message-content');
    userMessages.forEach((messageContent, index) => {
        if (!messageContent.querySelector('.user-message-controls')) {
            const messageDiv = messageContent.closest('.message');
            const messageId = messageDiv.id;
            const messageText = messageContent.querySelector('.message-text');
            if (messageText && messageText.textContent.trim()) {
                const controlsContainer = document.createElement('div');
                controlsContainer.className = 'user-message-controls';
                const copyBtn = document.createElement('button');
                copyBtn.className = 'user-message-btn copy-btn';
                copyBtn.title = 'Copy question';
                copyBtn.innerHTML = '<i class="fas fa-copy"></i><span class="hide-on-mobile">Copy</span>';
                copyBtn.addEventListener('click', () => copyUserMessage(messageId));
                const editBtn = document.createElement('button');
                editBtn.className = 'user-message-btn edit-btn';
                editBtn.title = 'Edit question';
                editBtn.innerHTML = '<i class="fas fa-pencil-alt"></i><span class="hide-on-mobile">Edit</span>';
                editBtn.addEventListener('click', () => editUserMessage(messageId));
                controlsContainer.appendChild(copyBtn);
                controlsContainer.appendChild(editBtn);
                messageContent.appendChild(controlsContainer);
            }
        }
    });
}

function loadThemePreference() {
    const savedTheme = localStorage.getItem('legalSwamiTheme');
    if (savedTheme === 'light') {
        document.body.classList.add('light-mode');
        document.querySelector('.theme-toggle i').className = 'fas fa-moon';
        isLightMode = true;
    }
}

function toggleTheme() {
    const themeIcon = document.querySelector('.theme-toggle i');
    if (isLightMode) {
        document.body.classList.remove('light-mode');
        themeIcon.className = 'fas fa-sun';
        localStorage.setItem('legalSwamiTheme', 'dark');
        isLightMode = false;
    } else {
        document.body.classList.add('light-mode');
        themeIcon.className = 'fas fa-moon';
        localStorage.setItem('legalSwamiTheme', 'light');
        isLightMode = true;
    }
    const emojiPicker = document.getElementById('emojiPicker');
    if (emojiPicker) {
        emojiPicker.setAttribute('class', isLightMode ? 'light' : 'dark');
    }
}

function createNewChat() {
    currentChatId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    conversationHistory = [];
    const chatMessages = document.getElementById('chatMessages');
    const welcomeContainer = document.createElement('div');
    welcomeContainer.innerHTML = WELCOME_MESSAGE_HTML;
    chatMessages.innerHTML = '';
    chatMessages.appendChild(welcomeContainer);
    addDraftTemplateListeners();
    clearAttachments();
    loadHistoryList();
    showToast('New chat started 💬', 'success');
}

function toggleVoiceRecognition() {
    if (!recognition) return;
    if (isListening && !isInputMicrophoneActive) {
        recognition.stop();
    } else {
        isInputMicrophoneActive = false;
        recognition.start();
    }
}

function toggleInputVoiceRecognition() {
    if (!recognition) return;
    if (isListening && isInputMicrophoneActive) {
        recognition.stop();
    } else {
        isInputMicrophoneActive = true;
        recognition.start();
    }
}

// Show language hint
function showLanguageHint(language) {
    const languageNames = {
        'english': 'English 🇬🇧',
        'hindi': 'Hindi 🇮🇳',
        'marathi': 'Marathi 🇮🇳',
        'tamil': 'Tamil 🇮🇳',
        'telugu': 'Telugu 🇮🇳',
        'kannada': 'Kannada 🇮🇳',
        'punjabi': 'Punjabi 🇮🇳',
        'gujarati': 'Gujarati 🇮🇳',
        'bengali': 'Bengali 🇮🇳'
    };
    let hintElement = document.querySelector('.language-hint');
    if (!hintElement) {
        hintElement = document.createElement('div');
        hintElement.className = 'language-hint';
        document.querySelector('.input-area').appendChild(hintElement);
    }
    hintElement.textContent = `Detected: ${languageNames[language] || 'English 🇬🇧'}`;
    hintElement.style.display = 'block';
}

function hideLanguageHint() {
    const hintElement = document.querySelector('.language-hint');
    if (hintElement) {
        hintElement.style.display = 'none';
    }
}

function adjustChatLayout() {
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 100);
    }
}

function clearAttachments() {
    attachedFiles = [];
    const preview = document.getElementById('attachmentsPreview');
    if (preview) {
        preview.innerHTML = '';
        preview.style.display = 'none';
    }
}

function openFileUploadModal() {
    document.getElementById('fileUploadModal').classList.add('active');
    selectedFiles = [];
    updateUploadedFilesDisplay();
}

function updateUploadedFilesDisplay() {
    const container = document.getElementById('uploadedFiles');
    if (!container) return;
    container.innerHTML = '';
    selectedFiles.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'uploaded-image-item';
        if (file.type.startsWith('image/')) {
            item.innerHTML = `
                <img src="${file.data}" alt="${file.name}" class="uploaded-image-preview">
                <button class="remove-uploaded-image" onclick="removeUploadedFile(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
        } else if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
            item.innerHTML = `
                <div style="padding: 12px; text-align: center; background: var(--dark-surface-light); height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <i class="fas fa-file-pdf" style="font-size: 1.8rem; color: var(--error); margin-bottom: 6px;"></i>
                    <div style="font-size: 0.65rem; color: var(--dark-text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">${file.name}</div>
                </div>
                <button class="remove-uploaded-image" onclick="removeUploadedFile(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
        } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
            item.innerHTML = `
                <div style="padding: 12px; text-align: center; background: var(--dark-surface-light); height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <i class="fas fa-file-alt" style="font-size: 1.8rem; color: var(--primary); margin-bottom: 6px;"></i>
                    <div style="font-size: 0.65rem; color: var(--dark-text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">${file.name}</div>
                </div>
                <button class="remove-uploaded-image" onclick="removeUploadedFile(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
        } else {
            item.innerHTML = `
                <div style="padding: 12px; text-align: center; background: var(--dark-surface-light); height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <i class="fas fa-file" style="font-size: 1.8rem; color: var(--dark-text-secondary); margin-bottom: 6px;"></i>
                    <div style="font-size: 0.65rem; color: var(--dark-text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">${file.name}</div>
                </div>
                <button class="remove-uploaded-image" onclick="removeUploadedFile(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
        }
        container.appendChild(item);
    });
}

window.removeUploadedFile = function(index) {
    selectedFiles.splice(index, 1);
    updateUploadedFilesDisplay();
};

// Close file upload modal
document.getElementById('closeFileUploadModal').addEventListener('click', function() {
    document.getElementById('fileUploadModal').classList.remove('active');
});
document.getElementById('cancelFileUpload').addEventListener('click', function() {
    document.getElementById('fileUploadModal').classList.remove('active');
});

// Handle file selection
document.getElementById('browseFilesBtn').addEventListener('click', function() {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.multiple = true;
    fileInput.accept = 'image/*,.pdf,.txt,.doc,.docx';
    fileInput.onchange = function(e) {
        handleFileSelection(e.target.files);
    };
    fileInput.click();
});

// Handle drag and drop
const uploadArea = document.getElementById('uploadArea');
uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});
uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
});
uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
        handleFileSelection(e.dataTransfer.files);
    }
});

function handleFileSelection(files) {
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (file.type.startsWith('image/') || 
            file.type === 'application/pdf' || 
            file.type === 'text/plain' ||
            file.type.includes('document') ||
            file.name.endsWith('.txt') ||
            file.name.endsWith('.pdf') ||
            file.name.endsWith('.doc') ||
            file.name.endsWith('.docx')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedFiles.push({
                    name: file.name,
                    data: e.target.result,
                    type: file.type,
                    file: file,
                    size: file.size
                });
                updateUploadedFilesDisplay();
            };
            reader.readAsDataURL(file);
        } else {
            showToast(`File type not supported: ${file.name} ❌`, 'warning');
        }
    }
}

// Confirm file upload
document.getElementById('confirmFileUpload').addEventListener('click', function() {
    if (selectedFiles.length === 0) {
        showToast('Please select at least one file 📎', 'warning');
        return;
    }
    attachedFiles = [...attachedFiles, ...selectedFiles];
    const preview = document.getElementById('attachmentsPreview');
    preview.innerHTML = '';
    attachedFiles.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'attachment-preview-item';
        if (file.type.startsWith('image/')) {
            item.innerHTML = `
                <img src="${file.data}" alt="${file.name}" class="attachment-preview-image">
                <button class="remove-attachment" onclick="removeAttachment(${index})">
                    <i class="fas fa-times"></i>
                </button>
                <div class="attachment-preview-name">${file.name}</div>
            `;
        } else if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
            item.innerHTML = `
                <div style="padding: 8px; text-align: center; background: var(--dark-surface-light); height: 70px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <i class="fas fa-file-pdf" style="font-size: 1.3rem; color: var(--error);"></i>
                    <div style="font-size: 0.55rem; color: var(--dark-text-secondary); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">PDF</div>
                </div>
                <button class="remove-attachment" onclick="removeAttachment(${index})" style="top: 2px; right: 2px;">
                    <i class="fas fa-times"></i>
                </button>
                <div class="attachment-preview-name">${file.name.substring(0, 12)}${file.name.length > 12 ? '...' : ''}</div>
            `;
        } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
            item.innerHTML = `
                <div style="padding: 8px; text-align: center; background: var(--dark-surface-light); height: 70px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <i class="fas fa-file-alt" style="font-size: 1.3rem; color: var(--primary);"></i>
                    <div style="font-size: 0.55rem; color: var(--dark-text-secondary); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">TXT</div>
                </div>
                <button class="remove-attachment" onclick="removeAttachment(${index})" style="top: 2px; right: 2px;">
                    <i class="fas fa-times"></i>
                </button>
                <div class="attachment-preview-name">${file.name.substring(0, 12)}${file.name.length > 12 ? '...' : ''}</div>
            `;
        } else {
            item.innerHTML = `
                <div style="padding: 8px; text-align: center; background: var(--dark-surface-light); height: 70px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <i class="fas fa-file" style="font-size: 1.3rem; color: var(--dark-text-secondary);"></i>
                    <div style="font-size: 0.55rem; color: var(--dark-text-secondary); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">DOC</div>
                </div>
                <button class="remove-attachment" onclick="removeAttachment(${index})" style="top: 2px; right: 2px;">
                    <i class="fas fa-times"></i>
                </button>
                <div class="attachment-preview-name">${file.name.substring(0, 12)}${file.name.length > 12 ? '...' : ''}</div>
            `;
        }
        preview.appendChild(item);
    });
    preview.style.display = 'flex';
    document.getElementById('sendButton').disabled = false;
    document.getElementById('fileUploadModal').classList.remove('active');
    showToast(`${selectedFiles.length} file(s) attached 📎`, 'success');
    selectedFiles = [];
});

window.removeAttachment = function(index) {
    attachedFiles.splice(index, 1);
    const preview = document.getElementById('attachmentsPreview');
    preview.innerHTML = '';
    if (attachedFiles.length === 0) {
        preview.style.display = 'none';
        document.getElementById('sendButton').disabled = document.getElementById('userInput').value.trim() === '';
    } else {
        attachedFiles.forEach((file, idx) => {
            const item = document.createElement('div');
            item.className = 'attachment-preview-item';
            if (file.type.startsWith('image/')) {
                item.innerHTML = `
                    <img src="${file.data}" alt="${file.name}" class="attachment-preview-image">
                    <button class="remove-attachment" onclick="removeAttachment(${idx})">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="attachment-preview-name">${file.name}</div>
                `;
            } else if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
                item.innerHTML = `
                    <div style="padding: 8px; text-align: center; background: var(--dark-surface-light); height: 70px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <i class="fas fa-file-pdf" style="font-size: 1.3rem; color: var(--error);"></i>
                        <div style="font-size: 0.55rem; color: var(--dark-text-secondary); margin-top: 4px;">PDF</div>
                    </div>
                    <button class="remove-attachment" onclick="removeAttachment(${idx})" style="top: 2px; right: 2px;">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="attachment-preview-name">${file.name.substring(0, 12)}${file.name.length > 12 ? '...' : ''}</div>
                `;
            } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                item.innerHTML = `
                    <div style="padding: 8px; text-align: center; background: var(--dark-surface-light); height: 70px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <i class="fas fa-file-alt" style="font-size: 1.3rem; color: var(--primary);"></i>
                        <div style="font-size: 0.55rem; color: var(--dark-text-secondary); margin-top: 4px;">TXT</div>
                    </div>
                    <button class="remove-attachment" onclick="removeAttachment(${idx})" style="top: 2px; right: 2px;">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="attachment-preview-name">${file.name.substring(0, 12)}${file.name.length > 12 ? '...' : ''}</div>
                `;
            } else {
                item.innerHTML = `
                    <div style="padding: 8px; text-align: center; background: var(--dark-surface-light); height: 70px; width: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <i class="fas fa-file" style="font-size: 1.3rem; color: var(--dark-text-secondary);"></i>
                        <div style="font-size: 0.55rem; color: var(--dark-text-secondary); margin-top: 4px;">DOC</div>
                    </div>
                    <button class="remove-attachment" onclick="removeAttachment(${idx})" style="top: 2px; right: 2px;">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="attachment-preview-name">${file.name.substring(0, 12)}${file.name.length > 12 ? '...' : ''}</div>
                `;
            }
            preview.appendChild(item);
        });
        preview.style.display = 'flex';
    }
};

// Load history list
function loadHistoryList() {
    const historyList = document.getElementById('historyList');
    if (!historyList) return;
    if (chatHistory.length === 0) {
        historyList.innerHTML = `
            <div class="empty-history">
                <i class="fas fa-comments"></i>
                <p>No chat history yet</p>
                <p style="font-size: 0.75rem; margin-top: 0.4rem;">Start a conversation to see it here</p>
            </div>
        `;
        return;
    }
    let html = '';
    chatHistory.forEach(chat => {
        const isActive = chat.id === currentChatId;
        const date = new Date(chat.date);
        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        html += `
            <div class="history-item ${isActive ? 'active' : ''}" data-chat-id="${chat.id}">
                <div class="history-title">${chat.title}</div>
                <div class="history-preview">${chat.preview}</div>
                <div class="history-date">${formattedDate}</div>
                <div class="history-item-actions">
                    <button class="history-item-btn download" onclick="downloadChatHistory('${chat.id}')" title="Download chat">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="history-item-btn delete" onclick="confirmDeleteChat('${chat.id}')" title="Delete chat">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    historyList.innerHTML = html;
    document.querySelectorAll('.history-item').forEach(item => {
        item.addEventListener('click', function(e) {
            if (!e.target.closest('.history-item-actions')) {
                const chatId = this.dataset.chatId;
                loadChatFromHistory(chatId);
            }
        });
    });
}

function loadChatFromHistory(chatId) {
    const chat = chatHistory.find(c => c.id === chatId);
    if (!chat) return;
    currentChatId = chatId;
    conversationHistory = [...chat.messages];
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '';
    chat.messages.forEach(msg => {
        const isDocument = msg.isDocument || false;
        const hasSources = msg.sources && msg.sources.length > 0;
        addMessageToChat(msg.content, msg.role === 'user', true, isDocument, msg.attachments || [], hasSources ? msg.sources : null);
    });
    loadHistoryList();
    if (window.innerWidth < 1024) {
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('sidebarOverlay').classList.remove('active');
        document.body.style.overflow = '';
    }
    showToast('Chat loaded from history 📚', 'success');
}

window.downloadChatHistory = function(chatId) {
    const chat = chatHistory.find(c => c.id === chatId);
    if (!chat) return;
    let content = `LegalSwami Chat History - ${chat.title}\n`;
    content += `Date: ${new Date(chat.date).toLocaleString()}\n\n`;
    content += '='.repeat(50) + '\n\n';
    chat.messages.forEach((msg, index) => {
        const role = msg.role === 'user' ? 'You' : 'LegalSwami';
        const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
        content += `${role} (${time}):\n`;
        content += msg.content + '\n\n';
        content += '-'.repeat(30) + '\n\n';
    });
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `legalswami-chat-${chatId}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showDownloadNotification(`legalswami-chat-${chatId}.txt`, 'Text File');
    showToast('Chat history downloaded 📥', 'success');
};

window.confirmDeleteChat = function(chatId) {
    const chat = chatHistory.find(c => c.id === chatId);
    if (!chat) return;
    document.getElementById('deleteChatTitle').textContent = `Delete "${chat.title}"?`;
    document.getElementById('deleteModal').dataset.chatId = chatId;
    document.getElementById('deleteModal').classList.add('active');
};

// Delete chat confirmation
document.getElementById('confirmDelete').addEventListener('click', function() {
    const chatId = document.getElementById('deleteModal').dataset.chatId;
    const chatIndex = chatHistory.findIndex(chat => chat.id === chatId);
    if (chatIndex !== -1) {
        if (currentChatId === chatId) {
            createNewChat();
        }
        chatHistory.splice(chatIndex, 1);
        saveUserChatHistory();
        loadHistoryList();
        document.getElementById('deleteModal').classList.remove('active');
        showToast('Chat deleted successfully 🗑️', 'success');
    }
});
document.getElementById('cancelDelete').addEventListener('click', function() {
    document.getElementById('deleteModal').classList.remove('active');
});
document.getElementById('closeDeleteModal').addEventListener('click', function() {
    document.getElementById('deleteModal').classList.remove('active');
});

// Download modal functions
function openDownloadModal() {
    document.getElementById('downloadModal').classList.add('active');
}
function openMessageDownloadModal(content) {
    messageContentForDownload = content;
    document.getElementById('messageDownloadModal').classList.add('active');
}
// Close download modals
document.getElementById('closeDownloadModal').addEventListener('click', function() {
    document.getElementById('downloadModal').classList.remove('active');
});
document.getElementById('closeMessageDownloadModal').addEventListener('click', function() {
    document.getElementById('messageDownloadModal').classList.remove('active');
});

// Handle download option clicks
document.querySelectorAll('.download-option').forEach(option => {
    option.addEventListener('click', function() {
        const format = this.dataset.format;
        const isMessageModal = this.closest('#messageDownloadModal') !== null;
        if (isMessageModal) {
            downloadMessage(format, messageContentForDownload);
        } else {
            downloadChat(format);
        }
    });
});

function downloadMessage(format, content) {
    const indicator = document.getElementById('messageProgressIndicator');
    indicator.classList.add('active');
    setTimeout(() => {
        const fileName = `LegalSwami-Document-${formatDateForFilename(new Date())}`;
        switch(format) {
            case 'pdf':
                downloadAsPDF(content, fileName);
                break;
            case 'doc':
                downloadAsDOC(content, fileName);
                break;
            case 'txt':
                downloadAsTXT(content, fileName);
                break;
        }
        indicator.classList.remove('active');
        document.getElementById('messageDownloadModal').classList.remove('active');
    }, 500);
}

function downloadChat(format) {
    const indicator = document.getElementById('progressIndicator');
    indicator.classList.add('active');
    setTimeout(() => {
        let content = '';
        conversationHistory.forEach((msg, index) => {
            const role = msg.role === 'user' ? 'You' : 'LegalSwami';
            const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
            content += `${role} (${time}):\n${msg.content}\n\n`;
        });
        const fileName = `LegalSwami-Chat-${formatDateForFilename(new Date())}`;
        switch(format) {
            case 'pdf':
                downloadAsPDF(content, fileName);
                break;
            case 'doc':
                downloadAsDOC(content, fileName);
                break;
            case 'txt':
                downloadAsTXT(content, fileName);
                break;
        }
        indicator.classList.remove('active');
        document.getElementById('downloadModal').classList.remove('active');
    }, 500);
}

function downloadAsPDF(content, filename) {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const lines = doc.splitTextToSize(content, 180);
        doc.setFontSize(12);
        doc.text(lines, 10, 20);
        doc.setFontSize(10);
        doc.text('Generated by LegalSwami AI Assistant ⚖️', 10, 280);
        const blob = doc.output('blob');
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        lastDownloadedFileUrl = url;
        lastDownloadedFileName = `${filename}.pdf`;
        showDownloadNotification(`${filename}.pdf`, 'PDF Document');
        showToast('PDF downloaded successfully 📥', 'success');
    } catch (error) {
        console.error('PDF generation error:', error);
        showToast('PDF download failed. Using fallback. 📄', 'warning');
        downloadAsTXT(content, filename);
    }
}

function downloadAsDOC(content, filename) {
    const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>${filename}</title>
            <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; margin: 40px; }
                h1 { color: #10a37f; }
                .timestamp { color: #666; font-size: 0.9em; }
                .user { color: #10a37f; font-weight: bold; }
                .ai { color: #7e57c2; font-weight: bold; }
                .disclaimer { 
                    background-color: #f8f9fa; 
                    border-left: 4px solid #f59e0b;
                    padding: 10px;
                    margin-top: 20px;
                    font-size: 0.9em;
                }
            </style>
        </head>
        <body>
            <h1>${filename} ⚖️</h1>
            <p class="timestamp">Generated on: ${new Date().toLocaleString()}</p>
            <hr>
            <pre style="white-space: pre-wrap; font-family: inherit;">${content}</pre>
            <div class="disclaimer">
                <strong>Disclaimer:</strong> This document is generated by LegalSwami AI Assistant for informational purposes only and does not constitute legal advice. ⚖️
            </div>
        </body>
        </html>
    `;
    const blob = new Blob([htmlContent], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${filename}.doc`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    lastDownloadedFileUrl = url;
    lastDownloadedFileName = `${filename}.doc`;
    showDownloadNotification(`${filename}.doc`, 'Word Document');
    showToast('Word document downloaded 📥', 'success');
}

function downloadAsTXT(content, filename) {
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${filename}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    lastDownloadedFileUrl = url;
    lastDownloadedFileName = `${filename}.txt`;
    showDownloadNotification(`${filename}.txt`, 'Text File');
    showToast('Text file downloaded 📥', 'success');
}

// Format date for filename
function formatDateForFilename(date) {
    return date.toISOString()
        .replace(/[:\-]/g, '')
        .replace('T', '_')
        .split('.')[0];
}

// Show toast notification
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    toastMessage.textContent = message;
    toast.className = `toast ${type} show`;
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// Initialize backend connection
async function initializeAppWithBackend() {
    console.log('🔌 Initializing app with backend...');
    
    try {
        const backendUrl = 'https://legal-swami-backend.onrender.com';
        
        if (!window.legalSwamiAPI) {
            window.legalSwamiAPI = {
                token: localStorage.getItem('legalSwamiToken'),
                user: currentUser,
                sendMessage: async function(message, attachments, chatId) {
                    console.log('📤 Sending message to backend:', message.substring(0, 50));
                    
                    const userId = this.user ? this.user.id : 'guest_' + Date.now();
                    
                    const response = await fetch(backendUrl + '/api/v1/chat/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-user-id': userId,
                            'x-request-id': 'req_' + Date.now(),
                            'x-language': selectedLanguage
                        },
                        body: JSON.stringify({
                            message: message,
                            generateDocument: isDocumentRequest(message),
                            language: selectedLanguage
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status + ': ' + await response.text());
                    }
                    
                    return await response.json();
                },
                getChatHistory: async function(page, size) {
                    page = page || 0;
                    size = size || 10;
                    const userId = this.user ? this.user.id : 'guest';
                    
                    const response = await fetch(
                        backendUrl + '/api/v1/chat/history?userId=' + userId + '&page=' + page + '&size=' + size,
                        {
                            headers: {
                                'x-user-id': userId,
                                'x-request-id': 'req_' + Date.now()
                            }
                        }
                    );
                    
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status);
                    }
                    
                    return await response.json();
                }
            };
        }
        
        // Test backend health
        try {
            const healthResponse = await fetch(backendUrl + '/api/v1/public/health');
            if (healthResponse.ok) {
                const healthData = await healthResponse.json();
                console.log('✅ Backend health check passed:', healthData);
                showToast('Backend connected successfully!', 'success');
            } else {
                console.warn('⚠️ Backend health check failed:', healthResponse.status);
            }
        } catch (error) {
            console.warn('⚠️ Backend health check failed:', error.message);
        }
        
    } catch (error) {
        console.error('❌ Initialization failed:', error);
        showToast('Note: Some features may be limited', 'warning');
    }
}

// Setup event listeners for backend
function setupBackendEventListeners() {
    // Header login button
    const headerLoginBtn = document.getElementById('headerLoginBtn');
    if (headerLoginBtn) {
        headerLoginBtn.addEventListener('click', showLoginModal);
    }
    
    // Demo login button
    const demoLoginBtn = document.getElementById('demoLoginBtn');
    if (demoLoginBtn) {
        demoLoginBtn.addEventListener('click', handleDemoLogin);
    }
    
    // Google login button
    const customGoogleBtn = document.getElementById('customGoogleBtn');
    if (customGoogleBtn) {
        customGoogleBtn.addEventListener('click', handleCustomGoogleLogin);
    }
}

// Show login modal
function showLoginModal() {
    const modal = document.getElementById('loginModal');
    if (modal) {
        modal.classList.add('active');
        isLoginModalOpen = true;
        
        // Render Google Sign-In button
        setTimeout(function() {
            renderGoogleSignInButton();
        }, 100);
    }
}

// Initialize Google Authentication
function initializeSimpleGoogleAuth() {
    console.log('🔐 Initializing Google Authentication...');
    
    if (typeof google === 'undefined') {
        console.warn('⚠️ Google Identity Services not loaded yet, will retry...');
        setTimeout(initializeSimpleGoogleAuth, 1000);
        return;
    }
    
    try {
        google.accounts.id.initialize({
            client_id: '166511615962-bohur5q8d4i5hud6icr4185kcte9enk8.apps.googleusercontent.com',
            callback: handleGoogleCredentialResponse,
            auto_select: false,
            cancel_on_tap_outside: true,
            context: 'signin',
            itp_support: false,
            ux_mode: isMobile ? 'popup' : 'popup'
        });
        
        googleGISInitialized = true;
        console.log('✅ Google Authentication initialized');
        
    } catch (error) {
        console.error('❌ Google Authentication initialization failed:', error);
    }
}

// Render Google Sign-In Button
function renderGoogleSignInButton() {
    try {
        const container = document.getElementById('googleSignInContainer');
        if (!container || !googleGISInitialized) {
            console.log('⚠️ Google Sign-In container not found or GIS not initialized');
            const customBtn = document.getElementById('customGoogleBtn');
            if (customBtn) customBtn.style.display = 'flex';
            return;
        }
        
        // Clear the container first
        container.innerHTML = '';
        
        // Render Google Sign-In button with mobile optimization
        const buttonSize = isMobile ? 'large' : 'large';
        const buttonWidth = isMobile ? '100%' : '400';
        
        google.accounts.id.renderButton(
            container,
            {
                theme: 'outline',
                size: buttonSize,
                text: 'signin_with',
                shape: 'rectangular',
                logo_alignment: 'left',
                width: buttonWidth,
                locale: 'en_US'
            }
        );
        
        console.log('✅ Google Sign-In button rendered');
        const customBtn = document.getElementById('customGoogleBtn');
        if (customBtn) customBtn.style.display = 'none';
        
    } catch (error) {
        console.error('❌ Failed to render Google Sign-In button:', error);
        const customBtn = document.getElementById('customGoogleBtn');
        if (customBtn) customBtn.style.display = 'flex';
    }
}

// Handle Google Credential Response
function handleGoogleCredentialResponse(response) {
    console.log('🔐 Google credential received');
    
    try {
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        
        const userData = {
            id: 'google_' + payload.sub,
            name: payload.name,
            email: payload.email,
            picture: payload.picture,
            provider: 'google',
            token: response.credential
        };
        
        console.log('✅ Google user authenticated:', userData.email);
        
        localStorage.setItem('legalSwamiUser', JSON.stringify(userData));
        localStorage.setItem('legalSwamiToken', response.credential);
        
        currentUser = userData;
        isLoggedIn = true;
        userToken = response.credential;
        
        if (window.legalSwamiAPI) {
            window.legalSwamiAPI.user = userData;
            window.legalSwamiAPI.token = response.credential;
        }
        
        updateUserUI();
        document.getElementById('loginModal').classList.remove('active');
        
        showToast('Successfully logged in with Google!', 'success');
        
    } catch (error) {
        console.error('❌ Failed to process Google credential:', error);
        showToast('Login failed. Please try again.', 'error');
    }
}

// Handle Custom Google Login
function handleCustomGoogleLogin() {
    console.log('🔐 Custom Google login triggered');
    
    if (!googleGISInitialized) {
        showToast('Google Sign-In is not available. Please use demo login.', 'warning');
        return;
    }
    
    try {
        google.accounts.id.prompt();
    } catch (error) {
        console.error('❌ Google login failed:', error);
        showToast('Google Sign-In failed. Using demo login instead.', 'warning');
        handleDemoLogin();
    }
}

// Handle Demo Login
function handleDemoLogin() {
    console.log('👤 Demo login triggered');
    
    const demoUsers = [
        {
            id: 'demo_lawyer_1',
            name: 'Advocate Rajesh Kumar',
            email: 'demo.lawyer@example.com',
            role: 'lawyer',
            specialization: 'Corporate Law'
        },
        {
            id: 'demo_client_1',
            name: 'Priya Sharma',
            email: 'demo.client@example.com',
            role: 'client',
            caseType: 'Property Dispute'
        },
        {
            id: 'demo_student_1',
            name: 'Amit Patel',
            email: 'demo.student@example.com',
            role: 'student',
            institution: 'NLSIU Bangalore'
        }
    ];
    
    const randomUser = demoUsers[Math.floor(Math.random() * demoUsers.length)];
    
    const userData = {
        id: randomUser.id,
        name: randomUser.name,
        email: randomUser.email,
        role: randomUser.role,
        picture: 'https://ui-avatars.com/api/?name=' + encodeURIComponent(randomUser.name) + '&background=1a56db&color=fff&size=128',
        provider: 'demo',
        isDemo: true
    };
    
    localStorage.setItem('legalSwamiUser', JSON.stringify(userData));
    localStorage.setItem('legalSwamiToken', 'demo_token_' + Date.now());
    
    currentUser = userData;
    isLoggedIn = true;
    userToken = 'demo_token';
    
    if (window.legalSwamiAPI) {
        window.legalSwamiAPI.user = userData;
        window.legalSwamiAPI.token = 'demo_token';
    }
    
    updateUserUI();
    document.getElementById('loginModal').classList.remove('active');
    showToast('Welcome ' + userData.name + '! (Demo Mode)', 'success');
}

// Check for existing user
function checkExistingUser() {
    console.log('👤 Checking for existing user...');
    
    const userStr = localStorage.getItem('legalSwamiUser');
    if (userStr) {
        try {
            const user = JSON.parse(userStr);
            console.log('✅ Found existing user:', user.name);
            
            currentUser = user;
            isLoggedIn = true;
            userToken = localStorage.getItem('legalSwamiToken');
            
            if (window.legalSwamiAPI) {
                window.legalSwamiAPI.user = user;
                window.legalSwamiAPI.token = userToken;
            }
            
            updateUserUI();
            return;
        } catch (e) {
            console.error('Error parsing user data:', e);
            localStorage.removeItem('legalSwamiUser');
            localStorage.removeItem('legalSwamiToken');
        }
    }
    
    updateUserUI();
}

// Apply mobile optimizations
function applyMobileOptimizations() {
    console.log('📱 Applying mobile optimizations...');
    
    // Larger touch targets
    const touchElements = document.querySelectorAll('button, .nav-link, .quick-btn, .chat-action-btn');
    touchElements.forEach(el => {
        el.style.minHeight = '44px';
        el.style.minWidth = '44px';
    });
    
    // Prevent zoom on input focus
    const inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.addEventListener('focus', function() {
            if (isMobile) {
                setTimeout(() => {
                    this.style.fontSize = '16px';
                }, 100);
            }
        });
    });
    
    // Better mobile scrolling
    document.body.style.overflowX = 'hidden';
    document.body.style.touchAction = 'manipulation';
    
    console.log('✅ Mobile optimizations applied');
}

// Setup scroll effects
function setupScrollEffects() {
    const header = document.querySelector('.premium-navbar');
    const navLinks = document.querySelectorAll('.nav-link');
    const backToTopBtn = document.getElementById('backToTop');
    
    if (header) {
        window.addEventListener('scroll', function() {
            // Header shadow on scroll
            if (window.scrollY > 50) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
            
            // Back to top button
            if (backToTopBtn) {
                if (window.scrollY > 300) {
                    backToTopBtn.classList.add('visible');
                } else {
                    backToTopBtn.classList.remove('visible');
                }
            }
        });
    }
    
    // Back to top functionality
    if (backToTopBtn) {
        backToTopBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }
}

// Setup mobile menu
function setupMobileMenu() {
    const mobileToggle = document.getElementById('mobileToggle');
    const mobileMenu = document.getElementById('mobileMenu');
    const mobileClose = document.getElementById('mobileClose');
    
    if (mobileToggle && mobileMenu) {
        mobileToggle.addEventListener('click', function() {
            isMobileMenuOpen = !isMobileMenuOpen;
            if (isMobileMenuOpen) {
                mobileMenu.style.display = 'block';
                setTimeout(function() {
                    mobileMenu.style.opacity = '1';
                }, 10);
                document.body.style.overflow = 'hidden';
            } else {
                mobileMenu.style.opacity = '0';
                setTimeout(function() {
                    mobileMenu.style.display = 'none';
                }, 300);
                document.body.style.overflow = '';
            }
            this.innerHTML = isMobileMenuOpen ? 
                '<i class="fas fa-times"></i>' : 
                '<i class="fas fa-bars"></i>';
        });
    }
    
    if (mobileClose && mobileMenu) {
        mobileClose.addEventListener('click', function() {
            isMobileMenuOpen = false;
            mobileMenu.style.opacity = '0';
            setTimeout(function() {
                mobileMenu.style.display = 'none';
            }, 300);
            document.body.style.overflow = '';
            if (mobileToggle) {
                mobileToggle.innerHTML = '<i class="fas fa-bars"></i>';
            }
        });
    }
}

// Setup device specific optimizations
function setupDeviceSpecificOptimizations() {
    // Tablet specific optimizations
    if (isTablet) {
        console.log('📱 Tablet optimizations enabled');
        
        // Adjust font sizes for tablet
        document.documentElement.style.fontSize = '15px';
    }
    
    // Mobile specific optimizations
    if (isMobile) {
        // Add swipe support for mobile menu
        let startX, startY;
        
        document.addEventListener('touchstart', function(e) {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        });
        
        document.addEventListener('touchend', function(e) {
            if (!startX || !startY) return;
            
            const endX = e.changedTouches[0].clientX;
            const endY = e.changedTouches[0].clientY;
            
            const diffX = startX - endX;
            const diffY = startY - endY;
            
            // Horizontal swipe (for chat interface)
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                if (diffX > 0 && isChatOpen) {
                    // Swipe left - go back to home
                    const backBtn = document.getElementById('backToHome');
                    if (backBtn) {
                        backBtn.click();
                    }
                }
            }
        });
    }
}

// Setup language buttons
function setupLanguageButtons() {
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const lang = this.getAttribute('data-lang');
            selectedLanguage = lang;
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Update chat placeholder based on language
            const messageInput = document.getElementById('userInput');
            if (messageInput) {
                if (lang === 'hi') {
                    messageInput.placeholder = "अपना कानूनी प्रश्न यहां टाइप करें...";
                } else if (lang === 'mr') {
                    messageInput.placeholder = "तुमचा कायदेशीर प्रश्न येथे टाइप करा...";
                } else if (lang === 'gu') {
                    messageInput.placeholder = "તમારો કાનૂની પ્રશ્ન અહીં ટાઈપ કરો...";
                } else {
                    messageInput.placeholder = "Type your legal question here...";
                }
            }
            
            showToast(`Language changed to ${getLanguageName(lang)}`, 'info');
        });
    });
}

function getLanguageName(code) {
    const languages = {
        'en': 'English',
        'hi': 'Hindi',
        'mr': 'Marathi',
        'gu': 'Gujarati'
    };
    return languages[code] || 'English';
}

// Mock response generator
async function generateMockResponse(message) {
    // Simple mock response for when backend is down
    const responses = [
        "I understand you're asking about legal matters. Based on common legal principles in India...",
        "For the legal document you requested, here's a basic template structure...",
        "Regarding your legal question, here are some general guidelines...",
        "I'll help you draft that document. Here's a standard format...",
        "Based on Indian legal practice, here's what you need to consider..."
    ];
    
    return {
        response: responses[Math.floor(Math.random() * responses.length)],
        content: responses[Math.floor(Math.random() * responses.length)],
        isDocument: isDocumentRequest(message)
    };
}

// Mock Response Generator - ADD THIS
function generateDocumentTemplate(query) {
    const templates = {
        nda: `NON-DISCLOSURE AGREEMENT

This Non-Disclosure Agreement is entered into on [DATE]

BETWEEN:
Party A: [NAME]
Party B: [NAME]

1. CONFIDENTIAL INFORMATION
   - All information disclosed shall remain confidential
   
2. OBLIGATIONS
   - Not to disclose to third parties
   - Use only for stated purposes

3. TERM
   - Valid for [X] years

___________________                    ___________________
Party A Signature                      Party B Signature

Disclaimer: Template for reference only. Consult a lawyer. ⚖️`,
        
        rental: `RENTAL AGREEMENT

Date: [DATE]

LANDLORD: [NAME]
TENANT: [NAME]
PROPERTY: [ADDRESS]

TERMS:
- Monthly Rent: ₹[AMOUNT]
- Security Deposit: ₹[AMOUNT]
- Duration: [X] months

___________________                    ___________________
Landlord                               Tenant

Disclaimer: Get this reviewed by a lawyer before signing. ⚖️`,
        
        default: `LEGAL DOCUMENT TEMPLATE

[TITLE]

PARTIES:
1. [NAME]
2. [NAME]

TERMS:
1. [TERM 1]
2. [TERM 2]

___________________
Signatures

Disclaimer: Consult a qualified attorney before use. ⚖️`
    };
    
    if (query.toLowerCase().includes('nda')) return templates.nda;
    if (query.toLowerCase().includes('rental')) return templates.rental;
    return templates.default;
}

async function generateMockResponse(message, originalQuery) {
    console.log("🤖 Generating mock response");
    
    const isDoc = isDocumentRequest(originalQuery);
    
    if (isDoc) {
        return {
            response: generateDocumentTemplate(originalQuery),
            content: generateDocumentTemplate(originalQuery),
            isDocument: true
        };
    }
    
    const response = `**Legal Information**

Based on your query: "${originalQuery.substring(0, 100)}..."

In India, legal matters require proper understanding of:

1. **Applicable Laws**: Identify relevant statutes
2. **Jurisdiction**: Determine appropriate authority
3. **Documentation**: Maintain proper records
4. **Time Limits**: Be aware of limitation periods
5. **Professional Advice**: Consult a qualified lawyer

**Disclaimer**: This is AI-generated general information, not legal advice. Always consult a licensed attorney. ⚖️`;
    
    return {
        response: response,
        content: response,
        isDocument: false
    };
}

// DOM Content Loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 LegalSwami Premium Frontend Initialized');
    console.log('📱 Device Type:', isMobile ? 'Mobile' : isTablet ? 'Tablet' : 'Desktop');
     
    // Hide loading screen
    setTimeout(function() {
        const loadingScreen = document.getElementById('loadingScreen');
        if (loadingScreen) {
            loadingScreen.style.opacity = '0';
            setTimeout(function() {
                loadingScreen.style.display = 'none';
                console.log('✅ Loading screen hidden');
            }, 300);
        }
    }, 500);
    
    // Setup button click handlers
    // FIXED: Button Setup
setTimeout(function() {
    console.log("🔧 Setting up buttons...");
    
    // Start Chat Buttons
    const startBtns = ['startChatBtn', 'ctaStartChat', 'mobileStartChat'];
    startBtns.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log("Button clicked:", btnId);
                showChatGPTInterface();
            });
            console.log("✅ Handler added:", btnId);
        }
    });
    
    // .btn-assistant class buttons
    document.querySelectorAll('.btn-assistant').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            showChatGPTInterface();
        });
    });
    
    // Generate/Pricing buttons
    document.querySelectorAll('.btn-generate, .btn-pricing').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            showChatGPTInterface();
        });
    });
    
    console.log('✅ All buttons setup complete');
}, 1000);
    
    // Initialize backend connection
    initializeAppWithBackend();
    
    // Setup event listeners
    setupBackendEventListeners();
    
    // Initialize Google Authentication
    setTimeout(initializeSimpleGoogleAuth, 2000);
    
    // Check for existing user
    checkExistingUser();
    
    // Setup scroll effects
    setupScrollEffects();
    
    // Setup mobile menu
    setupMobileMenu();
    
    // Setup device-specific optimizations
    setupDeviceSpecificOptimizations();
    
    // Apply mobile optimizations
    if (isMobile) {
        applyMobileOptimizations();
    }
    
    // Auto-initialize guest mode if not logged in
    setTimeout(function() {
        if (!isLoggedIn && !document.getElementById('loginModal').classList.contains('active')) {
            console.log("Auto-initializing guest mode...");
            initializeAppForGuest();
        }
    }, 1000);
    
    console.log('✅ All initialization complete');
});

// EMERGENCY FIX: Global error handler
window.onerror = function(msg, url, line, col, error) {
    console.log("Global error caught:", msg, "at", line, ":", col);
    return true; // Prevents default error handling
};

// =============================================
// EMERGENCY FIX FOR CHAT INTERFACE
// =============================================

// Override showChatGPTInterface function
window.showChatGPTInterface = function() {
    console.log("🚀 EMERGENCY: Showing Chat Interface");
    
    // Hide homepage completely
    const mainContainer = document.querySelector('.main-container');
    if (mainContainer) {
        mainContainer.style.display = 'none';
        console.log("✅ Main container hidden");
    }
    
    // Show chat interface
    const chatInterface = document.getElementById('chatInterface');
    if (chatInterface) {
        // Remove any conflicting styles
        chatInterface.style.cssText = `
            display: flex !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background: var(--dark-bg) !important;
            z-index: 99999 !important;
            flex-direction: column !important;
            opacity: 1 !important;
            visibility: visible !important;
        `;
        
        // Add active class
        chatInterface.classList.add('active');
        document.body.classList.add('chat-active');
        document.body.style.overflow = 'hidden';
        
        console.log("✅ Chat interface shown");
        
        // Initialize chat if not already initialized
        if (typeof initializeChatApp === 'function' && !window.chatInitialized) {
            setTimeout(function() {
                initializeChatApp();
                window.chatInitialized = true;
            }, 300);
        }
        
        // Focus on input
        setTimeout(function() {
            const userInput = document.getElementById('userInput');
            if (userInput) {
                userInput.focus();
                console.log("✅ Input focused");
            }
        }, 500);
    } else {
        console.error("❌ Chat interface element not found!");
        alert('Chat interface not found. Please refresh the page.');
    }
};

// Override goBackToHome function
window.goBackToHome = function() {
    console.log("🏠 EMERGENCY: Going back to home");
    
    // Hide chat
    const chatInterface = document.getElementById('chatInterface');
    if (chatInterface) {
        chatInterface.classList.remove('active');
        chatInterface.style.display = 'none';
    }
    
    // Show homepage
    const mainContainer = document.querySelector('.main-container');
    if (mainContainer) {
        mainContainer.style.display = 'block';
    }
    
    document.body.classList.remove('chat-active');
    document.body.style.overflow = '';
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    console.log("✅ Back to home successful");
};

// Force initialize guest mode immediately
if (!window.currentUser) {
    console.log("👤 Forcing guest mode initialization");
    
    window.currentUser = {
        id: 'guest_' + Date.now(),
        name: 'Guest User',
        email: 'Local Browser Mode',
        isGuest: true,
        picture: null
    };
    
    window.isLoggedIn = false;
    
    // Show toast
    if (typeof showToast === 'function') {
        showToast('Welcome to LegalSwami! You have 500 free searches per day.', 'info');
    }
}

// Fix all button click handlers
document.addEventListener('DOMContentLoaded', function() {
    console.log("🔧 Setting up emergency button handlers");
    
    // Start Chat buttons
    const startButtons = [
        'startChatBtn',
        'ctaStartChat', 
        'mobileStartChat'
    ];
    
    startButtons.forEach(function(btnId) {
        const btn = document.getElementById(btnId);
        if (btn) {
            // Remove any existing listeners
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            // Add fresh listener
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log("🖱️ Button clicked:", btnId);
                showChatGPTInterface();
            });
            
            console.log("✅ Fixed button:", btnId);
        }
    });
    
    // Back to Home button in chat
    const backBtn = document.getElementById('backToHomeBtn');
    if (backBtn) {
        const newBackBtn = backBtn.cloneNode(true);
        backBtn.parentNode.replaceChild(newBackBtn, backBtn);
        
        newBackBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            goBackToHome();
        });
        
        console.log("✅ Fixed back button");
    }
    
    // Fix .btn-assistant buttons
    document.querySelectorAll('.btn-assistant').forEach(function(btn) {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            showChatGPTInterface();
        });
    });
    
    // Fix .btn-generate buttons
    document.querySelectorAll('.btn-generate').forEach(function(btn) {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            showChatGPTInterface();
        });
    });
    
    console.log("✅ All emergency fixes applied");
});

// Add critical CSS fixes
(function() {
    const style = document.createElement('style');
    style.textContent = `
        /* EMERGENCY CSS FIXES */
        #chatInterface {
            display: none !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background: var(--dark-bg) !important;
            z-index: 99999 !important;
        }
        
        #chatInterface.active {
            display: flex !important;
            flex-direction: column !important;
        }
        
        body.chat-active .main-container {
            display: none !important;
        }
        
        body.chat-active {
            overflow: hidden !important;
        }
        
        #chatInterface .container {
            height: 100vh !important;
            width: 100vw !important;
            display: flex !important;
            flex-direction: column !important;
        }
        
        #chatInterface .chat-container {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
        }
        
        #chatInterface .chat-messages {
            flex: 1 !important;
            overflow-y: auto !important;
            background: var(--dark-bg) !important;
        }
        
        /* Mobile fixes */
        @media (max-width: 768px) {
            #chatInterface {
                height: -webkit-fill-available !important;
            }
        }
    `;
    document.head.appendChild(style);
    console.log("✅ Emergency CSS fixes added");
})();

// Force show chat on page load for testing (remove this after testing)
// setTimeout(function() {
//     showChatGPTInterface();
// }, 2000);
 </script>
</body>
</html>
