<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>LegalSwami - AI Legal Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #10a37f;
            --primary-dark: #0d8c6d;
            --primary-light: #12b886;
            --secondary: #7e57c2;
            --accent: #ec4899;
            --dark-bg: #0a0a0a;
            --dark-surface: #171717;
            --dark-surface-light: #262626;
            --dark-border: #404040;
            --dark-text: #f8fafc;
            --dark-text-secondary: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: var(--dark-bg);
            color: var(--dark-text);
            line-height: 1.6;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            background: var(--dark-bg);
            overflow: hidden;
        }
        
        /* Header */
        header {
            background: var(--dark-surface);
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--dark-border);
            position: sticky;
            top: 0;
            z-index: 100;
            min-height: 64px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            font-size: 1.2rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .logo h1 {
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
        }
        
        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: nowrap;
        }
        
        .header-btn {
            background: var(--dark-surface-light);
            color: var(--dark-text);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            padding: 0.5rem 0.8rem;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            min-height: 40px;
        }
        
        .header-btn:hover {
            background: var(--dark-border);
            transform: translateY(-1px);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0.4rem 0.8rem;
            background: rgba(16, 163, 127, 0.1);
            border: 1px solid rgba(16, 163, 127, 0.3);
            border-radius: 20px;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background-color: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Sidebar Toggle Button */
        .sidebar-toggle {
            background: transparent;
            border: none;
            color: var(--dark-text);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            border-radius: 8px;
            width: 44px;
            height: 44px;
        }
        
        .sidebar-toggle:hover {
            background: var(--dark-surface-light);
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--dark-surface);
            border-right: 1px solid var(--dark-border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 50;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            overflow: hidden;
            transform: translateX(-100%);
        }
        
        .sidebar.active {
            transform: translateX(0);
        }
        
        /* Sidebar Close Button */
        .sidebar-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--dark-surface-light);
            color: var(--dark-text);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            padding: 0.5rem;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        
        .sidebar-close:hover {
            background: var(--dark-border);
            transform: rotate(90deg);
        }
        
        /* Sidebar Tabs */
        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--dark-border);
            background: var(--dark-surface);
            position: sticky;
            top: 0;
            z-index: 20;
        }
        
        .sidebar-tab {
            flex: 1;
            padding: 1rem;
            background: transparent;
            border: none;
            color: var(--dark-text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
        }
        
        .sidebar-tab:hover {
            color: var(--dark-text);
            background: var(--dark-surface-light);
        }
        
        .sidebar-tab.active {
            color: var(--primary);
        }
        
        .sidebar-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 3px 3px 0 0;
        }
        
        /* Tab Content */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            display: none;
            padding-top: 0.5rem;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Legal Topics Tab */
        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--dark-border);
            position: sticky;
            top: 0;
            background: var(--dark-surface);
            z-index: 10;
        }
        
        .sidebar-header h2 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-section {
            padding: 1rem;
        }
        
        .sidebar-section h3 {
            font-size: 0.85rem;
            margin-bottom: 0.8rem;
            color: var(--dark-text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .topic-list, .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .topic-item, .action-item {
            padding: 0.8rem;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--dark-text-secondary);
            min-height: 44px;
        }
        
        .topic-item:hover, .action-item:hover {
            background: var(--dark-surface-light);
            color: var(--dark-text);
            transform: translateX(5px);
        }
        
        .topic-item i, .action-item i {
            width: 20px;
            text-align: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        /* Chat History Tab */
        .history-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--dark-border);
            position: sticky;
            top: 0;
            background: var(--dark-surface);
            z-index: 10;
        }
        
        .history-header h2 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .new-chat-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
        }
        
        .history-list {
            padding: 0.5rem;
        }
        
        .history-item {
            padding: 0.8rem;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
            display: flex;
            flex-direction: column;
            gap: 4px;
            color: var(--dark-text-secondary);
            margin-bottom: 6px;
            position: relative;
        }
        
        .history-item:hover {
            background: var(--dark-surface-light);
            color: var(--dark-text);
        }
        
        .history-item.active {
            background: rgba(16, 163, 127, 0.1);
            border-color: rgba(16, 163, 127, 0.3);
            color: var(--primary);
        }
        
        .history-title {
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 60px;
        }
        
        .history-preview {
            font-size: 0.8rem;
            color: var(--dark-text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 60px;
        }
        
        .history-date {
            font-size: 0.7rem;
            color: var(--dark-text-secondary);
        }
        
        /* History Item Actions */
        .history-item-actions {
            display: none;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            gap: 5px;
            background: var(--dark-surface);
            padding: 4px;
            border-radius: 6px;
            border: 1px solid var(--dark-border);
            z-index: 5;
        }
        
        .history-item:hover .history-item-actions {
            display: flex;
        }
        
        .history-item-btn {
            background: transparent;
            border: none;
            color: var(--dark-text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
        }
        
        .history-item-btn:hover {
            background: var(--dark-surface-light);
        }
        
        .history-item-btn.delete:hover {
            color: var(--error);
        }
        
        .history-item-btn.download:hover {
            color: var(--primary);
        }
        
        .empty-history {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--dark-text-secondary);
        }
        
        .empty-history i {
            font-size: 2rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-history p {
            font-size: 0.9rem;
        }
        
        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--dark-bg);
            width: 100%;
            transition: margin-left 0.3s ease;
        }
        
        /* Chat Messages */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        
        .message {
            display: flex;
            gap: 0.8rem;
            max-width: 100%;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            flex-direction: row-reverse;
        }
        
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
            margin-top: 4px;
        }
        
        .user-message .avatar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }
        
        .ai-message .avatar {
            background: linear-gradient(135deg, var(--secondary) 0%, #5e35b1 100%);
        }
        
        .message-content {
            max-width: 85%;
            position: relative;
        }
        
        .user-message .message-content {
            text-align: right;
        }
        
        .message-text {
            padding: 1rem 1.2rem;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .ai-message .message-text {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-top-left-radius: 4px;
            color: var(--dark-text);
        }
        
        .user-message .message-text {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        /* Message Actions - UPDATED with document button */
        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 0.8rem;
            flex-wrap: wrap;
        }
        
        .action-btn {
            background: var(--dark-surface-light);
            color: var(--dark-text-secondary);
            border: 1px solid var(--dark-border);
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            min-height: 32px;
        }
        
        .action-btn:hover {
            background: var(--dark-border);
            color: var(--dark-text);
        }
        
        .action-btn.copy:hover {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        .action-btn.like:hover {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        .action-btn.dislike:hover {
            background: var(--error);
            border-color: var(--error);
            color: white;
        }
        
        .action-btn.document:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        /* Download document button inside message */
        .document-download-btn {
            position: absolute;
            top: -15px;
            right: 10px;
            background: var(--dark-surface);
            border: 1px solid var(--primary);
            border-radius: 20px;
            padding: 6px 12px;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            z-index: 5;
            opacity: 0;
            transform: translateY(5px);
        }
        
        .ai-message .message-content:hover .document-download-btn {
            opacity: 1;
            transform: translateY(0);
        }
        
        .document-download-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
        }
        
        /* Document Template Styles */
        .document-template {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .document-header {
            text-align: center;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .document-title {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .document-subtitle {
            color: var(--dark-text-secondary);
            font-size: 0.9rem;
        }
        
        .document-section {
            margin-bottom: 1.5rem;
        }
        
        .document-section-title {
            color: var(--primary);
            font-size: 1.1rem;
            margin-bottom: 0.8rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--dark-border);
        }
        
        .document-clause {
            margin-bottom: 1rem;
            padding-left: 1rem;
            border-left: 3px solid var(--primary-light);
        }
        
        .clause-title {
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 0.5rem;
        }
        
        .clause-content {
            color: var(--dark-text-secondary);
            line-height: 1.6;
        }
        
        .signature-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--dark-border);
        }
        
        .signature-line {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }
        
        .signature-block {
            flex: 1;
            padding: 1rem;
        }
        
        .signature-name {
            border-bottom: 1px solid var(--dark-border);
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            min-height: 30px;
        }
        
        .signature-label {
            font-size: 0.8rem;
            color: var(--dark-text-secondary);
        }
        
        /* Welcome Message */
        .welcome-message {
            text-align: center;
            max-width: 600px;
            margin: 2rem auto;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(16, 163, 127, 0.1) 0%, rgba(30, 64, 175, 0.1) 100%);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            width: 90%;
        }
        
        .welcome-message h2 {
            font-size: 1.8rem;
            margin-bottom: 0.8rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .welcome-message p {
            color: var(--dark-text-secondary);
            font-size: 1rem;
            margin-bottom: 1.2rem;
            line-height: 1.5;
        }
        
        .welcome-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .feature {
            background: var(--dark-surface);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--dark-border);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .feature i {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .feature h4 {
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }
        
        .feature p {
            font-size: 0.8rem;
            color: var(--dark-text-secondary);
        }
        
        /* Input Area */
        .input-container {
            padding: 1rem;
            background: var(--dark-bg);
            border-top: 1px solid var(--dark-border);
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        
        .input-area {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            width: 100%;
        }
        
        .input-area textarea {
            width: 100%;
            padding: 1rem 5rem 1rem 1.2rem;
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            color: var(--dark-text);
            font-size: 1rem;
            resize: none;
            min-height: 56px;
            max-height: 200px;
            transition: all 0.3s;
            line-height: 1.5;
            font-family: inherit;
        }
        
        .input-area textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.1);
        }
        
        .send-button {
            position: absolute;
            right: 0.8rem;
            bottom: 0.8rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0.6rem 1rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            min-height: 44px;
            font-size: 0.9rem;
        }
        
        .send-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
        }
        
        .send-button:disabled {
            background: var(--dark-border);
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 1rem 1.2rem;
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            max-width: fit-content;
            margin-left: 3rem;
            margin-top: 0.5rem;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--primary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--dark-surface);
            color: var(--dark-text);
            padding: 1rem 1.2rem;
            border-radius: 12px;
            border: 1px solid var(--dark-border);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 300px;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            border-left: 4px solid var(--success);
        }
        
        .toast.error {
            border-left: 4px solid var(--error);
        }
        
        .toast.warning {
            border-left: 4px solid var(--warning);
        }
        
        .toast.info {
            border-left: 4px solid var(--primary);
        }
        
        /* Sidebar Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 45;
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        /* Document download modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--dark-surface);
            border-radius: 16px;
            border: 1px solid var(--dark-border);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--dark-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-text);
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--dark-text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: var(--dark-surface-light);
            color: var(--dark-text);
        }
        
        .modal-content {
            padding: 1.5rem;
        }
        
        .download-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .download-option {
            background: var(--dark-surface-light);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            padding: 1.5rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .download-option:hover {
            background: var(--dark-border);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .download-option i {
            font-size: 2rem;
            color: var(--primary);
        }
        
        .download-option h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-text);
        }
        
        .download-option p {
            font-size: 0.85rem;
            color: var(--dark-text-secondary);
        }
        
        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--dark-border);
            text-align: center;
        }
        
        .modal-footer p {
            font-size: 0.85rem;
            color: var(--dark-text-secondary);
        }
        
        /* Progress indicator */
        .progress-indicator {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 2rem;
        }
        
        .progress-indicator.active {
            display: flex;
        }
        
        .progress-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--dark-border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Delete confirmation modal */
        .confirmation-modal {
            max-width: 400px;
        }
        
        .confirmation-text {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .confirmation-text i {
            font-size: 3rem;
            color: var(--error);
            margin-bottom: 1rem;
        }
        
        .confirmation-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .confirmation-btn {
            flex: 1;
            padding: 0.8rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .confirmation-btn.cancel {
            background: var(--dark-surface-light);
            color: var(--dark-text);
            border: 1px solid var(--dark-border);
        }
        
        .confirmation-btn.cancel:hover {
            background: var(--dark-border);
        }
        
        .confirmation-btn.delete {
            background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
            color: white;
        }
        
        .confirmation-btn.delete:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        /* Language hint */
        .language-hint {
            position: absolute;
            top: -25px;
            left: 10px;
            font-size: 0.8rem;
            color: var(--primary);
            background: var(--dark-surface);
            padding: 2px 8px;
            border-radius: 10px;
            border: 1px solid var(--primary);
            z-index: 1;
            display: none;
        }
        
        /* Responsive Breakpoints */
        
        /* Mobile - Small Screens (up to 480px) */
        @media (max-width: 480px) {
            header {
                padding: 0.8rem 0.8rem;
            }
            
            .logo h1 {
                font-size: 1.1rem;
            }
            
            .header-btn span {
                display: none;
            }
            
            .header-btn i {
                margin: 0;
            }
            
            .status-indicator span {
                display: none;
            }
            
            .chat-messages {
                padding: 0.8rem;
            }
            
            .message-content {
                max-width: 90%;
            }
            
            .document-download-btn {
                opacity: 1;
                transform: translateY(0);
                top: -10px;
                right: 5px;
                padding: 4px 8px;
                font-size: 0.6rem;
            }
            
            .welcome-message {
                padding: 1rem;
                margin: 1rem auto;
            }
            
            .welcome-message h2 {
                font-size: 1.5rem;
            }
            
            .welcome-features {
                grid-template-columns: 1fr;
            }
            
            .input-container {
                padding: 0.8rem;
            }
            
            .input-area textarea {
                padding: 0.8rem 4.5rem 0.8rem 1rem;
                font-size: 0.95rem;
                min-height: 52px;
            }
            
            .send-button {
                padding: 0.5rem 0.8rem;
                right: 0.6rem;
                bottom: 0.6rem;
            }
            
            .sidebar {
                width: 260px;
            }
            
            .download-options {
                grid-template-columns: 1fr;
            }
            
            .history-item-actions {
                display: flex !important;
                opacity: 0.9;
            }
            
            .document-template {
                padding: 1rem;
            }
            
            .signature-line {
                flex-direction: column;
                gap: 1rem;
            }
        }
        
        /* Mobile - Medium Screens (481px to 767px) */
        @media (min-width: 481px) and (max-width: 767px) {
            .header-btn span {
                display: none;
            }
            
            .status-indicator {
                padding: 0.4rem;
            }
            
            .status-indicator span {
                display: none;
            }
            
            .document-download-btn {
                opacity: 1;
                transform: translateY(0);
            }
            
            .welcome-features {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .history-item-actions {
                display: flex !important;
                opacity: 0.9;
            }
        }
        
        /* Tablet (768px to 1023px) */
        @media (min-width: 768px) and (max-width: 1023px) {
            .sidebar {
                position: fixed;
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .chat-container {
                margin-left: 0;
            }
            
            .sidebar-toggle {
                display: flex;
            }
            
            .header-btn {
                padding: 0.6rem 1rem;
            }
            
            .welcome-features {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* Desktop (1024px and above) */
        @media (min-width: 1024px) {
            .sidebar {
                position: relative;
                transform: translateX(0);
            }
            
            .sidebar-toggle {
                display: none;
            }
            
            .sidebar-close {
                display: none;
            }
            
            .sidebar-overlay {
                display: none !important;
            }
            
            .chat-messages {
                padding: 1.5rem 2rem;
            }
            
            .input-container {
                padding: 1.5rem;
            }
            
            .welcome-message {
                margin: 3rem auto;
                padding: 2rem;
            }
            
            .welcome-message h2 {
                font-size: 2.2rem;
            }
        }
        
        /* Large Desktop Screens */
        @media (min-width: 1440px) {
            .container {
                max-width: 1600px;
                margin: 0 auto;
            }
            
            .chat-messages {
                padding: 2rem 3rem;
            }
            
            .message-content {
                max-width: 70%;
            }
            
            .sidebar {
                width: 300px;
            }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--dark-bg);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--dark-border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--dark-surface-light);
        }
        
        /* Legal Content */
        .legal-note {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            padding: 0.8rem;
            margin: 0.8rem 0;
            font-size: 0.85rem;
            color: var(--warning);
        }
        
        .legal-content {
            line-height: 1.7;
        }
        
        .legal-content h3 {
            color: var(--primary);
            margin: 1.2rem 0 0.6rem 0;
            font-size: 1.1rem;
        }
        
        .legal-content ul {
            margin: 0.8rem 0 0.8rem 1.2rem;
            list-style-type: disc;
        }
        
        .legal-content li {
            margin-bottom: 0.4rem;
        }
        
        .legal-content strong {
            color: var(--primary-light);
        }
        
        /* Language-specific styles */
        .hindi-text {
            direction: ltr;
            text-align: left;
            font-family: inherit;
        }
        
        .marathi-text {
            direction: ltr;
            text-align: left;
            font-family: inherit;
        }
        
        .tamil-text {
            direction: ltr;
            text-align: left;
            font-family: inherit;
        }
        
        .telugu-text {
            direction: ltr;
            text-align: left;
            font-family: inherit;
        }
        
        /* Utility Classes */
        .hide-on-mobile {
            display: none;
        }
        
        .show-on-mobile {
            display: flex;
        }
        
        @media (min-width: 768px) {
            .hide-on-mobile {
                display: flex;
            }
            
            .show-on-mobile {
                display: none;
            }
        }
        
        /* Input area with language hint */
        .input-area {
            position: relative;
        }
        
        /* Document Draft Templates */
        .draft-templates {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .draft-template {
            background: var(--dark-surface-light);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 10px;
        }
        
        .draft-template:hover {
            background: var(--dark-border);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .draft-template i {
            font-size: 2rem;
            color: var(--primary);
        }
        
        .draft-template h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-text);
        }
        
        .draft-template p {
            font-size: 0.8rem;
            color: var(--dark-text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo-icon">
                    <i class="fas fa-scale-balanced"></i>
                </div>
                <h1>LegalSwami</h1>
            </div>
            
            <div class="header-actions">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>AI Assistant Ready</span>
                </div>
                <button class="header-btn" id="clearChatBtn">
                    <i class="fas fa-broom"></i>
                    <span class="hide-on-mobile">Clear Chat</span>
                    <span class="show-on-mobile">Clear</span>
                </button>
                <button class="header-btn" id="downloadCurrentBtn">
                    <i class="fas fa-download"></i>
                    <span class="hide-on-mobile">Download Chat</span>
                </button>
                <button class="header-btn" id="suggestionsBtn">
                    <i class="fas fa-lightbulb"></i>
                    <span class="hide-on-mobile">Suggestions</span>
                    <span class="show-on-mobile">Tips</span>
                </button>
            </div>
        </header>
        
        <div class="main-content">
            <div class="sidebar-overlay" id="sidebarOverlay"></div>
            
            <aside class="sidebar" id="sidebar">
                <!-- Sidebar Close Button -->
                <button class="sidebar-close" id="sidebarClose">
                    <i class="fas fa-times"></i>
                </button>
                
                <!-- Sidebar Tabs -->
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" data-tab="legal-topics">
                        <i class="fas fa-book"></i>
                        <span class="hide-on-mobile">Legal Topics</span>
                        <span class="show-on-mobile">Topics</span>
                    </button>
                    <button class="sidebar-tab" data-tab="chat-history">
                        <i class="fas fa-history"></i>
                        <span class="hide-on-mobile">Chat History</span>
                        <span class="show-on-mobile">History</span>
                    </button>
                </div>
                
                <!-- Legal Topics Tab Content -->
                <div class="tab-content active" id="legal-topics-content">
                    <div class="sidebar-header">
                        <h2><i class="fas fa-book"></i> Legal Topics</h2>
                    </div>
                    
                    <div class="sidebar-section">
                        <div class="topic-list">
                            <div class="topic-item" data-topic="contract">
                                <i class="fas fa-file-contract"></i>
                                <span>Contract Law</span>
                            </div>
                            <div class="topic-item" data-topic="employment">
                                <i class="fas fa-briefcase"></i>
                                <span>Employment Law</span>
                            </div>
                            <div class="topic-item" data-topic="intellectual">
                                <i class="fas fa-lightbulb"></i>
                                <span>Intellectual Property</span>
                            </div>
                            <div class="topic-item" data-topic="realestate">
                                <i class="fas fa-house"></i>
                                <span>Real Estate Law</span>
                            </div>
                            <div class="topic-item" data-topic="family">
                                <i class="fas fa-heart"></i>
                                <span>Family Law</span>
                            </div>
                            <div class="topic-item" data-topic="criminal">
                                <i class="fas fa-gavel"></i>
                                <span>Criminal Law</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                        <div class="quick-actions">
                            <div class="action-item" data-action="document-drafts">
                                <i class="fas fa-file-alt"></i>
                                <span>Document Drafts</span>
                            </div>
                            <div class="action-item" data-action="legal-research">
                                <i class="fas fa-search"></i>
                                <span>Legal Research</span>
                            </div>
                            <div class="action-item" data-action="case-analysis">
                                <i class="fas fa-chart-bar"></i>
                                <span>Case Analysis</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat History Tab Content -->
                <div class="tab-content" id="chat-history-content">
                    <div class="history-header">
                        <h2><i class="fas fa-history"></i> Chat History</h2>
                        <button class="new-chat-btn" id="newChatBtn">
                            <i class="fas fa-plus"></i>
                            <span class="hide-on-mobile">New Chat</span>
                            <span class="show-on-mobile">New</span>
                        </button>
                    </div>
                    
                    <div class="history-list" id="historyList">
                        <!-- History items will be loaded here -->
                        <div class="empty-history">
                            <i class="fas fa-comments"></i>
                            <p>No chat history yet</p>
                            <p style="font-size: 0.8rem; margin-top: 0.5rem;">Start a conversation to see it here</p>
                        </div>
                    </div>
                </div>
            </aside>
            
            <main class="chat-container" id="chatContainer">
                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message">
                        <h2>Welcome to LegalSwami</h2>
                        <p>Your AI-powered legal assistant for accurate, comprehensive legal information and guidance.</p>
                        <p style="color: var(--primary); margin-top: 10px; font-size: 0.9rem;">
                            <i class="fas fa-language"></i> Supports multiple Indian languages!
                        </p>
                        
                        <div style="margin-top: 2rem;">
                            <h3 style="color: var(--primary); margin-bottom: 1rem;">Ready-to-Use Legal Documents:</h3>
                            <div class="draft-templates">
                                <div class="draft-template" data-template="nda">
                                    <i class="fas fa-file-signature"></i>
                                    <h4>Non-Disclosure Agreement</h4>
                                    <p>Confidentiality agreement template</p>
                                </div>
                                <div class="draft-template" data-template="employment">
                                    <i class="fas fa-briefcase"></i>
                                    <h4>Employment Contract</h4>
                                    <p>Employee agreement template</p>
                                </div>
                                <div class="draft-template" data-template="rental">
                                    <i class="fas fa-house"></i>
                                    <h4>Rental Agreement</h4>
                                    <p>Tenancy agreement template</p>
                                </div>
                                <div class="draft-template" data-template="loan">
                                    <i class="fas fa-money-bill-wave"></i>
                                    <h4>Loan Agreement</h4>
                                    <p>Money lending agreement</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="welcome-features">
                            <div class="feature">
                                <i class="fas fa-bolt"></i>
                                <h4>Instant Responses</h4>
                                <p>Get immediate legal insights powered by advanced AI</p>
                            </div>
                            <div class="feature">
                                <i class="fas fa-shield-alt"></i>
                                <h4>Confidential & Secure</h4>
                                <p>Your conversations are private and encrypted</p>
                            </div>
                            <div class="feature">
                                <i class="fas fa-language"></i>
                                <h4>Multi-Language</h4>
                                <p>Responds in same language as your query</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="input-container">
                    <div class="input-area">
                        <textarea 
                            id="userInput" 
                            placeholder="Ask any legal question or request a document draft... (Press Enter to send, Shift+Enter for new line)"
                            rows="1"
                        ></textarea>
                        <button class="send-button" id="sendButton">
                            <i class="fas fa-paper-plane"></i> <span class="hide-on-mobile">Send</span>
                        </button>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- Download Modal (for full chat) -->
        <div class="modal-overlay" id="downloadModal">
            <div class="modal">
                <div class="modal-header">
                    <h2><i class="fas fa-download"></i> Download Chat</h2>
                    <button class="modal-close" id="closeDownloadModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <p>Select the format you want to download your chat in:</p>
                    
                    <div class="download-options">
                        <div class="download-option" data-format="doc">
                            <i class="fas fa-file-word"></i>
                            <h3>Word Document</h3>
                            <p>.doc format</p>
                        </div>
                        <div class="download-option" data-format="pdf">
                            <i class="fas fa-file-pdf"></i>
                            <h3>PDF Document</h3>
                            <p>.pdf format</p>
                        </div>
                        <div class="download-option" data-format="txt">
                            <i class="fas fa-file-alt"></i>
                            <h3>Text File</h3>
                            <p>.txt format</p>
                        </div>
                        <div class="download-option" data-format="html">
                            <i class="fas fa-code"></i>
                            <h3>HTML File</h3>
                            <p>.html format</p>
                        </div>
                    </div>
                    
                    <div class="progress-indicator" id="progressIndicator">
                        <div class="progress-spinner"></div>
                        <p>Preparing your document...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <p>The document will include the complete chat conversation with timestamps.</p>
                </div>
            </div>
        </div>
        
        <!-- Delete Confirmation Modal -->
        <div class="modal-overlay" id="deleteModal">
            <div class="modal confirmation-modal">
                <div class="modal-header">
                    <h2><i class="fas fa-trash"></i> Delete Chat</h2>
                    <button class="modal-close" id="closeDeleteModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <div class="confirmation-text">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Are you sure you want to delete this chat?</h3>
                        <p id="deleteChatTitle">This action cannot be undone and the chat will be permanently deleted.</p>
                    </div>
                    
                    <div class="confirmation-buttons">
                        <button class="confirmation-btn cancel" id="cancelDelete">Cancel</button>
                        <button class="confirmation-btn delete" id="confirmDelete">Delete Permanently</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Individual Message Download Modal -->
        <div class="modal-overlay" id="messageDownloadModal">
            <div class="modal">
                <div class="modal-header">
                    <h2><i class="fas fa-file-download"></i> Download Document</h2>
                    <button class="modal-close" id="closeMessageDownloadModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <p>Select the format for this specific response:</p>
                    
                    <div class="download-options">
                        <div class="download-option" data-format="doc">
                            <i class="fas fa-file-word"></i>
                            <h3>Word Document</h3>
                            <p>.doc format</p>
                        </div>
                        <div class="download-option" data-format="pdf">
                            <i class="fas fa-file-pdf"></i>
                            <h3>PDF Document</h3>
                            <p>.pdf format</p>
                        </div>
                        <div class="download-option" data-format="txt">
                            <i class="fas fa-file-alt"></i>
                            <h3>Text File</h3>
                            <p>.txt format</p>
                        </div>
                    </div>
                    
                    <div class="progress-indicator" id="messageProgressIndicator">
                        <div class="progress-spinner"></div>
                        <p>Preparing your document...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <p>The document will include only this specific AI response.</p>
                </div>
            </div>
        </div>
        
        <div class="toast" id="toast">
            <i class="fas fa-check-circle"></i>
            <span id="toast-message">Message sent successfully</span>
        </div>
    </div>

    <script>
        // Your Groq API Key
        const GROQ_API_KEY = "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";
        
        // Working models
        const WORKING_MODELS = [
            "allam-2-7b",
            "meta-llama/llama-4-maverick-17b-128e-instruct",
            "openai/gpt-oss-safeguard-20b",
            "playai-tts-arabic",
            "meta-llama/llama-prompt-guard-2-86m",
            "meta-llama/llama-4-scout-17b-16e-instruct",
            "openai/gpt-oss-20b",
            "openai/gpt-oss-120b",
            "groq/compound-mini",
            "llama-3.1-8b-instant",
            "moonshotai/kimi-k2-instruct-0905",
            "playai-tts",
            "llama-3.3-70b-versatile",
            "qwen/qwen3-32b",
            "groq/compound",
            "meta-llama/llama-guard-4-12b",
            "moonshotai/kimi-k2-instruct",
            "meta-llama/llama-prompt-guard-2-22m",
            "llama3-8b-8192",
            "llama3-70b-8192",
            "mixtral-8x7b-32768"
        ];
        
        // Current model
        let currentModel = "openai/gpt-oss-safeguard-20b";
        
        // Chat History Management
        let chatHistory = []; // Array of chat sessions
        let currentChatId = null; // ID of current chat session
        let conversationHistory = []; // Messages in current chat
        
        // Store message content for document download
        let messageContentForDownload = "";
        
        // PRE-MADE LEGAL DOCUMENT TEMPLATES
        const LEGAL_DOCUMENTS = {
            'nda': {
                title: "NON-DISCLOSURE AGREEMENT",
                content: `NON-DISCLOSURE AGREEMENT

This Non-Disclosure Agreement ("Agreement") is made on ${new Date().toLocaleDateString()} between:

DISCLOSING PARTY:
Name: ________________________________
Address: _____________________________
______________________________________

RECEIVING PARTY:
Name: ________________________________
Address: _____________________________
______________________________________

1. DEFINITION OF CONFIDENTIAL INFORMATION
For purposes of this Agreement, "Confidential Information" shall include all information or material that has or could have commercial value or other utility in the business in which Disclosing Party is engaged.

2. OBLIGATIONS OF RECEIVING PARTY
Receiving Party shall hold and maintain the Confidential Information in strictest confidence for the sole and exclusive benefit of the Disclosing Party.

3. TIME PERIODS
The nondisclosure provisions of this Agreement shall survive the termination of this Agreement and Receiving Party's duty to hold Confidential Information in confidence shall remain in effect until the Confidential Information no longer qualifies as a trade secret or until Disclosing Party sends Receiving Party written notice releasing Receiving Party from this Agreement.

4. RELATIONSHIPS
Nothing contained in this Agreement shall be deemed to constitute either party a partner, joint venturer or employee of the other party for any purpose.

5. SEVERABILITY
If a court finds any provision of this Agreement invalid or unenforceable, the remainder of this Agreement shall be interpreted so as best to effect the intent of the parties.

6. INTEGRATION
This Agreement expresses the complete understanding of the parties with respect to the subject matter and supersedes all prior proposals, agreements, representations and understandings.

IN WITNESS WHEREOF, the parties have executed this Agreement as of the date first written above.

DISCLOSING PARTY:
___________________________
Signature
___________________________
Name
___________________________
Title
___________________________
Date

RECEIVING PARTY:
___________________________
Signature
___________________________
Name
___________________________
Title
___________________________
Date

[DOWNLOAD READY]`
            },
            
            'employment': {
                title: "EMPLOYMENT AGREEMENT",
                content: `EMPLOYMENT AGREEMENT

This Employment Agreement ("Agreement") is made on ${new Date().toLocaleDateString()} between:

EMPLOYER:
Company Name: _________________________
Address: ______________________________
_______________________________________

EMPLOYEE:
Name: _________________________________
Address: ______________________________
_______________________________________

1. POSITION AND DUTIES
Employee shall serve as _________________________________. Employee shall perform all duties customary to such position and such other duties as may be assigned by Employer.

2. TERM OF EMPLOYMENT
Employee's employment shall commence on _________________ and shall continue until terminated as provided herein.

3. COMPENSATION
As full compensation for all services rendered, Employer shall pay Employee:
- Base Salary: __________ per month
- Payment Date: 7th of each month

4. WORKING HOURS
Employee's normal working hours shall be from 9:00 AM to 6:00 PM, Monday through Friday, with one hour lunch break.

5. LEAVE ENTITLEMENT
Employee shall be entitled to:
- Paid Leave: 12 days per year
- Sick Leave: 12 days per year
- National Holidays: As per Indian law

6. CONFIDENTIALITY
Employee agrees not to disclose any confidential information of Employer during or after employment.

7. TERMINATION
This Agreement may be terminated by either party giving 30 days written notice.

8. GOVERNING LAW
This Agreement shall be governed by the laws of India.

IN WITNESS WHEREOF, the parties have executed this Agreement as of the date first written above.

EMPLOYER:
___________________________
Signature
___________________________
Name
___________________________
Title
___________________________
Date

EMPLOYEE:
___________________________
Signature
___________________________
Name
___________________________
Date

[DOWNLOAD READY]`
            },
            
            'rental': {
                title: "RENTAL AGREEMENT",
                content: `RENTAL AGREEMENT

This Rental Agreement ("Agreement") is made on ${new Date().toLocaleDateString()} between:

LANDLORD:
Name: _________________________________
Address: ______________________________
_______________________________________

TENANT:
Name: _________________________________
Address: ______________________________
_______________________________________

PROPERTY ADDRESS:
_______________________________________
_______________________________________

1. TERM OF AGREEMENT
This Agreement shall commence on _________________ and continue until _________________.

2. RENT AMOUNT AND PAYMENT
Tenant agrees to pay __________ per month, payable in advance on the 1st day of each month.

3. SECURITY DEPOSIT
Tenant shall deposit __________ as security deposit, refundable at the end of tenancy subject to deductions for damages.

4. UTILITIES
Tenant shall be responsible for payment of all electricity, water, and gas charges for the premises.

5. MAINTENANCE
Landlord shall be responsible for structural repairs. Tenant shall be responsible for minor repairs and maintenance.

6. USE OF PREMISES
The premises shall be used exclusively for residential purposes only.

7. NOTICE PERIOD
Either party may terminate this Agreement by giving one month's written notice.

8. GOVERNING LAW
This Agreement shall be governed by the laws of India.

IN WITNESS WHEREOF, the parties have executed this Agreement as of the date first written above.

LANDLORD:
___________________________
Signature
___________________________
Name
___________________________
Witness Name
___________________________
Witness Address
___________________________
Date

TENANT:
___________________________
Signature
___________________________
Name
___________________________
Witness Name
___________________________
Witness Address
___________________________
Date

[DOWNLOAD READY]`
            },
            
            'loan': {
                title: "LOAN AGREEMENT",
                content: `LOAN AGREEMENT

This Loan Agreement ("Agreement") is made on ${new Date().toLocaleDateString()} between:

LENDER:
Name: _________________________________
Address: ______________________________
_______________________________________

BORROWER:
Name: _________________________________
Address: ______________________________
_______________________________________

1. LOAN AMOUNT
Lender agrees to lend Borrower the sum of __________ (Indian Rupees ___________________________).

2. INTEREST RATE
Interest shall be charged at the rate of ____% per annum.

3. REPAYMENT TERMS
The loan shall be repaid in __________ equal monthly installments of __________ each, commencing on _________________.

4. SECURITY
[Describe any security provided for the loan]

5. DEFAULT
If Borrower fails to make any payment within 15 days of due date, the entire outstanding amount shall become immediately due.

6. PREPAYMENT
Borrower may prepay the loan in whole or in part without any prepayment penalty.

7. GOVERNING LAW
This Agreement shall be governed by the laws of India.

8. JURISDICTION
Any disputes shall be subject to the jurisdiction of courts in _________________.

IN WITNESS WHEREOF, the parties have executed this Agreement as of the date first written above.

LENDER:
___________________________
Signature
___________________________
Name
___________________________
Witness Name
___________________________
Witness Address
___________________________
Date

BORROWER:
___________________________
Signature
___________________________
Name
___________________________
Witness Name
___________________________
Witness Address
___________________________
Date

[DOWNLOAD READY]`
            },
            
            'will': {
                title: "LAST WILL AND TESTAMENT",
                content: `LAST WILL AND TESTAMENT

I, ___________________________, residing at ________________________________________, being of sound mind and memory, do hereby make, publish and declare this to be my Last Will and Testament.

1. REVOCATION OF PRIOR WILLS
I hereby revoke all former wills and codicils by me made.

2. APPOINTMENT OF EXECUTOR
I appoint ___________________________ as the Executor of this Will.

3. PAYMENT OF DEBTS AND EXPENSES
I direct that all my just debts, funeral expenses, and expenses of administration be paid as soon as practicable after my death.

4. DISTRIBUTION OF ESTATE
I give, devise and bequeath all my estate, both real and personal, as follows:

a) To my spouse, ___________________________, I bequeath 50% of my estate.

b) To my children, ___________________________, I bequeath the remaining 50% equally.

5. GUARDIANSHIP
If my spouse does not survive me, I appoint ___________________________ as guardian of my minor children.

6. RESIDUARY CLAUSE
All the rest, residue and remainder of my estate, I give to my spouse if living, otherwise to my children equally.

IN WITNESS WHEREOF, I have hereunto set my hand this ______ day of _________________, 20____.

___________________________
Testator

SIGNED in the presence of us, who at the request of the Testator and in the presence of each other, have subscribed our names as witnesses:

WITNESS 1:
___________________________
Signature
___________________________
Name
___________________________
Address

WITNESS 2:
___________________________
Signature
___________________________
Name
___________________________
Address

[DOWNLOAD READY]`
            }
        };
        
        // Simple language detection function
        function detectLanguage(text) {
            // Check for Indian scripts
            if (/[\u0900-\u097F]/.test(text)) {
                const marathiWords = ['', '', '', '', '', ''];
                const hasMarathi = marathiWords.some(word => text.includes(word));
                return hasMarathi ? 'marathi' : 'hindi';
            }
            if (/[\u0B80-\u0BFF]/.test(text)) return 'tamil';
            if (/[\u0C00-\u0C7F]/.test(text)) return 'telugu';
            if (/[\u0C80-\u0CFF]/.test(text)) return 'kannada';
            if (/[\u0A00-\u0A7F]/.test(text)) return 'punjabi';
            if (/[\u0A80-\u0AFF]/.test(text)) return 'gujarati';
            if (/[\u0980-\u09FF]/.test(text)) return 'bengali';
            
            const romanHindiPatterns = [
                /\bkya\b/, /\bkyun\b/, /\bkaise\b/, /\bmujhe\b/, /\btujhe\b/, 
                /\bhum\b/, /\btum\b/, /\baap\b/, /\bhai\b/, /\bhain\b/, /\bho\b/
            ];
            
            const lowerText = text.toLowerCase();
            const romanHindiCount = romanHindiPatterns.filter(pattern => pattern.test(lowerText)).length;
            
            if (romanHindiCount > 0) {
                return 'hindi';
            }
            
            return 'english';
        }
        
        // Get system prompt based on detected language
        function getSystemPrompt(language, isDocumentRequest = false) {
            if (isDocumentRequest) {
                return `You are LegalSwami, an expert AI legal assistant specializing in Indian law.
                
IMPORTANT: When the user asks for a legal document draft, you MUST provide a complete, ready-to-use legal document template. Include:
1. Proper document title and headings
2. All necessary legal clauses
3. Placeholders for personal information [like this]
4. Signature sections
5. Date and witness sections if applicable
6. End with [DOWNLOAD READY]

Make sure the document is:
- Legally sound for Indian context
- Professionally formatted
- Ready for immediate download and use
- Includes all standard legal clauses

Format your response as a complete legal document.

ALWAYS include this disclaimer at the end:
"Disclaimer: This template is for educational purposes only. Consult a qualified attorney before use."

[DOWNLOAD READY]`;
            }
            
            const prompts = {
                'english': `You are LegalSwami, an expert AI legal assistant specializing in Indian law. 
                
CRITICAL RULE: You MUST respond in English ONLY.

Provide accurate legal information about Indian laws.
Cite relevant Indian laws, acts, and sections when applicable.
Mention important Indian legal precedents.
Explain legal concepts clearly.
Include practical implications for Indian context.

When user asks for document drafts, provide complete legal document templates ready for download.

Format your response with:
- Clear headings
- Bullet points for lists
- Bold for important terms
- Logical structure

ALWAYS include this disclaimer at the end:
"Disclaimer: This information is for educational purposes only and not legal advice. Consult a qualified attorney for specific legal matters."`,

                'hindi': ` LegalSwami ,     AI  

 :        

         
  ,      
      
      
       

     ,           

      :
-  
-     
-     
-  

      :
":                       "`
            };
            
            return prompts[language] || prompts['english'];
        }
        
        // Get language-specific disclaimer
        function getDisclaimer(language) {
            const disclaimers = {
                'english': "\n\n**Disclaimer:** This information is for educational purposes only and not legal advice. Consult a qualified attorney for specific legal matters.",
                'hindi': "\n\n**:**                       ",
                'marathi': "\n\n**:**          .       ."
            };
            
            return disclaimers[language] || disclaimers['english'];
        }
        
        // Check if user is asking for document
        function isDocumentRequest(message) {
            const docKeywords = [
                'draft', 'template', 'format', 'document', 'agreement', 
                'contract', 'nda', 'non disclosure', 'employment', 
                'rental', 'loan', 'will', 'testament', 'legal document',
                'ready made', 'sample', 'example', 'form', '',
                '', '', '', ''
            ];
            
            const lowerMessage = message.toLowerCase();
            return docKeywords.some(keyword => lowerMessage.includes(keyword));
        }
        
        // Check which document type is requested
        function getRequestedDocumentType(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('nda') || lowerMessage.includes('non disclosure') || lowerMessage.includes('confidentiality')) {
                return 'nda';
            } else if (lowerMessage.includes('employment') || lowerMessage.includes('job') || lowerMessage.includes('employee')) {
                return 'employment';
            } else if (lowerMessage.includes('rental') || lowerMessage.includes('tenancy') || lowerMessage.includes('lease')) {
                return 'rental';
            } else if (lowerMessage.includes('loan') || lowerMessage.includes('lending') || lowerMessage.includes('borrow')) {
                return 'loan';
            } else if (lowerMessage.includes('will') || lowerMessage.includes('testament') || lowerMessage.includes('inheritance')) {
                return 'will';
            }
            
            return null;
        }
        
        // Get pre-made document
        function getPreMadeDocument(docType) {
            return LEGAL_DOCUMENTS[docType] || null;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const chatMessages = document.getElementById('chatMessages');
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarClose = document.getElementById('sidebarClose');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const clearChatBtn = document.getElementById('clearChatBtn');
            const downloadCurrentBtn = document.getElementById('downloadCurrentBtn');
            const suggestionsBtn = document.getElementById('suggestionsBtn');
            const topicItems = document.querySelectorAll('.topic-item');
            const actionItems = document.querySelectorAll('.action-item');
            const sidebarTabs = document.querySelectorAll('.sidebar-tab');
            const newChatBtn = document.getElementById('newChatBtn');
            const draftTemplates = document.querySelectorAll('.draft-template');
            
            // Modal elements
            const closeDownloadModal = document.getElementById('closeDownloadModal');
            const closeDeleteModal = document.getElementById('closeDeleteModal');
            const cancelDelete = document.getElementById('cancelDelete');
            const confirmDelete = document.getElementById('confirmDelete');
            const closeMessageDownloadModal = document.getElementById('closeMessageDownloadModal');
            
            // Set initial state based on screen size
            const isDesktop = window.innerWidth >= 1024;
            if (isDesktop) {
                sidebar.classList.add('active');
            }
            
            // Load chat history from localStorage
            loadChatHistory();
            
            // Create new chat if no current chat
            if (!currentChatId) {
                createNewChat();
            }
            
            // Event listeners
            sendButton.addEventListener('click', sendMessage);
            
            userInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            userInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
                sendButton.disabled = this.value.trim() === '';
                
                // Show language detection hint
                const text = this.value.trim();
                if (text.length > 0) {
                    const lang = detectLanguage(text);
                    showLanguageHint(lang);
                } else {
                    hideLanguageHint();
                }
            });
            
            // Sidebar toggle buttons
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.add('active');
                sidebarOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
            
            sidebarClose.addEventListener('click', function() {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
            });
            
            sidebarOverlay.addEventListener('click', function() {
                sidebar.classList.remove('active');
                this.classList.remove('active');
                document.body.style.overflow = '';
            });
            
            // Sidebar tab switching
            sidebarTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // Update active tab
                    sidebarTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show corresponding content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabId}-content`).classList.add('active');
                    
                    // If switching to history tab, refresh the list
                    if (tabId === 'chat-history') {
                        loadHistoryList();
                    }
                });
            });
            
            // New chat button
            newChatBtn.addEventListener('click', createNewChat);
            
            clearChatBtn.addEventListener('click', clearCurrentChat);
            downloadCurrentBtn.addEventListener('click', () => {
                if (conversationHistory.length === 0) {
                    showToast('No chat content to download', 'warning');
                    return;
                }
                openDownloadModal();
            });
            suggestionsBtn.addEventListener('click', showSuggestions);
            
            // Topic click handlers
            topicItems.forEach(item => {
                item.addEventListener('click', function() {
                    const topic = this.dataset.topic;
                    const questions = {
                        'contract': 'What are the essential elements of a valid contract under Indian law?',
                        'employment': 'What are the rights of employees regarding workplace harassment in India?',
                        'intellectual': 'How does copyright protection work for software in India?',
                        'realestate': 'What documents are required for property registration in India?',
                        'family': 'What are the grounds for divorce under Hindu Marriage Act?',
                        'criminal': 'What is the difference between bailable and non-bailable offenses?'
                    };
                    
                    userInput.value = questions[topic] || `Tell me about ${topic} law in India.`;
                    userInput.focus();
                    userInput.style.height = Math.min(userInput.scrollHeight, 200) + 'px';
                    
                    // Close sidebar on mobile/tablet
                    if (window.innerWidth < 1024) {
                        sidebar.classList.remove('active');
                        sidebarOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                });
            });
            
            // Action click handlers
            actionItems.forEach(item => {
                item.addEventListener('click', function() {
                    const action = this.dataset.action;
                    
                    if (action === 'document-drafts') {
                        userInput.value = 'Give me a non-disclosure agreement draft in doc format';
                        userInput.focus();
                    } else if (action === 'legal-research') {
                        userInput.value = 'Can you help me research case laws related to breach of contract?';
                        userInput.focus();
                    } else if (action === 'case-analysis') {
                        userInput.value = 'Can you analyze the legal principles in landmark privacy law cases?';
                        userInput.focus();
                    }
                    
                    // Close sidebar on mobile/tablet
                    if (window.innerWidth < 1024) {
                        sidebar.classList.remove('active');
                        sidebarOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                });
            });
            
            // Draft template click handlers
            draftTemplates.forEach(template => {
                template.addEventListener('click', function() {
                    const templateType = this.dataset.template;
                    let requestText = '';
                    
                    switch(templateType) {
                        case 'nda':
                            requestText = 'Give me a non-disclosure agreement draft in doc format';
                            break;
                        case 'employment':
                            requestText = 'Give me an employment contract draft in word format';
                            break;
                        case 'rental':
                            requestText = 'Give me a rental agreement draft ready for download';
                            break;
                        case 'loan':
                            requestText = 'Give me a loan agreement template in document format';
                            break;
                    }
                    
                    userInput.value = requestText;
                    userInput.focus();
                    userInput.style.height = Math.min(userInput.scrollHeight, 200) + 'px';
                    
                    // Auto-send after 1 second
                    setTimeout(() => {
                        sendMessage();
                    }, 1000);
                });
            });
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(event) {
                const isMobile = window.innerWidth < 1024;
                if (isMobile && sidebar.classList.contains('active') && 
                    !sidebar.contains(event.target) && 
                    !sidebarToggle.contains(event.target)) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
            
            // Modal event listeners
            closeDownloadModal.addEventListener('click', () => {
                document.getElementById('downloadModal').classList.remove('active');
            });
            
            closeDeleteModal.addEventListener('click', () => {
                document.getElementById('deleteModal').classList.remove('active');
            });
            
            cancelDelete.addEventListener('click', () => {
                document.getElementById('deleteModal').classList.remove('active');
            });
            
            confirmDelete.addEventListener('click', deleteChatFromHistory);
            
            closeMessageDownloadModal.addEventListener('click', () => {
                document.getElementById('messageDownloadModal').classList.remove('active');
            });
            
            // Download option click handlers for chat download
            const downloadOptions = document.querySelectorAll('#downloadModal .download-option');
            downloadOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const format = this.dataset.format;
                    const chatId = document.getElementById('downloadModal').dataset.chatId;
                    downloadChat(format, chatId);
                });
            });
            
            // Download option click handlers for message download
            const messageDownloadOptions = document.querySelectorAll('#messageDownloadModal .download-option');
            messageDownloadOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const format = this.dataset.format;
                    downloadMessageAsDocument(format, messageContentForDownload);
                });
            });
            
            // Close modals when clicking outside
            const modals = document.querySelectorAll('.modal-overlay');
            modals.forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
            
            // Handle window resize
            window.addEventListener('resize', function() {
                const isDesktopNow = window.innerWidth >= 1024;
                
                if (isDesktopNow) {
                    // Desktop - always show sidebar
                    sidebar.classList.add('active');
                    sidebarOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                } else {
                    // Mobile/tablet - hide sidebar
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
            
            // Focus input on load
            userInput.focus();
            
            // Adjust textarea height on page load
            setTimeout(() => {
                userInput.style.height = 'auto';
                userInput.style.height = Math.min(userInput.scrollHeight, 200) + 'px';
            }, 100);
        });
        
        // Show language hint
        function showLanguageHint(language) {
            const inputArea = document.querySelector('.input-area');
            let existingHint = inputArea.querySelector('.language-hint');
            
            if (!existingHint) {
                existingHint = document.createElement('div');
                existingHint.className = 'language-hint';
                inputArea.appendChild(existingHint);
            }
            
            const languageNames = {
                'hindi': '',
                'marathi': '',
                'tamil': '',
                'telugu': '',
                'kannada': '',
                'punjabi': '',
                'gujarati': '',
                'bengali': '',
                'english': 'English'
            };
            
            existingHint.innerHTML = `<i class="fas fa-language"></i> Detected: ${languageNames[language] || language}`;
            existingHint.style.display = 'block';
        }
        
        // Hide language hint
        function hideLanguageHint() {
            const inputArea = document.querySelector('.input-area');
            const existingHint = inputArea.querySelector('.language-hint');
            if (existingHint) {
                existingHint.style.display = 'none';
            }
        }
        
        // Create new chat
        function createNewChat() {
            // Save current chat if it exists
            if (currentChatId && conversationHistory.length > 0) {
                saveCurrentChat();
            }
            
            // Generate new chat ID
            currentChatId = 'chat_' + Date.now();
            
            // Reset conversation history
            conversationHistory = [];
            
            // Clear chat messages
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            // Add welcome message
            const welcomeMessage = document.createElement('div');
            welcomeMessage.className = 'welcome-message';
            welcomeMessage.innerHTML = `
                <h2>Welcome to LegalSwami</h2>
                <p>Your AI-powered legal assistant for accurate, comprehensive legal information and guidance.</p>
                <p style="color: var(--primary); margin-top: 10px; font-size: 0.9rem;">
                    <i class="fas fa-language"></i> Supports multiple Indian languages!
                </p>
                
                <div style="margin-top: 2rem;">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">Ready-to-Use Legal Documents:</h3>
                    <div class="draft-templates">
                        <div class="draft-template" data-template="nda">
                            <i class="fas fa-file-signature"></i>
                            <h4>Non-Disclosure Agreement</h4>
                            <p>Confidentiality agreement template</p>
                        </div>
                        <div class="draft-template" data-template="employment">
                            <i class="fas fa-briefcase"></i>
                            <h4>Employment Contract</h4>
                            <p>Employee agreement template</p>
                        </div>
                        <div class="draft-template" data-template="rental">
                            <i class="fas fa-house"></i>
                            <h4>Rental Agreement</h4>
                            <p>Tenancy agreement template</p>
                        </div>
                        <div class="draft-template" data-template="loan">
                            <i class="fas fa-money-bill-wave"></i>
                            <h4>Loan Agreement</h4>
                            <p>Money lending agreement</p>
                        </div>
                    </div>
                </div>
                
                <div class="welcome-features">
                    <div class="feature">
                        <i class="fas fa-bolt"></i>
                        <h4>Instant Responses</h4>
                        <p>Get immediate legal insights powered by advanced AI</p>
                    </div>
                    <div class="feature">
                        <i class="fas fa-shield-alt"></i>
                        <h4>Confidential & Secure</h4>
                        <p>Your conversations are private and encrypted</p>
                    </div>
                    <div class="feature">
                        <i class="fas fa-language"></i>
                        <h4>Multi-Language</h4>
                        <p>Responds in same language as your query</p>
                    </div>
                </div>
            `;
            chatMessages.appendChild(welcomeMessage);
            
            // Add event listeners to draft templates
            setTimeout(() => {
                document.querySelectorAll('.draft-template').forEach(template => {
                    template.addEventListener('click', function() {
                        const templateType = this.dataset.template;
                        let requestText = '';
                        
                        switch(templateType) {
                            case 'nda':
                                requestText = 'Give me a non-disclosure agreement draft in doc format';
                                break;
                            case 'employment':
                                requestText = 'Give me an employment contract draft in word format';
                                break;
                            case 'rental':
                                requestText = 'Give me a rental agreement draft ready for download';
                                break;
                            case 'loan':
                                requestText = 'Give me a loan agreement template in document format';
                                break;
                        }
                        
                        document.getElementById('userInput').value = requestText;
                        document.getElementById('userInput').focus();
                        document.getElementById('userInput').style.height = Math.min(document.getElementById('userInput').scrollHeight, 200) + 'px';
                        
                        // Auto-send after 1 second
                        setTimeout(() => {
                            sendMessage();
                        }, 1000);
                    });
                });
            }, 100);
            
            // Add to chat history
            chatHistory.unshift({
                id: currentChatId,
                title: 'New Chat',
                preview: 'Start a conversation...',
                date: new Date().toISOString(),
                messages: []
            });
            
            // Update history list
            loadHistoryList();
            
            // Show toast
            showToast('New chat created', 'success');
            
            // Focus input
            document.getElementById('userInput').focus();
        }
        
        // Save current chat to history
        function saveCurrentChat() {
            if (!currentChatId || conversationHistory.length === 0) return;
            
            // Find chat in history
            const chatIndex = chatHistory.findIndex(chat => chat.id === currentChatId);
            
            // Generate title from first user message
            let title = 'New Chat';
            let preview = 'No messages yet';
            
            if (conversationHistory.length > 0) {
                const firstUserMessage = conversationHistory.find(msg => msg.role === 'user');
                if (firstUserMessage) {
                    title = firstUserMessage.content.substring(0, 30);
                    if (firstUserMessage.content.length > 30) {
                        title += '...';
                    }
                }
                
                const lastMessage = conversationHistory[conversationHistory.length - 1];
                if (lastMessage) {
                    preview = lastMessage.content.substring(0, 50);
                    if (lastMessage.content.length > 50) {
                        preview += '...';
                    }
                }
            }
            
            if (chatIndex !== -1) {
                // Update existing chat
                chatHistory[chatIndex] = {
                    id: currentChatId,
                    title: title,
                    preview: preview,
                    date: new Date().toISOString(),
                    messages: [...conversationHistory]
                };
            } else {
                // Add new chat
                chatHistory.unshift({
                    id: currentChatId,
                    title: title,
                    preview: preview,
                    date: new Date().toISOString(),
                    messages: [...conversationHistory]
                });
            }
            
            // Save to localStorage
            saveChatHistory();
        }
        
        // Load chat from history
        function loadChatFromHistory(chatId) {
            // Save current chat first
            if (currentChatId && conversationHistory.length > 0) {
                saveCurrentChat();
            }
            
            // Find the chat
            const chat = chatHistory.find(c => c.id === chatId);
            if (!chat) return;
            
            // Set as current chat
            currentChatId = chatId;
            conversationHistory = [...chat.messages];
            
            // Clear and load chat messages
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            if (conversationHistory.length === 0) {
                // Show welcome message if no messages
                createNewChat();
            } else {
                // Display all messages
                conversationHistory.forEach(msg => {
                    if (msg.role === 'user' || msg.role === 'assistant') {
                        addMessageToChat(msg.content, msg.role === 'user', true, msg.isDocument);
                    }
                });
            }
            
            // Update history list UI
            loadHistoryList();
            
            // Show toast
            showToast('Chat loaded', 'success');
            
            // Focus input
            document.getElementById('userInput').focus();
            
            // Close sidebar on mobile/tablet
            if (window.innerWidth < 1024) {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('sidebarOverlay').classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        // Load history list UI
        function loadHistoryList() {
            const historyList = document.getElementById('historyList');
            
            if (chatHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-history">
                        <i class="fas fa-comments"></i>
                        <p>No chat history yet</p>
                        <p style="font-size: 0.8rem; margin-top: 0.5rem;">Start a conversation to see it here</p>
                    </div>
                `;
                return;
            }
            
            historyList.innerHTML = '';
            
            chatHistory.forEach(chat => {
                const historyItem = document.createElement('div');
                historyItem.className = `history-item ${chat.id === currentChatId ? 'active' : ''}`;
                historyItem.dataset.chatId = chat.id;
                
                const date = new Date(chat.date);
                const formattedDate = date.toLocaleDateString('en-IN', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
                
                historyItem.innerHTML = `
                    <div class="history-title">${chat.title}</div>
                    <div class="history-preview">${chat.preview}</div>
                    <div class="history-date">${formattedDate}</div>
                    <div class="history-item-actions">
                        <button class="history-item-btn download" title="Download chat">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="history-item-btn delete" title="Delete chat">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // Load chat when clicking on the item
                historyItem.addEventListener('click', (e) => {
                    // Only load if not clicking on action buttons
                    if (!e.target.closest('.history-item-actions')) {
                        loadChatFromHistory(chat.id);
                    }
                });
                
                // Download button event
                const downloadBtn = historyItem.querySelector('.download');
                downloadBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openDownloadModal(chat.id);
                });
                
                // Delete button event
                const deleteBtn = historyItem.querySelector('.delete');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openDeleteModal(chat.id, chat.title);
                });
                
                historyList.appendChild(historyItem);
            });
        }
        
        // Open download modal (for full chat)
        function openDownloadModal(chatId = null) {
            const downloadModal = document.getElementById('downloadModal');
            downloadModal.classList.add('active');
            
            // Store the chat ID to download
            downloadModal.dataset.chatId = chatId || currentChatId;
        }
        
        // Open delete modal
        function openDeleteModal(chatId, chatTitle) {
            const deleteModal = document.getElementById('deleteModal');
            deleteModal.classList.add('active');
            deleteModal.dataset.chatId = chatId;
            
            // Update modal text
            document.getElementById('deleteChatTitle').innerHTML = 
                `Are you sure you want to delete "<strong>${chatTitle}</strong>"?<br>
                This action cannot be undone and the chat will be permanently deleted.`;
        }
        
        // Open message download modal
        function openMessageDownloadModal(content) {
            messageContentForDownload = content;
            document.getElementById('messageDownloadModal').classList.add('active');
        }
        
        // Download chat function (full chat)
        async function downloadChat(format, chatId) {
            const progressIndicator = document.getElementById('progressIndicator');
            progressIndicator.classList.add('active');
            
            // Find the chat
            const chat = chatHistory.find(c => c.id === chatId) || {
                id: currentChatId,
                title: 'Current Chat',
                date: new Date().toISOString(),
                messages: conversationHistory
            };
            
            try {
                switch(format) {
                    case 'doc':
                        await downloadAsDoc(chat, true);
                        break;
                    case 'pdf':
                        await downloadAsPDF(chat, true);
                        break;
                    case 'txt':
                        downloadAsText(chat, true);
                        break;
                    case 'html':
                        downloadAsHTML(chat, true);
                        break;
                }
                
                showToast(`Chat downloaded as ${format.toUpperCase()} successfully!`, 'success');
            } catch (error) {
                console.error('Download error:', error);
                showToast('Failed to download chat', 'error');
            } finally {
                progressIndicator.classList.remove('active');
                document.getElementById('downloadModal').classList.remove('active');
            }
        }
        
        // Download message as document
        async function downloadMessageAsDocument(format, content) {
            const progressIndicator = document.getElementById('messageProgressIndicator');
            progressIndicator.classList.add('active');
            
            try {
                // Create a chat-like object for the single message
                const messageChat = {
                    id: 'single_message',
                    title: 'LegalSwami Document',
                    date: new Date().toISOString(),
                    messages: [
                        { role: 'assistant', content: content }
                    ]
                };
                
                switch(format) {
                    case 'doc':
                        await downloadAsDoc(messageChat, false);
                        break;
                    case 'pdf':
                        await downloadAsPDF(messageChat, false);
                        break;
                    case 'txt':
                        downloadAsText(messageChat, false);
                        break;
                }
                
                showToast(`Document downloaded as ${format.toUpperCase()} successfully!`, 'success');
            } catch (error) {
                console.error('Download error:', error);
                showToast('Failed to download document', 'error');
            } finally {
                progressIndicator.classList.remove('active');
                document.getElementById('messageDownloadModal').classList.remove('active');
            }
        }
        
        // Download as Word Document
        function downloadAsDoc(chat, isFullChat) {
            return new Promise((resolve) => {
                let content = `LEGALSWAMI ${isFullChat ? 'CHAT DOCUMENT' : 'DOCUMENT'}\n`;
                content += `================================\n\n`;
                content += `Title: ${chat.title}\n`;
                content += `Date: ${new Date(chat.date).toLocaleString()}\n\n`;
                content += `================================\n\n`;
                
                if (isFullChat) {
                    chat.messages.forEach((msg, index) => {
                        const role = msg.role === 'user' ? 'USER' : 'LEGALSWAMI';
                        
                        content += `${role}:\n`;
                        content += `${msg.content}\n\n`;
                        content += `--------------------------------\n\n`;
                    });
                } else {
                    // For single message, just include the content
                    content += chat.messages[0].content + '\n\n';
                }
                
                content += `\n\n================================\n`;
                content += `${isFullChat ? 'END OF CHAT' : 'END OF DOCUMENT'}\n`;
                content += `Disclaimer: This ${isFullChat ? 'chat transcript' : 'document'} is for reference purposes only.\n`;
                content += `The information provided is not legal advice. Consult a qualified attorney.\n`;
                
                // Create blob and download
                const blob = new Blob([content], { type: 'application/msword' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `LegalSwami_${isFullChat ? 'Chat' : 'Document'}_${formatDateForFilename(chat.date)}.doc`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                resolve();
            });
        }
        
        // Download as PDF (simplified)
        async function downloadAsPDF(chat, isFullChat) {
            return new Promise((resolve) => {
                // Create HTML content for PDF
                let htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>LegalSwami ${isFullChat ? 'Chat' : 'Document'}</title>
                        <style>
                            body { font-family: Arial, sans-serif; line-height: 1.6; margin: 40px; }
                            .header { text-align: center; border-bottom: 2px solid #10a37f; padding-bottom: 20px; margin-bottom: 30px; }
                            .title { color: #10a37f; font-size: 24px; margin-bottom: 10px; }
                            .chat-info { color: #666; font-size: 14px; margin-bottom: 30px; }
                            .message { margin-bottom: 25px; }
                            .user-message { background: #f0f9f7; padding: 15px; border-radius: 8px; border-left: 4px solid #10a37f; }
                            .ai-message { background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #7e57c2; }
                            .role { font-weight: bold; color: #10a37f; margin-bottom: 5px; }
                            .disclaimer { background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin-top: 40px; font-size: 14px; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1 class="title">LegalSwami ${isFullChat ? 'Chat Document' : 'Document'}</h1>
                            <div class="chat-info">
                                <p><strong>Title:</strong> ${chat.title}</p>
                                <p><strong>Date:</strong> ${new Date(chat.date).toLocaleString()}</p>
                            </div>
                        </div>
                        
                        <div class="content">
                `;
                
                if (isFullChat) {
                    chat.messages.forEach(msg => {
                        const roleClass = msg.role === 'user' ? 'user-message' : 'ai-message';
                        const roleText = msg.role === 'user' ? 'USER' : 'LEGALSWAMI';
                        
                        htmlContent += `
                            <div class="message ${roleClass}">
                                <div class="role">${roleText}</div>
                                <div>${msg.content.replace(/\n/g, '<br>')}</div>
                            </div>
                        `;
                    });
                } else {
                    htmlContent += `
                        <div class="message ai-message">
                            <div class="role">LEGALSWAMI</div>
                            <div>${chat.messages[0].content.replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                }
                
                htmlContent += `
                        </div>
                        
                        <div class="disclaimer">
                            <h3>Disclaimer</h3>
                            <p>This ${isFullChat ? 'chat transcript' : 'document'} is for reference purposes only. The information provided by LegalSwami AI Assistant is for educational and informational purposes only and should not be construed as legal advice. You should consult with a qualified attorney for advice regarding your individual legal situation.</p>
                            <p>Generated by LegalSwami AI Legal Assistant on ${new Date().toLocaleString()}</p>
                        </div>
                    </body>
                    </html>
                `;
                
                // Create blob and download
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `LegalSwami_${isFullChat ? 'Chat' : 'Document'}_${formatDateForFilename(chat.date)}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                resolve();
            });
        }
        
        // Download as Text
        function downloadAsText(chat, isFullChat) {
            let content = `LEGALSWAMI ${isFullChat ? 'CHAT TRANSCRIPT' : 'DOCUMENT'}\n`;
            content += `============================\n\n`;
            content += `Title: ${chat.title}\n`;
            content += `Date: ${new Date(chat.date).toLocaleString()}\n\n`;
            content += `============================\n\n`;
            
            if (isFullChat) {
                chat.messages.forEach((msg, index) => {
                    content += `${msg.role === 'user' ? 'USER' : 'LEGALSWAMI'}:\n`;
                    content += `${msg.content}\n\n`;
                    content += `-------------------------\n\n`;
                });
            } else {
                content += chat.messages[0].content + '\n\n';
            }
            
            content += `\n\n============================\n`;
            content += `${isFullChat ? 'END OF TRANSCRIPT' : 'END OF DOCUMENT'}\n\n`;
            content += `Disclaimer: This ${isFullChat ? 'transcript' : 'document'} is for reference only.\n`;
            content += `Not legal advice. Consult a qualified attorney.\n`;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `LegalSwami_${isFullChat ? 'Chat' : 'Document'}_${formatDateForFilename(chat.date)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Download as HTML
        function downloadAsHTML(chat, isFullChat) {
            let content = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LegalSwami ${isFullChat ? 'Chat' : 'Document'} - ${chat.title}</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; margin: 40px; max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; border-bottom: 2px solid #10a37f; padding-bottom: 20px; margin-bottom: 30px; }
        .title { color: #10a37f; font-size: 28px; margin-bottom: 10px; }
        .chat-info { color: #666; font-size: 14px; margin-bottom: 30px; }
        .message { margin-bottom: 25px; padding: 15px; border-radius: 8px; }
        .user-message { background: #f0f9f7; border-left: 4px solid #10a37f; }
        .ai-message { background: #f8f9fa; border-left: 4px solid #7e57c2; }
        .role { font-weight: bold; color: #10a37f; margin-bottom: 5px; }
        .timestamp { color: #999; font-size: 12px; float: right; }
        .disclaimer { background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin-top: 40px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">LegalSwami ${isFullChat ? 'Chat Document' : 'Document'}</h1>
        <div class="chat-info">
            <p><strong>Title:</strong> ${chat.title}</p>
            <p><strong>Date:</strong> ${new Date(chat.date).toLocaleString()}</p>
        </div>
    </div>
    
    <div class="content">`;
            
            if (isFullChat) {
                chat.messages.forEach((msg, index) => {
                    const roleClass = msg.role === 'user' ? 'user-message' : 'ai-message';
                    const roleText = msg.role === 'user' ? 'USER' : 'LEGALSWAMI AI ASSISTANT';
                    
                    content += `
        <div class="message ${roleClass}">
            <div class="role">${roleText}</div>
            <div class="content">${msg.content.replace(/\n/g, '<br>')}</div>
        </div>`;
                });
            } else {
                content += `
        <div class="message ai-message">
            <div class="role">LEGALSWAMI AI ASSISTANT</div>
            <div class="content">${chat.messages[0].content.replace(/\n/g, '<br>')}</div>
        </div>`;
            }
            
            content += `
    </div>
    
    <div class="disclaimer">
        <h3>Disclaimer</h3>
        <p>This ${isFullChat ? 'chat transcript' : 'document'} is for reference purposes only. The information provided by LegalSwami AI Assistant is for educational and informational purposes only and should not be construed as legal advice. You should consult with a qualified attorney for advice regarding your individual legal situation.</p>
        <p>Generated by LegalSwami AI Legal Assistant on ${new Date().toLocaleString()}</p>
    </div>
</body>
</html>`;
            
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `LegalSwami_${isFullChat ? 'Chat' : 'Document'}_${formatDateForFilename(chat.date)}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Delete chat from history
        function deleteChatFromHistory() {
            const chatId = document.getElementById('deleteModal').dataset.chatId;
            const chatIndex = chatHistory.findIndex(chat => chat.id === chatId);
            
            if (chatIndex !== -1) {
                // Check if we're deleting the current chat
                if (currentChatId === chatId) {
                    createNewChat();
                }
                
                // Remove from history
                chatHistory.splice(chatIndex, 1);
                
                // Update localStorage
                saveChatHistory();
                
                // Update UI
                loadHistoryList();
                
                // Close modal
                document.getElementById('deleteModal').classList.remove('active');
                
                // Show toast
                showToast('Chat deleted successfully', 'success');
            }
        }
        
        // Format date for filename
        function formatDateForFilename(dateString) {
            const date = new Date(dateString);
            return date.toISOString()
                .replace(/[:\-]/g, '')
                .replace('T', '_')
                .split('.')[0];
        }
        
        // Save chat history to localStorage
        function saveChatHistory() {
            try {
                localStorage.setItem('legalSwamiChatHistory', JSON.stringify(chatHistory));
                localStorage.setItem('legalSwamiCurrentChatId', currentChatId);
            } catch (error) {
                console.error('Error saving chat history:', error);
            }
        }
        
        // Load chat history from localStorage
        function loadChatHistory() {
            try {
                const savedHistory = localStorage.getItem('legalSwamiChatHistory');
                if (savedHistory) {
                    chatHistory = JSON.parse(savedHistory);
                }
                
                const savedChatId = localStorage.getItem('legalSwamiCurrentChatId');
                if (savedChatId) {
                    currentChatId = savedChatId;
                    // Load the current chat's messages
                    const currentChat = chatHistory.find(chat => chat.id === currentChatId);
                    if (currentChat) {
                        conversationHistory = [...currentChat.messages];
                    }
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
                chatHistory = [];
            }
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Send message function
        async function sendMessage() {
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            const message = userInput.value.trim();
            if (!message) return;
            
            // Detect language
            const detectedLanguage = detectLanguage(message);
            hideLanguageHint();
            
            // Check if this is a document request
            const isDocRequest = isDocumentRequest(message);
            const requestedDocType = getRequestedDocumentType(message);
            
            // Add user message to chat
            addMessageToChat(message, true);
            userInput.value = '';
            userInput.style.height = '56px';
            sendButton.disabled = true;
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                let response;
                
                // Check if we have a pre-made document for this request
                if (requestedDocType && LEGAL_DOCUMENTS[requestedDocType]) {
                    // Use pre-made document
                    response = LEGAL_DOCUMENTS[requestedDocType].content;
                } else if (isDocRequest) {
                    // Call AI for other document requests
                    response = await callGroqAPI(message, detectedLanguage, true);
                } else {
                    // Regular query
                    response = await callGroqAPI(message, detectedLanguage, false);
                }
                
                // Hide typing indicator and add response
                hideTypingIndicator();
                const messageId = addMessageToChat(response, false, false, isDocRequest || requestedDocType);
                
                // Check if response contains [DOWNLOAD READY] flag
                const hasDownloadFlag = response.includes('[DOWNLOAD READY]');
                
                // If it's a document request or has download flag, add download button
                if (isDocRequest || requestedDocType || hasDownloadFlag) {
                    addDocumentDownloadButton(messageId, response);
                }
                
                // Store in conversation history
                conversationHistory.push(
                    { 
                        role: 'user', 
                        content: message, 
                        language: detectedLanguage, 
                        isDocumentRequest: isDocRequest,
                        requestedDocType: requestedDocType
                    },
                    { 
                        role: 'assistant', 
                        content: response, 
                        language: detectedLanguage, 
                        hasDownloadFlag: hasDownloadFlag,
                        isDocument: isDocRequest || requestedDocType
                    }
                );
                
                // Save current chat to history
                saveCurrentChat();
                
                // Update history list if we're on that tab
                if (document.querySelector('.sidebar-tab[data-tab="chat-history"]').classList.contains('active')) {
                    loadHistoryList();
                }
                
            } catch (error) {
                hideTypingIndicator();
                
                // Show user-friendly error message
                const friendlyMessage = "I apologize for the inconvenience. I'm currently experiencing technical difficulties accessing my legal databases. This could be due to high demand or temporary service issues. Please try your question again in a moment, or try rephrasing it slightly.";
                
                addMessageToChat(friendlyMessage, false);
                
                // Store the error in conversation history for context
                conversationHistory.push(
                    { role: 'user', content: message, language: detectedLanguage },
                    { role: 'assistant', content: friendlyMessage, language: detectedLanguage }
                );
                
                console.error('AI Service Error:', error.message);
                
                // Show subtle notification to user
                showToast('Service temporarily unavailable', 'warning');
            } finally {
                sendButton.disabled = false;
                userInput.focus();
            }
        }
        
        // Call Groq API with sequential model fallback
        async function callGroqAPI(message, detectedLanguage, isDocumentRequest = false) {
            // Get appropriate system prompt
            const systemPrompt = getSystemPrompt(detectedLanguage, isDocumentRequest);
            
            const messages = [
                { role: 'system', content: systemPrompt },
                ...conversationHistory.map(msg => ({
                    role: msg.role,
                    content: msg.content
                })),
                { role: 'user', content: message }
            ];

            let lastError = null;
            let modelsTried = 0;
            
            // Try all models in sequence
            for (const modelToTry of WORKING_MODELS) {
                modelsTried++;
                console.log(`Trying model ${modelsTried}/${WORKING_MODELS.length}: ${modelToTry}`);
                
                try {
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${GROQ_API_KEY}`
                        },
                        body: JSON.stringify({
                            model: modelToTry,
                            messages: messages,
                            temperature: 0.7,
                            max_tokens: 4000,
                            stream: false
                        }),
                        // Add timeout to prevent hanging requests
                        signal: AbortSignal.timeout(30000) // 30 seconds timeout
                    });

                    // Check for HTTP errors
                    if (!response.ok) {
                        // If it's a 400 or 404 error, try the next model
                        if (response.status === 400 || response.status === 404) {
                            console.log(`Model ${modelToTry} returned ${response.status}, trying next model...`);
                            lastError = new Error(`Model ${modelToTry} failed with status: ${response.status}`);
                            continue; // Try next model
                        }
                        // For other errors, throw immediately
                        throw new Error(`API error: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // Validate response structure
                    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                        console.log(`Model ${modelToTry} returned invalid response format, trying next...`);
                        lastError = new Error('Invalid response format from API');
                        continue;
                    }
                    
                    let responseText = data.choices[0].message.content;
                    
                    // Update current model to the successful one
                    currentModel = modelToTry;
                    
                    // Notify user if we had to switch models (but not on first successful try)
                    if (modelsTried > 1) {
                        const modelName = modelToTry.split('/').pop() || modelToTry;
                        console.log(`Successfully switched to model: ${modelName}`);
                        // Optional: Show subtle notification to user
                        showToast(`Using ${modelName} model`, 'info');
                    }
                    
                    // For document requests, ensure download flag is included
                    if (isDocumentRequest && !responseText.includes('[DOWNLOAD READY]')) {
                        responseText += '\n\n[DOWNLOAD READY]';
                    }
                    
                    return responseText;

                } catch (error) {
                    lastError = error;
                    console.log(`Model ${modelToTry} failed:`, error.message);
                    
                    // Continue to next model if available
                    if (modelsTried < WORKING_MODELS.length) {
                        continue;
                    }
                }
            }
            
            // If all models failed, provide a user-friendly error
            throw new Error(`I'm having trouble connecting to my legal knowledge base. All available models failed. Please try again in a few moments or rephrase your question.`);
        }
        
        // Add message to chat
        function addMessageToChat(content, isUser, fromHistory = false, isDocument = false) {
            const chatMessages = document.getElementById('chatMessages');
            
            // Remove welcome message if it exists and this is a new message
            if (!fromHistory && isUser) {
                const welcomeMessage = document.querySelector('.welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.remove();
                }
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            messageDiv.id = messageId;
            
            // Avatar
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.innerHTML = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
            
            // Message content
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            
            if (isUser) {
                messageText.textContent = content;
            } else {
                if (isDocument) {
                    messageText.innerHTML = formatDocumentResponse(content);
                } else {
                    messageText.innerHTML = formatLegalResponse(content);
                }
            }
            
            messageContent.appendChild(messageText);
            
            // Action buttons for AI messages
            if (!isUser && !fromHistory) {
                const messageActions = document.createElement('div');
                messageActions.className = 'message-actions';
                messageActions.innerHTML = `
                    <button class="action-btn copy" onclick="copyMessage(this)">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                    <button class="action-btn like" onclick="likeMessage(this)">
                        <i class="far fa-thumbs-up"></i> Helpful
                    </button>
                    <button class="action-btn document" onclick="downloadThisMessage('${messageId}')">
                        <i class="fas fa-file-download"></i> Download
                    </button>
                `;
                messageContent.appendChild(messageActions);
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
            
            return messageId;
        }
        
        // Format document response
        function formatDocumentResponse(text) {
            // Remove [DOWNLOAD READY] flag from displayed text
            let displayText = text.replace(/\[DOWNLOAD READY\]/g, '');
            
            // Create document template container
            const documentContainer = document.createElement('div');
            documentContainer.className = 'document-template';
            
            // Split into lines and format
            const lines = displayText.split('\n');
            let htmlContent = '';
            
            lines.forEach(line => {
                if (line.trim() === '') return;
                
                // Check for title
                if (line.toUpperCase() === line && line.length > 10 && !line.includes(':')) {
                    htmlContent += `<div class="document-header">
                        <h2 class="document-title">${line}</h2>
                        <div class="document-subtitle">Legal Document Template</div>
                    </div>`;
                }
                // Check for section
                else if (line.match(/^\d+\.\s+.+/) || line.match(/^[A-Z\s]+:$/)) {
                    htmlContent += `<div class="document-section">
                        <h3 class="document-section-title">${line}</h3>`;
                }
                // Check for clause
                else if (line.match(/^[a-z]\)\s+.+/)) {
                    htmlContent += `<div class="document-clause">
                        <div class="clause-title">${line}</div>`;
                }
                // Regular content
                else {
                    if (line.includes('___________________') || line.includes('________________')) {
                        htmlContent += `<div class="clause-content" style="border-bottom: 1px solid var(--dark-border); padding-bottom: 5px; margin-bottom: 10px;">${line}</div>`;
                    } else {
                        htmlContent += `<div class="clause-content">${line}</div>`;
                    }
                }
            });
            
            // Add signature section if not present
            if (!displayText.includes('Signature') && !displayText.includes('Witness')) {
                htmlContent += `
                    <div class="signature-section">
                        <div class="signature-line">
                            <div class="signature-block">
                                <div class="signature-name"></div>
                                <div class="signature-label">Signature</div>
                            </div>
                            <div class="signature-block">
                                <div class="signature-name"></div>
                                <div class="signature-label">Date</div>
                            </div>
                        </div>
                    </div>`;
            }
            
            // Add disclaimer
            htmlContent += `<div class="legal-note">
                <strong>Disclaimer:</strong> This template is for educational purposes only. Consult a qualified attorney before use.
            </div>`;
            
            documentContainer.innerHTML = htmlContent;
            
            return documentContainer.outerHTML;
        }
        
        // Format legal response
        function formatLegalResponse(text) {
            // Remove [DOWNLOAD READY] flag from displayed text
            let displayText = text.replace(/\[DOWNLOAD READY\]/g, '');
            
            // Basic formatting
            let formatted = displayText
                .replace(/## (.*?)\n/g, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/- (.*?)\n/g, '<li>$1</li>')
                .replace(/\n/g, '<br>');
            
            // Wrap lists
            formatted = formatted.replace(/(<li>.*?<\/li>)/gs, function(match) {
                return '<ul>' + match + '</ul>';
            });
            
            // Add disclaimer styling
            if (formatted.includes('Disclaimer') || formatted.includes('') || formatted.includes('')) {
                formatted = formatted.replace(/(Disclaimer:.*?|:.*?|:.*?)(?=<br><br>|$)/is, 
                    '<div class="legal-note">$1</div>');
            }
            
            return '<div class="legal-content">' + formatted + '</div>';
        }
        
        // Add document download button to message
        function addDocumentDownloadButton(messageId, content) {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv) return;
            
            const messageContent = messageDiv.querySelector('.message-content');
            const existingBtn = messageContent.querySelector('.document-download-btn');
            
            if (existingBtn) return;
            
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'document-download-btn';
            downloadBtn.innerHTML = '<i class="fas fa-file-download"></i> Download Document';
            downloadBtn.title = 'Download this document template';
            
            downloadBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openMessageDownloadModal(content);
            });
            
            messageContent.appendChild(downloadBtn);
        }
        
        // Show typing indicator
        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <span>LegalSwami is preparing your document...</span>
            `;
            chatMessages.appendChild(typingDiv);
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 50);
        }
        
        // Hide typing indicator
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // Copy message function
        window.copyMessage = function(button) {
            const messageText = button.closest('.message-content').querySelector('.message-text');
            let textToCopy = messageText.innerText || messageText.textContent;
            
            // Create temporary textarea for copying
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('Document copied to clipboard!', 'success');
                } else {
                    showToast('Failed to copy text', 'error');
                }
            } catch (err) {
                console.error('Copy failed:', err);
                showToast('Failed to copy: ' + err, 'error');
            }
            
            document.body.removeChild(textarea);
        }
        
        // Like message function
        window.likeMessage = function(button) {
            button.innerHTML = '<i class="fas fa-thumbs-up"></i> Thank you!';
            button.style.background = 'var(--success)';
            button.style.borderColor = 'var(--success)';
            button.style.color = 'white';
            button.disabled = true;
            showToast('Thank you for your feedback!', 'success');
        }
        
        // Download this specific message
        window.downloadThisMessage = function(messageId) {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv) return;
            
            const messageText = messageDiv.querySelector('.message-text');
            const content = messageText.innerText || messageText.textContent;
            
            openMessageDownloadModal(content);
        }
        
        // Clear current chat
        function clearCurrentChat() {
            if (conversationHistory.length === 0) {
                showToast('Chat is already empty', 'warning');
                return;
            }
            
            if (confirm('Are you sure you want to clear the current chat?')) {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                conversationHistory = [];
                
                // Add welcome message back
                createNewChat();
                
                showToast('Current chat cleared', 'success');
            }
        }
        
        // Show suggestions
        function showSuggestions() {
            const suggestions = [
                "Give me a non-disclosure agreement draft",
                "I need an employment contract template",
                "Create a rental agreement for me",
                "Draft a loan agreement document",
                "What are the essential elements of a valid contract?"
            ];
            
            addMessageToChat(
                `<h3>Suggested Questions:</h3>
                <ul>
                    ${suggestions.map(q => `<li style="cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.3s;" 
                        onmouseover="this.style.background='var(--dark-surface-light)'" 
                        onmouseout="this.style.background='transparent'"
                        onclick="document.getElementById('userInput').value = '${q}'; document.getElementById('userInput').focus(); document.getElementById('userInput').style.height = Math.min(document.getElementById('userInput').scrollHeight, 200) + 'px'">
                        ${q}
                    </li>`).join('')}
                </ul>
                <p>Click any question to add it to the input field.</p>`,
                false
            );
        }
    </script>
</body>
</html>
